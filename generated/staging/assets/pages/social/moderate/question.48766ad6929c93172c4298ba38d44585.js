
(function(){function r(f){function h(a,b){b=b?RightNow.Url.convertToSegment(RightNow.Url.convertToArray(1,b)):"";d.add({state:a},{url:p.getCurrentPage()+b})}function k(a){return function(){g||a.apply(this,arguments)}}var c={},e={},a={},b="",g=!1,d=new f.HistoryHTML5;d.on("change",function(a){var b;a.src===f.HistoryHTML5.SRC_POPSTATE&&(a=a.changed.state||a.changed[RightNow.Event.browserHistoryManagementKey],b=m.get(),g=!0,a?f.Object.each(a.newVal,function(a){q.ajaxCallback(a.response,a.data)}):f.Object.each(b,function(a){a.fire("reset").fire("send")}),g=!1)});return{enabled:!0,setCache:function(a,b,g){c[a]||(c[a]={});c[a][b]=g},checkCache:function(a,b){return c[a]?c[a][b]:null},restoreCache:k(function(c){if(f.Object.isEmpty(e)){var g=Object.keys(a)[0];g&&a[g]&&(a={newTransactionID:c});h(a,b+=c.friendly)}b=""}),addRequest:k(function(c,g){f.Object.isEmpty(e)&&(q.searchesPerformed++,a={},b="");e[g]=c}),addResponse:k(function(c,g){var d=e[g];if(d){var k=b+=d.friendly,d=f.merge(d,c);a[g]=d;delete e[g];f.Object.isEmpty(e)&&h(a,k)}}),clearCache:function(a){c[a]=null},doesCacheExist:function(a){return c[a]?!0:!1}}}var l,q,p,m;"pushState"in window.history?YUI().use("history-html5",function(f){l=r(f)}):l={enabled:!1};q=function(){function f(a,b,c){var d="undefined"===typeof c;a&&!d&&l.addResponse({response:a,data:b},c);l.setCache(b.searchSource,b.cacheKey,a);c=m.get(b.searchSource);d&&(c.once("send",function(){return!1}).fire("send",b.allFilters),a.fromHistoryManager=!0);c.fire("response",new RightNow.Event.EventObject(null,{data:a,filters:b.allFilters}))}function h(a,b,c,d){a=RightNow.Ajax.makeRequest(a,b,{successHandler:f,failureHandler:function(a){var b=RightNow.Interface.getMessage("THERE_PROB_REQ_ACTION_COULD_COMPLETED_MSG");403===a.status&&void 0!==a.responseText&&(b=a.responseText);RightNow.UI.Dialog.messageDialog(b,{icon:"WARN",exitCallback:function(){window.location.reload(!0)}})},json:!0,data:c,timeout:1E4});l.addRequest(d,a.id+"")}function k(a,b,c,d){var f=["keyword"].concat(a.filters||[]),s=f.length,h,k,l={};c=RightNow.Lang.cloneObject(c);a.params&&(c=e.mix(c,a.params));if(b&&b.allFilters)for(a=0;a<s;a++)h=f[a],(k=b.allFilters[h])&&k.filters&&k.filters.data&&!c[h]&&("keyword"!==h||d||(h="kw"),l[h]=c[h]=k.filters.data);c.page&&!l.page&&(l.page=c.page);return{filtersToInclude:l,params:c}}function c(a,b){b&&1!==b||(a=RightNow.Url.addParameter(a,"search","1"));return a}var e=YUI();return{searchesPerformed:0,go:function(a,b,g,d,e){if("report"===d.type){if("undefined"===typeof b)throw Error("No search filters have been defined for report "+d.id);RightNow.Event.fire("evt_searchRequest",new RightNow.Event.EventObject(this,{filters:b}));if(!l.enabled||!0===a.newPage||a.reportPage&&!RightNow.Url.isSameUrl(a.reportPage))if(g=RightNow.Url,d=a.reportPage||p.getCurrentPage(),e=a.target||"_self",!a.page&&b.allFilters.page&&(a.page=1,b.allFilters.page=1),d=g.convertSearchFiltersToParms(d,b.allFilters,0),d=g.addParameter(d,"session",g.getSession()),d=c(d,b.allFilters.page),a.popupWindow){b=window.screenX||window.screenLeft;g=window.screenY||window.screenTop;var f;f=b+document.body.clientWidth;e=screen.width*a.width/100;a=screen.height*a.height/100;f=b>screen.width-f?b-e-15:f+15;var n=window.screenY?window.screenY:window.screenTop;0>f&&(f=b+100);0>n&&(n=g+100);window.open(d,"_blank","scrollbars=1,resizable=1,left="+f+",top="+n+",width="+e+"px,height="+a+"px")}else window.open(d,e);else a.page?delete b.allFilters.search:b.allFilters.page=1,a=d.id,d=d.type+d.id,g=p.buildReportRequestParameters(a,b.allFilters,b.format,b.token,0),e=RightNow.Url.convertSearchFiltersToParms("",b.allFilters,""),f=g.sf,1===f.page&&(f.search=1),f=RightNow.JSON.stringify(f),n=l.checkCache(d,f),e={friendly:e,response:n,data:{allFilters:b,cacheKey:f,key:d}},n?(l.restoreCache(e),m.get(d).fire("response",new RightNow.Event.EventObject(null,{data:n,filters:b}))):h("/ci/ajaxRequest/getReportData",{filters:f,report_id:a,r_tok:g.token,format:RightNow.JSON.stringify(g.fmt)},{searchSource:d,allFilters:b,cacheKey:f},e)}else if(g&&"object"===typeof g&&d.id)if(RightNow.Event.fire("evt_searchRequest",new RightNow.Event.EventObject(this,{filters:b})),l.enabled&&!0!==a.newPage){a=e.endpoint;b=k(e,b,g,!0);g=b.filtersToInclude;b=b.params;if(!a)throw Error("An endpoint hasn't been specified");d=d.type+d.id;e=RightNow.JSON.stringify(b);f=l.checkCache(d,e);g={key:d,friendly:RightNow.Url.convertToSegment(g)};f?(l.restoreCache(g),m.get(d).fire("response",new RightNow.Event.EventObject(null,{data:f,filters:b}))):h(a,b,{searchSource:d,allFilters:b,cacheKey:e},g)}else a=RightNow.Url,d=p.getCurrentPage(),b=k(e,b,g,!1).filtersToInclude,d+=a.convertToSegment(b),d=a.addParameter(d,"session",a.getSession()),d=c(d,b.page),window.open(d,"_self")},ajaxCallback:f}}();p={buildReportRequestParameters:function(f,h,k,c,e){var a=RightNow.Lang.cloneObject(h),b;for(b in a)a.hasOwnProperty(b)&&(a[b].filters&&(a[b].filters.report_id=parseInt(f,10)),a[b].data&&delete a[b].data);k||(k={});k.urlParms=RightNow.Url.buildUrlLinkString(h,k.parmList);return{c:e,id:f,sf:a,fmt:k,token:c}},getCurrentPage:function(){var f=window.location,h=f.pathname,f=f.origin||f.protocol+"//"+f.host;return"/"===h||"/app"===h||"/app/"===h?f+"/app/"+RightNow.Interface.getConfig("CP_HOME_URL"):h.split("/").slice(0,RightNow.Url.getParameterSegment()-1).join("/")}};m=function(){function f(c){if(!c||!c.length||2>c.length)throw Error("You're doing it wrong");this.sources=c;this.multiple=!0}var h={},k=RightNow.EventProvider.extend({overrides:{constructor:function(c,e){this.parent();this.Y=c;delete this.data;delete this.baseDomID;delete this.baseSelector;this.searchSource=e;this.instanceID=e.id;this._addEventHandler("search",{pre:function(a){this._params||(this._params={});a instanceof RightNow.Event.EventObject&&(this._originalEventObject=RightNow.Lang.cloneObject(a),this._collectSearchFilters(a),this._params.newPage=a.filters.newPage)},during:function(a){a instanceof RightNow.Event.EventObject&&this._collectSearchFilters(a)},post:function(){var a,b;if(this._excludedFilters)for(a=0;a<this._excludedFilters.length;a++)b=this._excludedFilters[a],this._respondingFilters&&!this._respondingFilters[b]&&(b=this._filters.allFilters[b])&&b.filters&&(b.filters.data[0]?b.filters.data[0]=null:b.filters.data=null);this.fire("send",this._filters,this._params)}})._addEventHandler("send",{pre:function(a){this._originalEventObject||(this._originalEventObject={filters:{page:1,newPage:!1}});this._eventCancelled=!1},during:function(a){!1===a&&(this._eventCancelled=!0)},post:function(a){this._eventCancelled||(this._excludedFilters=[],q.go(this._originalEventObject.filters,this._filters,this._params,this.searchSource,this))}})._addEventHandler("setInitialFilters",{post:function(a){this._setInitialFilters(a)}})._addEventHandler("appendFilter",{post:function(a){this._originalEventObject||(this._originalEventObject=RightNow.Lang.cloneObject(a));this._mergeFilters(a)}})._addEventHandler("excludeFilterFromNextSearch",{post:function(a){this._excludedFilters||(this._excludedFilters=[]);this._excludedFilters.push(a.data.name)}})._addEventHandler("reset").on("reset",function(){this._filters=RightNow.Lang.cloneObject(this._initialFilters);if(this._params&&this._filters&&this._filters.allFilters){var a=this._filters.allFilters;this._initialParams&&(this._params=RightNow.Lang.cloneObject(this._initialParams));this.Y.Object.each(this._params,function(b,c,d){a[c]&&a[c].filters&&"data"in a[c].filters&&(d[c]=a[c].filters.data)})}},this)}},clearCache:function(){l.enabled&&l.clearCache(this.searchSource.type+this.searchSource.id)},doesCacheExist:function(){return l.enabled?l.doesCacheExist(this.searchSource.type+this.searchSource.id):!1},_setFilters:function(c){this._filters=c},_setInitialFilters:function(c){c instanceof RightNow.Event.EventObject&&(this.Y.Object.isEmpty(c.filters)||(this._filters=c.filters,this._initialFilters=RightNow.Lang.cloneObject(c.filters)),this.Y.Object.isEmpty(c.data)||(this._params=c.data,this._initialParams=RightNow.Lang.cloneObject(c.data)))},_mergeFilters:function(c){this._filters.allFilters=this.Y.mix(this._filters.allFilters,c.filters,!0,null,0,!0)},_collectSearchFilters:function(c){c=new RightNow.Event.EventObject({instanceID:c.w_id},RightNow.Lang.cloneObject(c));c.filters.searchName?(this._respondingFilters||(this._respondingFilters={}),this._respondingFilters[c.filters.searchName]=!0,this._filters||(this._filters={}),this._filters.allFilters||(this._filters.allFilters={}),this._filters.allFilters[c.filters.searchName]=c):"generic"===this.searchSource.type&&(this._params=this.Y.mix(this._params||{},c.data,!0))}});f.prototype={_invoke:function(c,e,a,b){for(var f=0;f<this.sources.length;f++)this.sources[f][c](e,a,b);return this},on:function(c,e,a){return this._invoke("on",c,e,a)},fire:function(c,e,a){return this._invoke("fire",c,e,a)}};return{multipleSourcesWrapper:f,get:function(c){return"undefined"===typeof c?h:h[c]},add:function(c,e){if(c&&e instanceof k&&!h[c])return h[c]=e},getSearchSources:function(c,e){var a=c?(c+"").split(","):[],b=e?(e+"").split(","):[],f=[],d;for(d=0;d<a.length;d++)f.push({type:"report",id:a[d]});for(d=0;d<b.length;d++)f.push({type:"generic",id:b[d]});return{report:a,source:b,keys:f}},searchSource:k,findNamedSource:function(c,e){if(e){this.findNamedSource.findSource||(this.findNamedSource.findSource=function(a,b){if(b.multiple)for(var c=0;c<b.sources.length;c++){if(b.sources[c].instanceID===a)return b.sources[c]}else if(b.instanceID===a)return b});this.findNamedSource.warning||(this.findNamedSource.warning=function(a){RightNow.UI.DevelopmentHeader&&RightNow.UI.DevelopmentHeader.addJavascriptWarning(RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_D_SRCH_SRC_ID_RPT_ID_SRC_ID_LBL"),a))});var a=[],b=[];if("string"===typeof e||"number"===typeof e){e=(e+"").split(",");if(1<e.length){for(var g=0,d;g<e.length;g++)(d=this.findNamedSource.findSource(e[g],c))?a.push(d):b.push(e[g]);b.length&&this.findNamedSource.warning(b.join(", "));if(a.length)return 1<a.length?new f(a):a[0]}else if(a=this.findNamedSource.findSource(e[0],c))return a;!b.length&&this.findNamedSource.warning(e[0]);return c}if("object"===typeof e){for(g in e)e.hasOwnProperty(g)&&((d=this.findNamedSource.findSource(g,c))?(d=YUI().mix(d,e[g]),a.push(d)):b.push(g));b.length&&this.findNamedSource.warning(b.join(", "));if(a.length)return 1<a.length?new f(a):a[0]}}if(!c)throw Error("The widget extending from RightNow.SearchFilter doesn't have report_id or source_id attributes.");return c}}}();RightNow.SearchFilter=RightNow.Widgets.extend({constructor:function(){for(var f=m.getSearchSources(this.data.attrs.report_id,this.data.attrs.source_id),h=[],k=0,c,e;k<f.keys.length;k++)e=f.keys[k],c=m.get(e.type+e.id),c||(c=new m.searchSource(this.Y,e),m.add(e.type+e.id,c)),h.push(c);1<h.length&&(c=new m.multipleSourcesWrapper(h));this.searchSource=function(a){return m.findNamedSource(c,a)}}});RightNow.ResultsDisplay=RightNow.SearchFilter})();
RightNow.ProductCategory=RightNow.EventProvider.extend({initializeTreeView:function(a){this.dataType=a;this.displayField||(this.displayField=this.Y.one(this.baseSelector+"_"+this.dataType+"_Button"));this.buildPanel();this.Y.one(this.baseSelector+"_LinksTrigger").on("click",this.showAccessibleView,this);RightNow.Event.on("evt_accessibleTreeViewGetResponse",this.getAccessibleTreeViewResponse,this);RightNow.Event.on("evt_menuFilterGetResponse",this.getSubLevelResponse,this);this.data.js.hierData&&this.data.js.hierData[0]&&this.data.js.hierData[0].length&&this.buildTree()},buildPanel:function(){this.dropdown=new this.Y.RightNowTreeViewDropdown({srcNode:this.Y.one(this.baseSelector+"_TreeContainer").removeClass("rn_Hidden"),render:this.Y.one(this.baseSelector),trigger:this.displayField,visible:!1});this.dropdown.once("show",this.Y.bind(this.buildTree,this,!1));this.dropdown.on("show",function(){this.tree.focusOnSelectedNode()},this)},buildTree:function(a){if(!this.tree||a){this.tree&&this.tree.clear();this.data.js.linkingOn&&"Category"===this.dataType&&this.data.js.link_map[0]&&(this.data.js.hierData=this.data.js.link_map);this.tree=new this.Y.RightNowTreeView({hierarchyData:this.data.js.hierData,contentBox:this.Y.one(this.baseSelector+"_Tree").setStyles({"overflow-y":"auto",display:"block"})});this.tree.render();this.data.js.hierData&&this.data.js.hierDataNone&&delete this.data.js.hierData;this.tree.on("enterKey",this.selectNode,this);this.tree.on("dynamicNodeExpand",this.getSubLevelRequest,this);if(this.data.attrs.show_confirm_button_in_dialog)this.dropdown.set("confirmButton",this.Y.one(this.baseSelector+"_"+this.data.js.data_type+"_ConfirmButton")),this.dropdown.set("cancelButton",this.Y.one(this.baseSelector+"_"+this.data.js.data_type+"_CancelButton")),this.dropdown.on("confirm",function(){this.selectNode(this.tree.getFocusedNode())},this),this.Y.one(this.baseSelector+"_TreeContainer").setStyle("display","block");else this.tree.on("click",this.selectNode,this);this.tree.get("value")&&this.displaySelectedNodesAndClose(!1);this.dropdown.set("treeView",this.tree)}},pruneNonPermissionedAccessibleNodes:function(a){this.checkIdsAreValid("readableProdcatIds");if(0===this.data.js.readableProdcatIds.length)return a;var b=[];this.Y.Array.each(a,function(a){(this.checkPermissionsOnNode(a[1])||this.hasPermissionedAccessibleChildren(a))&&b.push(a)},this);return b},hasPermissionedAccessibleChildren:function(a){return this.checkForPermissionedChildren(a[1],a.level+1)},hasPermissionedChildren:function(a,b){return a.hasChildren?this.checkForPermissionedChildren(a.id,b):!1},checkForPermissionedChildren:function(a,b){if(!(this.data&&this.data.js&&this.data.js.readableProdcatIds&&this.Y.Lang.isArray(this.data.js.readableProdcatIds)))throw Error("Widget does not have this.data.js.readableProdcatIds attribute set, or its value is not an array");if(0===this.data.js.readableProdcatIds.length)return!0;var c="Level"+b;return this.Y.Array.some(this.data.js.permissionedProdcatList,function(b){if(b[c]===a&&b.ID!==a)return!0},this)},checkPermissionsOnNode:function(a){var b=this.data.js.permissionedProdcatIds&&this.Y.Lang.isArray(this.data.js.permissionedProdcatIds),c=this.data.js.readableProdcatIds&&this.Y.Lang.isArray(this.data.js.readableProdcatIds);if(!b&&!c)throw Error("Widget has neither this.data.js.readableProdcatIds or this.data.js.permissionedProdcatIds set, or their values are not an array.");return b&&0===this.data.js.permissionedProdcatIds.length||c&&0===this.data.js.readableProdcatIds.length?!0:b?this.isPermissionedNode(a):this.isReadableNode(a)},isPermissionedNode:function(a){return this.userHasFullProdcatPermissions()?!0:-1!==this.Y.Array.indexOf(this.data.js.permissionedProdcatIds,parseInt(a,10))},userHasFullProdcatPermissions:function(){this.checkIdsAreValid("permissionedProdcatIds");return"None"===this.data.attrs.verify_permissions||0===this.data.js.permissionedProdcatIds.length},isReadableNode:function(a){this.checkIdsAreValid("readableProdcatIds");return 0===this.data.js.readableProdcatIds.length?!0:-1!==this.Y.Array.indexOf(this.data.js.readableProdcatIds,parseInt(a,10))},disableNonPermissionedAccessibleNodes:function(a){this.checkIdsAreValid("readableProdcatIds");if(0!==this.data.js.readableProdcatIds.length&&this.data.attrs.label_selection_not_valid){var b;this.Y.Array.each(a,function(a){this.checkPermissionsOnNode(a[1])||(b=this.Y.one(this.baseSelector+"_AccessibleLink_"+a[1]),b.setHTML(RightNow.Text.sprintf(this.data.attrs.label_selection_not_valid,b.getHTML())))},this)}},disableNonPermissionedNodes:function(a){this.checkIdsAreValid("readableProdcatIds");0!==this.data.js.readableProdcatIds.length&&this.Y.Array.each(a,function(a){this.checkPermissionsOnNode(a.id)||this.Y.one("#ygtvlabelel"+this.tree.getNodeByValue(a.id).index).addClass("rn_Disabled")},this)},onAccessibleLinkClick:function(a){var b=a.valueChain[a.valueChain.length-1];this.tree.expandAndCreateNodes(a.valueChain);this.checkPermissionsOnNode(b)&&this.dialog.hide()},showAccessibleView:function(a){a.halt();this._eo||(this._eo=new RightNow.Event.EventObject(this));"Category"===this.dataType&&this.data.js.linkingOn&&(this._eo.data.linkingProduct=RightNow.UI.Form.currentProduct);this.dialog?this.displayAccessibleDialog():RightNow.Event.fire("evt_accessibleTreeViewRequest",this._eo)},getAccessibleTreeViewResponse:function(a,b){b=b[0];if(b.w_id===this._eo.w_id&&b.data.hm_type===this._eo.data.hm_type){var c=b.data.accessibleLinks;if("prod_chain"in c){c=[];delete b.data.accessibleLinks.prod_chain;for(var d in b.data.accessibleLinks)c.push(b.data.accessibleLinks[d])}c.unshift({0:this.data.attrs.label_all_values,1:0,hier_list:0,level:0});c=this.pruneNonPermissionedAccessibleNodes(c);this.createAccessibleDialog(c);this.buildTree();this.displayAccessibleDialog();this.disableNonPermissionedAccessibleNodes(c)}},createAccessibleDialog:function(a){this.dialog&&this.dialog.destroy();var b="Product"===this.dataType?RightNow.Interface.getMessage("SELECT_BELOW_USING_LINKS_PROVIDED_MSG"):RightNow.Interface.getMessage("CATEGORY_BELOW_USING_LINKS_PROVIDED_MSG"),c=RightNow.Interface.getMessage("DEPTH_ANNOUNCED_NAVIGATE_THROUGH_LIST_MSG");this.dialog=new this.Y.RightNowTreeViewDialog({id:"rn_"+this.instanceID,hierarchyData:a,contentBox:this.Y.one(this.baseSelector+"_Links"),dismissLabel:RightNow.Interface.getMessage("CANCEL_CMD"),titleLabel:this.data.attrs.label_nothing_selected,introLabel:b+" "+c,selectionPlaceholderLabel:RightNow.Interface.getMessage("SELECTION_PCT_S_ACTIVATE_LINK_JUMP_MSG"),levelLabel:this.data.attrs.label_level,noItemSelectedLabel:this.data.attrs.label_all_values});this.dialog.on("selectionMade",this.onAccessibleLinkClick,this);this.dialog.render()},displayAccessibleDialog:function(){this.dialog.set("selectedValue",this.tree.get("value"));this.dialog.set("selectedLabels",this.tree.get("labelChain"));this.dialog.show();var a=this.Y.one("p.rn_Intro a");a&&a.focus()},displaySelectedNodesAndClose:function(a){this._eo||(this._eo=new RightNow.Event.EventObject(this));this._eo.data.hierChain=this.tree.get("valueChain");RightNow.Event.fire("evt_productCategoryFilterSelected",this._eo);delete this._eo.data.hierChain;var b=this.tree.get("valueChain"),c=this.data.attrs.label_nothing_selected,d=this.data.attrs.label_nothing_selected;this.dropdown.hide();b[0]&&(c=this.tree.get("labelChain").join("<br>"),d=this.data.attrs.label_screen_reader_selected+c);this.dropdown.set("triggerText",c);this.Y.all(this.baseSelector+"_TreeDescription").setHTML(d);if(a&&!this.dialog)try{this.dropdown.get("trigger").focus()}catch(e){}},selectNode:function(a){this.displaySelectedNodesAndClose(!0)},getSubLevelRequest:function(a){if(!this._nodeBeingExpanded){this._nodeBeingExpanded=!0;if(a=this.getSubLevelRequestEventObject(a))"Product"===this.dataType&&(RightNow.UI.Form.currentProduct=a.data.value),this._requesting=a.data.value,RightNow.Event.fire("evt_menuFilterRequest",a);this._nodeBeingExpanded=!1;this._eo.data.link_map&&delete this._eo.data.link_map}},getSubLevelRequestEventObject:function(a){return new RightNow.Event.EventObject(this,{data:{level:a.depth+1,value:a.value,label:a.label,cache:{}}})},getSubLevelResponse:function(a,b){this.data.js.link_map&&delete this.data.js.link_map;var c=a.data.level,d=a.data.hier_data,e,d=this.groomProdcats(d);this.buildTree();!a.data.reset_linked_category&&this.getSubLevelRequestEventObject._origRequest&&this.getSubLevelRequestEventObject._origRequest[b]?e=this.getSubLevelRequestEventObject._origRequest[b]:a.data.reset_linked_category&&(this.tree.clear(this.data.attrs.label_all_values),this.dialog=null,this.selectNode(this.tree.getRoot()));7>c&&this.insertChildrenForNode(d,e);0===d.length&&this.displaySelectedNodesAndClose()},insertChildrenForNode:function(a,b){this.tree.insertChildHierarchyData(a,b)},removeNonReadableProdcats:function(a){this.checkIdsAreValid("readableProdcatIds");var b=this.data;return this.Y.Array.filter(a,function(a){if(-1!==this.Y.Array.indexOf(b.js.readableProdcatIds,a.id))return a},this)},updateProdcatsHasChildrenAttribute:function(a){this.checkIdsAreValid("readableProdcatIdsWithChildren");var b=this.data;return this.Y.Array.map(a,function(a){a.hasChildren=-1!==this.Y.Array.indexOf(b.js.readableProdcatIdsWithChildren,a.id)?!0:!1;return a},this)},groomProdcats:function(a){!1!==this.data.attrs.verify_permissions&&"None"!==this.data.attrs.verify_permissions&&0<this.data.js.readableProdcatIds.length&&(a=this.removeNonReadableProdcats(a),a=this.updateProdcatsHasChildrenAttribute(a));return a},checkIdsAreValid:function(a){if(!(this.data&&this.data.js&&this.data.js[a]&&this.Y.Lang.isArray(this.data.js[a])))throw Error("Widget does not have this.data.js."+a+" attribute set, or its value is not an array");}});
RightNow.Field=RightNow.Field||RightNow.EventProvider.extend({overrides:{constructor:function(){this.parent();this.data.js.name&&(this._fieldName=this.data.js.name,this._inputSelector=this.baseSelector+"_"+this._fieldName.replace(/\./g,"\\."),this.parentForm().addField(this._fieldName,this),this._addEventHandler("change"),this._addEventHandler("constraintChange",{post:function(){this.parentForm().fire("formUpdated")}}),this.parentForm().on("collect",this.onCollect,this));this.excludeFromValidation=this.data.attrs.hide_on_load||!1}},setConstraints:function(a){this.Y.Object.each({required:function(a){return"false"===a?!1:!!a},required_lvl:function(a){return parseInt(a,10)},min_required_attachments:function(a){return parseInt(a,10)}},function(b,c){a[c]&&(a[c]=b(a[c]))});this.fire("constraintChange",a);this.Y.Object.each(a,function(a,c){this.fire("constraintChange:"+c,{constraint:a})},this);this.parentForm().fire("formUpdated")},onCollect:function(){return this.isVisible()?this._fieldName:!1},isVisible:function(){return!this.excludeFromValidation},hide:function(){RightNow.UI.hide(this.baseSelector);this.excludeFromValidation=!0;var a=this.Y.one("#"+this.lastErrorLocation);this.lastErrorLocation&&a&&a.all("[data-field='"+this._fieldName+"']").remove();this.parentForm().fire("formUpdated")},show:function(){RightNow.UI.show(this.baseSelector);this.excludeFromValidation=!1;this.parentForm().fire("formUpdated")},getFieldName:function(){return this._fieldName},parentForm:function(a){return RightNow.Form.find(a||this.baseDomID,this.instanceID)},getParentFormID:function(){return RightNow.Form.find(this.baseDomID,this.instanceID,!0)},createEventObject:function(){return new RightNow.Event.EventObject(this,{data:{name:this.data.js.name,value:this.getValue(),required:this._isRequired(),form:this._parentForm}})},is:function(a){var b=this.data.js.type;return"text"===a?"Integer"===b||"String"===b||"Thread"===b:"selection"===a?"Boolean"===b||"NamedIDLabel"===b||"Country"===b||"StateOrProvince"===b:"date"===a?"Date"===b||"DateTime"===b:"email"===a?this.isCommonEmailType()||!0===this.data.js.email:"url"===a?this.data.js.url?!0:!1:"product"===a?"ServiceProduct"===b:"category"===a?"ServiceCategory"===b:"attachment"===a?"FileAttachmentIncident"===b:"password"===a?"Contact.NewPassword"===this._fieldName||"Contact.NewPassword_Validate"===this._fieldName:!1},isCommonEmailType:function(){return"Contact.Emails.PRIMARY.Address"===this._fieldName||"Contact.Emails.ALT1.Address"===this._fieldName||"Contact.Emails.ALT2.Address"===this._fieldName||"Incident.CustomFields.c.alternateemail"===this._fieldName},_isRadio:function(){var a=this.input.get("type");return this.Y.Lang.isArray(a)&&"radio"===a[0]},_reportError:function(a){this._errors=this._errors||[];this._errors.push(a)},validate:function(a,b){this._errors=a||[];this._value="undefined"!==typeof b?b:this.getValue();this._checkRequired();this._checkValue();this.is("email")?this._errors.length||this._checkEmail():this.is("url")?this._errors.length||this._checkUrl():this._checkData();return!this._errors.length},_checkValue:function(){var a,b,c;if("Integer"===this.data.js.type){if(""!==this._value&&"number"!==typeof this._value)return this._reportError(RightNow.Interface.getMessage("VALUE_MUST_BE_AN_INTEGER_MSG"));a=parseInt(this._value,10);b=parseInt(this.data.js.constraints.maxValue,10);c=parseInt(this.data.js.constraints.minValue,10);if(this.Y.Lang.isNumber(b)&&a>b)return this._reportError(RightNow.Interface.getMessage("VALUE_IS_TOO_LARGE_MAX_VALUE_MSG")+b+")");if(this.Y.Lang.isNumber(c)&&a<c)return this._reportError(RightNow.Interface.getMessage("VALUE_IS_TOO_SMALL_MIN_VALUE_MSG")+c+")")}else if("Contact.NewPassword"===this.data.js.name&&this.data.js.passwordLength&&(a=RightNow.Text.Encoding.utf8Length(this._value),b=this.data.js.passwordLength,a<b))return this._reportError(RightNow.Text.sprintf(1===b-a?RightNow.Interface.getMessage("CONTAIN_1_CHARACTER_MSG"):RightNow.Interface.getMessage("PCT_D_CHARACTERS_MSG"),b));if(null!==this._value&&(this.data.js.constraints.maxLength||this.data.js.constraints.minLength)){a=this._value.length;c=this.data.js.constraints.maxLength;b=this.data.js.constraints.minLength;if(c&&c<a)return this._reportError(RightNow.Text.sprintf(1===a-c?RightNow.Interface.getMessage("EXCEEDS_SZ_LIMIT_PCT_D_CHARS_1_LBL"):RightNow.Interface.getMessage("EXCEEDS_SZ_LIMIT_PCT_D_CHARS_PCT_D_LBL"),c,a-c));if(b&&b>a)return this._reportError(RightNow.Text.sprintf(1===b-a?RightNow.Interface.getMessage("CONTAIN_1_CHARACTER_MSG"):RightNow.Interface.getMessage("PCT_D_CHARACTERS_MSG"),b))}},_checkData:function(){if(null!==this._value&&""!==this._value){var a=this.data.js.constraints?this.data.js.constraints.regex:null;if(RightNow.Text.beginsWith(this._fieldName,"Contact.Phones.")||"Contact.Address.PostalCode"===this._fieldName){if(!/^[-A-Za-z0-9,# +.()]+$/.test(this._value))return this._reportError("Contact.Address.PostalCode"===this._fieldName?RightNow.Interface.getMessage("PCT_S_IS_AN_INVALID_POSTAL_CODE_MSG"):RightNow.Interface.getMessage("PCT_S_IS_AN_INVALID_PHONE_NUMBER_MSG"))}else{if(a&&!(new RegExp(a)).test(this._value))return this._reportError("Contact.Login"===this._fieldName?RightNow.Interface.getMessage("PCT_S_CONT_SPACES_DOUBLE_QUOTES_LBL"):RightNow.Interface.getMessage("PCT_S_DIDNT_MATCH_EXPECTED_INPUT_LBL"));if(this.data.js.channelID&&/\s/.test(this._value))return this._reportError(RightNow.Interface.getMessage("CONTAIN_SPACES_PLEASE_TRY_MSG"))}}},_checkEmail:function(){if(this._value)if("Incident.CustomFields.c.alternateemail"===this._fieldName)for(var a=0,b=this._value.split(/[,;]+/),c;a<b.length;a++)(c=this.Y.Lang.trim(b[a]))&&!RightNow.Text.isValidEmailAddress(c)&&this._reportError(RightNow.Interface.getMessage("PCT_S_IS_INVALID_MSG"));else RightNow.Text.isValidEmailAddress(this._value)||this._reportError(RightNow.Interface.getMessage("PCT_S_IS_INVALID_MSG"))},_checkUrl:function(){null===this._value||""===this._value||RightNow.Text.isValidUrl(this._value)||this._reportError(RightNow.Interface.getMessage("IS_NOT_A_VALID_URL_MSG"))},_isRequired:function(){return this.is("product")||this.is("category")?this.data.attrs.required_lvl&&0<this.data.attrs.required_lvl||!1:this.is("attachment")?this.data.attrs.min_required_attachments&&0<this.data.attrs.min_required_attachments||!1:this.data.attrs.required?!0:!1},_checkRequired:function(){var a=!1;if(this._isRequired())if(this.is("date"))a=!/\d/.test(this._value);else if(""===this._value||!1===this._value||null===this._value)a=!0;a&&this._reportError(this.data.attrs.label_required);return a},getValue:function(){var a;if(this.is("selection"))this.input.size&&this._isRadio()?(a="",this.input.item(0).get("checked")?a=this.input.item(0).get("value"):this.input.item(1).get("checked")&&(a=this.input.item(1).get("value"))):a="checkbox"===this.input.get("type")?this.input.get("checked"):this.input.get("value");else if(this.is("date")){a="";var b={day:32,month:13,year:1900,hour:0,minute:0};this.input.each(function(a){var e=a.get("name").toLowerCase();this.Y.Object.each(b,function(f,d){null!==e.match(new RegExp(d+"$"))&&(b[d]=parseInt(a.get("value"),10))})},this);a=1900<b.year?b.year+"-"+b.month+"-"+b.day+" "+b.hour+":"+b.minute+":00":""}else this.is("product")||this.is("category")?a=this._selectedNode?this._selectedNode.hierValue||0:this._currentValue||0:this.input&&!this.is("attachment")&&(a=this._getTextFieldValue(this.input));return a},politeFocus:function(a){a&&(this.Y.all("[role=alert], [aria-live=assertive]").some(function(a){return!a.hasClass("rn_Hidden")&&(a.get("textContent")||a.get("innerText"))},this)||a.focus())},_getTextFieldValue:function(a){if(!a)return null;this._trimField(a);a=a.get("value");"Integer"===this.data.js.type?a=a&&!isNaN(Number(a))&&parseInt(a,10)===parseFloat(a)?parseInt(a,10):a:this.is("text")&&!this.is("password")&&""===a&&(a=null);return a},_trimField:function(a){a=a||this.input;if(this.is("text")&&!this.is("password")){var b=a.get("value");this.Y.Lang.isUndefined(b)||""===b||a.set("value",this.Y.Lang.trim(b))}},_initializeHint:function(){if(!this.data.attrs.always_show_hint)if(this.Y.Overlay){var a=this.Y.Node.create("<span id='"+this.baseDomID+"_Hint' aria-hidden='true'>"+this.data.attrs.hint+"</span>"),b={node:this.baseSelector,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.BL]};this.data.info&&"RightNow.Widgets.SelectionInput"===this.data.info.class_name&&"Boolean"!==this.data.js.type?(a.addClass("rn_HintBoxRight"),b.node=this.Y.one(this.baseSelector+" select"),b.points=[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.TR]):a.addClass("rn_HintBox");a=new this.Y.Overlay({bodyContent:a,visible:!1,zIndex:3,align:b});if(this.Y.UA.webkit&&("checkbox"===this.input.get("type")||this._isRadio())){for(var c=this.input instanceof this.Y.NodeList?this.input.item(this.input.size()-1):this.input;c.next();)c=c.next();this.input.on("click",function(){c.focus();a.show()})}else this.input.on("focus",function(){a.show()});this.input.on("blur",function(){a.hide()});a.render(this.baseSelector)}else this.input.get("parentNode").append(this.Y.Node.create("<span class='rn_HintText' aria-hidden='true'>"+this.data.attrs.hint+"</span>"))}},{requires:{standard:["overlay"]}});
RightNow.Avatar=RightNow.Widgets.extend({constructor:function(){var d=new EJS({text:'<span class="rn_UserAvatar" title="<%= displayName %>"><span class="rn_Avatar <%= (className ? className : "rn_Medium") %> <%= (avatarUrl) ? "rn_Image" : "rn_Placeholder" %>"><% if(avatarUrl){%><img itemprop="image" src="<%= avatarUrl %>" height="<%= size %>" width="<%= size %>" alt=""/><%}else{%><span class="rn_Default rn_DefaultColor<%= color %>" aria-hidden="true" role="presentation"><span class="rn_Liner"><%= text %></span></span><%}%></span></span>'});EJS.Helpers.prototype.getDefaultAvatar=function(a){var b="?",c=0;a.displayName=RightNow.Text.stripTags(a.displayName);a.displayName&&(b=a.isActive?a.displayName.charAt(0).toUpperCase():"!",c=a.displayName.length);a.color=a.isActive?c%5:5;a.text=b;a.userID?a.isActive||(a.displayName=RightNow.Interface.getMessage("INACTIVE_LC_LBL")):a.displayName=RightNow.Interface.getMessage("UNKNOWN_LWR_LBL");return d.render(a)}}});
(function(){var l=function(){var b={},a={},f={};return{getDeferred:function(k,d){if(b[k])return b[k];a[d]=a[d]||{events:[]};a[d].form=k;return{on:function(b,c,h){if(c&&"function"===typeof c)return a[d].events.push({name:b,handler:c,context:h}),this;throw Error("Handler specified isn't a callable function");},addField:function(a,c){if(a&&c&&"object"===typeof c)f[k]||(f[k]={}),f[k][a]=c;else throw Error("A non-object field cannot be added to a form");}}},getInstance:function(a){return b[a]},newInstance:function(a,d){d instanceof RightNow.Form&&(b[a]=d)},getDeferredEvents:function(b){var d,e,c={};for(d in a)if(e=a[d],a.hasOwnProperty(d)&&e.form===b&&e.events.length){e=e.events;for(var h=0;h<e.length;h++)c[e[h].name]=c[e[h].name]||[],c[e[h].name].push(e[h])}return c},getDeferredFields:function(a){return f[a]}}}(),g=function(){function b(c,a,b,d){var e={},f=c.getAttribute("target");c.all("input, select, textarea").each(function(c){var a=c.get("type");""!==c.get("name")&&"submit"!==a&&"image"!==a&&(e[c.get("name")]=c.get("value"))});c=a+RightNow.Url.convertToSegment(e)+b;RightNow.Url.getSession()&&(c=RightNow.Url.addParameter(c,"session",RightNow.Url.getSession()));c=d.Y.Node.create("<a class='rn_Hidden'>form</a>").setAttribute("href",c);f&&c.setAttribute("target",f);d.Y.one(document.body).append(c);c=d.Y.Node.getDOMNode(c);document.createEvent?(d=document.createEvent("MouseEvents"),d.initEvent("click",!1,!1),c.dispatchEvent(d)):c.fireEvent("onclick")}function a(c){this.fire("response",new RightNow.Event.EventObject(this,{data:c}))}function f(c){this.fire("responseError",new RightNow.Event.EventObject(this,{data:c}))}function k(c,h,b){if(RightNow.Event.noSessionCookies())for(var d=0,e=b.length;d<e;d++)if("Contact.Login"===b[d].name){document.cookie="cp_login_start=1;path=/";break}b=RightNow.JSON.stringify(b);var k={form:b,updateIDs:RightNow.JSON.stringify({asset_id:RightNow.Url.getParameter("asset_id"),qid:RightNow.Url.getParameter("qid"),product_id:RightNow.Url.getParameter("product_id"),serial_no:RightNow.Url.getParameter("serial_no"),i_id:RightNow.Url.getParameter("i_id"),user_id:RightNow.Url.getParameter("user")})},g={scope:h,json:!0,successHandler:a,failureHandler:f};b=RightNow.UI.Form;null!=b.smartAssistant&&(k.smrt_asst=b.smartAssistant);null!==b.smartAssistantToken&&(k.saToken=b.smartAssistantToken);h.data.attrs.flash_message&&(k.flash_message=h.data.attrs.flash_message);h._originalEventObject&&(h._originalEventObject.data.timeout&&(g.timeout=h._originalEventObject.data.timeout),g=function(c,a){var b=["challengeHandler","challengeHandlerContext"],h,d;for(h=0;h<b.length;++h)d=b[h],c[d]=a[d]||void 0;return c}(g,h._originalEventObject));RightNow.Form.formToken.onNewToken(function(a){k.f_tok=a;RightNow.Ajax.makeRequest(c,k,g)})}var d={},e={};return{submitForm:function(c,a,d){var f=d.Y.one("#"+c),g=f.getAttribute("method"),m=f.getAttribute("action");c=e[c];a=a||"";if(m&&!d.data.attrs.on_success_url)if("post"===g.toLowerCase()||!RightNow.Text.beginsWith(m,"/")&&RightNow.Url.isExternalUrl(m)){a&&f.set("action",m+a);for(a=0;a<c.length;a++)(g=c[a])&&g.value&&((m=f.one('input[name="'+g.name+'"]')||f.one('textarea[name="'+g.name+'"]'))?m.set("value",g.value):f.append(d.Y.Node.create('<input type="hidden" name="'+g.name+'" value="'+d.Y.Escape.html(g.value)+'"/>')));f.submit()}else b(f,m,a,d);else k((m||"/ci/ajaxRequest/sendForm")+a,d,c)},resetValidatedFields:function(a){e[a]=[]},addValidatedField:function(a,b){e[a]||this.resetFormFields(a);delete b.data.form;e[a].push(b.data)},getValidatedFields:function(a){return RightNow.Lang.cloneObject(e[a])},addField:function(a,b,f){d[a]||(d[a]={});d[a][b]=f},findField:function(a,b){return d[a][b]},getAllFields:function(a){return d[a]||{}}}}();RightNow.Form=RightNow.EventProvider.extend({overrides:{constructor:function(){this.parent();this._challengeDivID=this.data.attrs.challenge_location;this._parentForm=RightNow.UI.findParentForm(this.baseSelector);this.Y.one("#"+this._parentForm).on("submit",function(a){a.halt()});this._errorMessageDiv=this.Y.one("#"+this.data.attrs.error_location);this._formButton=this.Y.one(this.baseSelector+"_Button");this._errorMessageDiv||(this._errorMessageDiv=this.Y.Node.create("<div id='rn_"+this.instanceID+"_ErrorLocation'>"),this._formButton.insert(this._errorMessageDiv,"before"));if(this._parentForm){if(l.getInstance(this._parentForm))throw Error("Can't have two different FormSubmits for a single form");l.newInstance(this._parentForm,this)}else throw RightNow.UI.addDevelopmentHeaderError(RightNow.Interface.getMessage("FORMSUBMIT_PLACED_FORM_UNIQUE_ID_MSG")),Error("An inappropriate form was specified");this._events=l.getDeferredEvents(this._parentForm);this.Y.Object.each(l.getDeferredFields(this._parentForm),function(a,b){g.addField(this._parentForm,b,a)},this);this._widgetInstantiationComplete=RightNow.Widgets.isWidgetInstantiationComplete();if(!this._widgetInstantiationComplete)RightNow.Event.on("evt_WidgetInstantiationComplete",function(){this._widgetInstantiationComplete=!0},this);this._addSubscribersFilter("submit",this._filterSubmittedWidgets,this);this._addEventHandler("submit",{pre:function(a){RightNow.Form.formToken.requestNewToken();g.resetValidatedFields(this._parentForm);this._challengeDivID&&(a.challengeHandler=RightNow.Event.createDelegate(this,this._challengeHandler));this._originalEventObject=a},during:function(a){!1===a?this._eventCanceled=!0:a instanceof RightNow.Event.EventObject&&g.addValidatedField(this._parentForm,a)},post:function(a){var b=this._eventCanceled?"fail":"pass";this._eventCanceled=!1;this.fire("validation:"+b,a)}})._addEventHandler("send",{post:function(a){this._eventCanceled||g.submitForm(this._parentForm,this.data.attrs.add_params_to_url,this);this._eventCanceled=!1},during:function(a){!1===a&&(this._eventCanceled=!0)}})._addEventHandler("collect",{pre:function(){this._collectedFields=[]},during:function(a){a&&this._collectedFields.push(a)},post:function(a){this.fire("submit",a)}})._addEventHandler("formUpdated");if(this.data.js.challengeProvider){try{this._challengeProvider=eval(this.data.js.challengeProvider)}catch(b){throw"Failed while trying to parse a challenge provider.  "+b;}this._createChallengeDiv();this._challengeProvider.create(this._challengeDivID,RightNow.UI.AbuseDetection.options);this.on("submit",this._onValidateChallengeResponse,this)}if(!this.data.js.f_tok)throw Error("This widget is required to have a `f_tok` form submission token");RightNow.Form.formToken.init(this.data.js.f_tok,this.data.js.formExpiration)}},_filterSubmittedWidgets:function(b){var a=g.getAllFields(this._parentForm),f=[];this.Y.Object.each(a,function(a,d){this.Y.Array.each(b,function(b,c){b.context===a&&-1===this.Y.Array.indexOf(this._collectedFields,d)&&f.push(c)},this)},this);return f},getValidatedFields:function(){return g.getValidatedFields(this._parentForm)},addField:function(b,a){g.addField(this._parentForm,b,a)},findField:function(b){if(!this._widgetInstantiationComplete)throw Error("Widget instantiation has not completed. This method can only be used after all widgets are constructed");return g.findField(this._parentForm,b)},hide:function(){RightNow.UI.hide(this._formButton)},show:function(){RightNow.UI.show(this._formButton)},disable:function(){this._formButton.set("disabled",!0)},enable:function(){this._formButton.set("disabled",!1)},_createChallengeDiv:function(){this.Y.one("#"+this._challengeDivID)||this._formButton.insert(this.Y.Node.create("<div id='"+this._challengeDivID+"' tabindex='-1'>"),"before")},_reportChallengeError:function(b){b=b||RightNow.Interface.getMessage("PLS_VERIFY_REQ_ENTERING_TEXT_IMG_MSG");this._errorMessageDiv.append("<div><b><a id ='rn_ChallengeErrorLink' href='javascript:void(0);'>"+b+"</a></b></div>");this.Y.one("#rn_ChallengeErrorLink").on("click",RightNow.Event.createDelegate(this,function(){this._challengeProvider.focus(this._challengeDivID);return!1}))},_challengeHandler:function(b,a,f){this._createChallengeDiv();this._challengeProvider||(this._challengeProvider=RightNow.UI.AbuseDetection.getChallengeProvider(b),this.on("submit",this._onValidateChallengeResponse,this),this._challengeProvider.create(this._challengeDivID,RightNow.UI.AbuseDetection.options));this._reportChallengeError(RightNow.UI.AbuseDetection.getDialogCaption(b));this.fire("validation:fail")},_onValidateChallengeResponse:function(){new RightNow.Event.EventObject(this,{data:{form:!1}});var b=this._challengeProvider.getInputs(this._challengeDivID);if(b.abuse_challenge_response)for(var a in b)b.hasOwnProperty(a)&&RightNow.Ajax.addRequestData(a,b[a])}},{find:function(b,a,f){if(b=RightNow.UI.findParentForm(b))return f?b:l.getDeferred(b,a);throw Error("You're using a form that doesn't have a proper form submit button or an id");},formToken:function(){function b(b,h){var e=h[0];if(e.data.newToken&&(!e.w_id||"RightNow.Form"===e.w_id)){a=e.data.newToken;e=f;g=(new Date).getTime()+e;for(var e=0,l=d.length,n;e<l;e++)n=d[e],n.callback.call(n.context,a);d=[]}}var a,f,g,d=[],e;return{init:function(c,d){a=c;var l=f=d;g=(new Date).getTime()+l;e||(RightNow.Event.on("evt_formTokenUpdate",b),e=!0)},requestNewToken:function(){(new Date).getTime()>=g&&RightNow.Event.fire("evt_formTokenRequest",new RightNow.Event.EventObject({instanceID:"RightNow.Form"},{data:{formToken:a}}))},onNewToken:function(b,e){(new Date).getTime()>=g?d.push({callback:b,context:e}):setTimeout(function(){b.call(e,a)},1)}}}()})})();
RightNow.Widgets.ResultInfo=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._searchSources=0;if(this.data.attrs.display_knowledgebase_results){this.searchSource(this.data.attrs.report_id).on('response',this._onReportChanged,this);}
if(this.data.attrs.combined_results){this._searchTerm=this.data.js.searchTerm;if(this.data.js.social){if(this.data.js.social){this._searchSources++;}
this.searchSource(this.data.attrs.source_id).on('response',this._reportCombinedResults,this);}
this.searchSource().on('appendFilter',function(evt,args){if(args[0].filters.page&&args[0].data){this._page=args[0].data.page;}},this);this.searchSource(this.data.attrs.report_id).on('send',this._watchSearchFilterChange,this);}
if(this.data.js.error){RightNow.UI.Dialog.messageDialog(this.data.js.error,{"icon":"WARN"});}}},_onReportChanged:function(type,args)
{var newData=args[0].data,resultQuery="",parameterList=(this.data.attrs.add_params_to_url)?RightNow.Url.buildUrlLinkString(args[0].filters.allFilters,this.data.attrs.add_params_to_url):'';this._determineNewResults(args[0]);if(!this.data.attrs.combined_results&&this.data.attrs.display_results&&newData.search_term)
{var stopWords=newData.stopword,noDictWords=newData.not_dict,searchTerms=newData.search_term.split(" "),displayedNoResultsMsg=false;for(var i=0,word,strippedWord;i<searchTerms.length;i++)
{word=searchTerms[i];strippedWord=word.replace(/\W/,"");if(stopWords&&strippedWord&&stopWords.indexOf(strippedWord)!==-1)
word="<span class='rn_Strike' title='"+this.data.attrs.label_common+"'>"+word+"</span>";else if(noDictWords&&strippedWord&&noDictWords.indexOf(strippedWord)!==-1)
word="<span class='rn_Strike' title='"+this.data.attrs.label_dictionary+"'>"+word+"</span>";else
word="<a href='"+RightNow.Url.addParameter(this.data.js.linkUrl+encodeURIComponent(word.replace(/\&amp;/g,"&"))+parameterList+"/search/1","session",RightNow.Url.getSession())+"'>"+word+"</a>";resultQuery+=word+" ";}
resultQuery=this.Y.Lang.trim(resultQuery);}
var suggestedDiv=this.Y.one(this.baseSelector+"_Suggestion");if(suggestedDiv)
{if(newData.ss_data)
{var links=this.data.attrs.label_suggestion+" <ul>";for(var i=0;i<newData.ss_data.length;i++)
links+='<li><a href="'+this.data.js.linkUrl+newData.ss_data[i]+'/suggested/1'+parameterList+'">'+newData.ss_data[i]+'</a></li>';links+="</ul>";suggestedDiv.set('innerHTML',links).removeClass('rn_Hidden');}
else
{RightNow.UI.hide(suggestedDiv);}}
var spellingDiv=this.Y.one(this.baseSelector+"_Spell");if(spellingDiv)
{if(newData.spelling)
{spellingDiv.set('innerHTML',this.data.attrs.label_spell+' <a href="'+this.data.js.linkUrl+newData.spelling+'/dym/1/'+parameterList+'">'+newData.spelling+' </a>').removeClass('rn_Hidden');}
else
{RightNow.UI.hide(spellingDiv);}}
if(!(newData.data!==undefined&&newData.data.length!==undefined&&newData.data.length=='0'&&RightNow.Url.getParameter('page')!=='1'))
this._updateSearchResults({searchTermToDisplay:resultQuery,userSearchedOn:newData.search_term,topics:newData.topics,truncated:newData.truncated});if(!this.data.attrs.combined_results)
{this.data.js.totalResults=0;this.data.js.firstResult=0;this.data.js.lastResult=0;}},_updateSearchResults:function(options)
{options=options||{};var noResultsDiv=this.Y.one(this.baseSelector+"_NoResults"),resultsDiv=this.Y.one(this.baseSelector+"_Results"),searchTermToDisplay=options.searchTermToDisplay,displayedNoResultsMsg=false;if(noResultsDiv)
{if(this.data.js.totalResults===0&&options.userSearchedOn&&(!options.topics||options.topics.length===0))
{noResultsDiv.set('innerHTML',this.data.attrs.label_no_results+"<br/><br/>"+this.data.attrs.label_no_results_suggestions).removeClass('rn_Hidden');displayedNoResultsMsg=true;}
else
{RightNow.UI.hide(noResultsDiv);}}
if(resultsDiv)
{if(!displayedNoResultsMsg&&!options.truncated)
{resultsDiv.set('innerHTML',(searchTermToDisplay&&searchTermToDisplay.length>0)?RightNow.Text.sprintf(this.data.attrs.label_results_search_query,this.data.js.firstResult,this.data.js.lastResult,this.data.js.totalResults,searchTermToDisplay):RightNow.Text.sprintf(this.data.attrs.label_results,this.data.js.firstResult,this.data.js.lastResult,this.data.js.totalResults));RightNow.UI.show(resultsDiv);}
else
{RightNow.UI.hide(resultsDiv);}}},_determineNewResults:function(eventObject){var reportData=eventObject.data;if(this.data.attrs.combined_results){if(this.data.js.totalResults===0||this.data.js.totalResults===this.data.js.combinedResults){this.data.js.totalResults+=reportData.total_num;}
if(typeof reportData.pruned==="number"){this.data.js.totalResults-=reportData.pruned;}
if(typeof this.data.js.prunedAnswers==="number"&&!reportData.pruned){reportData.start_num-=this.data.js.prunedAnswers;reportData.end_num-=this.data.js.prunedAnswers;reportData.pruned=true;}}
else{this.data.js.totalResults=reportData.total_num;}
this.data.js.firstResult=reportData.start_num;if(reportData.page!==1){this.data.js.firstResult+=this.data.js.combinedResults;}
if(this.data.js.firstResult===0&&this.data.js.combinedResults!==0){this.data.js.firstResult=1;}
this.data.js.lastResult=reportData.end_num+this.data.js.combinedResults;this._page=reportData.page;if(reportData.pruned&&eventObject.w_id&&eventObject.w_id.indexOf("CombinedSearchResults")>-1){this.data.js.prunedAnswers=(this.data.js.prunedAnswers===reportData.pruned)?false:reportData.pruned;}},_reportCombinedResults:function(evt,args){args=args[0];if(!args.data)return;var newTotal=0,argData=args.data,jsData=this.data.js;if(jsData.social&&argData.social){newTotal+=Math.min(argData.social.data.totalResults,20)||0;}
if(!this._page||this._page<2){jsData.combinedResults+=newTotal;jsData.lastResult+=newTotal;jsData.totalResults+=newTotal;jsData.firstResult=((jsData.combinedResults)?1:0);if(jsData.totalResults===0||this.data.js.combinedResults>0){this._updateSearchResults({userSearchedOn:true});}}},_watchSearchFilterChange:function(evt,args){args=args[0];if(!args)return;var filters=args.allFilters;if(filters&&((filters.keyword&&filters.keyword.filters.data!==this._searchTerm)||(filters.page===1))){this._page=1;this._searchTerm=filters.keyword.filters.data;this.data.js.totalResults=0;this.data.js.combinedResults=0;this.data.js.lastResult=0;this.data.js.firstResult=0;this.data.js.prunedAnswers=false;}}});
RightNow.Widgets.ProductCategorySearchFilter=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this.Y.augment(this,RightNow.ProductCategory);this._getFiltersRequest.lastInstance=this._getFiltersRequest.lastInstance||{};this.searchSource(this.data.attrs.report_id).on('search',this._getFiltersRequest,this).on('response',this._onReportResponse,this).on('reset',this._onResetRequest,this);this._initializeFilter();this.initializeTreeView(this.data.attrs.filter_type);}},selectNode:function(node){if(node!==null){this._getFiltersRequest.lastInstance[this.data.attrs.filter_type]=this.baseDomID;if((node.expanded||!node.value)&&!this.data.js.linkingOn){this._eo.data.level=node.depth+1;if(this._eo.data.level!==this._eo.filters.data[0].length){this._eo.filters.data[0]=node.valueChain;}
else{this._eo.filters.data[0][this._eo.data.level-1]=node.value||this._eo.data.value;for(var i=this._eo.data.level;i<this._eo.filters.data[0].length;i++)
delete this._eo.filters.data[0][i];}}
else if(this.data.attrs.search_on_select&&!RightNow.Url.isSameUrl(this.data.attrs.report_page_url)){this._eo.data.level=node.depth+1;this._eo.data.label=node.label;this._eo.data.value=node.value;this._eo.filters.data[0][node.depth]=node.value;}
else{this.getSubLevelRequest(node);this.tree.collapseAll();}
RightNow.ProductCategory.prototype.selectNode.call(this,node);if(this.data.attrs.search_on_select){this._eo.filters.reportPage=this.data.attrs.report_page_url;this.searchSource().fire('search',this._eo);}}},getSubLevelRequestEventObject:function(expandingNode){if(expandingNode.expanded&&!this.data.js.linkingOn)return;this._eo.data.level=expandingNode.depth+1;this._eo.data.label=expandingNode.label;this._eo.data.value=expandingNode.value;this.getSubLevelRequestEventObject._origRequest=this.getSubLevelRequestEventObject._origRequest||[];this.getSubLevelRequestEventObject._origRequest[this._dataType]=expandingNode.value;if(this.data.js.link_map){this._eo.data.link_map=this.data.js.link_map;this.data.js.link_map=null;}
if(this._eo.data.level!==this._eo.filters.data[0].length){this._eo.filters.data[0]=this.tree.get('valueChain');}
else{this._eo.filters.data[0][this._eo.data.level-1]=this._eo.data.value;for(var i=this._eo.data.level;i<this._eo.filters.data[0].length;i++)
delete this._eo.filters.data[0][i];}
if(!expandingNode.loaded||this.data.js.linkingOn)
return this._eo;},getSubLevelResponse:function(type,args){var eventObject=args[0];if(!((eventObject.data.linking_on&&((!eventObject.data.value&&eventObject.data.via_hier_request)||(eventObject.data.via_product_click)))||(eventObject.data.data_type!==this._dataType)||(eventObject.filters.report_id!==this.data.attrs.report_id))){RightNow.ProductCategory.prototype.getSubLevelResponse.call(this,eventObject,this._dataType);}},_onReportResponse:function(type,args){var data=RightNow.Event.getDataFromFiltersEventResponse(args,this.data.js.searchName);this._getFiltersRequest.cachedWidgetHier={};if(data[0]&&data[0].length){this.buildTree();if(typeof data[0]==="string")
data[0]=data[0].split(",");var finalData=RightNow.Lang.arrayFilter(data[0]);this.tree.expandAndCreateNodes(finalData);if(this.data.attrs.show_confirm_button_in_dialog){this.dropdown.fire('confirm');}
this._eo.filters.data[0]=finalData;this._lastSearchValue=finalData.slice(0);if(this._eo.filters.data.reconstructData){this._eo.filters.data.level=this._eo.filters.data.reconstructData.level;this._eo.filters.data.label=this._eo.filters.data.reconstructData.label;}}
else{this._eo.filters.data[0]=[];if(this.tree){this.tree.resetSelectedNode();this.displaySelectedNodesAndClose();}}},_getFiltersRequest:function(type,args){this._getFiltersRequest.lastInstance[this.data.attrs.filter_type]=this._getFiltersRequest.lastInstance[this.data.attrs.filter_type]||null;this._getFiltersRequest.cachedWidgetHier=this._getFiltersRequest.cachedWidgetHier||{};var filterName=(this._eo.filters.searchName||"")+this.data.attrs.report_id,filterKey=filterName+this.baseDomID,mostRecentFilterKey=filterName+this._getFiltersRequest.lastInstance[this.data.attrs.filter_type],cachedHier=this._getFiltersRequest.cachedWidgetHier[mostRecentFilterKey];this._eo.filters.data.reconstructData=[];if(this.tree&&this.tree.get('value')){this._eo.data.level=this.tree.get('depth');this._eo.data.label=this.tree.get('label');this._eo.data.value=this.tree.get('value');var labelChain=this.tree.get('labelChain');for(var i=0;i<labelChain.length;i++){this._eo.filters.data.reconstructData.push({level:i+1,label:labelChain[i],hierList:this._eo.filters.data[0].slice(0,i+1).join(",")});}
if(cachedHier&&filterKey!==mostRecentFilterKey){this._eo.filters.data=cachedHier;}
else{this._getFiltersRequest.cachedWidgetHier[filterKey]=RightNow.Lang.cloneObject(this._eo.filters.data);}}
else if(cachedHier){this._eo.filters.data=cachedHier;this._eo.data.value=cachedHier[0][0];}
else{this._eo.filters.data[0]=[];this._eo.data.value=0;}
this._lastSearchValue=this._eo.filters.data[0].slice(0);return this._eo;},_onResetRequest:function(type,args){args=args[0];if(this.tree&&(!args||args.data.name==='all'||args.data.name===this.data.js.searchName)){if(args&&args.data.name==="all"&&this._lastSearchValue){this._eo.filters.data[0]=this._lastSearchValue;}
else{if(args&&args.data.reset&&this.data.js.linkingOn&&this._dataType==="Category"){RightNow.Event.fire('evt_resetFilterRequest',args);if(this.data.js.link_map)
delete this.data.js.link_map;this.buildTree(true);}
if(!args)
this._eo.filters.data=[(this.data.js.initial)?this.data.js.initial:[]];else
this._eo.filters.data[0]=[];this._lastSearchValue=this._eo.filters.data[0].slice(0);this._getFiltersRequest.cachedWidgetHier={};}
this.tree.selectNodeWithValue(this._lastSearchValue[this._lastSearchValue.length-1]||0);this.displaySelectedNodesAndClose();}},_initializeFilter:function(){this._eo=new RightNow.Event.EventObject(this,{data:{data_type:this._dataType=this.data.attrs.filter_type,linking_on:this.data.js.linkingOn,cache:[],hm_type:this.data.js.hm_type,linkingProduct:0},filters:{rnSearchType:"menufilter",searchName:this.data.js.searchName,report_id:this.data.attrs.report_id,fltr_id:this.data.js.fltr_id,oper_id:this.data.js.oper_id,data:[(this.data.js.initial)?this.data.js.initial:[]]}});this._lastSearchValue=this._eo.filters.data[0].slice(0);if(this._dataType==="Product"){RightNow.UI.Form.currentProduct=this._eo.filters.data[0][this._eo.filters.data[0].length-1];}}});
RightNow.Widgets.Paginator=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._currentPage=this.data.js.currentPage;for(var i=this.data.js.startPage;i<=this.data.js.endPage;i++)
{var pageLinkID=this.baseSelector+"_PageLink_"+i;if(this.Y.one(pageLinkID))
this.Y.one(pageLinkID).on("click",this._onPageChange,this,i);}
this._instanceElement=this.Y.one(this.baseSelector);this._cloneForwardAndBackwardButton();this.Y.one(this.baseSelector).delegate("click",this._onDirection,".rn_NextPage",this,true);this.Y.one(this.baseSelector).delegate("click",this._onDirection,".rn_PreviousPage",this,false);this._eo=new RightNow.Event.EventObject(this,{filters:{report_id:this.data.attrs.report_id,per_page:this.data.attrs.per_page,page:this._currentPage}});this.searchSource(this.data.attrs.report_id).on("response",this._onReportChanged,this);}},_onPageChange:function(evt,pageNumber)
{evt.preventDefault();if(this._currentlyChangingPage||!pageNumber||pageNumber===this._currentPage)
return;this._currentlyChangingPage=true;pageNumber=(pageNumber<1)?1:pageNumber;this._eo.filters.page=this._currentPage=pageNumber;if(RightNow.Event.fire("evt_switchPagesRequest",this._eo)){this.searchSource().fire("appendFilter",this._eo).fire("search",this._eo);}},_onDirection:function(evt,isForward)
{evt.preventDefault();if(this._currentlyChangingPage)
return;this._currentlyChangingPage=true;if(isForward)
this._currentPage++;else
this._currentPage--;this._eo.filters.page=this._currentPage;if(RightNow.Event.fire("evt_switchPagesRequest",this._eo)){this.searchSource().fire("appendFilter",this._eo).fire("search",this._eo);}},_onReportChanged:function(type,args)
{var newData=args[0];newData=newData.data;if(args[0].filters.report_id==this.data.attrs.report_id)
{this._currentPage=newData.page;var totalPages=newData.total_pages;if(totalPages<2||newData.truncated)
{RightNow.UI.hide(this._instanceElement);}
else
{var pagesContainer=this.Y.one(this.baseSelector+" ul");if(pagesContainer)
{pagesContainer.set('innerHTML',"");var startPage,endPage;if(totalPages>this.data.attrs.maximum_page_links)
{var split=Math.round(this.data.attrs.maximum_page_links/2);if(this._currentPage<=split)
{startPage=1;endPage=this.data.attrs.maximum_page_links;}
else
{var offsetFromMiddle=this._currentPage-split;var maxOffset=offsetFromMiddle+this.data.attrs.maximum_page_links;if(maxOffset<=newData.total_pages)
{startPage=1+offsetFromMiddle;endPage=maxOffset;}
else
{startPage=newData.total_pages-(this.data.attrs.maximum_page_links-1);endPage=newData.total_pages;}}}
else
{startPage=1;endPage=totalPages;}
pagesContainer.appendChild(this._backButton);for(var i=startPage,link,titleString;i<=endPage;i++)
{if(i===this._currentPage)
{var currentPageTitle=RightNow.Text.sprintf(this.data.attrs.label_current_page,i,totalPages)
link=this.Y.Node.create("<span/>").addClass("rn_CurrentPage").set('innerHTML',i).set('title',currentPageTitle).set('aria-label',currentPageTitle).setAttribute('tabindex','0');}
else if(this._shouldShowPageNumber(i,this._currentPage,endPage))
{link=this.Y.Node.create("<a/>").set('id',this.baseDomID+"_PageLink_"+i).set('href',this.data.js.pageUrl+i).set('innerHTML',i+'<span class="rn_ScreenReaderOnly">'+RightNow.Text.sprintf(this.data.attrs.label_page,i,totalPages)+'</span>');titleString=this.data.attrs.label_page;if(titleString)
{titleString=titleString.replace(/%s/,i).replace(/%s/,newData.total_pages);link.set('title',titleString);}}
else if(this._shouldShowHellip(i,this._currentPage,endPage))
{link=this.Y.Node.create("<span/>").set('class','rn_PageHellip').set('innerHTML',"&hellip;");}
else{continue;}
pagesContainer.appendChild(this.Y.Node.create("<li/>").append(link));link.on("click",this._onPageChange,this,i);}
pagesContainer.appendChild(this._forwardButton);RightNow.UI.show(this._instanceElement);}}
if(this._backButton)
{if(newData.page>1)
this._backButton.removeClass("rn_Hidden").set('href',this.data.js.pageUrl+(this._currentPage-1));else
RightNow.UI.hide(this._backButton);}
if(this._forwardButton)
{if(newData.total_pages>newData.page)
this._forwardButton.removeClass("rn_Hidden").set('href',this.data.js.pageUrl+(this._currentPage+1));else
RightNow.UI.hide(this._forwardButton);}
this._cloneForwardAndBackwardButton();}
this._currentlyChangingPage=false;},_shouldShowHellip:function(pageNumber,currentPage,endPage){return Math.abs(pageNumber-currentPage)===((currentPage===1||currentPage===endPage)?3:2);},_shouldShowPageNumber:function(pageNumber,currentPage,endPage){return pageNumber===1||(pageNumber===endPage)||(Math.abs(pageNumber-currentPage)<=((currentPage===1||currentPage===endPage)?2:1));},_cloneForwardAndBackwardButton:function(){this._forwardButton=this.Y.one(this.baseSelector+" .rn_NextPage").cloneNode(true);this._backButton=this.Y.one(this.baseSelector+" .rn_PreviousPage").cloneNode(true);}});
RightNow.Widgets.ModerationFilterDialog=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._eo=new RightNow.Event.EventObject(this);this.Y.one(this.baseSelector+"_TriggerLink").on("click",this._openDialog,this);this._moderationDateFilter=this.Y.one('.rn_ModerationDateFilter');this._customDateFilterEnabled=false;RightNow.Event.subscribe('evt_moderationCustomDateFilterEnabled',function(){this._customDateFilterEnabled=true;RightNow.Event.subscribe('evt_moderationDateFilterValidated',this._performSearch,this);},this);this._errorMessageDiv=this.Y.one(this.baseSelector+"_ErrorLocation");}},_openDialog:function(evt){if(!this._dialog){var dialogDiv=this.Y.one(this.baseSelector+"_DialogContent");if(dialogDiv){var buttons=[{text:this.data.attrs.label_apply_button,handler:{fn:(this._customDateFilterEnabled||(this.data.attrs.object_type!=='SocialUser'&&this.Y.Array.indexOf(this.data.attrs.include_filters,'date')>-1&&this._moderationDateFilter!==null))?this._validateDateFilter:this._performSearch,scope:this}},{text:this.data.attrs.label_cancel_button,handler:{fn:this._cancelFilters,scope:this}}];this._dialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_dialog_title,dialogDiv,{buttons:buttons});this.Y.one("#"+this._dialog.get('id')).addClass("rn_ModerationFilterDialog");if(this.data.attrs.object_type==='SocialUser'){this.Y.one("#"+this._dialog.get('id')).addClass("rn_ModerationFilterDialogSocialUser");}
RightNow.UI.show(dialogDiv);this._dialog.hideEvent.subscribe(function(){if(evt.target.focus){evt.target.focus();}},null,this);}}
this._dialogClosed=false;if(this._dialog){this._dialog.show();this._dialog.hideEvent.subscribe(this._cancelFilters,null,this);}},_validateDateFilter:function(){if(this.searchSource().searchSource&&parseInt(this.searchSource().searchSource.id,10)===this.data.attrs.report_id){RightNow.Event.fire("evt_validateModerationDateFilter",new RightNow.Event.EventObject(this,{data:{report_id:this.data.attrs.report_id}}));}},_performSearch:function(evt,args){this._errorMessageDiv.get('childNodes').remove();if(args&&args[0]){if(this.data.attrs.report_id!==parseInt(args[0].data.report_id,10)){return;}
if(args[0].data.errors){this._displayError(args[0].data.errors);return;}}
if(this.searchSource().searchSource&&parseInt(this.searchSource().searchSource.id,10)===this.data.attrs.report_id){this._closeDialog();this.searchSource().fire("search",new RightNow.Event.EventObject(this,{filters:{report_id:this.data.attrs.report_id}}));}},_displayError:function(errors){errors.forEach(function(error){this._errorMessageDiv.appendChild(error);this._errorMessageDiv.addClass("rn_MessageBox").addClass("rn_ErrorMessage").removeClass("rn_Hidden").scrollIntoView();},this);var errorLbl=this._errorMessageDiv.all("a").size()>1?RightNow.Interface.getMessage("ERRORS_LBL"):RightNow.Interface.getMessage("ERROR_LBL");this._errorMessageDiv.prepend("<h2>"+errorLbl+"</h2>");this._errorMessageDiv.one("h2").setAttribute('role','alert');},_cancelFilters:function(){this._errorMessageDiv.addClass("rn_Hidden");if(this.searchSource().searchSource&&parseInt(this.searchSource().searchSource.id,10)===this.data.attrs.report_id){if(this._dialogClosed)return;this._closeDialog();this._eo.data.name="all";this.searchSource().fire("reset",this._eo);}},_closeDialog:function(){this._dialogClosed=true;if(this._dialog){this._dialog.hide();}}});
RightNow.Widgets.ModerationFilterBreadcrumbs=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._filterToAdd={};this._currentDomID=0;this.searchSource().on('response',this._onReportResponse,this);this.Y.Array.each(this.data.js.filters,function(filter){var filterData=[],filterValue=filter.data[filter.data.length-1].id,templateData;this.Y.Array.each(filter.data,function(dataElement){filterData.push(this.buildFilterData(dataElement.id,dataElement.label));},this);templateData=this.getFilterDataForTemplate(filter.urlParameter,filter.label,filterValue,filterData);this.Y.one('#'+templateData.removeLinkID).on('click',this._onFilterClear,this,templateData.divID,filter.urlParameter);},this);}},_onFilterClear:function(evt,filterDomID,filterUrlParameter){evt.preventDefault();var eo=new RightNow.Event.EventObject(this,{filters:{report_id:this.data.attrs.report_id},data:{name:filterUrlParameter,ignoreLastSearch:true,ignoreInitial:true}});this.Y.one('#'+filterDomID).remove(true);this.searchSource().fire('reset',eo).fire('excludeFilterFromNextSearch',eo).fire('search',eo);},_onReportResponse:function(evt,args){var reportFilters=args[0].filters.allFilters,filterContainer=this.Y.one(this.baseSelector+'_FilterContainer'),hasFilters=false,filterValueArray,filterType,filterLabel,filter,Y=this.Y,templateData;filterContainer.get('childNodes').remove(true);for(filterType in this.data.js.allAvailableFilters){if(filterType in reportFilters){filter=reportFilters[filterType]?reportFilters[filterType].filters:null;filterValueArray=this.getFilterValueArray(filterType,filter)||null;if(filterValueArray&&!this.isDefaultFilter(filterType,filterValueArray)){var filterData=[],prodcatValue;if(filterType==='p'||filterType==='c'){filterLabel=filterType==='p'?this.data.attrs.label_product_filter:this.data.attrs.label_category_filter;for(var j=filter.data[0].length-1;j>=0;j--){prodcatValue=filter.data.reconstructData[j].hierList.split(',');filterData.push(this.buildFilterData(prodcatValue[prodcatValue.length-1],filter.data.reconstructData[filter.data[0].length-j-1].label));}}else{for(var i=0;i<filterValueArray.length;i++){filterLabel=this.data.js.allAvailableFilters[filterType].caption;var formatter=this.getFormatter(filterType);var filterValue=this.data.js.allAvailableFilters[filterType].filters[filterValueArray[i]];filterValue=(!filterValue&&formatter)?formatter(filterValueArray[i]):(filterValue||filterValueArray[i]);filterData.push(this.buildFilterData(filterValueArray[i],filterValue));}}
if(filterData.length>0){templateData=this.getFilterDataForTemplate(filterType,filterLabel,filterValueArray[filterValueArray.length-1],filterData);filterContainer.append(new EJS({text:this.getStatic().templates.view}).render(templateData));filterContainer.one('#'+templateData.removeLinkID).on('click',this._onFilterClear,this,templateData.divID,filterType);hasFilters=true;}}}}
(hasFilters)?Y.one(this.baseSelector).removeClass('rn_Hidden'):this.Y.one(this.baseSelector).addClass('rn_Hidden');},getFilterValueArray:function(filterName,filter){var filterValueArray;if(filter&&!this.Y.Object.isEmpty(filter.data)&&(!this.Y.Lang.isArray(filter.data)||filter.data.length===1&&filter.data[0])){if((filterName==='p'||filterName==='c')&&filter.data.reconstructData===undefined){return null;}
filterValueArray=this.Y.Lang.isArray(filter.data)?filter.data[0]:filter.data.split(",");filterValueArray=this.Y.Array.map(filterValueArray,function(value){return this.Y.Lang.trim(value);},this);return filterValueArray;}
return null;},isDefaultFilter:function(filterType,filterValue){if(!this.Y.Lang.isArray(this.data.js.defaultFilters[filterType])){return filterValue.length===1&&this.data.js.defaultFilters[filterType]===filterValue[0];}
return this.areArraysEqual(this.data.js.defaultFilters[filterType],filterValue);},areArraysEqual:function(array1,array2){if(this.Y.Lang.isArray(array1)&&this.Y.Lang.isArray(array2)){if(array1.length!==array2.length){return false;}
array1=this.toStringArrayElements(array1).sort();array2=this.toStringArrayElements(array2).sort();for(var i=0;i<array1.length;i++){if(array1[i]!==array2[i]){return false;}}
return true;}
return false;},toStringArrayElements:function(arr){return this.Y.Array.map(arr,function(value){return this.Y.Lang.trim(String(value));},this);},buildFilterData:function(filterValue,filterName){return{'linkID':this.baseDomID+'_Filter_'+this._currentDomID+'_'+filterValue,'label':filterName};},getFilterDataForTemplate:function(filterType,filterLabel,filterValue,filterData){if(!this._filterToAdd[filterType]){this._filterToAdd[filterType]={'domID':this._currentDomID};this._currentDomID++;}
return(this._filterToAdd[filterType][filterValue]={'divID':this.baseDomID+'_Filter_'+this._filterToAdd[filterType].domID,'label':filterLabel,'removeLinkID':this.baseDomID+'_Remove_'+this._filterToAdd[filterType].domID,'labelFilterRemove':this.data.attrs.label_filter_remove,'filterData':filterData,'filterType':filterType});},getFormatter:function(filterName){if(!this.formatter){var dateFormatter=function(value){var formattedValue;var pipeIndex=value.indexOf('|');if(pipeIndex!==-1){formattedValue=value.substring(0,pipeIndex)+' - '+value.substring(pipeIndex+1);}
return formattedValue||value;};this.formatter={'questions.updated':dateFormatter,'comments.updated':dateFormatter};}
return this.formatter[filterName];}});
RightNow.Widgets.ModerationAction=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._eo=new RightNow.Event.EventObject(this);this.searchSource().on("response",this._onReportChanged,this);this.searchSource().on("search",this._onReportSearch,this);this._instanceElement=this.Y.one(this.baseSelector);this.Y.all(this.baseSelector+"_ActionButtons button").on("click",this._onAction,this);RightNow.Event.subscribe('evt_productCategorySelected',this._getProdcatID,this);RightNow.Event.subscribe('evt_rowSelected',this._onRowSelected,this);this._actionEventObj={};this.Y.all(this.baseSelector+" button").set("disabled",true);this._errorMessageDiv=this.Y.one(this.baseSelector+"_ErrorLocation");}},_onReportSearch:function(type,args)
{if(parseInt(args[0].filters.report_id,10)===this.data.attrs.report_id){this.Y.all(this.baseSelector+" button").set("disabled",true);}},_onReportChanged:function(type,args)
{if(parseInt(args[0].filters.report_id,10)===this.data.attrs.report_id){if((typeof args[0].data.total_pages==='undefined')||args[0].data.total_pages<=0){RightNow.UI.hide(this._instanceElement);}
else{RightNow.UI.show(this._instanceElement);}
this.Y.all(this.baseSelector+" button").set("disabled",true);}},_onAction:function(e){this._actionEventObj=new RightNow.Event.EventObject(this,{data:{w_id:this.data.info.w_id,action:e.currentTarget.get('value'),action_name:e.currentTarget.get('name'),message_location:this.data.attrs.message_location,moderation_action_baseselector:this.baseSelector,report_id:this.data.attrs.report_id}});if(e.currentTarget.get('value')==='move'){this._openMoveQuestionDialog();}
else{RightNow.Event.fire("evt_moderationAction",this._actionEventObj);}},_openMoveQuestionDialog:function(){this.prodcatID=0;var dialogBody=this.Y.one(this.baseSelector+"_MoveDialogBody");if(dialogBody&&!this._moveQuestionDialog){dialogBody=this.Y.Node.getDOMNode(dialogBody.removeClass('rn_Hidden'));var buttons=[{text:this.data.attrs.label_move_dialog_move_button,handler:{fn:this._moveQuestion,scope:this},isDefault:false},{text:this.data.attrs.label_move_dialog_cancel_button,handler:{fn:this._closeMoveQuestionDialog,scope:this},isDefault:false}];this._moveQuestionDialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_move_dialog_title,dialogBody,{"buttons":buttons});this.Y.one('#'+this._moveQuestionDialog.id).ancestor('.yui3-panel').addClass("rn_MoveDialogContainer");RightNow.UI.show(dialogBody);}
this._moveQuestionDialog.show();this._moveQuestionDialog.hideEvent.subscribe(this._closeMoveQuestionDialog,null,this);},_getProdcatID:function(evt,eventData){this.prodcatID=eventData[0].data.hierChain[eventData[0].data.hierChain.length-1];},_onRowSelected:function(evt,eventData){if(this.data.attrs.report_id===parseInt(eventData[0].data.report_id,10)){this.isRowSelected=eventData[0].data.isRowSelected;this.Y.all(this.baseSelector+" button").set("disabled",!this.isRowSelected);}},_moveQuestion:function(evt){var selectorString='#'+this._moveQuestionDialog.id+' form'+this.baseSelector+"_Form ",errorLabelSpan=this.Y.one(selectorString+'span.rn_ErrorLabel'),errorSpanHidden=false;if(errorLabelSpan===null){errorLabelSpan=this.Y.one(selectorString+'span.rn_Hidden');errorSpanHidden=true;}
if(errorSpanHidden&&this.prodcatID){this._actionEventObj.data.prodcat_type=this.data.attrs.prodcat_type;this._actionEventObj.data.prodcat_id=this.prodcatID;RightNow.Event.fire("evt_moderationAction",this._actionEventObj);this._closeMoveQuestionDialog();}
else if(this.prodcatID===0){if(this.data.attrs.prodcat_type==='Product')
errorLabelSpan.setHTML(this.data.attrs.label_select_product);else if(this.data.attrs.prodcat_type==='Category')
errorLabelSpan.setHTML(this.data.attrs.label_select_category);if(errorSpanHidden)
errorLabelSpan.replaceClass('rn_Hidden','rn_ErrorLabel');}},_closeMoveQuestionDialog:function(evt){this.prodcatID=0;if(this._moveQuestionDialog){RightNow.Event.fire("evt_resetProductCategoryMenu",new RightNow.Event.EventObject(this));this._moveQuestionDialog.hide();}}});
RightNow.Widgets.ModerationDateFilter=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._radioButtons=this.Y.all(this.baseSelector+" input[type=radio]");if(!this._radioButtons)
return;this._radioButtons.on("click",this._onDateChange,this);this._eo=new RightNow.Event.EventObject(this);this._newFilterData=false;this.searchSource().on("search",this._onSearch,this);this.searchSource().on("reset",this._onReset,this);if(this._isCustomDateOptionEnabled()){this.calendarConfigs={};this.calendarConfigs.fromDate={contentBox:this.baseSelector+'_EditedOnFromCal',boundingBox:this.baseSelector+'_EditedOnFromBoundingBox',dateInput:this.baseSelector+'_EditedOnFrom',calIcon:this.baseSelector+'_EditedOnFromIcon'};this.calendarConfigs.toDate={contentBox:this.baseSelector+'_EditedOnToCal',boundingBox:this.baseSelector+'_EditedOnToBoundingBox',dateInput:this.baseSelector+'_EditedOnTo',calIcon:this.baseSelector+'_EditedOnToIcon'};this.Y.Object.each(Object.keys(this.calendarConfigs),function(key){this._createCalendar(this.calendarConfigs[key]);},this);RightNow.Event.fire("evt_moderationCustomDateFilterEnabled",new RightNow.Event.EventObject(this,{data:{report_id:this.data.attrs.report_id}}));RightNow.Event.subscribe('evt_validateModerationDateFilter',this._validate,this);}
this._setFilter();}},_onSearch:function(){if(this._isCustomDateSelected()){this._newFilterData=this._getCustomDateInputsAsString();}
this._eo.filters.data=(this._newFilterData===false)?this._eo.filters.data:this._newFilterData;return this._eo;},_onReset:function(type,args){if(args&&args[0].data.name===this.data.attrs.report_filter_name){this._eo.filters.data=this._getDefaultDate();}
this._newFilterData=this._eo.filters.data;var customDateRange=(!this._isStandardDateOption(this._eo.filters.data)&&this._eo.filters.data)?this._eo.filters.data.split("|"):null;if(this._eo.filters.data){this._setSelectedRadioButton(customDateRange?customDateRange[0]:this._eo.filters.data,customDateRange?customDateRange[1]:null);}},_setSelectedRadioButton:function(fromDate,toDate){toDate=toDate||'';if(!this._isStandardDateOption(fromDate)){this.Y.one(this.calendarConfigs.fromDate.dateInput).set('value',fromDate);this.Y.one(this.calendarConfigs.toDate.dateInput).set('value',toDate);var selectedRadio=this.Y.one(this.baseSelector+"_DateFilter_custom");selectedRadio.set("checked","true");this._toggleCustomDateRange(true);}
else{var selectedDate=this.Y.one(this.baseSelector+"_DateFilter_"+fromDate);if(selectedDate){selectedDate.set("checked",true);this._toggleCustomDateRange(false);this._setCustomDateInputs('','');}}},_onChangedResponse:function(){this._radioBtns.set('disabled',false);},_onDateChange:function(){this._setSelectedFilters();},_setSelectedFilters:function(){if(this._isCustomDateSelected()){this._toggleCustomDateRange(true);}
else{var selectedRadio=this.Y.one(this.baseSelector+" input[type='radio']:checked");this._setCustomDateInputs('','');this._newFilterData=selectedRadio?selectedRadio.get('value'):false;this._toggleCustomDateRange(false);}},_setFilter:function(){var urlDateValue=this.data.js.urlDateValue||this._getDefaultDate();var dateRange=urlDateValue.split("|");this._setSelectedRadioButton(dateRange[0],dateRange[1]);this._eo.filters={rnSearchType:this.data.attrs.report_filter_name,report_id:this.data.attrs.report_id,searchName:this.data.attrs.report_filter_name,oper_id:this.data.js.oper_id,fltr_id:this.data.js.filter_id,data:urlDateValue};},_newDateFilter:function(reportFilterName,value){return{rnSearchType:reportFilterName,report_id:this.data.attrs.report_id,searchName:reportFilterName,oper_id:this.data.js[reportFilterName].oper_id,fltr_id:this.data.js[reportFilterName].filter_id,data:value};},_createCalendar:function(calendarConfig){var now=new Date();var calendar=new this.Y.Calendar({contentBox:calendarConfig.contentBox,showPrevMonth:true,showNextMonth:true,boundingBox:calendarConfig.boundingBox,maximumDate:now,minimumDate:this._getMinimumDate(),date:now}).render().hide();var dtdate=this.Y.DataType.Date;calendar.on("dateClick",function(ev){if(ev.date>now){return null;}
this.Y.one(calendarConfig.dateInput).set('value',dtdate.format(ev.date,{format:this._getDateFormat()}));if(ev.cell.get('aria-disabled')!=='true'){calendar.hide();}},this);calendar.on("selectionChange",function(ev){var newDate=ev.newSelection[0];this.Y.one(calendarConfig.dateInput).set('value',dtdate.format(newDate,{format:this._getDateFormat()}));this._newFilterData=this._getCustomDateInputsAsString();calendar.hide();},this);this.Y.one(calendarConfig.calIcon).on('click',function(ev){ev.preventDefault();var dateInput=this.Y.one(calendarConfig.dateInput).get('value');var dateValue=this._parseDate(dateInput)||now;calendar.deselectDates();calendar.set("date",dateValue);calendar.selectDates(dateValue);if(dateValue===now){this.Y.one(calendarConfig.dateInput).set('value',null);}
if(this.Y.one(calendarConfig.boundingBox).hasClass("yui3-calendar-hidden")){calendar.show();calendar.focus();}
else{calendar.hide();}},this);calendar.after('focusedChange',function(ev){if(!ev.target.get('focused')){calendar.hide();this.Y.one(calendarConfig.calIcon).focus();}},this);return calendar;},_toggleCustomDateRange:function(show){if(!this._isCustomDateOptionEnabled()){return;}
var dateRangeDiv=this.Y.one(this.baseSelector+" .rn_DateRangeContainer");dateRangeDiv.removeClass("rn_Hidden");dateRangeDiv.removeClass("rn_Show");dateRangeDiv.toggleClass(show?"rn_Show":"rn_Hidden");},_setCustomDateInputs:function(fromDate,toDate){if(!this._isCustomDateOptionEnabled()){return;}
this.Y.one(this.calendarConfigs.fromDate.dateInput).set('value',fromDate);this.Y.one(this.calendarConfigs.toDate.dateInput).set('value',toDate);},_isStandardDateOption:function(value){return value!=='custom'&&this.data.js.options[value]!==undefined;},_getCustomDateInputs:function(){return{from:this.Y.one(this.calendarConfigs.fromDate.dateInput).get('value'),to:this.Y.one(this.calendarConfigs.toDate.dateInput).get('value')};},_getCustomDateInputsAsString:function(delimitter){delimitter=delimitter||"|";var dates=this._getCustomDateInputs();return(dates.from.replace(/-/g,'\/')||"")+delimitter+(dates.to.replace(/-/g,'\/')||"");},_getDateFormat:function(){return("%"+this.data.js.date_format.short).replace(/-/g,"-%").replace(/\//g,"/%");},_isCustomDateSelected:function(){var selectedRadio=this.Y.one(this.baseSelector+" input[type='radio']:checked");return selectedRadio.get('value')==='custom';},_parseDate:function(dateVal){if(dateVal.trim()===""){return null;}
var dateArray=dateVal.split(/[\/-]/);dateArray=this.Y.Array.map(dateArray,function(datePart){return parseInt(datePart,10);});var dateObj=new Date(dateArray[this.data.js.date_format.yearOrder],dateArray[this.data.js.date_format.monthOrder]-1,dateArray[this.data.js.date_format.dayOrder]);var isValidDate=((dateObj.getMonth()+1===dateArray[this.data.js.date_format.monthOrder])&&(dateObj.getDate()===dateArray[this.data.js.date_format.dayOrder])&&(dateObj.getFullYear()===dateArray[this.data.js.date_format.yearOrder]));return isValidDate?dateObj:null;},_validate:function(evt,args){if(parseInt(this.data.attrs.report_id,10)!==args[0].data.report_id){return;}
errors=[];if(this._isCustomDateSelected()){var dtdate=this.Y.DataType.Date;var dates=this._getCustomDateInputs();var fromDate=this._parseDate(dates.from);var toDate=this._parseDate(dates.to);var fromDateInputID=this.calendarConfigs.fromDate.dateInput.replace("#","");var toDateInputID=this.calendarConfigs.toDate.dateInput.replace("#","");var errorMsgArg={'fromDate':dates.from!==null&&dates.from.length?dates.from:this.data.attrs.label_from_date,'toDate':dates.to!==null&&dates.to.length?dates.to:this.data.attrs.label_to_date};if(!fromDate){errors.push(this._getErrorMessage(fromDateInputID,this.data.attrs.label_invalid_from_date_error,errorMsgArg.fromDate));}
if(!toDate){errors.push(this._getErrorMessage(toDateInputID,this.data.attrs.label_invalid_to_date_error,errorMsgArg.toDate));}
if(fromDate&&toDate){var today=new Date();var minDate=this._getMinimumDate();var minDateStr=dtdate.format(minDate,{format:this._getDateFormat()});if(dtdate.isGreater(fromDate,today)){errors.push(this._getErrorMessage(fromDateInputID,this.data.attrs.label_future_from_date_error));}
if(dtdate.isGreater(toDate,today)){errors.push(this._getErrorMessage(toDateInputID,this.data.attrs.label_future_to_date_error));}
if(dtdate.isGreater(minDate,fromDate)){errors.push(this._getErrorMessage(fromDateInputID,this.data.attrs.label_min_from_date_error,minDateStr));}
if(dtdate.isGreater(minDate,toDate)){errors.push(this._getErrorMessage(toDateInputID,this.data.attrs.label_min_to_date_error,minDateStr));}
if(dtdate.isGreater(fromDate,toDate)){errors.push(this._getErrorMessage(fromDateInputID,this.data.attrs.label_invalid_date_range_error));}
var intervalParts=this.data.attrs.max_date_range_interval.split(" ");if(intervalParts[0]&&intervalParts[1]){var unit=intervalParts[1];if(unit==="hours"||unit==="hour"){unit="days";intervalParts[0]=intervalParts[0]/24;}
unit=(unit.slice(-1)==='s')?unit:(unit+'s');unit=unit.charAt(0).toUpperCase()+unit.slice(1);var maxToDate=dtdate["add"+unit](fromDate,parseInt(intervalParts[0],10));if(!dtdate.isGreater(fromDate,toDate)&&!dtdate.isInRange(toDate,fromDate,maxToDate)){errors.push(this._getErrorMessage(fromDateInputID,this.data.attrs.label_max_date_range_error,this.data.js.max_data_range_label));}}}}
RightNow.Event.fire("evt_moderationDateFilterValidated",new RightNow.Event.EventObject(this,{data:{report_id:this.data.attrs.report_id,errors:errors.length?errors:null}}));},_getErrorMessage:function(elementID,msg,msgArg)
{return this.Y.Node.create(new EJS({text:this.getStatic().templates.errorMessage}).render({error:{id:elementID,msg:msgArg?msg.replace("%s",msgArg):msg}}));},_getDefaultDate:function(){return this.data.js.default_value||'last_90_days';},_getMinimumDate:function(){return new Date(0);},_isCustomDateOptionEnabled:function(){return this.data.js.options.custom!==undefined;}});
RightNow.Widgets.ModerationStatusFilter=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._checkBoxes=this.Y.all(this.baseSelector+" input[type=checkbox]");if(!this._checkBoxes)
return;this._checkBoxes.on("click",this._onStatusChange,this);this._eo=new RightNow.Event.EventObject(this);this._newFilterData=false;this.searchSource().on("search",this._onSearch,this);this.searchSource().on("reset",this._onReset,this);this._setFilter();}},_onSearch:function(){this._eo.filters.data=(this._newFilterData===false)?this._eo.filters.data:this._newFilterData;return this._eo;},_onReset:function(type,args){if(args&&args[0].data.name===this.data.attrs.report_filter_name){this._eo.filters.data=this.data.js.default_value||'';}
this._newFilterData=this._eo.filters.data;this._setSelectedCheckboxes(this._eo.filters.data.split(","));},_setSelectedCheckboxes:function(statuses){var statusesToBeSelected=this.Y.Array(statuses);this._checkBoxes.each(function(checkbox){checkbox.set("checked",(this.Y.Array.indexOf(statusesToBeSelected,checkbox.get('value'))!==-1));},this);},_onChangedResponse:function(){this._checkBoxes.set('disabled',false);},_onStatusChange:function(){this._setSelectedFilters();},_setSelectedFilters:function(){var selectedCheckboxes=this.Y.all(this.baseSelector+" input[type='checkbox']");var selectedIDs=[];selectedCheckboxes.each(function(checkbox){if(checkbox.get('checked')){selectedIDs.push(checkbox.get("value"));}});this._newFilterData=selectedIDs.join(",");},_setFilter:function(){var urlStatusValue=RightNow.Url.getParameter(this.data.attrs.report_filter_name);var defaultFilters=urlStatusValue||this.data.js.default_value||'';this._setSelectedCheckboxes(defaultFilters.split(","));this._eo.filters={rnSearchType:this.data.attrs.report_filter_name,report_id:this.data.attrs.report_id,searchName:this.data.attrs.report_filter_name,oper_id:this.data.js.oper_id,fltr_id:this.data.js.filter_id,data:defaultFilters};}});
RightNow.Widgets.ModerationContentFlagFilter=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._checkBoxes=this.Y.all(this.baseSelector+" input[type=checkbox]");if(!this._checkBoxes)
return;this._checkBoxes.on("click",this._onFlagChange,this);this._eo=new RightNow.Event.EventObject(this);this._newFilterData=false;this.searchSource().on("search",this._onSearch,this);this.searchSource().on("reset",this._onReset,this);this._setFilter();}},_onSearch:function(){this._eo.filters.data=(this._newFilterData===false)?this._eo.filters.data:this._newFilterData;return this._eo;},_onReset:function(type,args){if(args&&args[0].data.name===this.data.attrs.report_filter_name){this._eo.filters.data=this.data.js.selected_flags?this.data.js.selected_flags.join(","):'';}
this._newFilterData=this._eo.filters.data;this._setSelectedCheckboxes(this._eo.filters.data.split(","));},_setSelectedCheckboxes:function(flags){var flagsToBeSelected=this.Y.Array(flags);this._checkBoxes.each(function(checkbox){checkbox.set("checked",(this.Y.Array.indexOf(flagsToBeSelected,checkbox.get('value'))!==-1));},this);},_onChangedResponse:function(){this._checkBoxes.set('disabled',false);},_onFlagChange:function(){this._setSelectedFilters();},_setSelectedFilters:function(){var selectedCheckboxes=this.Y.all(this.baseSelector+" input[type='checkbox']");var selectedIDs=[];selectedCheckboxes.each(function(checkbox){if(checkbox.get('checked')){selectedIDs.push(checkbox.get("value"));}});this._newFilterData=selectedIDs.join(",");},_setFilter:function(){var urlFlagValue=RightNow.Url.getParameter(this.data.attrs.report_filter_name);var defaultFilters=urlFlagValue||(this.data.js.selected_flags?this.data.js.selected_flags.join(","):'')||'';this._setSelectedCheckboxes(defaultFilters.split(","));this._eo.filters={rnSearchType:this.data.attrs.report_filter_name,report_id:this.data.attrs.report_id,searchName:this.data.attrs.report_filter_name,oper_id:this.data.js.oper_id,fltr_id:this.data.js.filter_id,data:defaultFilters};}});
RightNow.Widgets.ProductCategoryInput=RightNow.Field.extend({overrides:{constructor:function(){this.parent();this.Y.augment(this,RightNow.ProductCategory);this._maxDepth=this.data.attrs.max_lvl||6;this._notRequiredDueToProductLinking=false;this.displayField=this.Y.one(this.baseSelector+"_"+this.data.js.data_type+"_Button");this.requiredLabel=this.Y.one(this.baseSelector+"_RequiredLabel");this.errorLabel=this.Y.one(this.baseSelector+"_ErrorLabel");if(this.data.js.readOnly||!this.displayField)return;RightNow.Event.subscribe("evt_resetProductCategoryMenu",this._resetProductCategoryMenu,this);this.parentForm().on('submit',this._onValidate,this);if(this.data.attrs.set_button){this.Y.one(this.baseSelector+"_"+this.data.js.data_type+"_SetButton").on("click",this._setButtonClick,this);RightNow.Widgets.formTokenRegistration(this);}
if(this.data.attrs.hint){this._hintOverlay=this._initializeHint();}
this._eo=new RightNow.Event.EventObject(this,{data:{data_type:this.data.js.data_type,hm_type:this.data.js.hm_type,linking_on:this.data.js.linkingOn,linkingProduct:0,table:this.data.js.table,cache:[],name:((this.data.js.data_type.indexOf('prod')>-1)?'prod':'cat')}});this.on('constraintChange:required_lvl',this.updateRequiredLevel,this);if(this.data.attrs.verify_permissions!=='None'&&this.data.js.readableProdcatIds.length>0){this._updatePermissionedHierData('hierData');if(this.data.js.linkingOn&&(this.data.js.data_type==='Category')&&this.data.js.hierDataNone){this._updatePermissionedHierData('hierDataNone');}
var originalHierData=this.data.js.hierData;this.initializeTreeView(this.data.js.data_type);this.Y.Object.each(this.Y.Object.keys(originalHierData),function(key){this.disableNonPermissionedNodes(originalHierData[key]);},this);}
else{this.initializeTreeView(this.data.js.data_type);}
if(this.data.attrs.required_lvl&&this.requiredLabel){this.requiredLabel.replaceClass('rn_Hidden','rn_Required');}},_initializeHint:function(){if(this.Y.Overlay){var overlay;if(this.data.attrs.always_show_hint){overlay=this._createHintElement(true);var realignHintAfterFormValidation=this.Y.bind(this._realignHint,this,1);this.parentForm().on('validation:pass',realignHintAfterFormValidation).on('validation:fail',realignHintAfterFormValidation).on('response',realignHintAfterFormValidation);}
else{overlay=this._createHintElement(false);this.displayField.on("focus",overlay.show,overlay);this.displayField.on("blur",overlay.hide,overlay);}
return overlay;}
else{var hint=this.Y.Node.create('<span class="rn_HintText"/>').setHTML(this.data.attrs.hint);this.displayField.insert(hint,'after');}}},buildPanel:function(){RightNow.ProductCategory.prototype.buildPanel.call(this);this.dropdown.on('show',this.Y.bind(this._toggleHint,this,'show'));},_resetProductCategoryMenu:function(){this.tree.resetSelectedNode();this.displaySelectedNodesAndClose(false,false);this._removeErrorMessages();},_updatePermissionedHierData:function(dataType){if(!(this.data.js[dataType]&&this.Y.Lang.isObject(this.data.js[dataType]))){throw new Error("Widget does not have this.data.js."+dataType+" attribute set, or its value is not a valid object");}
this.Y.Object.each(this.Y.Object.keys(this.data.js[dataType]),function(key){this.data.js[dataType][key]=this.groomProdcats(this.data.js[dataType][key]);},this);},displaySelectedNodesAndClose:function(focus,fireSelectionEvent){fireSelectionEvent=typeof fireSelectionEvent!=='undefined'?fireSelectionEvent:true;this._eo.data.hierChain=this.tree.get('valueChain');if(fireSelectionEvent&&this._checkSelectionErrors()){RightNow.Event.fire("evt_productCategorySelected",this._eo);}
this.fire('change',this);delete this._eo.data.hierChain;RightNow.ProductCategory.prototype.displaySelectedNodesAndClose.call(this,focus);},selectNode:function(node){this._selected=true;if((!node.expanded&&node.value&&!node.loaded)||(this.data.js.linkingOn&&this.data.js.data_type==="Product")){this.getSubLevelRequest(node);}
else{this._errorLocation="";this._checkSelectionErrors();}
RightNow.ProductCategory.prototype.selectNode.call(this,node);},getSubLevelRequest:function(expandingNode){RightNow.ProductCategory.prototype.getSubLevelRequest.call(this,expandingNode);if(this._eo.data.link_map)
delete this._eo.data.link_map;},getSubLevelRequestEventObject:function(expandingNode){this._eo.data.level=expandingNode.depth+1;this._eo.data.value=expandingNode.value;this._eo.data.label=expandingNode.label;this._eo.data.reset=false;this._requestingParent=this._eo.data.value;if(this._eo.data.linking_on){if(this.data.js.data_type==="Category"){if(expandingNode.loaded){return;}
this._eo.data.reset=(this._eo.data.value<1);}
else if(this._eo.data.value<1&&this.data.js.data_type==="Product"){this._nodeBeingExpanded=false;RightNow.Event.fire("evt_menuFilterGetResponse",new RightNow.Event.EventObject(this,{data:{reset_linked_category:true,data_type:"Category",reset:true}}));return;}}
if(this.data.js.link_map){this._eo.data.link_map=this.data.js.link_map;delete this.data.js.link_map;}
return this._eo;},getSubLevelResponse:function(type,args){var evtObj=args[0],tempNode;if((evtObj.w_id&&evtObj.w_id===this.instanceID)||(this.data.js.linkingOn&&evtObj.data.data_type==="Category"&&this.data.js.data_type===evtObj.data.data_type)){var currentRoot;if(evtObj.data.reset_linked_category&&this.data.js.data_type==="Category"){if(this.data.js.link_map)
delete this.data.js.link_map;if(!this.tree||evtObj.data.reset){this.buildTree(true);this._linkedCategorySubset=false;if(this.data.attrs.verify_permissions!=='None'&&this.data.js.readableProdcatIds.length>0){this.Y.Object.each(this.Y.Object.keys(this.data.js.hierDataNone),function(key){this.disableNonPermissionedNodes(this.data.js.hierDataNone[key]);},this);}}
currentRoot=this._requestingParent=null;if(!evtObj.data.reset){this._linkedCategorySubset=true;this.tree.clear(this.data.attrs.label_all_values);}
this.dropdown.set('triggerText',this.data.attrs.label_nothing_selected);this._errorLocation='';this._checkSelectionErrors();}
else{currentRoot=this._requestingParent;}
var hierLevel=evtObj.data.level,hierData=evtObj.data.hier_data;if(hierLevel<=this._maxDepth){if(hierLevel===this._maxDepth){hierData=this.Y.Array.map(hierData,function(node){node.hasChildren=false;return node;});}
if(this.data.attrs.verify_permissions!=='None'&&this.data.js.readableProdcatIds.length>0){hierData=this.groomProdcats(hierData);this.insertChildrenForNode(hierData,currentRoot);this.disableNonPermissionedNodes(hierData);}
else{this.insertChildrenForNode(hierData,currentRoot);}}
if(this._selected){this._errorLocation="";this._checkSelectionErrors();if(this.data.attrs.required_lvl){this._selected=false;}}
if(this._requestingParent)
this.tree.selectNodeWithValue(this._requestingParent,true);}},_setButtonClick:function()
{var hierValues=[],labelChain=this.tree.get("labelChain"),valueChain=this.tree.get("valueChain");if(valueChain.length===0||valueChain[0]===0){if(!this._errorMessageDiv){this._errorMessageDiv=this.Y.Node.create("<div class='rn_MessageBox rn_ErrorMessage'/>");this.Y.one(this.baseSelector).prepend(this._errorMessageDiv);}
this._errorMessageDiv.setHTML("<b><a href='javascript:void(0);' onclick='document.getElementById(\""+this.displayField.get('id')+"\").focus(); return false;'>"+
this.data.attrs.label_nothing_selected+"</a></b>");this._errorMessageDiv.prepend("<h2>"+RightNow.Interface.getMessage("ERROR_LBL")+"</h2>");this._errorMessageDiv.one("h2").setAttribute('role','alert');RightNow.UI.show(this._errorMessageDiv);var errorLink=this._errorMessageDiv.one('a');if(errorLink){errorLink.focus();}
return;}
if(!this._checkSelectionErrors()){return;}
RightNow.UI.hide(this._errorMessageDiv);for(var i=0;i<labelChain.length;i++)
hierValues[i]={"id":valueChain[i],"label":labelChain[i]};this.tree.resetSelectedNode();this.displaySelectedNodesAndClose(false,false);this._eo.data.hierSetData=hierValues;this._eo.data.id=hierValues[hierValues.length-1].id;this._eo.data.f_tok=this.data.js.f_tok;RightNow.Event.fire("evt_menuFilterSelectRequest",this._eo);},_onValidate:function(type,args){var formEventObject=this.createEventObject();this._errorLocation=this.lastErrorLocation=args[0].data.error_location;if(this._checkSelectionErrors()){formEventObject.data.value=this.tree.get('value')||null;if(formEventObject.data.required&&this._notRequiredDueToProductLinking){formEventObject.data.required=false;}
RightNow.Event.fire("evt_formFieldValidatePass",formEventObject);return formEventObject;}
RightNow.Event.fire("evt_formFieldValidateFailure",this._eo);return false;},_createHintElement:function(visibility){var overlay=this.Y.Node.create("<span class='rn_HintBox'/>").set('id',this.baseDomID+'_Hint').setHTML(this.data.attrs.hint);if(visibility)
overlay.addClass("rn_AlwaysVisibleHint");return new this.Y.Overlay({visible:visibility,align:{node:this.displayField,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.TR]},bodyContent:overlay,render:this.Y.one(this.baseSelector)});},_toggleHint:function(hideOrShow){if(this._hintOverlay&&this._hintOverlay[hideOrShow]&&!this.data.attrs.always_show_hint)
this._hintOverlay[hideOrShow]();},_realignHint:function(delay){if(this._hintOverlay){if(delay){this.Y.later(delay,this._hintOverlay,this._hintOverlay.align);}
else{this._hintOverlay.align();}}},swapLabel:function(container,requiredLevel,label,template){var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,requiredLevel:requiredLevel,requiredMarkLabel:RightNow.Interface.getMessage("FIELD_REQUIRED_MARK_LBL"),requiredLabel:RightNow.Interface.getMessage("REQUIRED_LBL")};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},updateRequiredLevel:function(evt,constraint){var newLevel=constraint[0].constraint;if(newLevel>this.data.attrs.max_lvl||this.data.attrs.required_lvl===newLevel)return;if(this.data.attrs.required_lvl>0&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
this.swapLabel(this.Y.one(this.baseSelector+'_Label'),newLevel,this.data.attrs.label_input,this.getStatic().templates.label);this.data.attrs.required_lvl=newLevel;if(!newLevel){this.displayField.removeClass("rn_ErrorField");this.Y.one(this.baseSelector+"_Label").removeClass("rn_ErrorLabel");}
else{this._errorLocation="";this._checkSelectionErrors();}},_checkSelectionErrors:function(){var currentNode=this.tree.getSelectedNode(),currentDepth=(currentNode?currentNode.depth:0)+1,noErrorsFound=true;this._removeErrorMessages();this._notRequiredDueToProductLinking=false;if(this.data.js.linkingOn&&this.data.js.data_type==="Category"&&this._linkedCategorySubset){if(this.tree.getNumberOfNodes()===1){this._notRequiredDueToProductLinking=true;}}
if(this.data.attrs.required_lvl||!this.userHasFullProdcatPermissions()){if(!this.tree){this.buildTree();}
if(!this._notRequiredDueToProductLinking&&(!currentNode||!currentNode.value||((!currentNode.loaded||currentNode.hasChildren)&&(currentDepth<this.data.attrs.required_lvl)))){var message=(!currentNode||!currentNode.value)?this.data.attrs.label_nothing_selected:this.data.attrs.label_required;this._displayErrorMessage(message,currentNode);noErrorsFound=false;}}
if(currentNode&&currentNode.value&&!this.checkPermissionsOnNode(currentNode.value)){this._displayErrorMessage(this.data.attrs.label_not_permissioned,currentNode);noErrorsFound=false;}
return noErrorsFound;},_removeErrorMessages:function(){this.displayField.removeClass("rn_ErrorField");if(this.errorLabel){this.errorLabel.replaceClass('rn_ErrorLabel','rn_Hidden');}
RightNow.UI.hide(this._accessibleErrorMessageDiv);this._realignHint();if(!this.data.attrs.required_lvl&&this.requiredLabel){this.requiredLabel.replaceClass('rn_Required','rn_Hidden');}},_displayErrorMessage:function(message,currentNode){this.displayField.addClass("rn_ErrorField");if(this.requiredLabel){this.requiredLabel.replaceClass('rn_Hidden','rn_Required');}
message=(message.indexOf("%s")>-1)?RightNow.Text.sprintf(message,currentNode.label):message;if(this.errorLabel){this.errorLabel.setHTML(message).replaceClass('rn_Hidden','rn_ErrorLabel');}
var label=this.data.attrs.label_error||this.data.attrs.label_input;if(this._errorLocation){var commonErrorDiv=this.Y.one('#'+this._errorLocation);if(commonErrorDiv){commonErrorDiv.append("<div data-field=\""+this._fieldName+"\"><b><a href='#' onclick='document.getElementById(\""+this.displayField.get('id')+"\").focus(); return false;'>"+
label+" - "+message+"</a></b></div> ");}}
if(this.dialog){this.dialog.addErrorMessageForValue(message,currentNode.value);}
this._realignHint();}});
RightNow.Widgets.Grid=RightNow.ResultsDisplay.extend({overrides:{constructor:function(){this.parent();this._modActionPerformed=false;this._contentName=this.baseSelector+'_Content';this._contentDiv=this.Y.one(this._contentName);this._gridName=this.baseSelector+'_Grid';this._loadingDiv=this.Y.one(this.baseSelector+'_Loading');this._dataTable=null;this._columns=[];this._data=[];this._sortOn=null;RightNow.Event.subscribe('evt_getFiltersRequest',this._fireSortEvent,this);RightNow.Event.subscribe('evt_sortTypeResponse',this._onSortTypeResponse,this);this.searchSource().on('response',this._onReportChanged,this).on('send',this._searchInProgress,this);this._setFilter();if(this.data.attrs.headers){this._generateYUITable(this.data.js.headers);this._setSortableLabel(this.data.js.headers);}
else{this._contentDiv.addClass('rn_NoHeader');}
if(RightNow.Event.isHistoryManagerFragment()){this._setLoading(true);}
else{this._updateAriaAlert((this._dataTable&&this._data.length>0)?this.data.attrs.label_screen_reader_search_success_alert:this.data.attrs.label_screen_reader_search_no_results_alert);}}},_setFilter:function(){this._sortFilters=new RightNow.Event.EventObject(this,{filters:{searchName:this.data.js.searchName,report_id:this.data.attrs.report_id,data:{}}});this._setSortData();var eo=new RightNow.Event.EventObject(this,{filters:{report_id:this.data.attrs.report_id,token:this.data.js.token,allFilters:this.data.js.filters,format:this.data.js.format}});eo.filters.format.parmList=this.data.attrs.add_params_to_url;this.searchSource().fire('setInitialFilters',eo);},_setSortData:function(columnID,sortDirection){this._sortFilters.filters.data.col_id=(columnID||this.data.js.columnID);this._sortFilters.filters.data.sort_direction=(sortDirection||this.data.js.sortDirection);},_searchInProgress:function(evt,args){var params=args[1];if(!params||!params.newPage)
{document.body.setAttribute('aria-busy','true');this._setLoading(true);}},_setLoading:function(loading){var toOpacity=1,method='removeClass';if(loading){this._contentDiv.setStyle('height',this._contentDiv.get('offsetHeight')+'px');toOpacity=0;method='addClass';}
this._contentDiv.transition({opacity:toOpacity,duration:0.4});this._loadingDiv[method]('rn_Loading');},_onReportChanged:function(type,args){var sortData=RightNow.Event.getDataFromFiltersEventResponse(args,this.data.js.searchName,this.data.attrs.report_id);if(sortData)
this._sortFilters.filters.data=sortData;else
this._setSortData();var newdata=args[0].data;this._setLoading(false);var currentPageSize=newdata.per_page,cols=newdata.headers.length,data={instanceID:this.instanceID,tableID:this.baseDomID+'_Grid',caption:this.data.attrs.label_caption,attrs:this.data.attrs,headers:[],rows:[],js:this.data.js,hiddenHeaders:[],hiddenRows:[]},anchor,width,row,hiddenRow,i,j,td,currentDataLength;if(newdata.error){RightNow.UI.Dialog.messageDialog(newdata.error,{"icon":"WARN"});}
if(this.data.attrs.headers){if(newdata.row_num){data.headers.push({label:this.data.attrs.label_row_number});}
for(i=0;i<cols;i++){td={label:newdata.headers[i].heading};if(width=newdata.headers[i].width){td.style='width: "'+width+'%"';}
if(newdata.headers[i].visible){data.headers.push(td);}
else{data.hiddenHeaders[i]=td;}}}
if(newdata.total_num>0){currentDataLength=newdata.data.length;for(i=0;i<currentPageSize&&i<currentDataLength;i++){row=[];hiddenRow=[];if(newdata.row_num){row.push(i+1);}
for(j=0;j<cols;j++){if(!newdata.headers[j].visible){hiddenRow[j]=newdata.data[i][j];}
else{row.push(newdata.data[i][j]);}}
data.rows.push(row);data.hiddenRows.push(hiddenRow);}
if(this.data.attrs.hide_when_no_results)
RightNow.UI.show(this.baseSelector);}
else if(this.data.attrs.hide_when_no_results){RightNow.UI.hide(this.baseSelector);}
this._contentDiv.set('innerHTML',new EJS({text:this.getStatic().templates.dataTable}).render(data));if(this.data.attrs.headers){this._generateYUITable(newdata.headers);this._setSortableLabel(newdata.headers);if(!this._modActionPerformed){this._setFocusAfterSort(this._sortFilters.filters.data.col_id);}}
this._contentDiv.setStyle('height','auto');RightNow.Url.transformLinks(this._contentDiv);document.body.setAttribute('aria-busy','false');if(!this._modActionPerformed){this._updateAriaAlert((newdata.total_num>0)?this.data.attrs.label_screen_reader_search_success_alert:this.data.attrs.label_screen_reader_search_no_results_alert);}
else{this._modActionPerformed=false;}},_setTableData:function(headers){var dataTypes=this.data.js.dataTypes,sortDirection=this._sortFilters.filters.data.sort_direction,sortColumnID=this._sortFilters.filters.data.col_id,sortDirectivesPresent=(sortDirection!==null&&sortColumnID!==null),rowNumbersPresent=this.data.js.rowNumber,key,columnID,header,rowObj,rows,i,tableHeaderID,iconColumns=this.data.attrs.icon_cols.split(",")||[];this._columns=[];this._data=[];if(rowNumbersPresent){this._columns.push({key:'c0',label:this.data.attrs.label_row_number,sortable:false});}
for(i=0;i<headers.length;i++){header=headers[i];if(!header.visible)
continue;columnID=header.col_id;key='c'+columnID;tableHeaderID=this.instanceID+'_'+key;if(sortDirectivesPresent&&sortColumnID===columnID){this._sortOn={key:key,dir:sortDirection};}
var isSortable=!this.Y.Lang.isArray(this.data.attrs.exclude_from_sorting)||this.Y.Array.indexOf(this.data.attrs.exclude_from_sorting,(i+1).toString())===-1;this._columns.push({id:tableHeaderID,key:key,label:(iconColumns.indexOf(columnID.toString())!==-1)?"<span class='rn_ScreenReaderOnly'>"+header.heading+"</span>":header.heading,columnID:columnID,sortable:isSortable,emptyCellValue:"&nbsp;",allowHTML:true,className:"rn_GridColumn_"+columnID,title:isSortable?header.heading:"",cellTemplate:'<td class="{className}" headers="'+tableHeaderID+'">{content}</td>'});}
if(rows=this.Y.all(this._gridName+' tbody tr')){rows.each(function(row){rowObj={};row.all('td').each(function(td,i){rowObj[this._columns[i].key]=td.getContent();},this);this._data.push(rowObj);},this);}},_generateYUITable:function(headers){this._setTableData(headers);this._dataTable=new this.Y.DataTable({data:this._data,columns:this._columns,caption:this.data.attrs.label_caption,strings:{asc:RightNow.Interface.getMessage('ASCENDING_LBL'),desc:RightNow.Interface.getMessage('DESCENDING_LBL'),sortBy:RightNow.Text.sprintf(RightNow.Interface.getMessage('SORT_BY_S_LBL'),'{title}'),reverseSortBy:RightNow.Interface.getMessage('REVERSE_SORT_BY_COLUMN_LBL')}});this._dataTable.on('sort',this._onSort,this);this.Y.one(this._gridName).remove();this._dataTable.render(this._contentName);if(!this._data.length){this._dataTable.showMessage(RightNow.Interface.getMessage('NO_RECORDS_FOUND_MSG'));this._dataTable.setAttrs({'sortable':false});this._sortOn=null;}
else{this.Y.one(this._contentName+' .yui3-datatable-message-content').remove();}
if(this._sortOn){this._setSortedColumn(this._sortOn.key,this._sortOn.dir);}
this.Y.all(this._contentName+" th .yui3-datatable-sort-liner").each(function(node){node.setAttribute('aria-labelledby',node.ancestor('th').get('id'));},this);},_setSortableLabel:function(headers){var yuiHeaderPrefix='yui3-datatable-header.rn_GridColumn_',table=this.Y.one('#'+this._dataTable.get('id')),columnID=0;for(var i=0;i<headers.length;i++){if(headers[i].visible){columnID=i+1;header=table.one('th.'+yuiHeaderPrefix+columnID);if(header!==null){headerLiner=header.one('.yui3-datatable-sort-liner');if(headerLiner!==null){headerLiner.append('<span class="rn_ScreenReaderOnly">'+'&nbsp;'+this.data.attrs.label_sortable+'</span>');}}}}},_onSort:function(sortEvent){if(!sortEvent.sortBy)return;this.Y.Object.each(sortEvent.sortBy[0],function(value,columnID){this._setSortData(parseInt(RightNow.Text.getSubstringAfter(columnID,'c'),10),this._getDirectionToSort(columnID));},this);RightNow.Event.fire("evt_sortChange",this._sortFilters);this.searchSource().fire('search',this._sortFilters);sortEvent.halt();},_setFocusAfterSort:function(columnID){var yuiHeaderPrefix='yui3-datatable-header.rn_GridColumn_',header=this.Y.one('#'+this._dataTable.get('id')).one('th.'+yuiHeaderPrefix+columnID);if(header){headerLiner=header.one('.yui3-datatable-sort-liner');if(headerLiner!==null){headerLiner.focus();}}},_directions:{desc:2,asc:1},_getDirectionToSort:function(columnID){var yuiPrefix='yui3-datatable-',header=this.Y.one('#'+this._dataTable.get('id')).one('th.'+yuiPrefix+'col-'+columnID+'.'+yuiPrefix+'sortable-column');return(header&&header.hasClass(yuiPrefix+'sorted-desc'))?this._directions.asc:this._directions.desc;},_setSortedColumn:function(columnID,dir){var yuiPrefix='yui3-datatable-',sortedClass=yuiPrefix+'sorted',descClass=yuiPrefix+'sorted-desc',table=this.Y.one('#'+this._dataTable.get('id')),header=table.one('th.'+yuiPrefix+'col-'+columnID+'.'+yuiPrefix+'sortable-column');if(header){var headerLiner=header.one('.yui3-datatable-sort-liner'),sortLabel=(dir===this._directions.asc)?RightNow.Interface.getMessage('SORTED_ASCENDING_LBL'):RightNow.Interface.getMessage('SORTED_DESCENDING_LBL');headerLiner.append('<span class="rn_ScreenReaderOnly">'+sortLabel+'</span>');}
if(!this._prevSorted&&this.data.js.columnID){this._prevSorted='c'+this.data.js.columnID;}
if(this._prevSorted){table.all('.'+yuiPrefix+'col-'+this._prevSorted).removeClass(sortedClass).removeClass(descClass);}
if(header){if(dir===this._directions.asc){header.removeClass(descClass);}
else{header.addClass(descClass);}
header.addClass(sortedClass);}
table.all('td.'+yuiPrefix+'col-'+columnID).addClass(sortedClass);this._prevSorted=columnID;},_fireSortEvent:function(){RightNow.Event.fire('evt_searchFiltersResponse',new RightNow.Event.EventObject(this,{filters:this._sortFilters}));},_onSortTypeResponse:function(type,args){var evt=args[0];this._setSortData(evt.filters.data.col_id,evt.filters.data.sort_direction);},_updateAriaAlert:function(text){this._ariaAlert=this._ariaAlert||this.Y.one(this.baseSelector+'_Alert');if(this._ariaAlert){this._ariaAlert.set('innerHTML',text);}}});
RightNow.Widgets.ModerationGrid=RightNow.Widgets.Grid.extend({overrides:{constructor:function(){this._confirmDialog=null;this._actionEventArgument=null;this._contentName=this.baseSelector+'_Content';this._hasValidationMessage=false;this._errorDisplay=null;this.Y.one(this._contentName).delegate('click',this._toggleSelection,'table th input[type="checkbox"]',this);this.Y.one(this._contentName).delegate('click',this._onRowSelection,'table td input[type="checkbox"]',this);RightNow.Event.subscribe('evt_moderationAction',this._onModerationAction,this);this._eo=new RightNow.Event.EventObject(this,{filters:{report_id:this.data.attrs.report_id,per_page:this.data.attrs.per_page,page:RightNow.Url.getParameter('page')||1}});this.parent();this.searchSource().on("search",this._onReportSearch,this);this.Y.augment(this,RightNow.Avatar);},_onReportSearch:function(type,args){if(this._errorDisplay&&args[0].w_id!==this.instanceID){this._errorDisplay.hide();}},_onReportChanged:function(type,args){this._toggleProdCatColumn(args);if(args[0].data.data!==undefined&&args[0].data.data.length!==undefined&&args[0].data.data.length=='0'&&RightNow.Url.getParameter('page')!=='1'){this._eo.filters.page=RightNow.Url.getParameter('page')-1;this.searchSource().fire("appendFilter",this._eo).fire("search",this._eo);}
else
this.parent(type,args);},_generateYUITable:function(headers){var data={headers:headers,currentRow:0,selectAll:this.data.attrs.label_select_all,rowExist:this.Y.all(this._contentName+' table td input[type="checkbox"]').size()>0};var ejsHeaderObj=new EJS({text:this.getStatic().templates.tableHeader});for(var i=0;i<headers.length;i++){data.currentRow=i;headers[i].heading=this.Y.Lang.trim(ejsHeaderObj.render(data));}
this.parent(headers);}},_toggleProdCatColumn:function(args){var prodColumnIndex=this.data.attrs.product_column_index-1;var catColumnIndex=this.data.attrs.category_column_index-1;if(this.data.attrs.prodcat_type==='Category'){if(args[0].data.headers){this.Y.Object.each(Object.keys(args[0].data.headers[catColumnIndex]),function(key){args[0].data.headers[prodColumnIndex][key]=args[0].data.headers[catColumnIndex][key];},this);args[0].data.headers[prodColumnIndex].visible=true;}
if(args[0].data.data){for(i=0;i<args[0].data.data.length;i++){args[0].data.data[i][prodColumnIndex]=args[0].data.data[i][catColumnIndex];}}}},_toggleSelection:function(e){this.Y.all(this._contentName+' table td input[type=checkbox]').set("checked",e.currentTarget.get('checked'));this._onRowSelection();},_onRowSelection:function(e){var isRowSelected=this.Y.one(this._contentName+' table td input:checked')?true:false;this._actionEventObj=new RightNow.Event.EventObject(this,{data:{w_id:this.data.info.w_id,isRowSelected:isRowSelected,report_id:this.data.attrs.report_id}});RightNow.Event.fire("evt_rowSelected",this._actionEventObj);},_confirmAndSubmitRequest:function(){var buttons=[{text:RightNow.Interface.getMessage("YES_LBL"),handler:{fn:this._submitRequest,scope:this}},{text:RightNow.Interface.getMessage("NO_LBL"),handler:{fn:this._hideConfirmDialog,scope:this},isDefault:true}];if(!this._confirmDialog){var dialogBody=this.Y.Node.create("<div>").set("innerHTML",this.data.attrs.label_delete_social_object_confirm);this._confirmDialog=RightNow.UI.Dialog.actionDialog(RightNow.Interface.getMessage("WARNING_LBL"),dialogBody,{"buttons":buttons});this.Y.DOM.addClass(this._confirmDialog.id,'rn_dialog');RightNow.UI.Dialog.addDialogEnterKeyListener(this._confirmDialog,this._submitRequest,this);}
this._confirmDialog.show();},_getSelectedObjectIDs:function(action_name){var rowDataExist=false,selectedObjectIDs=[];this.Y.all(this._contentName+' table td input[type="checkbox"]').each(function(inputObj){rowDataExist=true;if(inputObj.get('checked')){var objectID=this.Y.JSON.parse(inputObj.get('value'));if(this.Y.Lang.isArray(objectID)){selectedObjectIDs.push((this.Y.Array.indexOf(['suspend_user','restore_user'],action_name)!==-1)?objectID[1]:objectID[0]);}
else{selectedObjectIDs.push(objectID);}}},this);return{"rowDataExist":rowDataExist,"object_ids":this.Y.Array.dedupe(selectedObjectIDs)};},_onModerationAction:function(evt,args){this._modActionPerformed=true;this._actionEventArgument=args;if(this.data.attrs.report_id===parseInt(this._actionEventArgument[0].data.report_id,10)){var selectedObjects=this._getSelectedObjectIDs(this._actionEventArgument[0].data.action_name);if(!selectedObjects.rowDataExist){return false;}
this._actionEventArgument.selectedObjectIDs=selectedObjects.object_ids;this._errorDisplay=this.Y.one('#'+this._actionEventArgument[0].data.message_location);if(this._actionEventArgument.selectedObjectIDs.length===0){this._addErrorOrSuccessMessage(this._errorDisplay,this.data.attrs.label_select_social_object_error);return false;}
else if(this._actionEventArgument.selectedObjectIDs.length>this.data.attrs.max_allowed_selected_rows){this._addErrorOrSuccessMessage(this._errorDisplay,RightNow.Text.sprintf(this.data.attrs.label_max_allowed_selected_rows_error,this.data.attrs.max_allowed_selected_rows));return false;}
if(this.data.js.statuses.deleted&&typeof this.data.js.statuses.deleted[this._actionEventArgument[0].data.action]!=='undefined'){this._confirmAndSubmitRequest();return;}
this._submitRequest();}},_submitRequest:function(){this._hideConfirmDialog();this._removeErrorMessage(this._errorDisplay);this._moderationActionSelector=this._actionEventArgument[0].data.moderation_action_baseselector;var eventObj=new RightNow.Event.EventObject(this,{data:{w_id:this.data.info.w_id,object_ids:this._actionEventArgument.selectedObjectIDs.join(','),action:this._actionEventArgument[0].data.action,action_name:this._actionEventArgument[0].data.action_name}});if(this.data.attrs.object_type==='SocialQuestion'&&this._actionEventArgument[0].data.action_name==='move'){eventObj.data.prodcat_id=this._actionEventArgument[0].data.prodcat_id;eventObj.data.prodcat_type=this._actionEventArgument[0].data.prodcat_type;}
this.Y.all(this._moderationActionSelector+" button").set("disabled",true);RightNow.Ajax.makeRequest(this.data.attrs.moderate_social_object_ajax,eventObj.data,{successHandler:this._onActionSuccess,failureHandler:this._onActionFailed,scope:this,data:eventObj,json:true});},_hideConfirmDialog:function(){if(this._confirmDialog){this._confirmDialog.hide();}},_onActionSuccess:function(response,eventObj){if(typeof response.success!=='undefined'||typeof response.error!=='undefined'){this._addErrorOrSuccessMessage(this._errorDisplay,response);}
if(typeof response.report_refresh_required==='undefined'||response.report_refresh_required===true){this.searchSource().clearCache();this._eo.filters.page=RightNow.Url.getParameter('page')||1;this.searchSource().fire("appendFilter",this._eo).fire("search",this._eo);}
else{this.Y.all(this._moderationActionSelector+" button").set("disabled",false);}},_onActionFailed:function(response,eventObj){this.Y.all(this._moderationActionSelector+" button").set("disabled",false);this._addErrorOrSuccessMessage(this._errorDisplay,response.ajaxError);},_addErrorOrSuccessMessage:function(errorDisplay,message){this._hasValidationMessage=true;if(!errorDisplay)return;errorDisplay.show();if(!this.Y.DOM.inViewportRegion(this.Y.Node.getDOMNode(errorDisplay),true)){(new this.Y.Anim({node:this.Y.one(document.body),to:{scrollTop:errorDisplay.get('offsetTop')-40},duration:0.5})).run();}
this._removeErrorMessage(errorDisplay);var newMessage=message||this.data.attrs.label_requested_action_not_performed_error,cssMsgClass="rn_MessageBox rn_ErrorMessage";errorDisplay.removeClass();if(this.Y.Lang.isObject(message)){if(message.success){cssMsgClass="rn_MessageBox rn_InfoMessage";var actualMessage=message.success;}
else if(message.error){var actualMessage=message.error;}
if(typeof actualMessage!=='undefined'&&errorDisplay&&actualMessage.length>0){newMessage=(actualMessage.length===1)?actualMessage[0]:actualMessage.shift()+'<br/><br/>'+this.Y.Object.values(actualMessage).join('<br>');}}
errorDisplay.addClass(cssMsgClass).set("innerHTML",newMessage);errorDisplay.set('tabIndex',0);this.Y.Lang.later(500,errorDisplay,errorDisplay.focus);if(!message.success){errorDisplay.one("h2")?errorDisplay.one("h2").setHTML(RightNow.Interface.getMessage("ERRORS_LBL")):errorDisplay.prepend("<h2>"+RightNow.Interface.getMessage("ERROR_LBL")+"</h2>");errorDisplay.one("h2").setAttribute('role','alert');}},_removeErrorMessage:function(errorDisplay){this._hasValidationMessage=false;if(!errorDisplay)return;errorDisplay.setHTML('').set('className','');}});
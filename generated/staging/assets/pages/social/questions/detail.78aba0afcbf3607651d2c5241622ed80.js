
RightNow.Field=RightNow.Field||RightNow.EventProvider.extend({overrides:{constructor:function(){this.parent();this.data.js.name&&(this._fieldName=this.data.js.name,this._inputSelector=this.baseSelector+"_"+this._fieldName.replace(/\./g,"\\."),this.parentForm().addField(this._fieldName,this),this._addEventHandler("change"),this._addEventHandler("constraintChange",{post:function(){this.parentForm().fire("formUpdated")}}),this.parentForm().on("collect",this.onCollect,this));this.excludeFromValidation=this.data.attrs.hide_on_load||!1}},setConstraints:function(a){this.Y.Object.each({required:function(a){return"false"===a?!1:!!a},required_lvl:function(a){return parseInt(a,10)},min_required_attachments:function(a){return parseInt(a,10)}},function(b,c){a[c]&&(a[c]=b(a[c]))});this.fire("constraintChange",a);this.Y.Object.each(a,function(a,c){this.fire("constraintChange:"+c,{constraint:a})},this);this.parentForm().fire("formUpdated")},onCollect:function(){return this.isVisible()?this._fieldName:!1},isVisible:function(){return!this.excludeFromValidation},hide:function(){RightNow.UI.hide(this.baseSelector);this.excludeFromValidation=!0;var a=this.Y.one("#"+this.lastErrorLocation);this.lastErrorLocation&&a&&a.all("[data-field='"+this._fieldName+"']").remove();this.parentForm().fire("formUpdated")},show:function(){RightNow.UI.show(this.baseSelector);this.excludeFromValidation=!1;this.parentForm().fire("formUpdated")},getFieldName:function(){return this._fieldName},parentForm:function(a){return RightNow.Form.find(a||this.baseDomID,this.instanceID)},getParentFormID:function(){return RightNow.Form.find(this.baseDomID,this.instanceID,!0)},createEventObject:function(){return new RightNow.Event.EventObject(this,{data:{name:this.data.js.name,value:this.getValue(),required:this._isRequired(),form:this._parentForm}})},is:function(a){var b=this.data.js.type;return"text"===a?"Integer"===b||"String"===b||"Thread"===b:"selection"===a?"Boolean"===b||"NamedIDLabel"===b||"Country"===b||"StateOrProvince"===b:"date"===a?"Date"===b||"DateTime"===b:"email"===a?this.isCommonEmailType()||!0===this.data.js.email:"url"===a?this.data.js.url?!0:!1:"product"===a?"ServiceProduct"===b:"category"===a?"ServiceCategory"===b:"attachment"===a?"FileAttachmentIncident"===b:"password"===a?"Contact.NewPassword"===this._fieldName||"Contact.NewPassword_Validate"===this._fieldName:!1},isCommonEmailType:function(){return"Contact.Emails.PRIMARY.Address"===this._fieldName||"Contact.Emails.ALT1.Address"===this._fieldName||"Contact.Emails.ALT2.Address"===this._fieldName||"Incident.CustomFields.c.alternateemail"===this._fieldName},_isRadio:function(){var a=this.input.get("type");return this.Y.Lang.isArray(a)&&"radio"===a[0]},_reportError:function(a){this._errors=this._errors||[];this._errors.push(a)},validate:function(a,b){this._errors=a||[];this._value="undefined"!==typeof b?b:this.getValue();this._checkRequired();this._checkValue();this.is("email")?this._errors.length||this._checkEmail():this.is("url")?this._errors.length||this._checkUrl():this._checkData();return!this._errors.length},_checkValue:function(){var a,b,c;if("Integer"===this.data.js.type){if(""!==this._value&&"number"!==typeof this._value)return this._reportError(RightNow.Interface.getMessage("VALUE_MUST_BE_AN_INTEGER_MSG"));a=parseInt(this._value,10);b=parseInt(this.data.js.constraints.maxValue,10);c=parseInt(this.data.js.constraints.minValue,10);if(this.Y.Lang.isNumber(b)&&a>b)return this._reportError(RightNow.Interface.getMessage("VALUE_IS_TOO_LARGE_MAX_VALUE_MSG")+b+")");if(this.Y.Lang.isNumber(c)&&a<c)return this._reportError(RightNow.Interface.getMessage("VALUE_IS_TOO_SMALL_MIN_VALUE_MSG")+c+")")}else if("Contact.NewPassword"===this.data.js.name&&this.data.js.passwordLength&&(a=RightNow.Text.Encoding.utf8Length(this._value),b=this.data.js.passwordLength,a<b))return this._reportError(RightNow.Text.sprintf(1===b-a?RightNow.Interface.getMessage("CONTAIN_1_CHARACTER_MSG"):RightNow.Interface.getMessage("PCT_D_CHARACTERS_MSG"),b));if(null!==this._value&&(this.data.js.constraints.maxLength||this.data.js.constraints.minLength)){a=this._value.length;c=this.data.js.constraints.maxLength;b=this.data.js.constraints.minLength;if(c&&c<a)return this._reportError(RightNow.Text.sprintf(1===a-c?RightNow.Interface.getMessage("EXCEEDS_SZ_LIMIT_PCT_D_CHARS_1_LBL"):RightNow.Interface.getMessage("EXCEEDS_SZ_LIMIT_PCT_D_CHARS_PCT_D_LBL"),c,a-c));if(b&&b>a)return this._reportError(RightNow.Text.sprintf(1===b-a?RightNow.Interface.getMessage("CONTAIN_1_CHARACTER_MSG"):RightNow.Interface.getMessage("PCT_D_CHARACTERS_MSG"),b))}},_checkData:function(){if(null!==this._value&&""!==this._value){var a=this.data.js.constraints?this.data.js.constraints.regex:null;if(RightNow.Text.beginsWith(this._fieldName,"Contact.Phones.")||"Contact.Address.PostalCode"===this._fieldName){if(!/^[-A-Za-z0-9,# +.()]+$/.test(this._value))return this._reportError("Contact.Address.PostalCode"===this._fieldName?RightNow.Interface.getMessage("PCT_S_IS_AN_INVALID_POSTAL_CODE_MSG"):RightNow.Interface.getMessage("PCT_S_IS_AN_INVALID_PHONE_NUMBER_MSG"))}else{if(a&&!(new RegExp(a)).test(this._value))return this._reportError("Contact.Login"===this._fieldName?RightNow.Interface.getMessage("PCT_S_CONT_SPACES_DOUBLE_QUOTES_LBL"):RightNow.Interface.getMessage("PCT_S_DIDNT_MATCH_EXPECTED_INPUT_LBL"));if(this.data.js.channelID&&/\s/.test(this._value))return this._reportError(RightNow.Interface.getMessage("CONTAIN_SPACES_PLEASE_TRY_MSG"))}}},_checkEmail:function(){if(this._value)if("Incident.CustomFields.c.alternateemail"===this._fieldName)for(var a=0,b=this._value.split(/[,;]+/),c;a<b.length;a++)(c=this.Y.Lang.trim(b[a]))&&!RightNow.Text.isValidEmailAddress(c)&&this._reportError(RightNow.Interface.getMessage("PCT_S_IS_INVALID_MSG"));else RightNow.Text.isValidEmailAddress(this._value)||this._reportError(RightNow.Interface.getMessage("PCT_S_IS_INVALID_MSG"))},_checkUrl:function(){null===this._value||""===this._value||RightNow.Text.isValidUrl(this._value)||this._reportError(RightNow.Interface.getMessage("IS_NOT_A_VALID_URL_MSG"))},_isRequired:function(){return this.is("product")||this.is("category")?this.data.attrs.required_lvl&&0<this.data.attrs.required_lvl||!1:this.is("attachment")?this.data.attrs.min_required_attachments&&0<this.data.attrs.min_required_attachments||!1:this.data.attrs.required?!0:!1},_checkRequired:function(){var a=!1;if(this._isRequired())if(this.is("date"))a=!/\d/.test(this._value);else if(""===this._value||!1===this._value||null===this._value)a=!0;a&&this._reportError(this.data.attrs.label_required);return a},getValue:function(){var a;if(this.is("selection"))this.input.size&&this._isRadio()?(a="",this.input.item(0).get("checked")?a=this.input.item(0).get("value"):this.input.item(1).get("checked")&&(a=this.input.item(1).get("value"))):a="checkbox"===this.input.get("type")?this.input.get("checked"):this.input.get("value");else if(this.is("date")){a="";var b={day:32,month:13,year:1900,hour:0,minute:0};this.input.each(function(a){var e=a.get("name").toLowerCase();this.Y.Object.each(b,function(f,d){null!==e.match(new RegExp(d+"$"))&&(b[d]=parseInt(a.get("value"),10))})},this);a=1900<b.year?b.year+"-"+b.month+"-"+b.day+" "+b.hour+":"+b.minute+":00":""}else this.is("product")||this.is("category")?a=this._selectedNode?this._selectedNode.hierValue||0:this._currentValue||0:this.input&&!this.is("attachment")&&(a=this._getTextFieldValue(this.input));return a},politeFocus:function(a){a&&(this.Y.all("[role=alert], [aria-live=assertive]").some(function(a){return!a.hasClass("rn_Hidden")&&(a.get("textContent")||a.get("innerText"))},this)||a.focus())},_getTextFieldValue:function(a){if(!a)return null;this._trimField(a);a=a.get("value");"Integer"===this.data.js.type?a=a&&!isNaN(Number(a))&&parseInt(a,10)===parseFloat(a)?parseInt(a,10):a:this.is("text")&&!this.is("password")&&""===a&&(a=null);return a},_trimField:function(a){a=a||this.input;if(this.is("text")&&!this.is("password")){var b=a.get("value");this.Y.Lang.isUndefined(b)||""===b||a.set("value",this.Y.Lang.trim(b))}},_initializeHint:function(){if(!this.data.attrs.always_show_hint)if(this.Y.Overlay){var a=this.Y.Node.create("<span id='"+this.baseDomID+"_Hint' aria-hidden='true'>"+this.data.attrs.hint+"</span>"),b={node:this.baseSelector,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.BL]};this.data.info&&"RightNow.Widgets.SelectionInput"===this.data.info.class_name&&"Boolean"!==this.data.js.type?(a.addClass("rn_HintBoxRight"),b.node=this.Y.one(this.baseSelector+" select"),b.points=[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.TR]):a.addClass("rn_HintBox");a=new this.Y.Overlay({bodyContent:a,visible:!1,zIndex:3,align:b});if(this.Y.UA.webkit&&("checkbox"===this.input.get("type")||this._isRadio())){for(var c=this.input instanceof this.Y.NodeList?this.input.item(this.input.size()-1):this.input;c.next();)c=c.next();this.input.on("click",function(){c.focus();a.show()})}else this.input.on("focus",function(){a.show()});this.input.on("blur",function(){a.hide()});a.render(this.baseSelector)}else this.input.get("parentNode").append(this.Y.Node.create("<span class='rn_HintText' aria-hidden='true'>"+this.data.attrs.hint+"</span>"))}},{requires:{standard:["overlay"]}});
RightNow.ProductCategory=RightNow.EventProvider.extend({initializeTreeView:function(a){this.dataType=a;this.displayField||(this.displayField=this.Y.one(this.baseSelector+"_"+this.dataType+"_Button"));this.buildPanel();this.Y.one(this.baseSelector+"_LinksTrigger").on("click",this.showAccessibleView,this);RightNow.Event.on("evt_accessibleTreeViewGetResponse",this.getAccessibleTreeViewResponse,this);RightNow.Event.on("evt_menuFilterGetResponse",this.getSubLevelResponse,this);this.data.js.hierData&&this.data.js.hierData[0]&&this.data.js.hierData[0].length&&this.buildTree()},buildPanel:function(){this.dropdown=new this.Y.RightNowTreeViewDropdown({srcNode:this.Y.one(this.baseSelector+"_TreeContainer").removeClass("rn_Hidden"),render:this.Y.one(this.baseSelector),trigger:this.displayField,visible:!1});this.dropdown.once("show",this.Y.bind(this.buildTree,this,!1));this.dropdown.on("show",function(){this.tree.focusOnSelectedNode()},this)},buildTree:function(a){if(!this.tree||a){this.tree&&this.tree.clear();this.data.js.linkingOn&&"Category"===this.dataType&&this.data.js.link_map[0]&&(this.data.js.hierData=this.data.js.link_map);this.tree=new this.Y.RightNowTreeView({hierarchyData:this.data.js.hierData,contentBox:this.Y.one(this.baseSelector+"_Tree").setStyles({"overflow-y":"auto",display:"block"})});this.tree.render();this.data.js.hierData&&this.data.js.hierDataNone&&delete this.data.js.hierData;this.tree.on("enterKey",this.selectNode,this);this.tree.on("dynamicNodeExpand",this.getSubLevelRequest,this);if(this.data.attrs.show_confirm_button_in_dialog)this.dropdown.set("confirmButton",this.Y.one(this.baseSelector+"_"+this.data.js.data_type+"_ConfirmButton")),this.dropdown.set("cancelButton",this.Y.one(this.baseSelector+"_"+this.data.js.data_type+"_CancelButton")),this.dropdown.on("confirm",function(){this.selectNode(this.tree.getFocusedNode())},this),this.Y.one(this.baseSelector+"_TreeContainer").setStyle("display","block");else this.tree.on("click",this.selectNode,this);this.tree.get("value")&&this.displaySelectedNodesAndClose(!1);this.dropdown.set("treeView",this.tree)}},pruneNonPermissionedAccessibleNodes:function(a){this.checkIdsAreValid("readableProdcatIds");if(0===this.data.js.readableProdcatIds.length)return a;var b=[];this.Y.Array.each(a,function(a){(this.checkPermissionsOnNode(a[1])||this.hasPermissionedAccessibleChildren(a))&&b.push(a)},this);return b},hasPermissionedAccessibleChildren:function(a){return this.checkForPermissionedChildren(a[1],a.level+1)},hasPermissionedChildren:function(a,b){return a.hasChildren?this.checkForPermissionedChildren(a.id,b):!1},checkForPermissionedChildren:function(a,b){if(!(this.data&&this.data.js&&this.data.js.readableProdcatIds&&this.Y.Lang.isArray(this.data.js.readableProdcatIds)))throw Error("Widget does not have this.data.js.readableProdcatIds attribute set, or its value is not an array");if(0===this.data.js.readableProdcatIds.length)return!0;var c="Level"+b;return this.Y.Array.some(this.data.js.permissionedProdcatList,function(b){if(b[c]===a&&b.ID!==a)return!0},this)},checkPermissionsOnNode:function(a){var b=this.data.js.permissionedProdcatIds&&this.Y.Lang.isArray(this.data.js.permissionedProdcatIds),c=this.data.js.readableProdcatIds&&this.Y.Lang.isArray(this.data.js.readableProdcatIds);if(!b&&!c)throw Error("Widget has neither this.data.js.readableProdcatIds or this.data.js.permissionedProdcatIds set, or their values are not an array.");return b&&0===this.data.js.permissionedProdcatIds.length||c&&0===this.data.js.readableProdcatIds.length?!0:b?this.isPermissionedNode(a):this.isReadableNode(a)},isPermissionedNode:function(a){return this.userHasFullProdcatPermissions()?!0:-1!==this.Y.Array.indexOf(this.data.js.permissionedProdcatIds,parseInt(a,10))},userHasFullProdcatPermissions:function(){this.checkIdsAreValid("permissionedProdcatIds");return"None"===this.data.attrs.verify_permissions||0===this.data.js.permissionedProdcatIds.length},isReadableNode:function(a){this.checkIdsAreValid("readableProdcatIds");return 0===this.data.js.readableProdcatIds.length?!0:-1!==this.Y.Array.indexOf(this.data.js.readableProdcatIds,parseInt(a,10))},disableNonPermissionedAccessibleNodes:function(a){this.checkIdsAreValid("readableProdcatIds");if(0!==this.data.js.readableProdcatIds.length&&this.data.attrs.label_selection_not_valid){var b;this.Y.Array.each(a,function(a){this.checkPermissionsOnNode(a[1])||(b=this.Y.one(this.baseSelector+"_AccessibleLink_"+a[1]),b.setHTML(RightNow.Text.sprintf(this.data.attrs.label_selection_not_valid,b.getHTML())))},this)}},disableNonPermissionedNodes:function(a){this.checkIdsAreValid("readableProdcatIds");0!==this.data.js.readableProdcatIds.length&&this.Y.Array.each(a,function(a){this.checkPermissionsOnNode(a.id)||this.Y.one("#ygtvlabelel"+this.tree.getNodeByValue(a.id).index).addClass("rn_Disabled")},this)},onAccessibleLinkClick:function(a){var b=a.valueChain[a.valueChain.length-1];this.tree.expandAndCreateNodes(a.valueChain);this.checkPermissionsOnNode(b)&&this.dialog.hide()},showAccessibleView:function(a){a.halt();this._eo||(this._eo=new RightNow.Event.EventObject(this));"Category"===this.dataType&&this.data.js.linkingOn&&(this._eo.data.linkingProduct=RightNow.UI.Form.currentProduct);this.dialog?this.displayAccessibleDialog():RightNow.Event.fire("evt_accessibleTreeViewRequest",this._eo)},getAccessibleTreeViewResponse:function(a,b){b=b[0];if(b.w_id===this._eo.w_id&&b.data.hm_type===this._eo.data.hm_type){var c=b.data.accessibleLinks;if("prod_chain"in c){c=[];delete b.data.accessibleLinks.prod_chain;for(var d in b.data.accessibleLinks)c.push(b.data.accessibleLinks[d])}c.unshift({0:this.data.attrs.label_all_values,1:0,hier_list:0,level:0});c=this.pruneNonPermissionedAccessibleNodes(c);this.createAccessibleDialog(c);this.buildTree();this.displayAccessibleDialog();this.disableNonPermissionedAccessibleNodes(c)}},createAccessibleDialog:function(a){this.dialog&&this.dialog.destroy();var b="Product"===this.dataType?RightNow.Interface.getMessage("SELECT_BELOW_USING_LINKS_PROVIDED_MSG"):RightNow.Interface.getMessage("CATEGORY_BELOW_USING_LINKS_PROVIDED_MSG"),c=RightNow.Interface.getMessage("DEPTH_ANNOUNCED_NAVIGATE_THROUGH_LIST_MSG");this.dialog=new this.Y.RightNowTreeViewDialog({id:"rn_"+this.instanceID,hierarchyData:a,contentBox:this.Y.one(this.baseSelector+"_Links"),dismissLabel:RightNow.Interface.getMessage("CANCEL_CMD"),titleLabel:this.data.attrs.label_nothing_selected,introLabel:b+" "+c,selectionPlaceholderLabel:RightNow.Interface.getMessage("SELECTION_PCT_S_ACTIVATE_LINK_JUMP_MSG"),levelLabel:this.data.attrs.label_level,noItemSelectedLabel:this.data.attrs.label_all_values});this.dialog.on("selectionMade",this.onAccessibleLinkClick,this);this.dialog.render()},displayAccessibleDialog:function(){this.dialog.set("selectedValue",this.tree.get("value"));this.dialog.set("selectedLabels",this.tree.get("labelChain"));this.dialog.show();var a=this.Y.one("p.rn_Intro a");a&&a.focus()},displaySelectedNodesAndClose:function(a){this._eo||(this._eo=new RightNow.Event.EventObject(this));this._eo.data.hierChain=this.tree.get("valueChain");RightNow.Event.fire("evt_productCategoryFilterSelected",this._eo);delete this._eo.data.hierChain;var b=this.tree.get("valueChain"),c=this.data.attrs.label_nothing_selected,d=this.data.attrs.label_nothing_selected;this.dropdown.hide();b[0]&&(c=this.tree.get("labelChain").join("<br>"),d=this.data.attrs.label_screen_reader_selected+c);this.dropdown.set("triggerText",c);this.Y.all(this.baseSelector+"_TreeDescription").setHTML(d);if(a&&!this.dialog)try{this.dropdown.get("trigger").focus()}catch(e){}},selectNode:function(a){this.displaySelectedNodesAndClose(!0)},getSubLevelRequest:function(a){if(!this._nodeBeingExpanded){this._nodeBeingExpanded=!0;if(a=this.getSubLevelRequestEventObject(a))"Product"===this.dataType&&(RightNow.UI.Form.currentProduct=a.data.value),this._requesting=a.data.value,RightNow.Event.fire("evt_menuFilterRequest",a);this._nodeBeingExpanded=!1;this._eo.data.link_map&&delete this._eo.data.link_map}},getSubLevelRequestEventObject:function(a){return new RightNow.Event.EventObject(this,{data:{level:a.depth+1,value:a.value,label:a.label,cache:{}}})},getSubLevelResponse:function(a,b){this.data.js.link_map&&delete this.data.js.link_map;var c=a.data.level,d=a.data.hier_data,e,d=this.groomProdcats(d);this.buildTree();!a.data.reset_linked_category&&this.getSubLevelRequestEventObject._origRequest&&this.getSubLevelRequestEventObject._origRequest[b]?e=this.getSubLevelRequestEventObject._origRequest[b]:a.data.reset_linked_category&&(this.tree.clear(this.data.attrs.label_all_values),this.dialog=null,this.selectNode(this.tree.getRoot()));7>c&&this.insertChildrenForNode(d,e);0===d.length&&this.displaySelectedNodesAndClose()},insertChildrenForNode:function(a,b){this.tree.insertChildHierarchyData(a,b)},removeNonReadableProdcats:function(a){this.checkIdsAreValid("readableProdcatIds");var b=this.data;return this.Y.Array.filter(a,function(a){if(-1!==this.Y.Array.indexOf(b.js.readableProdcatIds,a.id))return a},this)},updateProdcatsHasChildrenAttribute:function(a){this.checkIdsAreValid("readableProdcatIdsWithChildren");var b=this.data;return this.Y.Array.map(a,function(a){a.hasChildren=-1!==this.Y.Array.indexOf(b.js.readableProdcatIdsWithChildren,a.id)?!0:!1;return a},this)},groomProdcats:function(a){!1!==this.data.attrs.verify_permissions&&"None"!==this.data.attrs.verify_permissions&&0<this.data.js.readableProdcatIds.length&&(a=this.removeNonReadableProdcats(a),a=this.updateProdcatsHasChildrenAttribute(a));return a},checkIdsAreValid:function(a){if(!(this.data&&this.data.js&&this.data.js[a]&&this.Y.Lang.isArray(this.data.js[a])))throw Error("Widget does not have this.data.js."+a+" attribute set, or its value is not an array");}});
RightNow.RequiredLabel=function(){var a=new EJS({text:'<span class="rn_Required" aria-label="<%= requiredLabel %>"><%= requiredMarkLabel %></span>'});EJS.Helpers.prototype.getRequiredLabel=function(b,c){return a.render({requiredLabel:b||RightNow.Interface.getMessage("REQUIRED_LBL"),requiredMarkLabel:c||RightNow.Interface.getMessage("FIELD_REQUIRED_MARK_LBL")})}};
(function(){var l=function(){var b={},a={},f={};return{getDeferred:function(k,d){if(b[k])return b[k];a[d]=a[d]||{events:[]};a[d].form=k;return{on:function(b,c,h){if(c&&"function"===typeof c)return a[d].events.push({name:b,handler:c,context:h}),this;throw Error("Handler specified isn't a callable function");},addField:function(a,c){if(a&&c&&"object"===typeof c)f[k]||(f[k]={}),f[k][a]=c;else throw Error("A non-object field cannot be added to a form");}}},getInstance:function(a){return b[a]},newInstance:function(a,d){d instanceof RightNow.Form&&(b[a]=d)},getDeferredEvents:function(b){var d,e,c={};for(d in a)if(e=a[d],a.hasOwnProperty(d)&&e.form===b&&e.events.length){e=e.events;for(var h=0;h<e.length;h++)c[e[h].name]=c[e[h].name]||[],c[e[h].name].push(e[h])}return c},getDeferredFields:function(a){return f[a]}}}(),g=function(){function b(c,a,b,d){var e={},f=c.getAttribute("target");c.all("input, select, textarea").each(function(c){var a=c.get("type");""!==c.get("name")&&"submit"!==a&&"image"!==a&&(e[c.get("name")]=c.get("value"))});c=a+RightNow.Url.convertToSegment(e)+b;RightNow.Url.getSession()&&(c=RightNow.Url.addParameter(c,"session",RightNow.Url.getSession()));c=d.Y.Node.create("<a class='rn_Hidden'>form</a>").setAttribute("href",c);f&&c.setAttribute("target",f);d.Y.one(document.body).append(c);c=d.Y.Node.getDOMNode(c);document.createEvent?(d=document.createEvent("MouseEvents"),d.initEvent("click",!1,!1),c.dispatchEvent(d)):c.fireEvent("onclick")}function a(c){this.fire("response",new RightNow.Event.EventObject(this,{data:c}))}function f(c){this.fire("responseError",new RightNow.Event.EventObject(this,{data:c}))}function k(c,h,b){if(RightNow.Event.noSessionCookies())for(var d=0,e=b.length;d<e;d++)if("Contact.Login"===b[d].name){document.cookie="cp_login_start=1;path=/";break}b=RightNow.JSON.stringify(b);var k={form:b,updateIDs:RightNow.JSON.stringify({asset_id:RightNow.Url.getParameter("asset_id"),qid:RightNow.Url.getParameter("qid"),product_id:RightNow.Url.getParameter("product_id"),serial_no:RightNow.Url.getParameter("serial_no"),i_id:RightNow.Url.getParameter("i_id"),user_id:RightNow.Url.getParameter("user")})},g={scope:h,json:!0,successHandler:a,failureHandler:f};b=RightNow.UI.Form;null!=b.smartAssistant&&(k.smrt_asst=b.smartAssistant);null!==b.smartAssistantToken&&(k.saToken=b.smartAssistantToken);h.data.attrs.flash_message&&(k.flash_message=h.data.attrs.flash_message);h._originalEventObject&&(h._originalEventObject.data.timeout&&(g.timeout=h._originalEventObject.data.timeout),g=function(c,a){var b=["challengeHandler","challengeHandlerContext"],h,d;for(h=0;h<b.length;++h)d=b[h],c[d]=a[d]||void 0;return c}(g,h._originalEventObject));RightNow.Form.formToken.onNewToken(function(a){k.f_tok=a;RightNow.Ajax.makeRequest(c,k,g)})}var d={},e={};return{submitForm:function(c,a,d){var f=d.Y.one("#"+c),g=f.getAttribute("method"),m=f.getAttribute("action");c=e[c];a=a||"";if(m&&!d.data.attrs.on_success_url)if("post"===g.toLowerCase()||!RightNow.Text.beginsWith(m,"/")&&RightNow.Url.isExternalUrl(m)){a&&f.set("action",m+a);for(a=0;a<c.length;a++)(g=c[a])&&g.value&&((m=f.one('input[name="'+g.name+'"]')||f.one('textarea[name="'+g.name+'"]'))?m.set("value",g.value):f.append(d.Y.Node.create('<input type="hidden" name="'+g.name+'" value="'+d.Y.Escape.html(g.value)+'"/>')));f.submit()}else b(f,m,a,d);else k((m||"/ci/ajaxRequest/sendForm")+a,d,c)},resetValidatedFields:function(a){e[a]=[]},addValidatedField:function(a,b){e[a]||this.resetFormFields(a);delete b.data.form;e[a].push(b.data)},getValidatedFields:function(a){return RightNow.Lang.cloneObject(e[a])},addField:function(a,b,f){d[a]||(d[a]={});d[a][b]=f},findField:function(a,b){return d[a][b]},getAllFields:function(a){return d[a]||{}}}}();RightNow.Form=RightNow.EventProvider.extend({overrides:{constructor:function(){this.parent();this._challengeDivID=this.data.attrs.challenge_location;this._parentForm=RightNow.UI.findParentForm(this.baseSelector);this.Y.one("#"+this._parentForm).on("submit",function(a){a.halt()});this._errorMessageDiv=this.Y.one("#"+this.data.attrs.error_location);this._formButton=this.Y.one(this.baseSelector+"_Button");this._errorMessageDiv||(this._errorMessageDiv=this.Y.Node.create("<div id='rn_"+this.instanceID+"_ErrorLocation'>"),this._formButton.insert(this._errorMessageDiv,"before"));if(this._parentForm){if(l.getInstance(this._parentForm))throw Error("Can't have two different FormSubmits for a single form");l.newInstance(this._parentForm,this)}else throw RightNow.UI.addDevelopmentHeaderError(RightNow.Interface.getMessage("FORMSUBMIT_PLACED_FORM_UNIQUE_ID_MSG")),Error("An inappropriate form was specified");this._events=l.getDeferredEvents(this._parentForm);this.Y.Object.each(l.getDeferredFields(this._parentForm),function(a,b){g.addField(this._parentForm,b,a)},this);this._widgetInstantiationComplete=RightNow.Widgets.isWidgetInstantiationComplete();if(!this._widgetInstantiationComplete)RightNow.Event.on("evt_WidgetInstantiationComplete",function(){this._widgetInstantiationComplete=!0},this);this._addSubscribersFilter("submit",this._filterSubmittedWidgets,this);this._addEventHandler("submit",{pre:function(a){RightNow.Form.formToken.requestNewToken();g.resetValidatedFields(this._parentForm);this._challengeDivID&&(a.challengeHandler=RightNow.Event.createDelegate(this,this._challengeHandler));this._originalEventObject=a},during:function(a){!1===a?this._eventCanceled=!0:a instanceof RightNow.Event.EventObject&&g.addValidatedField(this._parentForm,a)},post:function(a){var b=this._eventCanceled?"fail":"pass";this._eventCanceled=!1;this.fire("validation:"+b,a)}})._addEventHandler("send",{post:function(a){this._eventCanceled||g.submitForm(this._parentForm,this.data.attrs.add_params_to_url,this);this._eventCanceled=!1},during:function(a){!1===a&&(this._eventCanceled=!0)}})._addEventHandler("collect",{pre:function(){this._collectedFields=[]},during:function(a){a&&this._collectedFields.push(a)},post:function(a){this.fire("submit",a)}})._addEventHandler("formUpdated");if(this.data.js.challengeProvider){try{this._challengeProvider=eval(this.data.js.challengeProvider)}catch(b){throw"Failed while trying to parse a challenge provider.  "+b;}this._createChallengeDiv();this._challengeProvider.create(this._challengeDivID,RightNow.UI.AbuseDetection.options);this.on("submit",this._onValidateChallengeResponse,this)}if(!this.data.js.f_tok)throw Error("This widget is required to have a `f_tok` form submission token");RightNow.Form.formToken.init(this.data.js.f_tok,this.data.js.formExpiration)}},_filterSubmittedWidgets:function(b){var a=g.getAllFields(this._parentForm),f=[];this.Y.Object.each(a,function(a,d){this.Y.Array.each(b,function(b,c){b.context===a&&-1===this.Y.Array.indexOf(this._collectedFields,d)&&f.push(c)},this)},this);return f},getValidatedFields:function(){return g.getValidatedFields(this._parentForm)},addField:function(b,a){g.addField(this._parentForm,b,a)},findField:function(b){if(!this._widgetInstantiationComplete)throw Error("Widget instantiation has not completed. This method can only be used after all widgets are constructed");return g.findField(this._parentForm,b)},hide:function(){RightNow.UI.hide(this._formButton)},show:function(){RightNow.UI.show(this._formButton)},disable:function(){this._formButton.set("disabled",!0)},enable:function(){this._formButton.set("disabled",!1)},_createChallengeDiv:function(){this.Y.one("#"+this._challengeDivID)||this._formButton.insert(this.Y.Node.create("<div id='"+this._challengeDivID+"' tabindex='-1'>"),"before")},_reportChallengeError:function(b){b=b||RightNow.Interface.getMessage("PLS_VERIFY_REQ_ENTERING_TEXT_IMG_MSG");this._errorMessageDiv.append("<div><b><a id ='rn_ChallengeErrorLink' href='javascript:void(0);'>"+b+"</a></b></div>");this.Y.one("#rn_ChallengeErrorLink").on("click",RightNow.Event.createDelegate(this,function(){this._challengeProvider.focus(this._challengeDivID);return!1}))},_challengeHandler:function(b,a,f){this._createChallengeDiv();this._challengeProvider||(this._challengeProvider=RightNow.UI.AbuseDetection.getChallengeProvider(b),this.on("submit",this._onValidateChallengeResponse,this),this._challengeProvider.create(this._challengeDivID,RightNow.UI.AbuseDetection.options));this._reportChallengeError(RightNow.UI.AbuseDetection.getDialogCaption(b));this.fire("validation:fail")},_onValidateChallengeResponse:function(){new RightNow.Event.EventObject(this,{data:{form:!1}});var b=this._challengeProvider.getInputs(this._challengeDivID);if(b.abuse_challenge_response)for(var a in b)b.hasOwnProperty(a)&&RightNow.Ajax.addRequestData(a,b[a])}},{find:function(b,a,f){if(b=RightNow.UI.findParentForm(b))return f?b:l.getDeferred(b,a);throw Error("You're using a form that doesn't have a proper form submit button or an id");},formToken:function(){function b(b,h){var e=h[0];if(e.data.newToken&&(!e.w_id||"RightNow.Form"===e.w_id)){a=e.data.newToken;e=f;g=(new Date).getTime()+e;for(var e=0,l=d.length,n;e<l;e++)n=d[e],n.callback.call(n.context,a);d=[]}}var a,f,g,d=[],e;return{init:function(c,d){a=c;var l=f=d;g=(new Date).getTime()+l;e||(RightNow.Event.on("evt_formTokenUpdate",b),e=!0)},requestNewToken:function(){(new Date).getTime()>=g&&RightNow.Event.fire("evt_formTokenRequest",new RightNow.Event.EventObject({instanceID:"RightNow.Form"},{data:{formToken:a}}))},onNewToken:function(b,e){(new Date).getTime()>=g?d.push({callback:b,context:e}):setTimeout(function(){b.call(e,a)},1)}}}()})})();
RightNow.Widgets.SocialBookmarkLink=RightNow.Widgets.extend({constructor:function(){this.Y.Event.attach("click",this._onClick,this.baseSelector+"_Link",this);this.Y.Event.attach("click",this._togglePanel,this.baseSelector+"_Panel li a",this);RightNow.Event.subscribe('evt_inlineModerationStatusUpdate',this._onStatusUpdate,this);},_onClick:function(event){event.halt();if(this.data.attrs.object_type==='answer'){this._togglePanel();return;}
var eventObject=new RightNow.Event.EventObject(this,{data:{qid:RightNow.Url.getParameter('qid'),}});RightNow.Ajax.makeRequest(this.data.attrs.check_question_exist_ajax,eventObject.data,{data:eventObject,json:true,scope:this,successHandler:this._onResponseReceived});},_onResponseReceived:function(response){if(response.errors){if(!RightNow.Ajax.indicatesSocialUserError(response)){var dialogParameters={exitCallback:{fn:function(){messageDialog.hide();},scope:this}},messageDialog;dialogParameters.icon='WARN';messageDialog=RightNow.UI.Dialog.messageDialog(response.errors[0].externalMessage,dialogParameters).show();}}
else{this._togglePanel();}},_createPanel:function(panelElement){var widget=this.Y.one(this.baseSelector);RightNow.UI.show(panelElement);var panel=new this.Y.Panel({srcNode:panelElement,align:{node:widget,points:[this.Y.WidgetPositionAlign.TC,this.Y.WidgetPositionAlign.BC]},render:widget,visible:false,zIndex:10,buttons:[],alignOn:[{node:'win',eventName:'resize'}],hideOn:[{eventName:"clickoutside"},{node:panelElement.all("a").slice(-1).item(0),eventName:"keydown",keyCode:RightNow.UI.KeyMap.TAB}]});panel.after('visibleChange',function(e){if(e.newVal){this._focusFirstLink();}},this);return panel;},_focusFirstLink:function(){this._panel.get('contentBox').one('a').focus();},_onStatusUpdate:function(evt,args){if(args[0].data.object_data.updatedObject.objectType==='SocialQuestion'&&args[0].data.object_data.updatedObject.ID===parseInt(this.data.js.objectID,10)){if(parseInt(args[0].data.object_data.updatedObject.statusWithTypeID,10)!==this.data.js.activeStatusWithTypeID){RightNow.UI.hide(this.baseSelector);}
else{RightNow.UI.show(this.baseSelector);}}},_togglePanel:function(){var panelElement=this.Y.one(this.baseSelector+"_Panel");if(!panelElement){return false;}
this._panel=this._panel||this._createPanel(panelElement);if(this._panel.get("visible")){this._panel.hide();}
else{this._panel.show();}}});
RightNow.Widgets.EmailAnswerLink=RightNow.Widgets.extend({constructor:function(){this._dialogElement=this.Y.one(this.baseSelector+'_EmailAnswerLinkForm');if(this._dialogElement)
{this.Y.Event.attach("click",this._onEmailLinkClick,this.baseSelector+"_Link",this);}
RightNow.Event.subscribe('evt_inlineModerationStatusUpdate',this._onStatusUpdate,this);},_onEmailLinkClick:function(e)
{if(this.data.attrs.object_type==="question"&&!RightNow.Profile.isSocialUser())
{this.requestAuthentication(e);}
else
{if(!this._dialog)
{var buttons=[{text:this.data.attrs.label_send_button,handler:{fn:this._submitClicked,scope:this},isDefault:true},{text:this.data.attrs.label_cancel_button,handler:{fn:this._closeDialog,scope:this},isDefault:false}];this._dialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_dialog_title,this._dialogElement,{"buttons":buttons});this._dialogElement.removeClass("rn_Hidden").addClass("rn_EmailLinkDialog");this._keyListener=RightNow.UI.Dialog.addDialogEnterKeyListener(this._dialog,this._submitClicked,this);}
this._recipientEmailElement=this._recipientEmailElement||this.Y.one(this.baseSelector+"_InputRecipientEmail");this._senderEmailElement=this._senderEmailElement||this.Y.one(this.baseSelector+"_InputSenderEmail");this._senderNameElement=this._senderNameElement||this.Y.one(this.baseSelector+"_InputSenderName");this._errorDisplay=this._errorDisplay||this.Y.one(this.baseSelector+"_ErrorMessage");if(this._errorDisplay)
{this._errorDisplay.set("innerHTML","").removeClass('rn_MessageBox rn_ErrorMessage');}
this._dialog.show();RightNow.UI.Dialog.enableDialogControls(this._dialog,this._keyListener,this._recipientEmailElement);}},requestAuthentication:function(e){if(!RightNow.Profile.isLoggedIn()){RightNow.Event.fire('evt_requireLogin',new RightNow.Event.EventObject(this,{data:{isSocialAction:true,title:RightNow.Interface.getMessage("PLEASE_LOG_CREATE_AN_ACCOUNT_CONTINUE_LBL")}}));}
else{RightNow.Event.fire("evt_userInfoRequired");}
e.halt();},_closeDialog:function()
{if(this._errorDisplay)
{this._errorDisplay.set("innerHTML","").removeClass('rn_MessageBox rn_ErrorMessage');}
RightNow.UI.Dialog.disableDialogControls(this._dialog,this._keyListener);this._dialog.hide();},_shouldIgnoreEvent:function(name,event){if(name==="keyPressed"){var target=(event&&event[1])?(event[1].target||event[1].srcElement):null,targetContents=target?target.getHTML():null;return(!target||target.get('tagName')==='A'||targetContents===this.data.attrs.label_send_button||targetContents===this.data.attrs.label_cancel_button);}
return false;},_submitClicked:function(type,args)
{if(this._shouldIgnoreEvent(type,args))return;RightNow.UI.Dialog.disableDialogControls(this._dialog,this._keyListener);if(this._validateFormData())
{this._submitRequest();}
else
{RightNow.UI.Dialog.enableDialogControls(this._dialog,this._keyListener);}},_validateFormData:function()
{if(this._errorDisplay)
{this._errorDisplay.set("innerHTML","").removeClass('rn_MessageBox rn_ErrorMessage');}
var toEmailIsValid=this._validateEmailAddress(this._recipientEmailElement,this.data.attrs.label_to),fromEmailIsValid=!this._senderEmailElement||this._validateEmailAddress(this._senderEmailElement,this.data.attrs.label_sender_email),senderNameIsValid=!this._senderNameElement||this._validateSenderName(this._senderNameElement,this.data.attrs.label_sender_name);return toEmailIsValid&&fromEmailIsValid&&senderNameIsValid;},_validateSenderName:function(senderInput,label){var nameValue=this.Y.Lang.trim(senderInput.get("value")),id=senderInput.get("id"),errors=[];if(nameValue===""){errors.push(RightNow.Interface.getMessage("PCT_S_IS_REQUIRED_MSG"));}
else{if(nameValue.indexOf("<")>-1||nameValue.indexOf(">")>-1){errors.push(RightNow.Interface.getMessage("PCT_S_CONTAIN_THAN_MSG"));}
if(nameValue.indexOf("'")>-1||nameValue.indexOf('"')>-1){errors.push(RightNow.Interface.getMessage("PCT_S_MUST_NOT_CONTAIN_QUOTES_MSG"));}
if(nameValue.indexOf("&")>-1){errors.push(RightNow.Interface.getMessage("PCT_S_MUST_NOT_CONTAIN_MSG"));}}
this.Y.Array.each(errors,function(message){this._addErrorMessage(RightNow.Text.sprintf(message,label),id);},this);return!errors.length;},_validateEmailAddress:function(emailField,label)
{if(emailField)
{var emailFieldValue=this.Y.Lang.trim(emailField.get("value")),id=emailField.get("id");if(emailFieldValue==="")
{this._addErrorMessage(RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_IS_REQUIRED_MSG"),label),id);return false;}
if(emailFieldValue.indexOf(";")>=0||emailFieldValue.indexOf(",")>=0||emailFieldValue.indexOf(" ")>=0)
{this._addErrorMessage(RightNow.Interface.getMessage("PLEASE_ENTER_SINGLE_EMAIL_ADDRESS_MSG"),id);return false;}
if(!RightNow.Text.isValidEmailAddress(emailFieldValue))
{this._addErrorMessage(RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_IS_INVALID_MSG"),label),id);return false;}
if(emailFieldValue.length>80)
{this._addErrorMessage(RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_IS_TOO_LONG_MSG"),label),id);return false;}
return true;}
return false;},_submitRequest:function()
{var eventObject,requestURL;if(this.data.attrs.object_type==="question"){eventObject=new RightNow.Event.EventObject(this,{data:{w_id:this.data.info.w_id,to:this._recipientEmailElement.get("value"),qid:this.data.js.objectID}});requestURL=this.data.attrs.send_discussion_email_ajax;}
else{var name=((this._senderNameElement)?this._senderNameElement.get("value"):"")||this.data.js.senderName;eventObject=new RightNow.Event.EventObject(this,{data:{w_id:this.data.info.w_id,to:this._recipientEmailElement.get("value"),a_id:this.data.js.objectID,emailAnswerToken:this.data.js.emailAnswerToken,from:((this._senderEmailElement)?this._senderEmailElement.get("value"):"")||this.data.js.senderEmail,name:name.substring(0,80)}});requestURL=this.data.attrs.send_email_ajax;}
if(RightNow.Event.fire("evt_emailLinkRequest",eventObject)){RightNow.Ajax.makeRequest(requestURL,eventObject.data,{successHandler:this._onResponseReceived,scope:this,data:eventObject,json:true});}},_onResponseReceived:function(response,originalEventObj)
{if(RightNow.Event.fire("evt_emailLinkSubmitResponse",{data:originalEventObj,response:response})){if(response.ajaxError){this._closeDialog();}
else{var dialogParameters={exitCallback:{fn:function(){messageDialog.hide();this._closeDialog();},scope:this}},messageDialog,message;if(typeof response==="string"){message=response;}
else if(response.errors){if(!RightNow.Ajax.indicatesSocialUserError(response)){message=response.errors[0].externalMessage||response.suggestedErrorMessage||RightNow.Interface.getMessage("THERE_PROB_REQ_ACTION_COULD_COMPLETED_MSG");dialogParameters.icon='WARN';}}
else{message=this.data.attrs.label_email_sent;}
messageDialog=RightNow.UI.Dialog.messageDialog(message,dialogParameters);}}},_addErrorMessage:function(message,focusElement){if(this._errorDisplay){this._errorDisplay.addClass('rn_MessageBox rn_ErrorMessage');var newMessage='<a href="javascript:void(0);" onclick="document.getElementById(\''+focusElement+'\').focus(); return false;">'+message+'</a>';var oldMessage=this._errorDisplay.get("innerHTML");if(oldMessage!=="")
newMessage=oldMessage+'<br/>'+newMessage;this._errorDisplay.set("innerHTML",newMessage);this._errorDisplay.one('a').focus();this._errorDisplay.one("h2")?this._errorDisplay.one("h2").setHTML(RightNow.Interface.getMessage("ERRORS_LBL")):this._errorDisplay.prepend("<h2>"+RightNow.Interface.getMessage("ERROR_LBL")+"</h2>");this._errorDisplay.one("h2").setAttribute('role','alert');}},_onStatusUpdate:function(evt,args){if(args[0].data.object_data.updatedObject.objectType==='SocialQuestion'){if(parseInt(args[0].data.object_data.updatedObject.statusWithTypeID,10)!==this.data.js.activeStatusWithTypeID){RightNow.UI.hide(this.baseSelector);}
else{RightNow.UI.show(this.baseSelector);}}}});
RightNow.Widgets.SiteFeedback=RightNow.Widgets.extend({constructor:function(){this._dialog=this._keyListener=null;this._resetElements();if(!this._feedbackField)
{RightNow.UI.DevelopmentHeader.addJavascriptError(RightNow.Text.sprintf(RightNow.Interface.getMessage("SITEFEEDBACK_DIALOG_MISSING_REQD_MSG"),"rn_"+this.instanceID+"_FeedbackTextarea"));return;}
this.Y.one(this.baseSelector+"_FeedbackLink").on("click",this._onGiveFeedbackClick,this);RightNow.Event.subscribe("evt_formTokenUpdate",this._onFormTokenUpdate,this);},_resetElements:function()
{this._errorDisplay=this.Y.one(this.baseSelector+"_ErrorMessage");this._emailField=this.Y.one(this.baseSelector+"_EmailInput");this._feedbackField=this.Y.one(this.baseSelector+"_FeedbackTextarea");},_onGiveFeedbackClick:function()
{if(this.data.attrs.feedback_page_url)
{window.open(RightNow.Url.addParameter(this.data.attrs.feedback_page_url,"session",RightNow.Url.getSession()),"","resizable, scrollbars, width=630, height=400");}
else
{this._showDialog();}},_onFormTokenUpdate:function(type,args){var eventObject=args[0];if(eventObject.data.newToken&&this.instanceID===eventObject.w_id){this.data.js.f_tok=eventObject.data.newToken;}},_showDialog:function()
{RightNow.Event.fire("evt_formTokenRequest",new RightNow.Event.EventObject(this,{data:{formToken:this.data.js.f_tok}}));if(!this._dialog)
{var buttons=[{text:this.data.attrs.label_send_button,handler:{fn:this._onSubmit,scope:this},isDefault:true},{text:this.data.attrs.label_cancel_button,handler:{fn:this._onCancel,scope:this},isDefault:false}];this._dialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_dialog_title,this.Y.one(this.baseSelector+"_SiteFeedbackForm"),{buttons:buttons});this._keyListener=RightNow.UI.Dialog.addDialogEnterKeyListener(this._dialog,this._onSubmit,this);this.Y.one("#"+this._dialog.id).addClass('rn_SiteFeedbackDialog');}
if(this._errorDisplay)
{this._errorDisplay.set("innerHTML","").removeClass('rn_MessageBox rn_ErrorMessage');}
RightNow.ActionCapture.record('siteFeedback','click');this._dialog.show();this._resetElements();var focusElement;if(this._emailField&&this._emailField.get('value')==='')
focusElement=this._emailField;else
focusElement=this._feedbackField;focusElement.focus();RightNow.UI.Dialog.enableDialogControls(this._dialog,this._keyListener);},_onSubmit:function(type,args)
{var target=(args&&args[1])?(args[1].target||args[1].srcElement):null;if((type==="keyPressed"&&target&&(target.get('tagName')==='A'||target.get('tagName')==='TEXTAREA'||target.getHTML()===this.data.attrs.label_send_button||target.getHTML()===this.data.attrs.label_cancel_button))||!this._validateDialogData()){return;}
RightNow.UI.Dialog.disableDialogControls(this._dialog,this._keyListener);this._submitFeedback();},_onCancel:function()
{RightNow.UI.Dialog.disableDialogControls(this._dialog,this._keyListener);this._closeDialog(true);},_validateDialogData:function()
{this._errorDisplay.removeClass('rn_MessageBox rn_ErrorMessage').set("innerHTML","");var returnValue=true;if(this._emailField)
{this._emailField.set('value',this.Y.Lang.trim(this._emailField.get('value')));this._emailField.set('value',this._emailField.get('value').replace(/\s*[,;]$/g,''));if(this._emailField.get('value')==="")
{this._addErrorMessage(RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_IS_REQUIRED_MSG"),this.data.attrs.label_email_address),this._emailField.get('id'));returnValue=false;}
else if(!RightNow.Text.isValidEmailAddress(this._emailField.get('value')))
{this._addErrorMessage(this.data.attrs.label_email_address+' '+RightNow.Interface.getMessage("FIELD_IS_NOT_A_VALID_EMAIL_ADDRESS_MSG"),this._emailField.get('id'));returnValue=false;}
else
{var email=this._emailField.get('value');var flag=false;for(var index=0;index<email.length;index++){if((email[index]===";")||(email[index]===",")){flag=true;break;}}
if(flag&&index!=email.length-1){for(var i=index+1;i<email.length;i++)
{if(!(email[i]===";"||email[i]===",")){this._addErrorMessage(RightNow.Interface.getMessage("PLEASE_ENTER_SINGLE_EMAIL_ADDRESS_LBL"),this._emailField.get('id'));returnValue=false;break;}}
if(i===email.length){this._emailField.set('value',email.substring(0,index));}}}}
this._feedbackField.set('value',this.Y.Lang.trim(this._feedbackField.get('value')));if(this._feedbackField.get('value')==="")
{this._addErrorMessage(RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_IS_REQUIRED_MSG"),this.data.attrs.label_comment_box),this._feedbackField.get('id'));returnValue=false;}
return returnValue;},_closeDialog:function(cancelled)
{if(!cancelled)
{this._feedbackField.set('value',"");}
if(this._errorDisplay)
{this._errorDisplay.set("innerHTML","").removeClass('rn_MessageBox rn_ErrorMessage');}
if(this._dialog)
this._dialog.hide();},_submitFeedback:function()
{var eventObject=new RightNow.Event.EventObject(this,{data:{"w_id":this.data.info.w_id,"a_id":null,"rate":0,"f_tok":this.data.js.f_tok,"message":this._feedbackField.get('value')}});if(this.data.js.isProfile)
eventObject.data.email=this.data.js.email;else if(this._emailField)
eventObject.data.email=this._emailField.get('value');if(RightNow.Event.fire("evt_siteFeedbackRequest",eventObject))
{RightNow.Ajax.makeRequest(this.data.attrs.submit_site_feedback_ajax,eventObject.data,{successHandler:this._onResponseReceived,scope:this,data:eventObject,json:true});}
return false;},_onResponseReceived:function(response,originalEventObj)
{if(RightNow.Event.fire("evt_siteFeedbackSubmitResponse",{data:originalEventObj,response:response}))
{this._closeDialog();if(!response){return;}
var error;if((error=response.error)||!response.ID){RightNow.UI.Dialog.messageDialog(error||RightNow.Interface.getMessage("SORRY_ERROR_SUBMISSION_LBL"),{icon:"WARN",exitCallback:{fn:this._dialog.enableButtons,scope:this._dialog}});}
else{RightNow.UI.Dialog.messageDialog(this.data.attrs.label_feedback_confirmation,{exitCallback:{fn:this._closeDialog,scope:this}});}}},_addErrorMessage:function(message,focusElement)
{if(this._errorDisplay)
{var newMessage='<a href="javascript:void(0);" onclick="document.getElementById(\''+focusElement+'\').focus(); return false;">'+message+'</a>',oldMessage=this._errorDisplay.get("innerHTML");this._errorDisplay.addClass('rn_MessageBox rn_ErrorMessage').set("innerHTML",((oldMessage==="")?newMessage:oldMessage+'<br/>'+newMessage));this._errorDisplay.get('children').item(0).focus();this._errorDisplay.one("h2")?this._errorDisplay.one("h2").setHTML(RightNow.Interface.getMessage("ERRORS_LBL")):this._errorDisplay.prepend("<h2>"+RightNow.Interface.getMessage("ERROR_LBL")+"</h2>");this._errorDisplay.one("h2").setAttribute('role','alert');}}});
RightNow.Widgets.ConditionalChatLink=RightNow.Widgets.extend({constructor:function()
{this._container=this.Y.one(this.baseSelector);this._isPersistentChat=this.data.attrs.is_persistent_chat;this._pollingBegan=null;this._linkClicked=false;this._offerRecorded=this.data.js.offer_recorded;this._queueReceivedEventSubscribed=false;this._linkUrl=this.data.js.link_url;this._eeWidgetId=null;this._offered=false;if(this.data.attrs.is_persistent_chat)
{this._ls=RightNow.Chat.LS;if(!this._ls.isSupported)
{this._isPersistentChat=false;}}
var initialResult={};if(this.data.attrs.initiate_by_event)
{if(this.data.attrs.hide_on_unavailable)
{initialResult.stats={availableSessionCount:0,expectedWaitSeconds:0};}}
else if(this.data.js.unavailable_hours)
{initialResult.out_of_hours=true;}
else if(this.data.js.available_session_count!==undefined&&this.data.js.expected_wait_seconds!==undefined)
{initialResult.stats={availableSessionCount:this.data.js.available_session_count,expectedWaitSeconds:this.data.js.expected_wait_seconds};}
this._eo=new RightNow.Event.EventObject(this,{data:{wait_threshold:this.data.attrs.wait_threshold,min_agents_avail:this.data.attrs.min_sessions_avail,interface_id:this.data.js.interface_id,contact_email:this.data.js.contact_email,contact_fname:this.data.js.contact_fname,contact_lname:this.data.js.contact_lname,prod:this.data.js.prod,cat:this.data.js.cat,c_id:this.data.js.c_id,org_id:this.data.js.org_id,cacheable:true,avail_type:this.data.js.avail_type,ccl:true,name:'ConditionalChatLink'}});this._onQueueReceived(initialResult);RightNow.Event.subscribe("evt_productCategoryFilterSelected",this._onProdCatChanged,this);if(!this.data.attrs.initiate_by_event&&this.data.attrs.enable_availability_check&&this.data.attrs.enable_polling)
this._startPollingTimer(false);if(this.data.attrs.initiate_by_event)
{RightNow.Event.subscribe("evt_customInitialization",this._startPollingTimer,this,true);RightNow.Event.fire("evt_CCLReady");RightNow.Event.subscribe("evt_isCCLReady",function(){RightNow.Event.fire("evt_CCLReady");},this);}},_generateEncodedChatData:function(args)
{var chatData=this.data.js.routeData||'';if(args!==undefined&&args[0]!==undefined&&args[0].data!==undefined)
{var data=args[0].data;this._eeWidgetId=data.instance_id;chatData=this._addChatDataParam(chatData,'referrerUrl',encodeURIComponent(window.location.href));chatData=this._addChatDataParam(chatData,'v_id',data.visitor_id);chatData=this._addChatDataParam(chatData,'ee_id',data.ee_id);chatData=this._addChatDataParam(chatData,'es_id',data.estara_id);chatData=this._addChatDataParam(chatData,'ee_s_id',data.ee_session_id);}
chatData=this._addChatDataParam(chatData,'hash',new Date().getTime()+Math.random().toString(36).substring(7));return RightNow.Text.Encoding.base64Encode(chatData);},_startPollingTimer:function(startImmediately,args)
{var chatData=this._generateEncodedChatData(args);if(chatData.length!==0)
this._linkUrl=RightNow.Url.addParameter(this._linkUrl,'chat_data',chatData);if(this._pollingBegan!==null&&this.data.attrs.enable_polling)
return;if(!this._queueReceivedEventSubscribed)
RightNow.Event.subscribe("evt_chatQueueResponseCCL",this._onQueueReceived,this);this._pollingBegan=new Date().getTime();if(startImmediately)
{this._onPollingTimerElapsed();}
else
{this.Y.later(12000,this,this._onPollingTimerElapsed);}},_onPollingTimerElapsed:function()
{var eventObject=RightNow.Lang.cloneObject(this._eo);if(RightNow.Event.fire("evt_chatQueueRequest",eventObject))
{delete eventObject.data.rn_contextData;delete eventObject.data.rn_contextToken;delete eventObject.data.rn_formToken;delete eventObject.data.rn_timestamp;delete eventObject.data.w_id;RightNow.Ajax.makeRequest(this.data.attrs.get_chat_info_ajax,eventObject.data,{successHandler:this._onQueueReceived,failureHandler:function(){},scope:this,json:true,data:eventObject,type:"GETPOST",cors:true});}
var timeElapsed=new Date().getTime()-this._pollingBegan;var newTimeout=timeElapsed>=300000?60000:12000;if(this.data.attrs.enable_polling)
this.Y.later(newTimeout,this,this._onPollingTimerElapsed);},_openChatLink:function()
{var callback=null;if(this.data.attrs.open_in_new_window)
window.open(this._linkUrl,'chatLauncher','width='+this.data.attrs.chat_login_page_width+',height='+this.data.attrs.chat_login_page_height+',scrollbars=1,resizable=1');else
callback=function(){window.location.href=this._linkUrl;};if(!this._linkClicked)
{this._linkClicked=true;this._publishStats({w:this.data.js.dqaWidgetType.toString(),accepts:1},callback);}
var eo=new RightNow.Event.EventObject(this,{data:{id:this._eeWidgetId,name:'ConditionalChatLink'}});RightNow.Event.fire("evt_CCLChatAccepted",eo);},_onQueueReceived:function(result)
{if(result&&result.out_of_hours)
{this._container.setContent(this.Y.Node.create(new EJS
({text:this.getStatic().templates.unavailableHoursMessage}).render({instanceID:this.instanceID,linkTitle:RightNow.Interface.getMessage("LIVE_CHAT_LBL"),message:this.data.attrs.label_unavailable_hours})));this._addClickHandler(this.Y.one(this.baseSelector+'_UnavailableHoursLink'));}else if(result&&result.stats&&RightNow.Event.fire("evt_chatQueueResponse",{data:{w_id:this._eo.w_id,name:"ConditionalChatLink"},response:{stats:{expectedWaitSeconds:parseInt(result.stats.expectedWaitSeconds,10)}}}))
{var availableSessionCount=0,expectedWaitSeconds=0;var availableImmediately=false,availableWithWait=false,unavailableBusy=false,unavailableHours=false;if(result===null||result===undefined){result={};}
var eoData=this._eo.data;this._linkUrl=eoData.prod?RightNow.Url.addParameter(this._linkUrl,'p',eoData.prod):RightNow.Url.deleteParameter(this._linkUrl,'p');this._linkUrl=eoData.cat?RightNow.Url.addParameter(this._linkUrl,'c',eoData.cat):RightNow.Url.deleteParameter(this._linkUrl,'c');if(result.stats)
{availableSessionCount=parseInt(result.stats.availableSessionCount,10);expectedWaitSeconds=parseInt(result.stats.expectedWaitSeconds,10);if(expectedWaitSeconds<=this.data.attrs.wait_threshold&&availableSessionCount>=this.data.attrs.min_sessions_avail&&(expectedWaitSeconds>0||availableSessionCount>0))
{if(expectedWaitSeconds===0)
availableImmediately=true;else
availableWithWait=true;}
else
{unavailableBusy=true;}}
else if(result.out_of_hours)
{unavailableHours=true;}
this._container.removeClass('rn_Hidden');if(this.data.attrs.hide_on_unavailable&&(unavailableHours||unavailableBusy))
{this._container.addClass('rn_Hidden');}
else if(availableImmediately||availableWithWait)
{if(!this._offerRecorded)
{this._offerRecorded=true;this._publishStats({w:this.data.js.dqaWidgetType.toString(),offers:1},null);}
if(availableImmediately)
{this._container.setContent(this.Y.Node.create(new EJS({text:this.getStatic().templates.availableImmediatelyMessage}).render({instanceID:this.instanceID,linkTitle:RightNow.Interface.getMessage("LIVE_CHAT_LBL"),message:this._parseMacro(this.data.attrs.label_available_immediately_template,expectedWaitSeconds)})));if(this._isPersistentChat)
{this.data.attrs.enable_polling=false;this._addPersistentChatClickHandler(this.Y.one(this.baseSelector+'_AvailableImmediatelyLink'));}
else
{this._addClickHandler(this.Y.one(this.baseSelector+'_AvailableImmediatelyLink'));}}
else
{this._container.setContent(this.Y.Node.create(new EJS({text:this.getStatic().templates.availableWithWaitMessage}).render({instanceID:this.instanceID,linkTitle:RightNow.Interface.getMessage("LIVE_CHAT_LBL"),message:this._parseMacro(this.data.attrs.label_available_with_wait_template,expectedWaitSeconds)})));if(this._isPersistentChat)
{this.data.attrs.enable_polling=false;this._addPersistentChatClickHandler(this.Y.one(this.baseSelector+'_AvailableWithWaitLink'));}
else
{this._addClickHandler(this.Y.one(this.baseSelector+'_AvailableWithWaitLink'));}}
if(!this._offered)
{this._offered=true;var eo=new RightNow.Event.EventObject(this,{data:{id:this._eeWidgetId,name:'ConditionalChatLink'}});RightNow.Event.fire("evt_CCLChatOffered",eo);}}
else if(unavailableBusy)
{if(this._isPersistentChat)
{this._container.setContent(this.Y.Node.create(new EJS({text:this.getStatic().templates.persistentMessage}).render({instanceID:this.instanceID,message:this._parseMacro(this.data.attrs.label_unavailable_busy_template,expectedWaitSeconds)})));}
else
{this._container.setContent(this.Y.Node.create(new EJS({text:this.getStatic().templates.unavailableBusyMessage}).render({instanceID:this.instanceID,linkTitle:RightNow.Interface.getMessage("LIVE_CHAT_LBL"),message:this._parseMacro(this.data.attrs.label_unavailable_busy_template,expectedWaitSeconds)})));this._addClickHandler(this.Y.one(this.baseSelector+'_UnavailableBusyLink'));}}
else if(unavailableHours)
{if(this._isPersistentChat)
{this._container.setContent(this.Y.Node.create(new EJS({text:this.getStatic().templates.persistentMessage}).render({instanceID:this.instanceID,message:this._parseMacro(this.data.attrs.label_unavailable_hours)})));}
else
{this._container.setContent(this.Y.Node.create(new EJS({text:this.getStatic().templates.unavailableHoursMessage}).render({instanceID:this.instanceID,linkTitle:RightNow.Interface.getMessage("LIVE_CHAT_LBL"),message:this.data.attrs.label_unavailable_hours})));this._addClickHandler(this.Y.one(this.baseSelector+'_UnavailableHoursLink'));}}
else
{this._container.setContent(this.Y.Node.create(new EJS({text:this.getStatic().templates.defaultMessage}).render({instanceID:this.instanceID,linkTitle:RightNow.Interface.getMessage("LIVE_CHAT_LBL"),message:this.data.attrs.label_default})));this._addClickHandler(this.Y.one(this.baseSelector+'_DefaultLink'));}}
else if(!this.data.attrs.enable_availability_check)
{var eoData=this._eo.data;this._linkUrl=eoData.prod?RightNow.Url.addParameter(this._linkUrl,'p',eoData.prod):RightNow.Url.deleteParameter(this._linkUrl,'p');this._linkUrl=eoData.cat?RightNow.Url.addParameter(this._linkUrl,'c',eoData.cat):RightNow.Url.deleteParameter(this._linkUrl,'c');this._container.setContent(this.Y.Node.create(new EJS({text:this.getStatic().templates.defaultMessage}).render({instanceID:this.instanceID,linkTitle:RightNow.Interface.getMessage("LIVE_CHAT_LBL"),message:this.data.attrs.label_default})));this._addClickHandler(this.Y.one(this.baseSelector+'_DefaultLink'));}
else
{this._container.setContent(this.Y.Node.create(new EJS({text:this.getStatic().templates.unavailableMessage}).render({instanceID:this.instanceID,message:this.data.attrs.label_unavailable})));}},_addPersistentChatClickHandler:function(elementNode){elementNode.on('click',this._launchPersistentChat,this);},_launchPersistentChat:function(){RightNow.UI.hide(this.Y.one(this.baseSelector+'.rn_ConditionalChatLink'));RightNow.Event.fire("evt_launchPersistentChat",{});},_addClickHandler:function(elementNode)
{if(elementNode)
{elementNode.on('click',this._openChatLink,this);}},_parseMacro:function(message,expectedWaitSeconds)
{var expectedWaitMinutes=Math.floor(expectedWaitSeconds/60);if(message.indexOf('{NUM_MINUTES}'!==-1))
{expectedWaitSeconds=expectedWaitSeconds%60;message=message.replace('{NUM_MINUTES}',expectedWaitMinutes).replace('{MINUTES}',expectedWaitMinutes===1?RightNow.Interface.getMessage("MINUTE_LC_LBL"):RightNow.Interface.getMessage('MINUTES_LWR_LBL'));}
var expectedWaitSecondsPadded=expectedWaitSeconds<10?'0'+expectedWaitSeconds.toString():expectedWaitSeconds;message=message.replace('{TIME}',expectedWaitMinutes+':'+expectedWaitSecondsPadded);return message.replace('{NUM_SECONDS}',expectedWaitSeconds).replace('{SECONDS}',expectedWaitSeconds===1?RightNow.Interface.getMessage('SECOND_LBL'):RightNow.Interface.getMessage('SECONDS_LC_LBL'));},_publishStats:function(data,callback)
{RightNow.Ajax.CT.submitAction(RightNow.Ajax.CT.WIDGET_STATS,data,callback,this);},_addChatDataParam:function(chatData,key,value)
{if(chatData===undefined)
chatData='';if(value===undefined||value.length===0)
return chatData;if(chatData.length!==0)
chatData+='&';chatData+=key+'='+value;return chatData;},_onProdCatChanged:function(type,args)
{var prodCatType=args[0].data.data_type;var value=args[0].data.value;if(prodCatType.indexOf("Category")>-1)
this._eo.data.cat=value;else
this._eo.data.prod=value;}});
RightNow.Widgets.MobileProductCategoryInput=RightNow.Field.extend({overrides:{constructor:function(){this.parent();this.Y.augment(this,RightNow.ProductCategory);this._selections=[];this._currentValue=0;this._currentLabel='';this._currentLevel=1;this._currentScreenIndex=1;this._maxDepth=this.data.attrs.max_lvl||6;this._hasChildren=false;this._baseID=this.baseSelector+"_"+this.data.js.data_type;this._launchButton=this.Y.one(this._baseID+"_Launch");if(this.data.js.readOnly)return;if(this.data.js.initial.length!==0){for(var i=0,currentItem;i<this.data.js.initial.length;i++){currentItem=this.data.js.initial[i];this._selections.push({value:currentItem.id,label:this.Y.Escape.html(currentItem.label)});}
if(typeof currentItem!=="undefined"){this._currentValue=currentItem.id;this._currentLabel=currentItem.label;this._hasChildren=currentItem.hasChildren;}
this._commitSelection(this._selections);}
else if(this.data.js.linkingOn&&this.data.js.data_type==="Category"&&this.data.js.linkMap&&typeof this.data.js.linkMap[0]==="undefined"){this._setCategoryUnavailable();}
this._launchButton.on("click",this._openDialog,this);RightNow.Event.subscribe("evt_menuFilterGetResponse",this._getSubLevelResponse,this);this.parentForm().on("submit",this._onValidateRequest,this);this.on('constraintChange:required_lvl',this.updateRequiredLevel,this);}},_openDialog:function(){(this._dialog||this._createDialog());this._dialog.show();},_createDialog:function(element){var firstLevelItems=element||this.Y.one(this._baseID+"_Level1Input");if(!firstLevelItems)return;this._dialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_prompt,firstLevelItems,{navButtons:true,cssClass:"rn_MobileProductCategoryInput"});this._dialog.hideEvent.subscribe(this._resetView,this,true);this._dialog.backEvent.subscribe(function(){this._currentLevel=Math.max(this._currentLevel-1,1);this._currentScreenIndex=Math.max(this._currentScreenIndex-1,1);},this,true);firstLevelItems.removeClass("rn_Hidden").delegate("click",this._getSubLevelRequest,"input",this);},_selectionAllMade:function(parentSelected){this._selectionMade(parentSelected);if(this.data.js.linkingOn&&this.data.attrs.filter_type==="Product"){this._currentScreenIndex--;RightNow.Event.fire("evt_menuFilterRequest",this._eo);}},_selectionMade:function(parentSelected){var index=0,buttonText="",ariaText="";if(parentSelected){while(parentSelected!==this._selections[this._selections.length-1].value){this._selections.pop();}
this._currentValue=this._selections[this._selections.length-1].value;this._currentLabel=this._selections[this._selections.length-1].label;this._currentLevel=this._selections.length;}
if(this._launchButton){do{if(this._selections[index].value){buttonText+=this._selections[index].label+"<br>";ariaText+=this._selections[index].label+" ";}
index++;}
while(index<this._currentLevel&&this._selections[index]);if(ariaText){ariaText=RightNow.Text.sprintf(this.data.attrs.label_current_selection_screenreader,ariaText);}
this._launchButton.set("innerHTML",buttonText||this.data.attrs.label_prompt);this.swapLabel(this.Y.one(this._baseID+'_Label'),this.data.attrs.required_lvl,this.data.attrs.label_input,this.getStatic().templates.label,ariaText);}
if(this._dialog&&this._dialog.visible()){this._dialog.hide();}
this._markSelectionInDialog();this._commitSelection(this._selections);this._updateEventObject({data:{level:this._currentLevel,value:this._currentValue}});if(this._launchButton){this._launchButton.focus();}
this._eo.data.hierChain=this._getCommittedSelection(true);RightNow.Event.fire("evt_productCategorySelected",this._eo);this.fire('change',this);delete this._eo.data.hierChain;},_resetView:function(){if(!this._launchButton)return;if(this._launchButton.intersect(this._launchButton.get('viewportRegion'))){this._launchButton.scrollIntoView();}},_clearSelection:function(){this._selections=[{value:0}];if(this._dialog){while(this._dialog.hasPreviousContent()){this._dialog.previousScreen();}}
this._currentLevel=1;this._currentValue=0;this._currentLabel='';this._hasChildren=false;this._selectionMade();},_markSelectionInDialog:function(deselectAll){if(deselectAll){deselectAll.all("div").removeClass("rn_Selected");}
else{if(this._dialog&&this._dialog._panel&&this._dialog._panel.id){this.Y.one("#"+this._dialog._panel.id).all("div.rn_Selected").removeClass("rn_Selected");}
for(var i=0,currentValue,currentNode,length=this._selections.length+1,markSelection=(this._selections[0]&&this._selections[0].value),apply=function(node){node.removeClass("rn_Selected");if(markSelection&&parseInt(node.one("input").get("value"),10)===currentValue){node.addClass("rn_Selected");}};i<length;i++){currentValue=(this._selections[i])?this._selections[i].value:this._selections[this._selections.length-1].value;currentNode=this.Y.one(this._baseID+"_Level"+(i+1)+"Input"+((i===0)?"":"_"+this._selections[i-1].value));if(currentNode){currentNode.all("div").each(apply);}}}},_getSubLevelRequest:function(clickEvent){if(!this._beingSelected){this._toggleLoadingIcon(clickEvent.target);var input=clickEvent.target,label=input.next("label");if(label&&label.get("innerHTML")){this._hasChildren=label.hasClass("rn_HasChildren");this._currentLabel=this.Y.Lang.trim(label.get("childNodes").item(0).get("text"));}
this._currentValue=parseInt(input.get("value"),10);this._selections=this._selections.slice(0,this._currentScreenIndex-1);this._selections.push({value:this._currentValue,label:this.Y.Escape.html(this._currentLabel)});this._currentLevel=this._selections.length;if(this.data.js.linkingOn&&this.data.js.data_type==="Product"){this._currentValue=this._currentValue||-1;this._backButtonLabel=(this._currentLevel===1)?this.data.attrs.label_data_type:this._selections[this._currentLevel-2].label;RightNow.Event.fire("evt_menuFilterRequest",this._updateEventObject({"data":{"level":this._currentLevel,"value":this._currentValue}}));if(!this._hasChildren){this._selectionMade();}
this._toggleLoadingIcon(clickEvent.target);return;}
if(!this._hasChildren){this._selectionMade();this._toggleLoadingIcon();}
else if(this._currentValue){this._backButtonLabel=(this._currentLevel===1)?this.data.attrs.label_data_type:this._selections[this._currentLevel-2].label;RightNow.Event.fire("evt_menuFilterRequest",this._updateEventObject({data:{level:this._currentLevel,value:this._currentValue}}));if(this._eo.data.link_map)
delete this._eo.data.link_map;}}},_buildDialogContent:function(data,level){if(data.length&&level<=this._maxDepth&&this._dialog){var id=this._baseID+"_Level"+level+"Input_"+this._currentValue,existingElement=this.Y.one(id),requirementMet=false;this._currentScreenIndex++;if(existingElement){var committedSelections=this._getCommittedSelection();var isSameSelection=false;for(var i in committedSelections){if(committedSelections[i].value===this._currentValue){isSameSelection=true;break;}}
if(!isSameSelection&&!(committedSelections.length+1===this._currentLevel&&committedSelections[committedSelections.length-1].value===this._currentValue)){this._markSelectionInDialog(existingElement);}
this._dialog.showScreen(id);}
else{if((!this.data.attrs.required_lvl||this._currentLevel>this.data.attrs.required_lvl)&&this.checkPermissionsOnNode(this._currentValue)){data.unshift({id:this._currentValue,label:RightNow.Text.sprintf(RightNow.Interface.getMessage("ALL_PCT_S_LBL"),this._currentLabel)});requirementMet=true;}
var maxDepth=this._maxDepth,currentSelections=this._getCommittedSelection(),alreadySelected=(currentSelections[level-1])?currentSelections[level-1].value:((currentSelections[level-2])?currentSelections[level-2].value:false),div=new EJS({text:this.getStatic().templates.view}).render({inputID:id.substr(1),labelID:(this._baseID+"_Level"+level+"Label_"+this._currentValue).substr(1),level:level,data:data,parentAlt:this.data.attrs.label_parent_menu_alt,getContainerClass:function(item,i){return((i===0)?"rn_Parent":"rn_SubItem")+((item.id===alreadySelected)?" rn_Selected":"");},getLabelClass:function(item){return(level!==maxDepth&&item.hasChildren)?"rn_HasChildren":"";},escapeHtml:this.Y.Escape.html});this._dialog.nextScreen(div,null,this._backButtonLabel);var allItem=(requirementMet)?this.Y.one(id).one('input'):null;this.Y.one(id).delegate("click",function(e){if(allItem&&e.target.compareTo(allItem)){this._selectionAllMade(data[0].id);}
else{this._getSubLevelRequest(e);}},"input",this);}}},_buildLinkedCategoryContent:function(level,data,selectedItem){var id=this._baseID+"_Level1Input",firstLevelItems=this.Y.one(id),element,maxDepth=this._maxDepth;if(this._dialog&&firstLevelItems){element=firstLevelItems.next();while(element){this._dialog.previousScreen();element.remove();element=firstLevelItems.next();}
firstLevelItems.remove();}
data.unshift({id:0,label:RightNow.Text.sprintf(this.data.attrs.label_all_values,this._currentLabel)});firstLevelItems=this.Y.Node.create(new EJS({text:this.getStatic().templates.view}).render({inputID:id.substr(1),labelID:(this._baseID+"_Level"+level+"Label_"+this._currentValue).substr(1),level:level,data:data,parentAlt:this.data.attrs.label_parent_menu_alt,getContainerClass:function(item,i){return((i===0)?"rn_Parent":"rn_SubItem")+((item.id===selectedItem)?" rn_Selected":"");},getLabelClass:function(item){return(level!==maxDepth&&item.hasChildren)?"rn_HasChildren":"";},escapeHtml:this.Y.Escape.html}));this._createDialog(firstLevelItems);return firstLevelItems;},_getSubLevelResponse:function(type,args){var evtObj=args[0];if((evtObj.w_id&&evtObj.w_id===this.instanceID)||(this.data.js.linkingOn&&evtObj.data.data_type==="Category"&&this.data.js.data_type===evtObj.data.data_type)){if(evtObj.data.reset_linked_category){if(this.data.js.linkMap)
delete this.data.js.linkMap;if(!evtObj.data.hier_data.length){this._setCategoryUnavailable();}
else{this._categoryUnavailable=false;evtObj.data.hier_data=this.groomProdcats(evtObj.data.hier_data);if(this._selections.length){var currentSelections=this._selections.slice(0),currentIndex=0;for(var i=0,firstItem=this._selections[0].value,newData=evtObj.data.hier_data,stillSelected;i<newData.length;i++){if(newData[i].id===firstItem){stillSelected=firstItem;break;}}
if(!stillSelected){this._clearSelection();this._buildLinkedCategoryContent(1,evtObj.data.hier_data,stillSelected);}
else{var firstLevelItems=this._buildLinkedCategoryContent(1,evtObj.data.hier_data,stillSelected),baseID=this._baseID,thisY=this.Y,firstSelectedNode=firstLevelItems.one("input[value='"+firstItem+"']"),followTree=function(input){if(!input)
return;currentIndex++;var thisRoot=baseID+"_Level"+currentIndex+"Input_"+currentSelections[currentIndex-2].value,thisRootNode=thisY.one(thisRoot),selectedNode;if(currentIndex>currentSelections.length){if(thisRootNode&&(selectedNode=thisRootNode.one("input[value='"+currentSelections[currentIndex-2].value+"']")))
selectedNode.getDOMNode().click();return;}
if(thisRootNode&&(selectedNode=thisRootNode.one("input[value='"+currentSelections[currentIndex-2].value+"']")))
selectedNode.getDOMNode().click();if(thisRootNode)
followTree(thisRootNode.one("input[value='"+currentSelections[currentIndex-1].value+"']"));};if(firstSelectedNode){currentIndex++;firstSelectedNode.getDOMNode().click();followTree(firstSelectedNode);}}}
else{this._buildLinkedCategoryContent(1,evtObj.data.hier_data);}
this.Y.one(this.baseSelector).setStyle("visibility","visible");}
return;}
this._currentLevel=(evtObj.data.hier_data.length)?evtObj.data.level:this._currentLevel;if(evtObj.data.hier_data.length===0){this._selectionMade();}
else{evtObj.data.hier_data=this.groomProdcats(evtObj.data.hier_data);this._buildDialogContent(evtObj.data.hier_data,this._currentLevel);}
this._toggleLoadingIcon();}},_onValidateRequest:function(type,args){this._errorLocation=this.lastErrorLocation=args[0].data.error_location;if(this._checkSelectionErrors()){var formEventObject=this.createEventObject(),value=this._getCommittedSelection(true);if(value.length){formEventObject.data.value=value[value.length-1];}
RightNow.Event.fire("evt_formFieldValidatePass",formEventObject);return formEventObject;}
RightNow.Event.fire("evt_formFieldValidateFailure",this._eo);return false;},swapLabel:function(container,requiredLevel,label,template,screenReaderText){this.Y.augment(this,RightNow.RequiredLabel);var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,requiredLevel:requiredLevel,requiredLabel:RightNow.Interface.getMessage("REQUIRED_LBL"),screenReaderText:screenReaderText||""};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},updateRequiredLevel:function(evt,constraint){var newLevel=constraint[0].constraint;if(newLevel>this.data.attrs.max_lvl||this.data.attrs.required_lvl===newLevel)return;if(this.data.attrs.required_lvl>0&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
this.swapLabel(this.Y.one(this._baseID+'_Label'),newLevel,this.data.attrs.label_input,this.getStatic().templates.label);this.data.attrs.required_lvl=newLevel;this._toggleErrorLabels(newLevel);},_checkSelectionErrors:function(){if(this.data.attrs.required_lvl){this._toggleErrorLabels();if(this._categoryUnavailable){return true;}
if(this._currentValue===0||(this._hasChildren&&(this._getCommittedSelection()).length<this.data.attrs.required_lvl)){this._displayErrorMessage();return false;}}
if(!this.checkPermissionsOnNode(this._currentValue)){this._displayErrorMessage();return false;}
return true;},_toggleErrorLabels:function(addErrorClass){var css,label;if(addErrorClass){if(this._failedPreviousCheck)return;this._failedPreviousCheck=true;css="addClass";}
else if(this._failedPreviousCheck){this._failedPreviousCheck=false;css="removeClass";}
else return;if(label=this.Y.one(this._baseID+"_Label")){label[css]("rn_ErrorLabel");}},_displayErrorMessage:function(){this._toggleErrorLabels(true);var commonErrorDiv,message,label;if(this._errorLocation&&(commonErrorDiv=this.Y.one("#"+this._errorLocation))){if(!this.checkPermissionsOnNode(this._currentValue)&&this._currentLabel){label=this.data.attrs.label_not_permissioned;message=this.data.attrs.label_input+" - "+((label.indexOf("%s")>-1)?RightNow.Text.sprintf(label,this._currentLabel):label);}
else if(this._currentLabel){label=this.data.attrs.label_required;message=this.data.attrs.label_input+" - "+((label.indexOf("%s")>-1)?RightNow.Text.sprintf(label,this._currentLabel):label);}
else{message=this.data.attrs.label_prompt;}
commonErrorDiv.append(new EJS({text:this.getStatic().templates.error}).render({id:this._baseID.substr(1)+"_Launch",errorLink:message,escapeHtml:this.Y.Escape.html,fieldName:this._fieldName}));}},_commitSelection:function(selection){this._committedSelection=RightNow.Lang.cloneObject(selection);},_getCommittedSelection:function(justValues){if(justValues&&this._committedSelection){for(var i=0,values=[];i<this._committedSelection.length;i++){values.push(this._committedSelection[i].value);}
return values;}
return this._committedSelection||[];},_setCategoryUnavailable:function(){this._categoryUnavailable=true;this._clearSelection();this.Y.one(this.baseSelector).setStyle("visibility","hidden");},_updateEventObject:function(options){if(!this._initialized){this._eo=new RightNow.Event.EventObject(this,{data:{data_type:this.data.js.data_type,hm_type:this.data.js.hm_type,linking_on:this.data.js.linkingOn,linkingProduct:0,table:this.data.js.table,cache:[],name:((this.data.js.data_type==="Product")?'prod':'cat')}});this._updateEventObject._updateVals=function(origArray,properties){for(var i in properties){if(properties.hasOwnProperty(i)){origArray[i]=properties[i];}}};this._initialized=true;}
if(options&&options.data){this._updateEventObject._updateVals(this._eo.data,options.data);}
if(this.data.js.linkMap){this._eo.data.link_map=this.data.js.linkMap;delete this.data.js.linkMap;}
return this._eo;},_toggleLoadingIcon:function(toggleNode){if(toggleNode&&!toggleNode.hasClass('rn_LoadingIcon')){this._beingSelected=true;this.Y.one(toggleNode).next().addClass('rn_LoadingIcon');}
else{this._beingSelected=false;this.Y.one('.rn_MobileProductCategoryInput .rn_LoadingIcon').removeClass('rn_LoadingIcon');}}});
RightNow.Widgets.DiscussionSubscriptionIcon=RightNow.Widgets.extend({constructor:function(){this.subscriptionDiv=this.Y.one(this.baseSelector+'_Subscription');this.subscribeDiv=this.Y.one(this.baseSelector+'_Subscribe');this.unsubscribeDiv=this.Y.one(this.baseSelector+'_Unsubscribe');this.subscribedToProdDiv=this.Y.one(this.baseSelector+'_ProdSubscribed');this.loadingIcon=this.Y.one(this.baseSelector+'_LoadingIcon');this.subscribedToCatDiv=this.Y.one(this.baseSelector+'_CatSubscribed');if(this.subscribeDiv){this.subscribeDiv.on('click',this._createSubscription,this);}
this.unsubscribeDiv.on('click',this._deleteSubscription,this);RightNow.Event.subscribe('evt_inlineModerationStatusUpdate',this._onStatusUpdate,this);RightNow.Widgets.formTokenRegistration(this);},_createSubscription:function(){this._makeAjaxRequest(this.data.attrs.add_social_subscription_ajax,'subscribe');},_deleteSubscription:function(){this._makeAjaxRequest(this.data.attrs.delete_social_subscription_ajax,'unsubscribe');},_makeAjaxRequest:function(requestEndpoint,action){var eventObject=new RightNow.Event.EventObject(this,{data:{id:this.data.js.objectID,type:this.data.attrs.subscription_type,action:action,f_tok:this.data.js.f_tok}});this.loadingIcon.toggleClass("rn_Hidden");this.subscriptionDiv.toggleClass("rn_Hidden");RightNow.Ajax.makeRequest(requestEndpoint,eventObject.data,{successHandler:this._onResponse,scope:this,data:eventObject,json:true});},_onResponse:function(response,eventObject){var textToDisplay=[];this.loadingIcon.toggleClass("rn_Hidden");this.subscriptionDiv.toggleClass("rn_Hidden");if(response.success){this.unsubscribeDiv.toggleClass("rn_Hidden").toggleClass("rn_Show");var message;if(eventObject.data.action==='subscribe'){message=this.data.attrs.label_on_subscription_success_banner;this.subscribeDiv.toggleClass("rn_Hidden").toggleClass("rn_Show");}
else{message=this.data.attrs.label_on_unsubscription_success_banner;if(this.data.js.prodSubscriptionID){this.subscribedToProdDiv.toggleClass("rn_Hidden").toggleClass("rn_Show");}
else if(this.data.js.catSubscriptionID){this.subscribedToCatDiv.toggleClass("rn_Hidden").toggleClass("rn_Show");}
else{this.subscribeDiv.toggleClass("rn_Hidden").toggleClass("rn_Show");}}
RightNow.UI.displayBanner(message,{focusElement:this.subscriptionDiv.one('.rn_Show')});}
else{if(!RightNow.Ajax.indicatesSocialUserError(response)){if(response.errors){this.Y.Object.each(response.errors,function(message){if(message.hasOwnProperty('externalMessage'))
textToDisplay.push(message.externalMessage);});}
RightNow.UI.displayBanner((textToDisplay.length!==0)?textToDisplay.join('<br>'):this.data.attrs.label_on_failure_banner,{type:'ERROR'});}}},_onStatusUpdate:function(evt,args){if(args[0].data.object_data.updatedObject.objectType==='SocialQuestion'){if(parseInt(args[0].data.object_data.updatedObject.statusWithTypeID,10)!==this.data.js.activeStatusWithTypeID){RightNow.UI.hide(this.baseSelector);}
else{RightNow.UI.show(this.baseSelector);}}}});
RightNow.Widgets.ModerationInlineAction=RightNow.Widgets.extend({constructor:function(){this.Y.one(this.baseSelector).delegate('click',this._toggleDropdown,'div.rn_ActionMenu',this);this.Y.one(this.baseSelector).delegate('click',this._onModeratorActionSubmit,'a.rn_Action',this);RightNow.Event.subscribe('evt_inlineModerationAuthorStatusUpdate',this._authorStatusUpdateEventListener,this);},_toggleDropdown:function(e){this._dropdown||(this._dropdown=this._createDropdown(this._renderDropdown()));if(this._dropdown.get('visible')){this._dropdown.hide();}
else{this._dropdown.show().get('contentBox').one('a').focus();}},_createDropdown:function(contentNode){return new this.Y.Panel({srcNode:contentNode,align:{node:this.baseSelector,points:[this.Y.WidgetPositionAlign.TR,this.Y.WidgetPositionAlign.BR]},visible:false,zIndex:1,render:this.baseSelector,buttons:[],hideOn:[{eventName:'clickoutside'},{node:contentNode.all('a').slice(-1).item(0),eventName:'keydown',keyCode:RightNow.UI.KeyMap.TAB}]});},_onModeratorActionSubmitSuccess:function(response){var moderateButton=this.Y.one(this.baseSelector+'_Button');this._hideProgressIcon();if(response.updatedObject.ID){if(!this.data.attrs.refresh_page_on_moderator_action){RightNow.UI.displayBanner(response.updatedObject.successMessage,{focusElement:moderateButton});}
this._fireStatusUpdateEvent(response);if(this._isUserDeleteAction(response.updatedObject.statusID)){RightNow.Url.navigate(this.data.attrs.deleted_user_redirect_url);}
else{if(response.updatedObject.objectType==='SocialUser'&&this.data.attrs.object_type!=='SocialUser'){this._fireAuthorStatusUpdateEvent(response);}
this.data.js.userActions=response.updatedUserActions;this.data.js.contentActions=response.updatedContentActions;if(this.data.attrs.refresh_page_on_moderator_action){RightNow.Url.navigate(window.location.href);}}
this._dropdown=null;}
else{RightNow.UI.displayBanner(response.error||this.data.attrs.label_on_failure_banner,{focusElement:moderateButton,type:'ERROR'});}},_isUserDeleteAction:function(statusID){return this.data.js.userDeleteStatuses&&typeof this.data.js.userDeleteStatuses[parseInt(statusID,10)]!=='undefined';},_fireStatusUpdateEvent:function(response){var eventObject=new RightNow.Event.EventObject(this,{data:{w_id:this.data.info.w_id,object_data:{updatedObject:response.updatedObject}}});RightNow.Event.fire("evt_inlineModerationStatusUpdate",eventObject);},_fireAuthorStatusUpdateEvent:function(response){var eventObject=new RightNow.Event.EventObject(this,{data:{w_id:this.data.info.w_id,object_data:response}});RightNow.Event.fire("evt_inlineModerationAuthorStatusUpdate",eventObject);},_authorStatusUpdateEventListener:function(e,eventData){if(this.data.js.authorID===eventData[0].data.object_data.updatedObject.ID){this.data.js.userActions=eventData[0].data.object_data.updatedUserActions;}},_showProgressIcon:function(){RightNow.UI.show(this.baseSelector+'_LoadingIcon');},_hideProgressIcon:function(){RightNow.UI.hide(this.baseSelector+'_LoadingIcon');},_onModeratorActionSubmit:function(e){this._toggleDropdown(e);if(this._isUserDeleteAction(e.currentTarget.getAttribute('data-action-id'))){this._deleteUserConfirm(e);return;}
this._submitRequest(e);},_submitRequest:function(e){var actionID=e.currentTarget.getAttribute('data-action-id');var objectType=e.currentTarget.getAttribute('data-object-type');var eo=new RightNow.Event.EventObject(this,{data:{actionID:actionID,objectType:objectType,w_id:this.data.info.w_id}});this._showProgressIcon();RightNow.Ajax.makeRequest(this.data.attrs.submit_moderator_action_ajax,eo.data,{data:eo,json:true,scope:this,successHandler:this._onModeratorActionSubmitSuccess});},_renderDropdown:function(){return this.Y.Node.create(this._getDropdownContent());},_deleteUserConfirm:function(e){var confirmElement=this.Y.Node.create('<p>').addClass('rn_UserDeleteDialog').set('innerHTML',this.data.attrs.label_user_delete_confirm);this._deleteDialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_user_delete_confirm_title,confirmElement,{buttons:[{text:RightNow.Interface.getMessage('YES_LBL'),handler:{fn:function(){this._deleteDialog.hide();this._submitRequest(e);},scope:this},isDefault:true},{text:RightNow.Interface.getMessage('NO_LBL'),handler:{fn:function(){this._deleteDialog.hide();},scope:this},isDefault:false}]});this._deleteDialog.show();},_getDropdownContent:function(){return new EJS({text:this.getStatic().templates.view}).render({contentActions:this.data.js.contentActions,socialContentObjectType:this.data.attrs.object_type,userActions:this.data.js.userActions});}});
RightNow.Widgets.QuestionDetail=RightNow.Widgets.extend({constructor:function(){var questionDetails=this.Y.one(this.baseSelector);if(questionDetails){questionDetails.delegate("click",this._toggleEditForm,'.rn_EditQuestionLink',this,true);questionDetails.delegate("click",this._toggleEditForm,'.rn_CancelEdit',this,false);questionDetails.delegate("click",this._deleteQuestionConfirm,'.rn_DeleteQuestion',this);}
this._deleteDialog=null;},_toggleEditForm:function(e,showForm){var toggleElements=this.Y.one(this.baseSelector).all('.rn_QuestionEdit,.rn_QuestionInfoOptions,.rn_QuestionHeader,.rn_QuestionBody,.rn_QuestionToolbar');toggleElements.toggleClass('rn_Hidden');this.Y.one(this.baseSelector+((showForm)?'_QuestionEdit input':' .rn_QuestionActions a')).focus();var questionEditDiv=this.Y.one(this.baseSelector+'_QuestionEdit');if(showForm&&!this.data.attrs.use_rich_text_input&&questionEditDiv.getAttribute('data-contentType')==='text/html'){questionEditDiv.one('textarea.rn_TextArea').setAttribute('readonly','readonly');}},_deleteQuestionConfirm:function(event){var confirmElement=this.Y.Node.create('<p id="rn_'+this.instanceID+'_QuestionDetailDeleteDialogText">').addClass('rn_QuestionDetailDeleteDialog').set('innerHTML',this.data.attrs.label_delete_confirm),buttons=[{text:this.data.attrs.label_confirm_delete_button,handler:{fn:function(){this._deleteQuestion(parseInt(event.currentTarget.getAttribute('data-questionID'),10),event.currentTarget);},scope:this},isDefault:true},{text:this.data.attrs.label_cancel_delete_button,handler:{fn:function(){this._deleteDialog.hide();},scope:this},isDefault:false}];this._deleteDialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_delete_confirm_title,confirmElement,{buttons:buttons,dialogDescription:'rn_'+this.instanceID+'_QuestionDetailDeleteDialogText'});this._deleteDialog.show();},_deleteQuestion:function(questionID,target){if(isNaN(questionID))return;var eventObj=new RightNow.Event.EventObject(this,{data:{w_id:this.data.info.w_id,questionID:questionID}});if(RightNow.Event.fire('evt_deleteQuestionRequest',eventObj)){this._deleteDialog.destroy();target.setHTML(this.data.attrs.label_deleting).toggleClass('rn_DeleteQuestion',false).toggleClass('rn_DeletingQuestion',true).set('disabled',true);RightNow.Ajax.makeRequest(this.data.attrs.delete_question_ajax,eventObj.data,{successHandler:this._deleteQuestionResponse,scope:this,data:[eventObj],json:true});}},_deleteQuestionResponse:function(response,args){var message;if(!response.errors&&RightNow.Event.fire('evt_deleteQuestionResponse',response,args[0])){RightNow.UI.displayBanner(this.data.attrs.successfully_deleted_question_banner,{type:'SUCCESS'}).on('close',function(){(args[1]||window.location).href=this.data.attrs.deleted_question_redirect_url;},this);}
else if(!RightNow.Ajax.indicatesSocialUserError(response)){var deleteButton=this.Y.one('.rn_DeletingQuestion');if(response.errors){message=response.errors[0].externalMessage;}
else{RightNow.UI.displayBanner(RightNow.Interface.getMessage("THERE_WAS_PROBLEM_IN_DELETING_QUESTION_MSG"),{type:'ERROR',focus:true});}
RightNow.UI.displayBanner(message,{type:'ERROR',focusElement:deleteButton});if(deleteButton){deleteButton.setHTML(this.data.attrs.label_delete_button).toggleClass('rn_DeletingQuestion',false).toggleClass('rn_DeleteQuestion',true).set('disabled',false);}}}});
RightNow.Widgets.BestAnswerDisplay=RightNow.Widgets.extend({constructor:function(){this.el=this.Y.one(this.baseSelector);this.el.delegate('click',this._toggleCommentClick,'.rn_ShowAllCommentText, .rn_CollapseCommentText',this);this.el.delegate('click',this._makeRefreshRequest,'.rn_Refresh',this);this.el.delegate('click',this._jumpToAnswer,'.rn_ReplyToComment',this);this.el.delegate('click',this._unselectBestAnswer,'.rn_BestAnswerRemoval span',this);RightNow.Event.on('evt_bestAnswerResponse',this._bestAnswerUpdated,this);RightNow.Event.on('evt_refreshBestAnswer',this._refreshBestAnswer,this);this._autoExpandShorterComments();},_unselectBestAnswer:function(e){e.target.set('disabled',true);e.halt();RightNow.Event.fire('evt_bestAnswerUnselect',new RightNow.Event.EventObject(this,{data:{commentID:parseInt(e.currentTarget.one('button').getAttribute('data-commentid'),10),chosenByType:e.currentTarget.hasClass('rn_UserTypeAuthor')?"Author":"Moderator"}}));},_jumpToAnswer:function(e){e.halt();RightNow.Event.fire('evt_jumpToComment',new RightNow.Event.EventObject(this,{data:{commentID:e.currentTarget.getAttribute('data-commentid')}}));},_toggleCommentClick:function(e){var toggleLink=e.target,commentID=toggleLink.getAttribute('data-commentid'),commentBody=this.Y.one("#rn_"+this.instanceID+"_BestAnswerCommentText_"+commentID).ancestor('.rn_BestAnswerBody');if(e.target.hasClass('rn_ShowAllCommentText'))
this._expandComment(toggleLink,commentBody,true);else if(e.target.hasClass('rn_CollapseCommentText'))
this._collapseComment(toggleLink,commentBody);},_expandComment:function(expandLink,commentBody,showCollapsedLink){RightNow.UI.hide(expandLink);if(showCollapsedLink)
RightNow.UI.show(expandLink.siblings('.rn_CollapseCommentText'));RightNow.UI.show(expandLink.siblings('.rn_ReplyToComment'));commentBody.removeClass("rn_CommentCollapsed");},_collapseComment:function(collapseLink,commentBody){RightNow.UI.hide(collapseLink);RightNow.UI.show(collapseLink.siblings('.rn_ShowAllCommentText'));commentBody.addClass("rn_CommentCollapsed").scrollIntoView(true);},_autoExpandShorterComments:function(){this.el.all('ul li.rn_BestAnswerContainer').each(function(bestAnswerItem){var commentDiv=bestAnswerItem.one('.rn_BestAnswerBody'),commentText=commentDiv.one('.rn_CommentText'),maxHeight=commentText.getComputedStyle('maxHeight'),commentChildElements=commentText.all('p'),expandLink=bestAnswerItem.one('.rn_ShowAllCommentText');if(maxHeight==='none'||maxHeight==='0'){return;}
var currentCommentHeight=this.Y.Array.reduce(commentChildElements.get('offsetHeight'),0,function(prev,curr){return prev+curr;});maxHeight=parseInt(maxHeight,10);if(currentCommentHeight<=maxHeight){this._expandComment(expandLink,commentDiv,false);}},this);},_bestAnswerUpdated:function(response,origEventObj){if(!origEventObj[0].errors){this._displayRefreshMask(this.el);RightNow.UI.displayBanner(this.data.attrs.label_dynamic_notice,{baseClass:'#rn_'+origEventObj[1].w_id+'_'+origEventObj[1].data.commentID+' .rn_BestAnswerActions .rn_UserType'+origEventObj[1].data.chosenByType+' button'});}
else{var bestAnswerButton=this.Y.one(this.baseSelector+' .rn_BestAnswer'+(origEventObj[1].data.removeAnswer?'Removal':'Assignment')+' .rn_UserType'+origEventObj[1].data.chosenByType+' button');if(bestAnswerButton){bestAnswerButton.set('disabled',false);}}},_refreshBestAnswer:function(event,origEventObj){RightNow.UI.displayBanner(this.data.attrs.label_dynamic_notice,{focusElement:this.Y.one('#rn_'+origEventObj[0].w_id+'_'+origEventObj[0].data.commentID+' .rn_EditCommentAction')});this._displayRefreshMask(this.el);},_displayRefreshMask:function(parent){parent.append(this._render('RefreshMask'));parent.all('ul').setAttribute('aria-hidden','true');},_scrollToWidget:function(){this._makeRefreshRequest();this._removeMask();this.el.scrollIntoView();},_makeRefreshRequest:function(){var eo=new RightNow.Event.EventObject(this,{data:{w_id:this.data.info.w_id,questionID:RightNow.Url.getParameter('qid')}});if(RightNow.Event.fire('evt_bestAnswerRefreshRequest',eo)){RightNow.Ajax.makeRequest(this.data.attrs.refresh_ajax,eo.data,{data:eo,scope:this,successHandler:this._onRefreshResponse});}},_onRefreshResponse:function(response,origEventObj){if(RightNow.Event.fire('evt_bestAnswerRefreshResponse',response,origEventObj)){this._replaceCurrentContent(response.responseText);this._removeMask();}},_replaceCurrentContent:function(newContent){var container=this.Y.Node.create('<div></div>').setHTML(newContent||'<p>'+this.data.attrs.label_no_best_answers+'</p>');RightNow.Url.transformLinks(container);var newUl=container.one('ul');(this.el.one('ul')||this.el.one('p')).replace((newUl&&newUl.addClass('rn_Refreshed'))||container.one('p'));this._autoExpandShorterComments();},_removeMask:function(){this.el.all('.rn_Mask').remove();},_render:function(viewName){this._views||(this._views={});this._views[viewName]||(this._views[viewName]=new EJS({text:this.getStatic().templates[viewName]}).render({labels:this.data.attrs}));return this._views[viewName];}});
RightNow.Widgets.QuestionComments=RightNow.Widgets.extend({constructor:function(){this._subscribe([['click','.rn_DeleteCommentAction',this._deleteCommentConfirm],['click','.rn_EditCommentAction',this._extractCommentIDFromEvent(this._commentEditDisplayClick)],['click','.rn_BestAnswerAssignment button',this._extractCommentIDFromEvent(this._bestAnswerClick)],['click','.rn_BestAnswerRemoval button',this._extractCommentIDFromEvent(this._bestAnswerClick)],['click','.rn_Paginator a',this._paginateCommentsClick],['click','.rn_SocialLogin',this._loginLinkClick],['click','.rn_NeedSocialInfo',this._needSocialInfoClick],['click','[data-toggle-parent]',this._toggleParent]]);this.readingPosition=new RightNow.Widgets.QuestionComments.readingPosition(this.data,this.instanceID,this.Y);this.readingPosition.setCommentsSelector(this.baseSelector+'_Comments .rn_CommentContainer');this.readingPosition.on('requestPageWithComment',this._requestPageWithComment,this);this.commentActions=new RightNow.Widgets.QuestionComments.commentActions(this.data,this.instanceID,this.Y);this.commentActions.on('reply',this._commentReplyClick,this);this.newCommentEditor=new RightNow.Widgets.QuestionComments.embeddedEditor(this.data,this.instanceID,this.Y);this.newCommentEditor.on('submit',this._newCommentSubmitted,this);this.newCommentEditor.setForm(this.Y.one(this.baseSelector+'_CommentForm'));this.editor=new RightNow.Widgets.QuestionComments.rovingEditor(this.data,this.instanceID,this.Y);this.editor.on('move',this._editorMoved,this);this.editor.on('toggle',this._editorToggled,this);this.editor.on('submit',this._editorSubmitted,this);this.editor.setForm(this.Y.one(this.baseSelector+'_RovingCommentForm'));this._deleteDialog=null;RightNow.Event.on('evt_bestAnswerUnselect',function(evt,args){this._makeRequest({commentID:args[0].data.commentID,removeAnswer:"true",chosenByType:args[0].data.chosenByType},this._events('bestAnswer'));},this);},_events:function(name){this.__events||(this.__events={'new':{name:'newComment',endpoint:this.data.attrs.new_comment_ajax,callback:this._newCommentResponse,dataType:'text/html'},'edit':{name:'editComment',endpoint:this.data.attrs.edit_comment_ajax,callback:this._editCommentResponse},'reply':{name:'replyToComment',endpoint:this.data.attrs.reply_to_comment_ajax,callback:this._replyToCommentResponse,dataType:'text/html'},'delete':{name:'deleteComment',endpoint:this.data.attrs.delete_comment_ajax,callback:this._deleteCommentResponse},'bestAnswer':{name:'bestAnswer',endpoint:this.data.attrs.best_answer_ajax,callback:this._bestAnswerResponse},'paginate':{name:'paginateComments',endpoint:this.data.attrs.paginate_comments_ajax,callback:this._paginateCommentsResponse,dataType:'text/html'},'pageWithComment':{name:'pageWithComment',endpoint:this.data.attrs.fetch_page_with_comment_ajax,callback:this._paginateCommentsResponse,dataType:'text/html'}});return(name)?this.__events[name]:this.__events;},_needSocialInfoClick:function(e){RightNow.Event.fire("evt_userInfoRequired");e.halt();},_loginLinkClick:function(e){e.halt();var loginLink=this.Y.one(this.baseSelector+'_Login');if(e.target.compareTo(loginLink)){this.readingPosition.updatePath(0);}
RightNow.Event.fire('evt_requireLogin',new RightNow.Event.EventObject(this,{data:{isSocialAction:true,title:RightNow.Interface.getMessage("PLEASE_LOG_CREATE_AN_ACCOUNT_CONTINUE_LBL")}}));},_toggleParent:function(e){this._swapClasses(e.target.get('parentNode'),e.target.getAttribute('data-toggle-parent'));},_swapClasses:function(el,classes){classes=classes.split('|');if(classes.length===1){el.toggleClass(classes[0]);return;}
if(!el.hasClass(classes[0])){classes.reverse();}
el.replaceClass(classes[0],classes[1]);},_bestAnswerClick:function(commentID,target){if(commentID){target.set('disabled',true);this._makeRequest({commentID:commentID,removeAnswer:target.ancestor().hasClass('rn_BestAnswerRemoval'),chosenByType:target.ancestor().hasClass('rn_UserTypeAuthor')?"Author":"Moderator"},this._events('bestAnswer'));}},_paginateCommentsClick:function(e){e.halt();this._requestPage({pageID:parseInt(e.currentTarget.getAttribute('data-pageID'),10)},this._events('paginate'));},_requestPageWithComment:function(evt,args){this._requestPage({commentID:args[0].commentID},this._events('pageWithComment'));},_requestPage:function(requestParameters,eventDetails){if(!this._toggleLoading(true)){this._makeRequest(requestParameters,eventDetails);}},_toggleLoading:function(loading){var commentListContainer=this.Y.one(this.baseSelector+' .rn_Comments'),requestedLoading=typeof loading==='undefined'||!loading?false:true,isLoading=(commentListContainer&&commentListContainer.hasClass('rn_Loading'));if(isLoading&&!requestedLoading){commentListContainer.removeClass('rn_Loading').get('parentNode').setAttribute('aria-busy',false);}
else if(!isLoading&&requestedLoading&&commentListContainer){commentListContainer.addClass('rn_Loading').get('parentNode').setAttribute('aria-busy',true);}
return isLoading;},_commentEditDisplayClick:function(commentID,target,comment){if(!commentID)return;var commentDivID=this.baseSelector+'_'+commentID,commentText=this.data.attrs.use_rich_text_input?comment.one('.rn_CommentText').getHTML():this.Y.one(commentDivID+' span'+commentDivID+'_rawComment').getAttribute('data-rawCommentText');this.editor.editComment(comment,commentText);if(this.editor.isHidden()){target.focus();}},_editorMoved:function(evt,args){var details=args[0];if(details.mode==='edit'){this._toggleComment(details.newParent,'hide');}
var noNewCommentMessage=this.Y.one(this.baseSelector+' .rn_NoNewCommentMessage');if(noNewCommentMessage&&noNewCommentMessage.hasClass('rn_Hidden')){this._toggleNewCommentAction();}
if(details.prevParent!==details.newParent){this._toggleComment(details.prevParent,'show');}},_editorToggled:function(evt,args){var details=args[0];if(details.mode==='edit'){this._toggleComment(details.parent,this.editor.isVisible()?'hide':'show');}
this._toggleNewCommentAction();},_toggleComment:function(parent,action){var comment=this._getCommentContainer(parent),method=action==='show'?'removeClass':'addClass';if(comment){comment[method]('rn_Hidden');}},_commentReplyClick:function(evt,args){var clickEvent=args[0];if(!this.data.js.displayName){this._needSocialInfoClick(clickEvent);}
var commentID=this._getCommentIDFromNode(clickEvent.currentTarget),commentReplies=this.Y.one(this.baseSelector+'_Replies_'+commentID),replyToLocation=commentReplies?commentReplies:this._getCommentContainer(clickEvent.currentTarget);this.editor.replyToComment(replyToLocation);if(this.editor.isHidden()){clickEvent.currentTarget.focus();}},_escapeMapping:{'`':'&#x60;','<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;',"'":'&#x27;','*':'&#x2A;',},_escape:function(string){var mapping=this._escapeMapping;return(string+'').replace(/[&<>"'`]/g,function(match){return mapping[match];});},_newCommentSubmitted:function(evt,args){var value=this.data.attrs.use_rich_text_input?args[0].value.text:args[0].value;this._requestPage({commentBody:value},this._events('new'));},_isCommentErrorResponse:function(response){return this.Y.Node.create(response).get('nodeName')==='#text';},_newCommentResponse:function(response,origResponseObj){this._paginateCommentsResponse(response,origResponseObj);if(this.data.attrs.label_new_comment_banner){var newComments=this.Y.one(this.baseSelector+'_Comments .rn_Comments');if(newComments){RightNow.UI.displayBanner(this.data.attrs.label_new_comment_banner,{focusElement:newComments.one(' > .rn_CommentContainer:last-child')});}}
this.newCommentEditor.reload();},_editorSubmitted:function(evt,args){var details=args[0];var value=this.data.attrs.use_rich_text_input?details.value.text:details.value;this._makeRequest({commentID:this._getCommentIDFromNode(details.comment),commentBody:value},this._events(details.mode));},_editCommentResponse:function(response,originalEventObj){var commentID=this.baseSelector+'_'+originalEventObj.data.commentID,comment=this.Y.one(commentID),commentText=comment.one('.rn_CommentText');this.editor.hide().resetForm();this._toggleComment(comment,'show');if(this.data.attrs.use_rich_text_input){commentText.setHTML(this.editor.getHTML());}
else{var rawInputText=this._escape(response.comment.result.Body),html=(new Markdown.Converter()).makeHtml(rawInputText),output=this.Y.Node.create('<div>'+html+'</div>').getHTML();this.Y.one(commentID+' span.rn_rawCommentText').setAttribute('data-rawcommenttext',rawInputText);commentText.setHTML(output);}
this._refreshUpdatedTime(commentID,response.formattedUpdatedTime);this._toggleNewCommentAction();if(this.data.attrs.label_edit_comment_banner){RightNow.UI.displayBanner(this.data.attrs.label_edit_comment_banner,{focusElement:this.Y.one('#rn_'+originalEventObj.w_id+'_'+
originalEventObj.data.commentID+' .rn_EditCommentAction')});}
this._checkBestAnswerComment(originalEventObj.data.commentID);},_refreshUpdatedTime:function(commentID,formattedTime){var updatedTimeElem=this.Y.one(commentID+' time[itemprop=dateUpdated]');if(!updatedTimeElem){var timestampElem=this.Y.one(commentID+' .rn_CommentTimestamp');var labelUpdatedTime=this.data.attrs.label_updated_time.replace('%s','<time itemprop="dateUpdated" datetime="'+formattedTime[1]+'" >'+formattedTime[0]+'</time>');timestampElem.setHTML(timestampElem.getHTML()+labelUpdatedTime);}
else{updatedTimeElem.setAttribute("datetime",formattedTime[1]);updatedTimeElem.setHTML(formattedTime[0]);}},_replyToCommentResponse:function(response,originalEventObj){this.editor.hide().reload();var comment=this.Y.one(this.baseSelector+'_'+originalEventObj.data.commentID),replies=this.Y.one(this.baseSelector+'_Replies_'+originalEventObj.data.commentID),label;if(!replies){replies=this.Y.Node.create(new EJS({text:this.getStatic().templates.commentReplies}).render({baseDomID:this.baseDomID,commentID:originalEventObj.data.commentID,labelReplies:this.data.attrs.label_replies}));comment.insert(replies,'after');}
if(replies){RightNow.UI.show(replies.append(response));if(!this.Y.Lang.isObject(response)){RightNow.Widgets.instantiateWidgetsFoundInContent(response);}
this.readingPosition.fire('refresh');}
if(label=this.data.attrs.label_replied_banner){var children=replies.get('childNodes');RightNow.UI.displayBanner(label,{focusElement:(children&&children.size()>2)?children.slice(-1).item(0):comment});}
this._toggleNewCommentAction();if(this.newCommentEditor){this.newCommentEditor.form.insert(this.editor.form,"after");this.newCommentEditor.reload();}},_deleteCommentConfirm:function(e){var commentId=this._getCommentIDFromNode(e.target.ancestor('form').previous());var commentMarkedAsBestAnswer=(this.Y.one(this.baseSelector+'_'+commentId+".rn_BestAnswer"))?true:false;var bestReplyPresentForComment=(this.Y.one(this.baseSelector+'_Replies_'+commentId+" .rn_BestAnswer"))?true:false;var confirmElement=this.Y.Node.create('<p>').addClass('rn_QuestionCommentsDeleteDialog');if(commentMarkedAsBestAnswer&&bestReplyPresentForComment){confirmElement.set('innerHTML',this.data.attrs.comment_and_reply_marked_as_best_answer_delete_confirm);}
else if(commentMarkedAsBestAnswer){confirmElement.set('innerHTML',this.data.attrs.comment_marked_as_best_answer_delete_confirm);}
else if(bestReplyPresentForComment){confirmElement.set('innerHTML',this.data.attrs.comment_reply_marked_as_best_answer_delete_confirm);}
else{confirmElement.set('innerHTML',this.data.attrs.label_delete_confirm);}
this._deleteDialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_delete_confirm_title,confirmElement,{buttons:[{text:this.data.attrs.label_confirm_delete_button,handler:{fn:function(){this._deleteComment(this._getCommentIDFromNode(e.target.ancestor('form').previous()));},scope:this},isDefault:true},{text:this.data.attrs.label_cancel_delete_button,handler:{fn:function(){this._deleteDialog.hide();},scope:this},isDefault:false}]});this._deleteDialog.show();},_deleteComment:function(commentID){this._deleteDialog.destroy();this.editor.hide().resetForm();this._makeRequest({commentID:commentID},this._events('delete'));},_deleteCommentResponse:function(response,originalEventObj){var comment=this.Y.one(this.baseSelector+'_'+originalEventObj.data.commentID),currentPage=parseInt(this.Y.all('#rn_'+this.instanceID+' .rn_CurrentPage').getHTML()[0],10);if(!isNaN(currentPage)){if(this._hasMoreComments(comment)||this._isAReply(comment)){this._requestPage({pageID:parseInt(currentPage,10)},this._events('paginate'));}
else{this._requestPage({pageID:Math.max(currentPage-1,1)},this._events('paginate'));}}
else{this._requestPage({pageID:1},this._events('pageWithComment'));}
RightNow.UI.displayBanner(this.data.attrs.label_delete_comment_banner,{baseClass:this.baseSelector+' .rn_CommentText'});this._toggleNewCommentAction();if(this.newCommentEditor){this.newCommentEditor.form.insert(this.editor.form,"after");this.newCommentEditor.reload();}
this._checkBestAnswerComment(originalEventObj.data.commentID);},_hasMoreComments:function(comment){return comment.previous('div .rn_CommentContainer')||comment.next('div .rn_CommentContainer');},_isAReply:function(comment){return comment.ancestor('.rn_Replies')!==null;},_bestAnswerResponse:function(bestAnswers,originalEventObj){this._updateBestAnswerButtons(originalEventObj.data.commentID,originalEventObj.data.chosenByType);this._refreshBestAnswerBanner(bestAnswers);},_paginateCommentsResponse:function(response,originalEventObj){this.Y.one(this.baseSelector+'_Comments').setHTML(response).removeAttribute('aria-busy');this.readingPosition.fire('refresh',{commentID:originalEventObj.data.commentID});RightNow.Widgets.instantiateWidgetsFoundInContent(response);},_refreshBestAnswerBanner:function(bestAnswers){this.Y.one(this.baseSelector).all('.rn_CommentContainer.rn_BestAnswer').each(function(comment){comment.removeClass('rn_BestAnswer');comment.all('.rn_BestAnswerInfo').setHTML('');});this.Y.Object.each(bestAnswers,function(bestAnswer){var comment=this.Y.one(this.baseSelector+'_'+bestAnswer.commentID);if(comment){comment.addClass('rn_BestAnswer').one('.rn_BestAnswerInfo').setHTML(this._renderBestAnswerLabel(bestAnswer));}},this);},_updateBestAnswerButtons:function(updatedCommentID,updatedAnswerUser){var buttonToUpdate=this.Y.one(this.baseSelector+'_'+updatedCommentID+' .rn_UserType'+updatedAnswerUser);var newButtonType=buttonToUpdate.hasClass('rn_BestAnswerAssignment')?"remove":"pick";if(newButtonType==="remove"){var bestAnswerButton;this.Y.one(this.baseSelector).all('.rn_CommentContainer.rn_BestAnswer').each(function(comment){if(bestAnswerButton=comment.one('.rn_BestAnswerRemoval.rn_UserType'+updatedAnswerUser)){bestAnswerButton.replace(this.Y.Node.create(this._renderBestAnswerButton({commentID:comment.getAttribute('data-commentid')},true,'pick',updatedAnswerUser)));}},this);}
buttonToUpdate.replace(this.Y.Node.create(this._renderBestAnswerButton({commentID:updatedCommentID},true,newButtonType,updatedAnswerUser)));},_renderBestAnswerButton:function(bestAnswer,displayBestAnswerButton,buttonType,userType){this._bestAnswerButton||(this._bestAnswerButton=new EJS({text:this.getStatic().templates.bestAnswerButton}));var viewArgs={displayButton:(typeof displayBestAnswerButton!=='undefined')?displayBestAnswerButton:!!userType,buttonType:(typeof buttonType!=='undefined')?buttonType:'pick',userType:userType,labels:this.data.attrs,bestAnswer:bestAnswer};return this._bestAnswerButton.render(viewArgs);},_renderBestAnswerLabel:function(bestAnswer){this._bestAnswerLabel||(this._bestAnswerLabel=new EJS({text:this.getStatic().templates.bestAnswerLabel}));return this._bestAnswerLabel.render({label:bestAnswer.label,attrs:this.data.attrs});},_extractCommentIDFromEvent:function(handler){var self=this;return function(e){e.preventDefault();handler.call(self,self._getCommentIDFromNode(e.currentTarget),e.currentTarget,self._getCommentContainer(e.currentTarget),e);};},_getCommentContainer:function(node,excludeNode){var className='rn_CommentContainer';return(!excludeNode&&node.hasClass(className))?node:node.ancestor('.'+className);},_getCommentIDFromNode:function(node){var idAttr='data-commentid',commentID;if(!node.hasAttribute(idAttr))node=this._getCommentContainer(node);commentID=parseInt(node?node.getAttribute(idAttr):null,10);return isNaN(commentID)?0:commentID;},_subscribe:function(eventMap){var el=this.Y.one(this.baseSelector);if(el){this.Y.Array.each(eventMap,function(eventInfo){el.delegate(eventInfo[0],eventInfo[2],eventInfo[1],this);},this);}},_toggleNewCommentAction:function(){this.Y.one(this.baseSelector).all('.rn_PostNewComment,.rn_NoNewCommentMessage').toggleClass('rn_Hidden');},_makeRequest:function(requestData,event){var eventObject=new RightNow.Event.EventObject(this,{data:this.Y.mix({w_id:this.data.info.w_id,questionID:this.data.js.questionID},requestData)}),eventName='evt_'+event.name;if(RightNow.Event.fire(eventName+'Request',eventObject)){var requestOptions={scope:this,json:true,type:'POST',data:eventObject,headers:{'Accept':'application/json'},successHandler:this._ajaxResponse(eventName,event.callback)};if(event.dataType){requestOptions.json=false;requestOptions.headers={'Accept':event.dataType};}
RightNow.Ajax.makeRequest(event.endpoint,eventObject.data,requestOptions);}},_ajaxResponse:function(eventName,callback){return function(response,originalEventObj){if(RightNow.Event.fire(eventName+'Response',response,originalEventObj)){var error=('responseText'in response)?this._isCommentErrorResponse(response.responseText):response.errors;if(error){if(eventName.indexOf('bestAnswer')>-1){var bestAnswerLink=this.Y.one(this.baseSelector+'_'+originalEventObj.data.commentID+' .rn_BestAnswerActions .rn_UserType'+originalEventObj.data.chosenByType+' button');if(bestAnswerLink!==null){bestAnswerLink.set('disabled',false);}}
(eventName.indexOf('newComment')>-1?this.newCommentEditor:this.editor).resetForm();if(!RightNow.Ajax.indicatesSocialUserError(response)){if(response.errors&&response.errors[0].externalMessage){message=response.errors[0].externalMessage;}
else{message=RightNow.Interface.getMessage("UNABLE_SAVE_YOUR_COMMENT_AT_THIS_TIME_LBL");}
RightNow.UI.displayBanner(message,{type:'ERROR'});}
this._toggleLoading(false);if(eventName.indexOf('deleteComment')>-1){this._toggleNewCommentAction();}}
else{callback.call(this,response.responseText||response,originalEventObj);}}};},_checkBestAnswerComment:function(commentID){if(this.Y.one('.rn_BestAnswerList .rn_ShowAllCommentText[data-commentid='+commentID+']')){RightNow.Event.fire('evt_refreshBestAnswer',new RightNow.Event.EventObject(this,{data:{commentID:commentID}}));}}});RightNow.Widgets.QuestionComments.readingPosition=RightNow.EventProvider.extend({overrides:{constructor:function(){this.parent();this.current=null;this.comments=null;this.selector=null;this.jumpToOrLoadComment(this.getCommentParam());this.Y.one(window).on('scroll',this.Y.throttle(this.Y.bind(this.guardedScrollHandler,this),100));this.on('refresh',function(evt,args){this.refreshComments();if(args[0]&&args[0].commentID){this.jumpToComment(args[0].commentID);}},this);RightNow.Event.on('evt_jumpToComment',function(evt,args){this.jumpToOrLoadComment(args[0].data.commentID);},this);}},setCommentsSelector:function(selector){this.selector=selector;if(!this.comments){this.refreshComments();}},refreshComments:function(){this.comments=this.Y.all(this.selector);},guardedScrollHandler:function(){if(!this._restoringPosition&&this.comments){this.onScroll();}},onScroll:function(){this.setComment(this.getTopMostComment(this.comments,Math.abs(document.documentElement.scrollTop||document.body.scrollTop)));},getTopMostComment:function(nodeList,bodyTop){var current;nodeList.some(function(node,index){var nodeTop=node.getY(),midwayThruNode=nodeTop+(node.get('offsetHeight')/2);if(bodyTop<=midwayThruNode){if(index===0&&(nodeTop-bodyTop>200)){this.removeComment();}
else{current=node.getAttribute('data-commentid');}
return true;}},this);return current;},removeComment:function(){if(this.current){this.current=null;this.removePath();}},setComment:function(commentID){if(commentID&&commentID!==this.current){this.current=commentID;this.updatePath(commentID);}},updatePath:function(commentID){this.replaceHistoryState(this.replacePath(commentID));},removePath:function(){this.replaceHistoryState(RightNow.Url.deleteParameter(window.location.pathname,'comment'));},replaceHistoryState:function(path){if('replaceState'in window.history&&typeof window.history.replaceState==='function'){window.history.replaceState({commentID:this.current},"",path);}},replacePath:function(commentID){return RightNow.Url.addParameter(window.location.pathname,'comment',commentID);},jumpToComment:function(commentID){if(commentID==='0'){window.location.hash=this.Y.one(this.baseSelector+'_NewComment').getAttribute('id');return true;}
var commentOnThePage=commentID?this.Y.one(this.baseSelector+' #comment_'+commentID):null;if(commentOnThePage){var commentReplies=this.Y.one(this.baseSelector+'_'+commentID).get('parentNode');if(commentReplies.hasClass('rn_Collapsed')){commentReplies.removeClass('rn_Collapsed');}
this.scrollNodeIntoViewport(commentOnThePage.get('parentNode'),50);this.setComment(commentID);return true;}
return false;},loadComment:function(commentID){this.fire('requestPageWithComment',{commentID:commentID});},jumpToOrLoadComment:function(commentID){this.jumpToComment(commentID)||this.loadComment(commentID);},getCommentParam:function(){return RightNow.Url.getParameter('comment');},scrollNodeIntoViewport:function(node,offset){var focusOnNode=function(){node.setAttribute('tabIndex',-1).focus().once('blur',function(){node.removeAttribute('tabIndex');});},anim;anim=new this.Y.Anim({node:'win',to:{scroll:[document.body.scrollLeft,node.get('region').top-(offset||100)]},duration:0.5});anim.after('end',function(){this._restoringPosition=false;focusOnNode();},this);this._restoringPosition=true;anim.run();}});RightNow.Widgets.QuestionComments.embeddedEditor=RightNow.EventProvider.extend({overrides:{constructor:function(){this.parent();this.hideClass='rn_Hidden';}},_onFormSubmit:function(editor){this.fire('submit',{value:editor.getValue()});},_getCommentEditorWidget:function(){var editorType=this.data.attrs.use_rich_text_input?'.rn_RichTextInput':'.rn_TextInput';this._editorInstanceID||(this._editorInstanceID=RightNow.Text.getSubstringAfter(this.form.one(editorType).get('id'),'rn_'));return this._monitorEditorSubmitEvent(RightNow.Widgets.getWidgetInstance(this._editorInstanceID));},_monitorEditorSubmitEvent:function(editor){if(!this._monitoringEditor&&editor){this._monitoringEditor=true;editor.parentForm().on('send',function(){this._onFormSubmit(editor);return false;},this);}
return editor;},_reloadEditor:function(label,formSubmitLabel,content,readOnly){var editor=this._getCommentEditorWidget();if(editor){editor.setLabel(label);editor.reload(content,readOnly);this.resetForm(editor);if(formSubmitLabel)
this.Y.one(editor.parentForm().baseSelector+' button').set('innerHTML',formSubmitLabel);if(readOnly){this.Y.one('.rn_CommentEditForm .rn_FormSubmit button').set('disabled',true);if(!this.data.attrs.use_rich_text_input)
this.Y.one(this.baseSelector+' textarea.rn_TextArea').setAttribute('readonly','readonly');}}},_scrollIntoViewport:function(){if(!this.Y.DOM.inViewportRegion(this.Y.Node.getDOMNode(this.form,true))){(new this.Y.Anim({node:'win',to:{scroll:[document.body.scrollLeft,this.form.getY()-
(this.Y.DOM.winHeight()/2)+
(this.form.get('offsetHeight')/2)]},duration:0.5})).run();}},setForm:function(form){if(form){this.form=form;this.form.all('[type="submit"]').on('click',this._getCommentEditorWidget,this);}
return this;},resetForm:function(editor){editor||(editor=this._getCommentEditorWidget());if(editor){editor.parentForm().fire('reset',new RightNow.Event.EventObject(this));}
return this;},reload:function(){this._reloadEditor();return this;},getHTML:function(){return this._getCommentEditorWidget().getValue('html').html;},isHidden:function(){return this.form&&this.form.hasClass(this.hideClass);},isVisible:function(){return!this.isHidden();},show:function(){this.form.removeClass(this.hideClass);return this;},hide:function(){this.form.addClass(this.hideClass);return this;},toggle:function(){this.form.toggleClass(this.hideClass);return this;}});RightNow.Widgets.QuestionComments.rovingEditor=RightNow.Widgets.QuestionComments.embeddedEditor.extend({overrides:{setForm:function(form){this.parent(form);if(this.form){this.form.delegate('click',this._cancelClick,'.rn_CancelEditor',this);}},_onFormSubmit:function(editor){this.fire('submit',{mode:this.mode,value:editor.getValue(),comment:this.form.previous()});}},_modes:{edit:'rn_CommentEditForm',reply:'rn_CommentReplyForm'},_setMode:function(mode){this.mode=mode;this._setFormClassName(this._modes[mode]);},_setFormClassName:function(className){this._modeClassNames||(this._modeClassNames=this.Y.Object.values(this._modes));this.Y.Array.each(this._modeClassNames,function(classToRemove){this.form.removeClass(classToRemove);},this);this.form.addClass(className);},_cancelClick:function(e){e.halt();this.hide();this.fire('toggle',{mode:this.mode,parent:this.form.previous()});},_orchestrateMove:function(mode,directives){if(!this.form)return false;var parentComment=this.form.previous();if(this.mode===mode&&!directives.shouldMove.call(this)){this.toggle();this.fire('toggle',{mode:mode,parent:parentComment});if(this.isVisible()){this._scrollIntoViewport();}
return false;}
this._setMode(mode);var comment=directives.move.call(this,parentComment);this._scrollIntoViewport();this.fire('move',{mode:mode,prevParent:parentComment,newParent:comment});return true;},_toggleDeleteButton:function(commentContainer){var deleteButton=this.Y.Node.one('.rn_DeleteCommentAction'),isDeletable=commentContainer.one('.rn_CommentContent').hasClass('rn_CommentDeletable');if(!deleteButton&&isDeletable){this.Y.Node.create('<button class="rn_DeleteCommentAction">'+
this.data.attrs.label_delete+'</button>').appendTo(this.Y.one('.rn_CommentEditOptions'));}
else if(deleteButton&&!isDeletable){deleteButton.remove();}},editComment:function(commentContainer,commentText){return this._orchestrateMove('edit',{shouldMove:function(){var readOnly=commentContainer.getAttribute('data-contentType')==='text/html',label=readOnly?this.data.attrs.label_comment_not_editable:this.data.attrs.label_edit_comment;this._reloadEditor(label,this.data.attrs.label_save_edit,this.Y.Lang.trim(commentText),readOnly);return!this.isSiblingOfNode(commentContainer);},move:function(){this.show();commentContainer.insert(this.form,'after');var readOnly=commentContainer.getAttribute('data-contentType')==='text/html',label=readOnly?this.data.attrs.label_comment_not_editable:this.data.attrs.label_edit_comment;this._reloadEditor(label,this.data.attrs.label_save_edit,this.Y.Lang.trim(commentText),readOnly);this._toggleDeleteButton(commentContainer);return commentContainer;}});},replyToComment:function(commentContainer){return this._orchestrateMove('reply',{shouldMove:function(){this._reloadEditor(this.data.attrs.label_reply_to_comment,this.data.attrs.label_post_reply_button);return!this.isSiblingOfNode(commentContainer);},move:function(){this.show();commentContainer.insert(this.form,'after');this._reloadEditor(this.data.attrs.label_reply_to_comment,this.data.attrs.label_post_reply_button);return commentContainer;}});},isSiblingOfNode:function(node){return node.next()===this.form;}});RightNow.Widgets.QuestionComments.commentActions=RightNow.EventProvider.extend({overrides:{constructor:function(){this.parent();var el=this.Y.one(this.baseSelector);this._eventHandler.subscribeToEvents(el,[{type:'share',selector:'.rn_ShareAction',handler:'_shareClicked'},{type:'reply',selector:'.rn_ReplyAction'}],this);}},_eventHandler:{subscribeToEvents:function(el,events,context){var delegator=this.delegator;context.Y.Array.each(events,function(event){el.delegate('click',delegator,event.selector,this,event.type,event.handler);},context);},delegator:function(e,type,handler){e.halt();this.fire(type,e);if(handler){this[handler].call(this,e);}}},_getCommentID:function(node){var idAttr='data-commentid',commentContainer=node.ancestor('['+idAttr+']');return(commentContainer)?commentContainer.getAttribute(idAttr):'';},_getUrl:function(commentID){var location=window.location,pathname=RightNow.Url.deleteParameter(location.pathname,'session');return location.protocol+'//'+
location.hostname+
RightNow.Url.addParameter(RightNow.Url.deleteParameter(pathname,'page'),'comment',commentID);},_shareClicked:function(e){e.halt();var eventObject=new RightNow.Event.EventObject(this,{data:{commentID:this._getCommentID(e.currentTarget),}});RightNow.Ajax.makeRequest(this.data.attrs.check_comment_exists_ajax,eventObject.data,{data:eventObject,json:true,scope:this,successHandler:this._onShareResponse});},_onShareResponse:function(response,e){if(response.errors){if(!RightNow.Ajax.indicatesSocialUserError(response)){var dialogParameters={exitCallback:{fn:function(){messageDialog.hide();},scope:this}},messageDialog;dialogParameters.icon='WARN';messageDialog=RightNow.UI.Dialog.messageDialog(response.errors[0].externalMessage,dialogParameters).show();}}
else{this._showPanel(this.Y.one(this.baseSelector+'_'+e.data.commentID+' .rn_CommentAction.rn_ShareAction'),this._getUrl(e.data.commentID));}},_showPanel:function(referenceNode,commentUrl){if(!this._panel){this._panel=this._createPanel();}
else if(this._panel.get('align').node===referenceNode&&this._panel.get('visible')){this._panel.hide();return;}
this._adjustPanelForComment(referenceNode);this._populateDynamicContent(commentUrl);},_populateDynamicContent:function(commentUrl){var body=this._panel.getStdModNode(this.Y.WidgetStdMod.BODY);body.all('a').each(function(a,baseHref){baseHref=a.getAttribute('data-base-href');if(baseHref){a.setAttribute('href',baseHref+encodeURIComponent(commentUrl));}});body.one('input').set('value',commentUrl).focus().set('selectionStart',0).set('selectionEnd',commentUrl.length);},_adjustPanelForComment:function(referenceNode){referenceNode.ancestor('.rn_CommentContainer').insert(this._panel.get('boundingBox'),'after');this._panel.align(referenceNode,[this.Y.WidgetPositionAlign.TR,this.Y.WidgetPositionAlign.BR]).show();this._panel.onceAfter('visibleChange',function(e){if(!e.newVal){referenceNode.focus();this._panel.destroy();this._panel=null;}},this);},_createPanel:function(){return new this.Y.Panel({headerContent:null,bodyContent:this._renderShareBox(),constrain:true,srcNode:this.Y.Node.create('<div class="rn_ShareBox">'),alignOn:[{node:this.Y.one('win'),eventName:'resize'}],render:this.baseSelector,zIndex:1,hideOn:[{eventName:'clickoutside'},{eventName:'key',node:this.Y.one(document),keyCode:'esc'}]});},_renderShareBox:function(){if(!this._shareBoxView){this._shareBoxView=new EJS({text:this.getStatic().templates.commentShareBox}).render({id:this.baseDomID,labels:{title:RightNow.Interface.getMessage('SHARE_A_LINK_TO_THIS_COMMENT_LBL'),label:RightNow.Interface.getMessage('LINK_TO_THIS_COMMENT_LBL'),fb:RightNow.Interface.getMessage('SHARE_THIS_CONTENT_ON_FACEBOOK_LBL'),twitter:RightNow.Interface.getMessage('SHARE_THIS_CONTENT_ON_TWITTER_LBL'),linkedin:RightNow.Interface.getMessage('SHARE_THIS_CONTENT_ON_LINKEDIN_LBL'),reddit:RightNow.Interface.getMessage('SHARE_THIS_CONTENT_ON_REDDIT_LBL')}});}
return this._shareBoxView;}});
RightNow.Widgets.DiscussionPagination=RightNow.Widgets.extend({constructor:function(){this.Y.all(this.baseSelector+" .rn_DiscussionPaginationLinks a").on('click',this._onDiscussionPaginationClick,this);},_onDiscussionPaginationClick:function(evt){evt.preventDefault();var eventObject=new RightNow.Event.EventObject(this,{data:{qid:RightNow.Url.getParameter('qid'),paginatorLink:evt.target.getAttribute('data-type'),prodcat_id:this.data.js.prodcat_id}});RightNow.Ajax.makeRequest(this.data.attrs.get_next_prev_ajax,eventObject.data,{data:eventObject,json:true,scope:this,successHandler:this._onResponseReceived});},_onResponseReceived:function(response)
{if(parseInt(response,10)!==0){RightNow.Url.navigate(this.data.attrs.redirect_url+response,true);}
else{RightNow.Url.navigate('/app/error/error_id/9',true);}}});
RightNow.Widgets.RichTextInput=RightNow.Field.extend({overrides:{constructor:function(){this.parent();this.data.isTouchDevice=this._isTouchDevice;this.data.readOnly=this.data.attrs.read_only;this.data.isSubscribed=false;this.data.label=this.data.attrs.label_input;this.data.contentWasPruned=false;var data=this.data,instanceID=this.instanceID,Y=this.Y,self=RightNow.Widgets.RichTextInput,converter=new self.converter(data,instanceID,Y),viewController=new self.viewController(data,instanceID,Y);viewController.converter=converter;viewController.setEditor(new self.editor(data,instanceID,Y));viewController.setMenu(new self.menu(data,instanceID+'_Editor',Y));viewController.setInsertLinkDialog(new self.insertLinkDialog(data,instanceID,Y));viewController.setTooltip(new self.tooltip(data,instanceID,Y));this.viewController=viewController;this.Y.one(window).on('windowresize',this.Y.throttle(RightNow.Event.createDelegate(this,function(){this.viewController.editor.queueRegrow();}),200));this._subscribeToFormValidation();this._hintOverlay=null;this._initialInputHeight=null;},getValue:function(type){return this.viewController.getValue(type);}},setLabel:function(newLabel){if(newLabel){this.data.label=newLabel;this.Y.one(this.baseSelector+' label .rn_LabelInput').set('text',newLabel);}},getLabel:function(){return this.data.label;},reload:function(content,readOnly){this.data.js.initialValue=content||'';this.data.readOnly=typeof readOnly==='undefined'?this.data.attrs.read_only:readOnly;this._subscribeToFormValidation();this.viewController.reloadEditor();this.viewController.updateMenuForReadOnlyState();this._toggleErrorIndicator(false);},_subscribeToFormValidation:function(){if(this.data.readOnly||this._subscribedToFormValidation)return;this.parentForm().on('submit',this.onValidate,this);this._subscribedToFormValidation=true;},_displayError:function(message,errorLocation){var commonErrorDiv=this.Y.one('#'+errorLocation),label=this.getLabel();if(this.data.attrs.label_error_fieldname){label=this.data.attrs.label_error_fieldname;}
else if(this.data.attrs.name==='SocialQuestion.Body'){label=RightNow.Interface.getMessage('QUESTION_LBL');}
else if(this.data.attrs.name==='SocialQuestionComment.Body'){label=RightNow.Interface.getMessage('COMMENT_LBL');}
if(commonErrorDiv){if(message.indexOf("%s")>-1){message=RightNow.Text.sprintf(message,label);}
else if(!RightNow.Text.beginsWith(message,label)){message=(label+' '+message);}
commonErrorDiv.append("<div><b><a href='javascript:void(0);' onclick='document.getElementById(\""+
this.baseDomID+'_Iframe'+"\").contentWindow.document.body.focus(); return false;'>"+message+"</a></b></div>");}
this._toggleErrorIndicator(true);},_toggleErrorIndicator:function(show){var method=(show)?'addClass':'removeClass';this.Y.one(this.baseSelector+'_Input')[method]('rn_ErrorField');this.Y.one(this.baseSelector+'_Label')[method]('rn_ErrorLabel');},onValidate:function(type,args){var eventObject=this.createEventObject(),globalEvent='evt_formFieldValidate',result='Pass',errors=[],error_location=args[0].data.error_location,label=this.getLabel(),value=this.getValue(),errorMessage;eventObject.data.value=value.text;this._toggleErrorIndicator(false);if(value.error){this._displayError(value.error,error_location);result='Failure';}
else if(!this.validate(errors,this.Y.Lang.trim(value.text))){this.Y.Array.each(errors,function(error){this._displayError(error,error_location);},this);result='Failure';if(!(eventObject.data.value=this.Y.Lang.trim(value.text)?value.text:'')&&this.data.contentWasPruned){this._displayError(this.data.attrs.label_content_stripped,error_location);}}
RightNow.Event.fire(globalEvent+result,eventObject);return result==='Pass'?eventObject:false;},_isTouchDevice:'ontouchstart'in window||(window.DocumentTouch&&document instanceof DocumentTouch)});RightNow.Widgets.RichTextInput.viewController=RightNow.Widgets.extend({editor:null,menu:null,tooltip:null,insertLinkDialog:null,advancedMode:false,constructor:function(){},getValue:function(type){var result=this.editor.getContent(),response={};try{if(this.advancedMode){result=this.converter.mdToHTML(this.Y.Lang.trim(this.converter.browserHTMLToMarkdown(result)));}
result=this._removeDisallowedContent(result);if(type==='html'){response.html=result.html;}
else if(this.advancedMode){response.text=this.converter.htmlToMd(this.Y.Lang.trim(result.html));}
else{response.text=this.converter.htmlToMd(result.html).replace(/\n/g,"\n\n");}}
catch(e){response.error=this.data.attrs.label_parsing_error;}
return response;},setEditor:function(editor){editor.on({'mouseup':this._updateTextState,'keydown':this._updateTextState,'keyboardFormattingChange':this._keyboardFormattingChange},null,this);this.editor=editor;},reloadEditor:function(){this.editor.reload();},setMenu:function(menu){menu.after({bold:this._bolden,italic:this._italicize,link:this._showLinkDialog,unlink:this._unlink,bullet:this._insertBullet,advanced:this._toggleAdvancedMode},null,this);this.menu=menu;this.updateMenuForReadOnlyState();},updateMenuForReadOnlyState:function(){this.menu.updateForReadOnlyState();},setTooltip:function(tooltip){this.tooltip=tooltip;},setInsertLinkDialog:function(dialog){dialog.on('insertLink',this._insertLink,this);this.insertLinkDialog=dialog;},_updateTextState:function(e){var selection=e.selection,selectionMade=selection&&!selection.collapsed;if(selectionMade&&(e.event.type!=='mouseup'||e.event.button===1)){this.menu.show(e.event,selectionMade);}
else{this.menu.hide(selectionMade);this.menu.toggleLimitedFunctionality(false,'.rn_SlideMenu');}
if(e.event.type==='keydown'){RightNow.Event.fire("evt_formInputDataChanged",null);}
this._showStateOfSelectedText(selection);},_keyboardFormattingChange:function(e){if(e.automatic){this.menu.refreshSelectedStateOfButtons(e);}},_showStateOfSelectedText:function(selection){if(!selection||!selection.elements.size()){this.menu.deselectAllButtons();this.tooltip.hide();return false;}
var selectionData=this._getSelectionData(selection.elements),selectedNode=selectionData.node,aTag=selectionData.tag==='A',ancestors=selection.ancestors;this.menu.refreshSelectedStateOfButtons({link:aTag,bold:selectedNode&&this._nodeIsBold(selectedNode,ancestors),italic:selectedNode&&this._nodeIsItalic(selectedNode,ancestors),bullet:this._nodeIsListItem(ancestors)});if(aTag&&!selectionData.otherTextSelected&&!selection.collapsed){this._showLinkTooltip(selectedNode);return false;}
return true;},_getSelectionData:function(list){var otherTextSelected=false,selectedNode=null,tag=null,_tag,text;list.some(function(node){if(selectedNode&&otherTextSelected){return true;}
if(this.Y.Lang.trim(node.get('text'))){if(!selectedNode&&(_tag=node.get('tagName'))){selectedNode=node;tag=_tag;}
else{otherTextSelected=true;}}},this);return{node:selectedNode,tag:tag,otherTextSelected:otherTextSelected}},_nodeIsBold:function(node,ancestors){var match=/^(STRONG|B)$/,tagName=node.get('tagName');return!!tagName&&(match.test(tagName)||node.getStyle('fontWeight')==='bold'||(ancestors&&!!this.Y.Array.grep(ancestors,match).length)||this._wraps(node,'bold'));},_nodeIsItalic:function(node,ancestors){var match=/^(I|EM)$/,tagName=node.get('tagName');return!!tagName&&(match.test(tagName)||node.getStyle('fontStyle')==='italic'||(ancestors&&!!this.Y.Array.grep(ancestors,match).length)||this._wraps(node,'italic'));},_nodeIsListItem:function(ancestors){return!!this.Y.Array.grep(ancestors,/^UL$/).length;},_wraps:function(node,type){if(node.all('*').size()===1){var child=node.get('firstChild'),text=node.get('textContent')||node.get('innerText'),childText=node.get('textContent')||node.get('innerText');if(text===childText){if(type==='bold'){return this._nodeIsBold(child);}
else if(type==='italic'){return this._nodeIsItalic(child);}}}
return false;},_showLinkDialog:function(){var selection=this.editor.getSelection('text'),placeholderText='',url='',selected;this.data.globalObject=this;if(selection){placeholderText=selection;selection=this.editor.getSelection();selected=selection.elements.item(0);if(selected.get('tagName')==='A'){url=selected.getAttribute('href');}}
this.editor.stashIESelection();this.insertLinkDialog.show(placeholderText,url);},_showLinkTooltip:function(node){var href=node.getAttribute('href');this.tooltip.setContent('<a href="'+href+'" target="_blank">'+href+'</a>').reposition(node,this.Y.one(this.baseSelector+'_Input')).show();var hideTooltipOnClick=function(){this.tooltip.hide();};this.Y.one(document.body).once('click',hideTooltipOnClick,this);this.editor.getBody().once('click',hideTooltipOnClick,this);},_insertLink:function(link){this.editor.insertLink(link);this.menu.toggleLimitedFunctionality(false,'.rn_SlideMenu');this.menu.hide();},_unlink:function(){this.editor.unlink();this.menu.toggleLimitedFunctionality(false,'.rn_SlideMenu');this.menu.hide();},_bolden:function(){this.editor.boldTheSelection();this._showStateOfSelectedText(this.editor.getSelection());this._focusOnEventWidgetIframe();},_italicize:function(){this.editor.italicizeTheSelection();this._showStateOfSelectedText(this.editor.getSelection());this._focusOnEventWidgetIframe();},_insertBullet:function(){this.editor.insertBullet();this._showStateOfSelectedText(this.editor.getSelection());this._focusOnEventWidgetIframe();},_focusOnEventWidgetIframe:function(){var iframe=this.Y.one(this.baseSelector+'_Iframe');if(iframe){iframe.focus();}},_toggleAdvancedMode:function(){var output=this.editor.getContent();if(this.advancedMode){this.menu.enableRichMode();this.menu.toggleLimitedFunctionality();output=this.converter.extractNormalizedMDFromHTML(output);output=this.converter.mdToHTML(output);}
else{this.menu.deselectAllButtons();this.menu.disableRichMode();output=this.converter.htmlToMd(output);output=output.replace(/\n/g,"<br>");}
this.editor.setContent(output);this.advancedMode=!this.advancedMode;this.editor.setAdvancedMode(this.advancedMode);},_removeDisallowedContent:function(html){var content=this.Y.Node.create('<div>'+html+'</div>');content.all(this.converter.disallowedContent).remove();pruned=content.getHTML();this.data.contentWasPruned=html.length>pruned.length;return{html:pruned};}});RightNow.Widgets.RichTextInput.editor=RightNow.Widgets.extend({_advancedMode:false,constructor:function(){this.widget=this.Y.one(this.baseSelector+'_Input');this.editor=this._initializeEditor();if(!this.Y.UA.ie||this.Y.UA.ie>8){this.Y.later(200,this,this._autoGrowInputHeight,null,true);}
this.Y.augment(this,this.Y.EventTarget);},getContent:function(){return this.editor.getContent();},setContent:function(html){this.editor.frame.getInstance().one('body').setHTML(html);},getBody:function(){return this.editor.frame.getInstance().one('body');},setAdvancedMode:function(mode){this._advancedMode=mode;},queueRegrow:function(){this._recomputeHeightWhenVisible=true;},reload:function(){this.editor.frame.destroy();this.editor=this._initializeEditor(true);if(this.shadowInput){this.shadowInput.destroy();this.shadowInput=null;}},_initializeEditor:function(focusWhenReady){this.widget.addClass('rn_Loading');var frame=new this.Y.Frame({content:this.data.js.initialValue||'',extracss:this._getDefaultStyles(),title:this.data.label});frame.onceAfter('render',this.Y.later(this.data.js.initialValue?800:300,this.widget,this.widget.removeClass,'rn_Loading'));frame.after('dom:mouseup',function(e){this.Y.Lang.later(100,this,this._onMouseUp,e);},this);if(this.Y.UA.os==='macintosh'){frame.on(['dom:keydown','dom:keyup'],function(e){var cmdKeys=[91,93,224,];this.cmdKeyDown=e.type==='keydown'&&this.Y.Array.indexOf(cmdKeys,e.keyCode)>-1;},this);}
frame.on('dom:keydown',this._onKeyDown,this);frame.render(this.widget);frame.get('node').setAttribute('title',frame.get('title')).setAttribute('id',this.baseDomID+'_Iframe');var doc=this.Y.Node.getDOMNode(frame.get('node')).contentDocument;if(!this.data.readOnly){doc.body.setAttribute("contenteditable","true");}
this._recomputeHeightWhenVisible=true;try{doc.execCommand('styleWithCSS',false);doc.execCommand('enableObjectResizing',true);}
catch(IEDoesNotSupportTheseCommands_){}
if(this.data.attrs.hint&&!this.data.attrs.always_show_hint){this._initializeHint(doc.body);}
focusWhenReady||(focusWhenReady=this.data.attrs.initial_focus);if(focusWhenReady){doc.body.focus();}
return{win:this.Y.Node.getDOMNode(frame.getInstance().one('window')),doc:doc,frame:frame,getContent:function(){return frame.get('content');}};},_initializeHint:function(input){var overlay=this._hintOverlay=new this.Y.Overlay({bodyContent:this.Y.Node.create('<span class="rn_RichTextInputHint rn_HintBox">'+this.data.attrs.hint+'</span>'),visible:false,zIndex:3,align:{node:this.baseSelector+'_Iframe',points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.BL]}});input.addEventListener('focus',function(){overlay.show();});input.addEventListener('blur',function(){overlay.hide();});overlay.render();},_createShadowInput:function(bottomPadding){this.originalMinHeight=parseInt(this.widget.getComputedStyle('minHeight'),10)||100;this.maxGrowHeight=parseInt(this.widget.getComputedStyle('maxHeight'),10)||500;var shadowContainer=this.Y.Node.create('<div aria-hidden="true"></div>').setStyles({visibility:'hidden',height:0});this.Y.one(this.baseSelector).append(shadowContainer);var shadowInput=new this.Y.Frame({extracss:this._getDefaultStyles()+'body{padding-bottom:'+bottomPadding+'px;}',title:this.data.label+' shadow'});shadowInput.render(shadowContainer);shadowInput.get('node').setAttribute('title',shadowInput.get('title'));return shadowInput;},_autoGrowInputHeight:function(){var yInstance=(this.editor.frame)?this.editor.frame.getInstance():null,body=(yInstance)?yInstance.one('body'):null;if(!yInstance|!body)return;var bottomPadding=60,inputHeight=parseInt(this.widget.getComputedStyle('height'),10),newInput=this.editor.getContent(),isVisible=this._elementIsVisible(this.editor.frame.get('node')),shadowInstance,shadowBody,height;(this.shadowInput||(this.shadowInput=this._createShadowInput(bottomPadding)));if(newInput!==this.previousInput||(this._recomputeHeightWhenVisible&&isVisible)){if(this._advancedMode){newInput.replace(/\n/,'<br>');}
shadowInstance=this.shadowInput.getInstance();if(shadowInstance){shadowBody=shadowInstance.one('body').setHTML(newInput);shadowHeight=shadowBody.get('scrollHeight');if(shadowHeight!==inputHeight){if(shadowHeight===this.originalMinHeight+bottomPadding){shadowHeight=this.originalMinHeight;}
shadowHeight+=bottomPadding;height=(shadowHeight<this.maxGrowHeight)?shadowHeight:this.maxGrowHeight;(this._initialInputHeight||(this._initialInputHeight=height));if(this._hintOverlay&&height>this._initialInputHeight){this._hintOverlay.hide();}
this.widget.setStyle('minHeight',height);this.editor.frame.get('node').setAttribute('height','99%').setStyle('minHeight',height-20);if(isVisible){this._recomputeHeightWhenVisible=false;}}
else if(typeof this.previousInput==='undefined'&&!this._elementIsVisible(this.editor.frame.get('node'))){this._recomputeHeightWhenVisible=true;}}
this.previousInput=newInput;}},_elementIsVisible:function(el){if(!el||!el.get('tagName'))return true;if(el.getComputedStyle('display')==='none')return false;return this._elementIsVisible(el.get('parentNode'));},_onMouseUp:function(e){if(this._advancedMode)return;this.fire('mouseup',{event:e,selection:this.getSelection()});},_keyCombos:{'boldTheSelection':66,'italicizeTheSelection':73},_onKeyDown:function(e){if(!e.shiftKey&&((this.cmdKeyDown&&!e.ctrlKey)||(typeof this.cmdKeyDown==='undefined'&&e.ctrlKey))){this.Y.Object.some(this._keyCombos,function(keyCode,method){if(e.keyCode===keyCode){if(this.cmdKeyDown){this[method]();}
this.fire('keyboardFormattingChange',{bold:method.indexOf('bold')>-1,italic:method.indexOf('italicize')>-1,automatic:!this.cmdKeyDown});return true;}},this);}
if(!this._advancedMode){this.fire('keydown',{event:e,selection:this.getSelection('cursor')});}},getSelection:function(type){var subWindow=this.editor.win,selection=subWindow.getSelection?subWindow.getSelection():null,range;if(!selection){range=this.editor.doc.selection.createRange();if(type==='text')return range.text;}
else if(selection&&type==='text'){return selection.toString();}
else if(selection.rangeCount){range=selection.getRangeAt(0);}
if(!range)return;return this._captureSelectionWithParent(range);},_captureSelectionWithParent:function(range){var parent,collapsed,ancestors=[],selectedFragment;if(range.cloneContents){selectedFragment=range.cloneContents();collapsed=range.collapsed;var startParent=range.startContainer.firstChild||range.startContainer.parentNode,endParent=range.endContainer.firstChild||range.endContainer.parentNode;if(startParent.tagName&&startParent.tagName!=='BODY'){if(startParent===endParent||startParent.contains(endParent)){parent=startParent;}}}
else{collapsed=!range.text;parent=range.parentElement();}
if(parent){for(var nextParent=parent,tagName;nextParent&&nextParent.tagName!=='BODY';nextParent=nextParent.parentNode){tagName=nextParent.tagName;if(tagName==='SPAN'){if(nextParent.style.fontStyle==='italic')tagName='EM';else if(nextParent.style.fontWeight==='bold')tagName='STRONG';}
ancestors.push(tagName);}
if(parent.setAttribute){parent.setAttribute('data-offsetTop',parent.offsetTop);parent.setAttribute('data-offsetLeft',parent.offsetLeft);parent.setAttribute('data-offsetHeight',parent.offsetHeight);parent.setAttribute('data-offsetWidth',parent.offsetWidth);}
parent=parent.cloneNode(true);}
var holder=this.editor.frame.getInstance().Node.create('<div>');holder.appendChild(parent||selectedFragment);return{elements:holder.get('childNodes'),collapsed:collapsed,ancestors:ancestors};},stashIESelection:function(){if(!this.Y.UA.ie)return;var selection,doc=this.editor.doc;if(doc.getSelection){if(doc.getSelection().toString()){if(this.Y.UA.ie>='11'){selection=doc.getSelection();this.liveRange=selection.getRangeAt(0);this.currentRange=this.liveRange.cloneRange();}
else{this.currentSelection=doc.selection.createRange();}}
else{this.currentRange=doc.getSelection();}}
else{var textRange=doc.selection.createRange();this.currentSelection=(textRange.text)?textRange:null;}},_insertHTMLForIE:function(html){if(!this.Y.UA.ie)return false;var iframe=this.Y.Node.getDOMNode(this.Y.one(this.baseSelector+'_Input iframe')),doc=iframe.contentDocument;if(doc.getSelection&&doc.getSelection().toString()){doc.selection.createRange().pasteHTML(html);}
else if(this.currentSelection){var selection=this.currentSelection;selection.pasteHTML(html);selection.collapse(false);selection.select();this.currentSelection=null;}
else if(this.currentRange){this.editor.frame.focus(RightNow.Event.createDelegate(this,function(){var frag,node;if(!doc.getSelection().rangeCount)return;frag=doc.createDocumentFragment();node=this.editor.frame.getInstance().Node.getDOMNode(this.editor.frame.getInstance().Node.create(html));frag.appendChild(node);this.liveRange.insertNode(frag);this.liveRange.collapse(false);}));this.currentRange.deleteContents();}
return true;},_insertHTMLForNonIE:function(html){var editor=this.editor;editor.frame.focus(function(){var selection=editor.win.getSelection();if(selection.getRangeAt&&selection.rangeCount){var range=selection.getRangeAt(0);range.deleteContents();var el=document.createElement('div');el.innerHTML=html;var frag=document.createDocumentFragment(),node,last;while(node=el.firstChild){last=frag.appendChild(node);}
range.insertNode(frag);if(last){range=range.cloneRange();range.setStartAfter(last);range.collapse(true);selection.removeAllRanges();selection.addRange(range);}}});},_insertHTML:function(html){return this._insertHTMLForIE(html)||this._insertHTMLForNonIE(html);},insertLink:function(link){this._insertHTML("<a href='"+link.url+"'>"+(link.text||link.url)+"</a>");},unlink:function(){this.editor.doc.execCommand('unlink');},boldTheSelection:function(){this._applyFormatting('bold');},italicizeTheSelection:function(){this._applyFormatting('italic');},insertBullet:function(){this._applyFormatting('insertUnorderedList');},_applyFormatting:function(command){this.editor.doc.execCommand(command);},_getDefaultStyles:function(){if(!this._defaultStyle){var styles=this.getStatic().editor.editorCSS,styleString='';this.Y.Object.each(styles,function(rules,selector,dynamicRules){dynamicRules=(selector==='body')?'font-family:'+this.Y.one(document.body).getComputedStyle('fontFamily')+';':'';styleString+=selector+'{'+rules.join(';')+';'+dynamicRules+'}';},this);this._defaultStyle=styleString;}
return this._defaultStyle;}},{editorCSS:{'html':['height: 100%'],'body':['background:none','height: 100% !important','font-size: 1em'],'body > p:first-child':['margin:0'],'iframe,img':['display:none']}});RightNow.Widgets.RichTextInput.menu=RightNow.Widgets.extend({_events:{'click .rn_Bolden':'bold','click .rn_Italicize':'italic','click .rn_InsertLink':'link','click .rn_RemoveLink':'unlink','click .rn_InsertBullet':'bullet','click .rn_AdvancedMode button':'advanced'},_buttonClasses:{bold:'.rn_Bolden',italic:'.rn_Italicize',bullet:'.rn_InsertBullet',link:'.rn_InsertLink'},_keyShortcuts:{'rn_Bolden':{win:'CTRL + B',mac:'B'},'rn_Italicize':{win:'CTRL + I',mac:'I'}},popupMenu:null,slideMenu:null,limitedFunctionality:null,richButtonsEnabled:true,constructor:function(){this.Y.augment(this,this.Y.EventTarget);this.widget=this.Y.one(this.baseSelector);this._initializeEvents();if(this.Y.UA.ie){this.limitedFunctionality={severe:this.Y.UA.ie<9};}},updateForReadOnlyState:function(){var button=this.widget.one('button.rn_MenuButton');if(this.data.readOnly){RightNow.UI.hide(button);this.widget.one('.rn_InputArea').setStyle('backgroundColor','#EFEFEF');}
else{RightNow.UI.show(button);}},refreshSelectedStateOfButtons:function(states){var selectedClass='rn_Selected';this.Y.Object.each(states,function(toggleOnOrOff,stateName){this.widget.all(this._buttonClasses[stateName]).toggleClass(selectedClass,toggleOnOrOff);},this);},deselectAllButtons:function(){this.widget.all('.rn_Menu .rn_RichMode button').removeClass('rn_Selected');},disableRichMode:function(){this.widget.all(this._getSelectorForSelection('rich')+' button').addClass('rn_Hidden');this.widget.all(this._getSelectorForSelection('advanced')+' a').removeClass('rn_Hidden');},enableRichMode:function(section){this.widget.all(this._getSelectorForSelection('rich')+' button').removeClass('rn_Hidden');this.widget.all(this._getSelectorForSelection('advanced')+' a').addClass('rn_Hidden');},toggleLimitedFunctionality:function(onOrOff,classOfButtons){if(!this.limitedFunctionality||(this.richButtonsEnabled===onOrOff&&!classOfButtons))return;if(this.limitedFunctionality.severe){this.widget.all('.rn_Menu'+(classOfButtons||'')+' .rn_RichMode').each(function(div,parent,clone){parent=div.get('parentNode');clone=div.cloneNode(true);div.remove();clone.all('button')[(onOrOff)?'removeAttribute':'setAttribute']('disabled',true);parent.insert(clone,0);});}
else{this.widget.all('.rn_Menu'+(classOfButtons||'')+' .rn_RichMode button.rn_FormatAction')
[(onOrOff)?'removeAttribute':'setAttribute']('disabled',true);}
this.richButtonsEnabled=onOrOff;},show:function(clickEvent,somethingIsSelected){if(this.data.isTouchDevice||this.data.readOnly)return false;if(somethingIsSelected){this.slideMenu||(this.slideMenu=this._createSlideMenu());this.slideMenu.one('.rn_RichMode button.rn_InsertLink').removeAttribute('disabled');this.slideMenu.one('.rn_RichMode button.rn_InsertLink').addClass('rn_SelectedText');if(this.Y.UA.ie){this.slideMenu.one('.rn_RichMode button.rn_Bolden').removeAttribute('disabled');this.slideMenu.one('.rn_RichMode button.rn_Italicize').removeAttribute('disabled');this.slideMenu.one('.rn_RichMode button.rn_InsertBullet').removeAttribute('disabled');}
return true;}},hide:function(somethingIsSelected){if(!somethingIsSelected){this.slideMenu||(this.slideMenu=this._createSlideMenu());this.slideMenu.one('.rn_RichMode button.rn_InsertLink').setAttribute('disabled',true);this.slideMenu.one('.rn_RichMode button.rn_InsertLink').removeClass('rn_SelectedText');this.slideMenu.one('.rn_RichMode button.rn_Bolden').removeClass('rn_SelectedText');this.slideMenu.one('.rn_RichMode button.rn_Italicize').removeClass('rn_SelectedText');this.slideMenu.one('.rn_RichMode button.rn_InsertBullet').removeClass('rn_SelectedText');}},destroy:function(){if(this.slideMenu){this.slideMenu.remove();this.slideMenu=null;}},_getSelectorForSelection:function(section){if(!section||section==='all')return'.rn_Menu';return(section==='advanced')?'.rn_AdvancedMode':'.rn_RichMode';},_initializeEvents:function(){this.widget.one('button.rn_MenuButton').on('click',this._toggleSlideMenu,this);var container=this.widget.get('parentNode');this.Y.Object.each(this._events,function(event,action){action=action.split(' ');this.publish(event,{emitFacade:true});container.delegate(action[0],this._onEventDelegate,action.slice(1).join(' '),this,event);},this);},_onEventDelegate:function(e,eventToFire){if(e.currentTarget.getAttribute('disabled'))return;if(eventToFire==='advanced'){e.currentTarget.toggleClass('rn_Selected');}
this.fire(eventToFire,{type:eventToFire});},_toggleSlideMenu:function(e){e.currentTarget.toggleClass('rn_Selected');this.slideMenu||(this.slideMenu=this._createSlideMenu());var to,eventKey;if(this.slideMenu.hasClass('rn_Hidden')){eventKey='start';var parentWidth=parseInt(this.Y.one(this.baseSelector).getComputedStyle('width'),10);if(this.Y.UA.ie){to=parentWidth-(parentWidth-parseInt(e.currentTarget.getComputedStyle('width'),10))+25;}
else{to=parentWidth-(parentWidth-parseInt(e.currentTarget.getComputedStyle('width'),10))-1;}}
else{eventKey='end';to=-200;}
var anim=new this.Y.Anim({node:this.slideMenu,to:{right:to},duration:0.4});anim.on(eventKey,function(){anim.get('node').toggleClass('rn_Hidden');});anim.run();var linkButton=this.slideMenu.one('.rn_RichMode button.rn_InsertLink');if(!linkButton.hasClass('rn_SelectedText')){linkButton.setAttribute('disabled',true);}},_createSlideMenu:function(){var menu=this._renderMenu('rn_SlideMenu').setStyle('right',-200);this._supplyButtonTitles(menu);this._matchExistingSelection(menu);menu.one('.rn_AdvancedMode').removeClass('rn_Hidden');this.widget.one('button.rn_MenuButton').insert(menu,'before');this.toggleLimitedFunctionality(false,'.rn_SlideMenu');return menu;},_renderMenu:function(className){return this.Y.Node.create(new EJS({text:this.getStatic().templates.menu}).render({messages:{label_advanced_mode:this.data.attrs.label_advanced_mode,label_insert_link_dialog:this.data.attrs.label_insert_link_dialog,label_help_link:this.data.attrs.label_help_link},attrs:{editor_help_url:this.data.attrs.editor_help_url},formatContent:!this.data.isTouchDevice})).addClass('rn_Hidden').addClass(className);},_supplyButtonTitles:function(menu){var platform=this.Y.UA.os==='macintosh'?'mac':'win',firefox=this.Y.UA.gecko>0;menu.all('.rn_ScreenReaderOnly').each(function(span,parent,keyLabel){parent=span.ancestor('button');if(parent){keyLabel='';this.Y.Object.some(this._keyShortcuts,function(labels,className){if(!firefox&&parent.hasClass(className)){return keyLabel=' ('+labels[platform]+') ';}});parent.setAttribute('title',span.getHTML()+keyLabel);}},this);},_matchExistingSelection:function(newMenu){var selections=this.widget.all('.rn_Menu button').hasClass('rn_Selected');if(selections.toString().indexOf('true')>-1){var buttons=newMenu.all('button');this.Y.Array.each(selections,function(selected,index){if(selected){buttons.item(index).addClass('rn_Selected');}});}}});RightNow.Widgets.RichTextInput.dialog=RightNow.Widgets.extend({dialog:null,title:null,templateName:null,constructor:function(){this.Y.augment(this,this.Y.EventTarget);this.Y.augment(this,RightNow.RequiredLabel);},show:function(){this.dialog||(this.dialog=this._createDialog());this.dialog.show();var focusFirst=this.dialog.get('contentBox').one('input,a');focusFirst&&focusFirst.focus();},hide:function(){if(this.dialog){this.dialog.hide();this._resetUIControls();}},destroy:function(){if(this.dialog){this.dialog.destroy();this.dialog=null;}},_createDialog:function(templateData,options,globalObject){var initialContent=this.templateName?this.getStatic().templates[this.templateName]:'<form>Provide a template name</form>';if(templateData){initialContent=new EJS({text:initialContent}).render(templateData);}
options=options||{};var buttons=[{text:RightNow.Interface.getMessage("CANCEL_LBL"),handler:options.exitCallback||function(){this.hide();}}];if(options&&options.buttons){buttons=options.buttons.concat(buttons);}
var dialog=new RightNow.UI.Dialog.actionDialog(this.data.attrs[this.title],this.Y.Node.create(initialContent),{cssClass:'rn_RichTextInput',buttons:buttons,exitCallback:options.exitCallback||null}),enterPressHandler=buttons[0].handler,context=null;if('fn'in enterPressHandler&&'scope'in enterPressHandler){context=enterPressHandler.scope;enterPressHandler=enterPressHandler.fn;}
RightNow.UI.Dialog.addDialogEnterKeyListener(dialog,function(name,e,target){target=e[1].target;if(target.get('tagName')==='INPUT'&&target.getAttribute('type')!=='file'){enterPressHandler.call(this,e);}},context);dialog.get('contentBox').all('form').on('submit',function(e){e.halt();});return dialog;},_resetUIControls:function(){var dialogContent=this.dialog.get('contentBox');dialogContent.all('.rn_Loading').addClass('rn_Hidden');dialogContent.all('input').set('value','');dialogContent.all('.rn_ErrorMessage').remove();return dialogContent;},_insertErrorMessage:function(message,fieldID){var form=this.dialog.get('contentBox').one('form'),error=form.one('.rn_MessageBox');if(!error){error=this.Y.Node.create(new EJS({text:this.getStatic().templates.errorMessage}).render({error:{id:fieldID,msg:message}}));form.insert(error,0);}
form.all('input[type="file"]').set('value','');error.focus();}});RightNow.Widgets.RichTextInput.insertLinkDialog=RightNow.Widgets.RichTextInput.dialog.extend({overrides:{title:'label_insert_link_dialog',templateName:'insertLinkForm',_createDialog:function(templateData){templateData||(templateData={});templateData.messages={link_text:this.data.attrs.label_link_text,link_to:this.data.attrs.label_link_to,domID:this.baseDomID};var globalObject=this.data.globalObject;var dialog=this.parent(templateData||true,{buttons:[{text:RightNow.Interface.getMessage("OK_LBL"),handler:{fn:this._onFormSubmit,scope:this}}],exitCallback:function(){this.hide();if(globalObject.editor.Y.UA.ie){globalObject.menu.hide();}
globalObject.menu.toggleLimitedFunctionality(false,'.rn_SlideMenu');}},this.data.globalObject);return dialog;},show:function(placeholderText,url){this.dialog||(this.dialog=this._createDialog());var contentBox=this.dialog.get('contentBox');contentBox.all('.rn_LinkUrlInput input').set('value',url||'');if(!url){contentBox.all('.rn_LinkTextInput input').set('value','');}
contentBox.all('.rn_ErrorMessage').remove();if(placeholderText){contentBox.one('input').set('value',placeholderText);}
this.dialog.show();contentBox.one('input,a').focus();}},_onFormSubmit:function(){var inputs=this.dialog.get('contentBox').all('input'),text=this.Y.Escape.html(inputs.item(0).get('value')),url=inputs.item(1).get('value');if(url&&RightNow.Text.isValidUrl(url)&&url.indexOf('ftp:')!==0){this.Y.later(200,this,function(){if(this.dialog)
this.dialog.hide();});if(url.indexOf('http')!==0){url='http://'+url;}
this.fire('insertLink',{text:text,url:url});}
else{this._insertErrorMessage(RightNow.Interface.getMessage("VALID_URL_REQ_MSG"),inputs.item(1).get("id"));}}});RightNow.Widgets.RichTextInput.converter=RightNow.Widgets.extend({disallowedContent:'iframe,img,table',constructor:function(){},htmlToMd:function(input){if(!input)return'';var output=this._convertEditorMarkupIntoSemanticMarkup(input);output=output.replace(/<\/ul>/g,'</ul><br>');output=new reMarked({link_list:true,gfm_del:false,gfm_tbls:false,h1_setext:false,h2_setext:false}).render(output);return output.replace(/&#x2F;/g,'/');},extractNormalizedMDFromHTML:function(content){var marker=+new Date(),converted=content.replace(/<br>/gi,marker);if(converted===content){converted=content.replace(/ &nbsp;(<div)/gi," "+marker+"$1");}
converted=this.Y.one(document.createDocumentFragment()).setHTML(converted).get('textContent');converted=converted.replace(new RegExp(marker,'g')," \n\n");return converted;},mdToHTML:function(input){if(!input)return'';input=this._prepareStyleTagsForConversionToHTML(input);input=this._escape(input);var html=(new Markdown.Converter()).makeHtml(input);html=this._removeSpacesAddedForConversion(html);return this.Y.Node.create('<div>'+html+'</div>').getHTML();},browserHTMLToMarkdown:function(input){if(!input)return'';var node=this.Y.Node.create('<div>'+input+'</div>'),advancedResultContent='',processSubNodes=function(subnode){if(subnode.get('nodeName')==='BR'){advancedResultContent+="\n\n";}
else if(subnode.get('childNodes').size()===0){advancedResultContent+=subnode.get('text');}
else{if(subnode.get('nodeName')==='DIV'||subnode.get('nodeName')==='P')
advancedResultContent+="\n\n";subnode.get('childNodes').each(processSubNodes);}};node.get('childNodes').each(processSubNodes);return advancedResultContent;},_convertEditorMarkupIntoSemanticMarkup:function(input){var output=this.Y.Node.create('<div>'+input+'</div>'),replacement;this._fixWhitespace(output);this._swapStyleTags(output);this._removeExtraSpanTags(output);output.all('div,p').each(function(node){replacement=this._fixBlockElements(node);if(replacement){node.replace(replacement);}},this);var nodeToCheck=output.get('childNodes');if((nodeToCheck=nodeToCheck.item(0))&&nodeToCheck.get('nodeName').toLowerCase()==='br'){nodeToCheck.remove();}
output.all(this.disallowedContent).remove();this._fixMultilineFormatting(output);this._fixWhitespace(output);var outputHTML=output.getHTML();if(outputHTML.search(/>(&nbsp;)+</)!==-1){outputHTML='<p>'+outputHTML+'</p>';}
return outputHTML;},_swapStyleTags:function(node){if(node.hasChildNodes()){node.get('children').each(function(child){this._swapStyleTags(child);},this);}
if(node.get('nodeName').search(/^(font|span|i|b|strong|em|a)$/i)!==-1){var replacement=this._createSemanticReplacementNode(node);if(replacement){node.replace(replacement);}}},_removeExtraSpanTags:function(node){if(node.hasChildNodes()){node.get('children').each(function(child){this._removeExtraSpanTags(child);},this);}
if(node.get('nodeName')==='SPAN'){node.replace(this.Y.Node.create(node.getHTML()));}},_fixWhitespace:function(node){if(node.hasChildNodes()){node.get('children').each(function(child){this._fixWhitespace(child);},this);}
if(node.get('nodeName').search(/^(font|span|i|b|strong|em|a)$/i)!==-1){var html=node.getHTML(),matches=html.match(/^((?:\s|&nbsp;|<br ?\/?>)*)(.*?)((?:\s|&nbsp;|<br ?\/?>)*)$/),whiteSpace=matches?matches.slice(1):[];if(!whiteSpace[0]&&!whiteSpace[2]){return;}
node.insert(whiteSpace[0].replace(/\s/g,'&nbsp;'),'before');node.setHTML(whiteSpace[1]);node.insert(whiteSpace[2].replace(/\s/g,'&nbsp;'),'after');}},_fixBlockElements:function(node){if(node.get('nodeName').toLowerCase()==='div'||node.get('nodeName').toLowerCase()==='p'){return this.Y.Node.create('<br/><span>'+node.getHTML()+'</span>');}},_fixMultilineFormatting:function(node){if(node.hasChildNodes()){node.get('children').each(function(child){this._fixMultilineFormatting(child);},this);}
if(node.get('nodeName').search(/^(strong|em)$/i)!==-1){var html=node.getHTML(),nodeName=node.get('nodeName').toLowerCase(),replacement=html.replace(/<br>/g,'</'+nodeName+'><br><'+nodeName+'>');node.replace(this.Y.Node.create('<'+nodeName+'>'+replacement+'</'+nodeName+'>'));}},_prepareStyleTagsForConversionToHTML:function(input){input=input.replace(/(\*{2}[^\*]+\*{2})+/g,function(match){return" "+match+" ";});input=input.replace(/(_{2}[^_]+_{2})+/g,function(match){return" "+match+" ";});input=input.replace(/(^|[^\*])(\*[^\*]+[^\n]\*)+/g,function(match){return match.slice(0,match.indexOf('*'))+" "+match.slice(match.indexOf('*'),match.length)+" ";});input=input.replace(/(^|[^_])(_[^_]+[^\n]_)+/g,function(match){return match.slice(0,match.indexOf('_'))+" "+match.slice(match.indexOf('_'),match.length)+" ";});return input;},_removeSpacesAddedForConversion:function(html){html=html.replace(/( <strong>)+/g,'<strong>');html=html.replace(/(<\/strong> )+/g,'</strong>');html=html.replace(/( <em>)+/g,'<em>');html=html.replace(/(<\/em> )+/g,'</em>');return html;},_createSemanticReplacementNode:function(node){if(!node.get('textContent')&&!this.Y.Lang.trim(node.get('innerText')))return'<br><br>';var replacement,domNode=this.Y.Node.getDOMNode(node);if(domNode.style.fontWeight==='bold'&&!this._isSemanticTag(domNode.tagName,'bold')){replacement=this.Y.Node.create(this._wrapHtmlWithTag(this._getReplacementContent(node),'strong'));}
if(domNode.style.fontStyle==='italic'&&!this._isSemanticTag(domNode.tagName,'italic')){replacement=(replacement)?replacement.setHTML(this._wrapHtmlWithTag(replacement.getHTML(),'em')):this.Y.Node.create(this._wrapHtmlWithTag(this._getReplacementContent(node),'em'));}
return replacement;},_getReplacementContent:function(node){return(this._isSemanticTag(node.get('tagName')))?this._getOuterHTML(node):node.getHTML();},_getOuterHTML:function(node){return node.get('outerHTML')||this.Y.Node.create('<div>').append(node).getHTML();},_wrapHtmlWithTag:function(html,tag){return'<'+tag+'>'+html+'</'+tag+'>';},_isSemanticTag:function(tag,which){if((!which||which==='italic')&&(tag==='I'||tag==='EM'))return true;if((!which||which==='bold')&&(tag==='B'||tag==='STRONG'))return true;return false;},_escapeMapping:{'`':'&#x60;','<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;',"'":'&#x27;'},_escape:function(string){var mapping=this._escapeMapping;return(string+'').replace(/[&<>"'`]/g,function(match){return mapping[match];});}});RightNow.Widgets.RichTextInput.tooltip=RightNow.Widgets.extend({element:null,xOffset:15,yOffset:10,bottomBuffer:50,constructor:function(){},_create:function(){this.element=this.Y.Node.create(new EJS({text:this.getStatic().templates.tooltip}).render({messages:{label_change_link:this.data.attrs.label_change_link,label_remove_link:this.data.attrs.label_remove_link}}));this.Y.one(this.baseSelector).append(this.element);},setContent:function(content){this.element||this._create();this.element.one('.rn_ToolTipContent').setHTML(content||'');return this;},hide:function(){this.element&&this.element.addClass('rn_Hidden');return this;},show:function(){this.element||this._create();this.element.removeClass('rn_Hidden');return this;},remove:function(){if(this.element){this.element.remove();this.element=null;}
return this;},reposition:function(reference,container){var coordinates={};this.Y.Object.each({x:['offsetLeft'],y:['offsetTop','offsetHeight']},function(prop,coordinate,value,propName,offset){propName=prop[0];value=(reference.get(propName)||parseInt(reference.getAttribute('data-'+propName),10))+container.get(propName);if(propName=prop[1]){value+=(reference.get(propName)||parseInt(reference.getAttribute('data-'+propName),10));}
offset=this[coordinate+'Offset'];if(value<offset)value=offset+10;coordinates[coordinate]=value;},this);this.element||this._create();if(coordinates.y+this.yOffset>=container.get('offsetHeight')-this.bottomBuffer){this.element.setStyles({top:'auto',bottom:(container.get('offsetHeight')-coordinates.y+this.bottomBuffer)+'px',left:(coordinates.x-this.xOffset)+'px'});}
else{this.element.setStyles({top:(coordinates.y+this.yOffset)+'px',left:(coordinates.x-this.xOffset)+'px',bottom:'auto'});}
return this;}});
RightNow.Widgets.SocialContentRating=RightNow.Widgets.extend({constructor:function(){if(!this.data.js.canRate){return;}
this._baseNode=this.Y.one(this.baseSelector);this._resetButton=this._baseNode.one(".rn_ResetButton");if(this.data.js.canResetRating){this._resetButton.removeClass('rn_Hidden');}
if(this.data.attrs.rating_count_format==="graphical"){this.rateNoVoteGraph=this._baseNode.one(".rn_RateGraphNoVotes");this.rateVotedGraph=this._baseNode.one(".rn_RateGraphVoted");}
if(this._resetButton){this._resetButton.on('click',this._submit,this);}
this._upvoteButton=this.Y.all(this.baseSelector+" .rn_RatingButtons button");if(this._upvoteButton){this._upvoteButton.on('click',this._submit,this);}},_submit:function(e){e.target.hasClass('rn_ResetButton')?this._resetButton.set('disabled',true):this._toggleDisabledVoteButton(true);this.userRating=e.target.hasClass('rn_ResetButton')?0:(parseFloat(e.target.get('value'))||1);this._sendVote();},_sendVote:function(){var eventObject=new RightNow.Event.EventObject(this,{data:{questionID:this.data.attrs.question_id,commentID:this.data.attrs.comment_id,rating:this.userRating,w_id:this.data.info.w_id}});if(RightNow.Event.fire("evt_submitVoteRequest",eventObject)){RightNow.Ajax.makeRequest(this.data.attrs.submit_vote_ajax,eventObject.data,{successHandler:(this.userRating?this._onResponseReceived:this._onVoteResetResponse),scope:this,data:eventObject,json:true});}},_toggleDisabledVoteButton:function(force){this._upvoteButton.set('disabled',force);},_updateVoteButtonTitle:function(message,button,voteAction){var title;button=button||this._upvoteButton;button.set('title',message);if(this.data.attrs.rating_type==='upvote'){title=message;button.all('.rn_ScreenReaderOnly').setHTML(title);}
else if(this.data.attrs.rating_type==='star'){title=message+" "+(voteAction?this.userRating:parseInt(button.get('value'),10));if(voteAction){button.all('.rn_ScreenReaderOnly').addClass('rn_Hidden');this.Y.one(this.baseSelector+" .rn_StarVoting .rn_ScreenReaderOnly").removeClass('rn_Hidden').setHTML(title);button.set('aria-hidden','true');}
else{this.Y.one(this.baseSelector+" .rn_StarVoting .rn_ScreenReaderOnly").addClass('rn_Hidden');button.all('.rn_ScreenReaderOnly').removeClass('rn_Hidden').setHTML(title);button.set('aria-hidden','false');}}
else if(this.data.attrs.rating_type==='updown'){if(voteAction){title=message+" "+((this.userRating===2)?RightNow.Interface.getMessage("UP_LBL"):RightNow.Interface.getMessage("DOWN_LBL"));button.all('.rn_ScreenReaderOnly').addClass('rn_Hidden');this.Y.one(this.baseSelector+" .rn_UpDownVoting .rn_ScreenReaderOnly").removeClass('rn_Hidden').setHTML(title);button.set('aria-hidden','true');}
else{title=message+" "+(button.hasClass('rn_ThumbsUpButton')?RightNow.Interface.getMessage("UP_LBL"):RightNow.Interface.getMessage("DOWN_LBL"));this.Y.one(this.baseSelector+" .rn_UpDownVoting .rn_ScreenReaderOnly").addClass('rn_Hidden');button.all('.rn_ScreenReaderOnly').removeClass('rn_Hidden').setHTML(title);button.set('aria-hidden','false');}}},_updateRating:function(totalRatingLabel){var ratingTitle=totalRatingLabel.label;if(totalRatingLabel.totalVotes===0){ratingTitle=this.data.attrs.label_be_first_to_vote;}
else if(this.data.attrs.rating_count_format==="numerical"&&this.data.attrs.label_vote_count_singular&&this.data.attrs.label_vote_count_plural){ratingTitle=(totalRatingLabel.totalVotes===1)?this.data.attrs.label_vote_count_singular:this.data.attrs.label_vote_count_plural;}
this._baseNode.one(".rn_RatingValue").set('title',ratingTitle);if(this.data.attrs.rating_count_format==="numerical"){this._baseNode.one(".rn_RatingValueNumerical").setHTML(totalRatingLabel.label);}
else{var totalVoteLabel="("+totalRatingLabel.totalVotes+" "+(totalRatingLabel.totalVotes===1?RightNow.Interface.getMessage('USER_LC_LBL'):RightNow.Interface.getMessage('USERS_LC_LBL'))+")";var buttonVal=1;if(totalRatingLabel.totalVotes===0){this.rateVotedGraph.addClass('rn_Hidden');this.rateNoVoteGraph.removeClass('rn_Hidden');this.rateNoVoteGraph.setHTML(totalRatingLabel.label);}
else{this.rateNoVoteGraph.addClass('rn_Hidden');this.rateVotedGraph.removeClass('rn_Hidden');if(this.data.attrs.rating_type==='star'){this.Y.all(this.baseSelector+" .rn_StarRateCount .rn_StarButton").each(function(star){star.removeClass('rn_VotedRating').addClass('rn_VoteRating');star.removeClass('rn_VotedHalfRating').addClass('rn_VoteRating');var classToAdd=(totalRatingLabel.ratedValue<buttonVal)?((totalRatingLabel.ratedValue<(buttonVal-0.5))?'rn_VoteRating':'rn_VotedHalfRating'):'rn_VotedRating';star.removeClass('rn_VoteRating').addClass(classToAdd);this._baseNode.one(".rn_StarRateTotal").setHTML(totalVoteLabel);buttonVal++;},this);}
else if(this.data.attrs.rating_type==='updown'){this._baseNode.one(".rn_UpDownRatePositive").setHTML(totalRatingLabel.positiveVotes);this._baseNode.one(".rn_UpDownRateNegative").setHTML(totalRatingLabel.negativeVotes);this._baseNode.one(".rn_UpDownRateTotal").setHTML(totalVoteLabel);}
else{this._baseNode.one(".rn_RatePositive").setHTML(totalRatingLabel.positiveVotes);this._baseNode.one(".rn_RateTotal").setHTML(totalVoteLabel);}}}},_onResponseReceived:function(response){var bannerOptions={},message;if(response&&response.ratingID&&!response.errors){message=this.data.attrs.label_upvote_thanks;this._upvoteButton.each(function(button){this._updateVoteButtonTitle(message,button,true);if(this.data.attrs.rating_type==='star'){if(parseInt(button.get('value'),10)<=this.userRating){button.addClass('rn_Voted').removeClass('rn_Vote');}}
else if(this.data.attrs.rating_type==='updown'){if(parseFloat(button.get('value'))===this.userRating){button.addClass('rn_Voted').removeClass('rn_Vote');}}},this);if(response.canResetRating){this._resetButton.removeClass('rn_Hidden');this._resetButton.set('disabled',false);}
this._updateRating(response.totalRatingLabel);}
else{this._toggleDisabledVoteButton(false);if(RightNow.Ajax.indicatesSocialUserError(response)){return;}
if(response.errors&&response.errors[0]){message=response.errors[0].externalMessage;}
else{message=response.suggestedErrorMessage||RightNow.Interface.getMessage("THERE_PROB_REQ_ACTION_COULD_COMPLETED_MSG");}
bannerOptions.type='ERROR';}
var activeButton=this.Y.one(this.baseSelector+' .rn_RatingValue');bannerOptions.focusElement=activeButton;RightNow.UI.displayBanner(message,bannerOptions);},_onVoteResetResponse:function(response){var bannerOptions={},message;if(response&&response.ratingReset&&!response.errors){message=this.data.attrs.label_vote_reset;this._updateRating(response.totalRatingLabel);this._toggleDisabledVoteButton(false);this._resetButton.addClass('rn_Hidden');this._upvoteButton.each(function(button){this._updateVoteButtonTitle(this.data.attrs.label_upvote_hint,button,false);button.removeClass('rn_Voted').addClass('rn_Vote');},this);}
else if(response.errors){if(!RightNow.Ajax.indicatesSocialUserError(response)){message=response.errors[0].externalMessage;}
bannerOptions.type='ERROR';}
else{message=response.suggestedErrorMessage||RightNow.Interface.getMessage("THERE_PROB_REQ_ACTION_COULD_COMPLETED_MSG");bannerOptions.type='ERROR';}
RightNow.UI.displayBanner(message,bannerOptions);}});
RightNow.Widgets.SocialContentFlagging=RightNow.Widgets.extend({constructor:function(){if(this.data.js.isFlagged&&this.data.js.flags.length===1)
return;this.Y.one(this.baseSelector+'_Button').on('click',this.flagButtonClicked,this);this.Y.one(this.baseSelector).delegate('click',this.onFlagClick,'a.rn_Flag',this);},flagButtonClicked:function(e){e.halt();if(!e.currentTarget.one('.rn_Flagged.rn_Hidden')&&this.data.js.flags.length===1)
return;if(this.data.js.flags.length>1){this.toggleDropdown();}
else{this.toggleLoadingOnFlag(e.currentTarget);this.submitFlag(this.data.js.flags[0].ID);}},onFlagClick:function(e){if(e.currentTarget.hasClass('rn_Selected')){this.indicateFlaggedStateOnButton();this.toggleDropdown();return;}
this.toggleLoadingOnFlag(e.currentTarget);this.submitFlag(e.currentTarget.getAttribute('data-id'));},submitFlag:function(flagID){var eo=new RightNow.Event.EventObject(this,{data:{flagID:flagID,questionID:this.data.attrs.question_id,commentID:this.data.attrs.comment_id,w_id:this.data.info.w_id}});if(RightNow.Event.fire('evt_ContentFlagSubmit',eo)){RightNow.Ajax.makeRequest(this.data.attrs.submit_flag_ajax,eo.data,{data:eo,json:true,scope:this,successHandler:this.onFlagSubmitted});}},onFlagSubmitted:function(response,originalEventObject){if(RightNow.Event.fire('evt_ContentFlagResponse',response,originalEventObject)&&response.type){this.indicateFlaggedStateOnButton();if(this.dropdown){this.indicateFlaggedStateInDropdown(response.type);this.toggleDropdown();}}
else{this.toggleLoadingOnFlag(this.Y.one(this.baseSelector+'_Button'),false);if(!RightNow.Ajax.indicatesSocialUserError(response)){RightNow.UI.displayBanner(this.data.attrs.label_action_cannot_be_completed,{type:'ERROR',focusElement:this.Y.one(this.baseSelector+' .rn_Unflagged')});}}},indicateFlaggedStateInDropdown:function(flagID){var widget=this.Y.one(this.baseSelector),className='rn_Selected',selectedFlag=widget.one('.rn_Flag[data-id="'+flagID+'"]');widget.all('.rn_Flag').removeClass(className);this.toggleLoadingOnFlag(selectedFlag.addClass(className));},indicateFlaggedStateOnButton:function(){var flagButton=this.Y.one(this.baseSelector+'_Button');flagButton.setAttribute('title',this.data.attrs.label_already_flagged_tooltip);RightNow.UI.show(flagButton.all('.rn_Flagged'));RightNow.UI.hide(flagButton.all('.rn_Unflagged'));flagButton.focus();this.toggleLoadingOnFlag(flagButton,false);},toggleLoadingOnFlag:function(flagItem,force){flagItem.toggleClass('rn_Loading',force).setAttribute('aria-busy',flagItem.hasClass('rn_Loading'));},toggleDropdown:function(){this.dropdown||(this.dropdown=this.createDropdown(this.renderDropdown()));if(this.dropdown.get('visible')){this.dropdown.hide();}
else{this.dropdown.show().get('contentBox').one('a').focus();}},createDropdown:function(dropdown){return new this.Y.Panel({srcNode:dropdown,align:{node:this.baseSelector,points:[this.Y.WidgetPositionAlign.TC,this.Y.WidgetPositionAlign.BC]},alignOn:[{node:this.Y.one('win'),eventName:'resize'}],visible:false,zIndex:1,render:this.baseSelector,buttons:[],constrain:true,hideOn:[{eventName:'clickoutside'},{node:dropdown.all('a').slice(-1).item(0),eventName:'keydown',keyCode:RightNow.UI.KeyMap.TAB}]});},renderDropdown:function(){return this.Y.Node.create(new EJS({text:this.getStatic().templates.view}).render({flags:this.data.js.flags}));}});
RightNow.Widgets.FormSubmit=RightNow.Form.extend({overrides:{constructor:function(){this.parent();this.inputDataChanged=false;this._formButton=this.Y.one(this.baseSelector+"_Button");this._formSubmitFlag=this.Y.one(this.baseSelector+"_Submission");this._navigateToUrlFlag=false;if(!this._formButton||!this._formSubmitFlag)return;if(this._formSubmitFlag.get("checked")){this._formButton.set("disabled","true");return;}
this.on("validation:fail",this._onFormValidationFail,this).on("validation:fail",this._resetFormButton,this,false).on("validation:pass",this._onFormValidated,this).on("response",this._defaultFormSubmitResponse,this).on("response",this._resetFormButton,this).on("submitRequest",this._onButtonClick,this).on("reset",this._resetFormForSubmission,this).on("responseError",this._onErrorResponse,this).on("formUpdated",this._onFormUpdated,this);this._toggleClickListener(true);RightNow.Event.subscribe("evt_formToggleButton",function(type,args){this._toggleClickListener(args[0]);},this);RightNow.Event.subscribe("evt_formInputDataChanged",function(){this.inputDataChanged=true;},this);if(this.data.attrs.unsaved_data_dialog){var that=this;window.onbeforeunload=function(e){if(that.inputDataChanged){return"";}};}}},_onButtonClick:function(evt){this.inputDataChanged=false;if(evt&&evt.halt){evt.halt();}
if(this._requestInProgress)return false;this._toggleClickListener(false);this._removeFormErrors();if(this.Y.UA.ie&&window.external&&"AutoCompleteSaveForm"in window.external){window.external.AutoCompleteSaveForm(document.getElementById(this._parentForm));}
this._fireSubmitRequest();},_fireSubmitRequest:function(){var eo=new RightNow.Event.EventObject(this,{data:{form:this._parentForm,f_tok:this.data.js.f_tok,error_location:this._errorMessageDiv.get("id"),timeout:this.data.attrs.timeout*1000}});RightNow.Event.fire("evt_formButtonSubmitRequest",eo);this.fire("collect",eo);},_onFormValidated:function(){this._toggleLoadingIndicators(true);this.fire("send",this.getValidatedFields());},_onFormValidationFail:function(){this._displayErrorMessages(this._errorMessageDiv);RightNow.Event.fire("evt_formValidateFailure",new RightNow.Event.EventObject(this));},_clearFlashData:function(){var infoDiv=this.Y.one('.rn_MessageBox.rn_InfoMessage');if(infoDiv){var parentClass=infoDiv.ancestor().getAttribute('class');if(parentClass&&parentClass.search("rn_SmartAssistantDialog")===-1)
infoDiv.set('innerHTML','').removeClass('rn_InfoMessage');}},_absoluteOffset:function(element){var top=0;do{top+=element.get('offsetTop');element=element.get('offsetParent');}
while(element);return top;},_displayErrorMessages:function(messageArea){messageArea.addClass("rn_MessageBox").addClass("rn_ErrorMessage").removeClass("rn_Hidden");this._clearFlashData();if(!this.Y.DOM.inViewportRegion(this.Y.Node.getDOMNode(messageArea),true)){(new this.Y.Anim({node:this.Y.one(document.body),to:{scrollTop:this._absoluteOffset(messageArea)-40},duration:0.5})).run();}
var firstField=messageArea.one("a");if(firstField){firstField.focus();firstField.setAttribute('role','alert');messageArea.removeAttribute('tabIndex');}
else{messageArea.set('tabIndex',0);messageArea.setAttribute('role','alert');messageArea.focus();}
var errorLbl=messageArea.all("div").size()>1?RightNow.Interface.getMessage("ERRORS_LBL"):RightNow.Interface.getMessage("ERROR_LBL");messageArea.prepend("<h2>"+errorLbl+"</h2>");messageArea.one("h2").setAttribute('role','alert');},_defaultFormSubmitResponse:function(type,args){if(this.fire('defaultResponseHandler',args[0])){this._formSubmitResponse(type,args);}},_formSubmitResponse:function(type,args){var responseObject=args[0].data,result;if(!this._handleFormResponseFailure(responseObject)&&responseObject.result){result=responseObject.result;if(!result.sa){if(result.transaction||result.redirectOverride){return this._handleFormResponseSuccess(result);}
else{this._displayErrorDialog();}}}
args[0].data||(args[0].data={});args[0].data.form=this._parentForm;RightNow.Event.fire('evt_formButtonSubmitResponse',args[0]);},_handleFormResponseSuccess:function(result){this._formSubmitFlag.set("checked",true);if(this.data.attrs.label_on_success_banner){RightNow.UI.displayBanner(this.data.attrs.label_on_success_banner,{focusElement:this._formButton}).on('close',function(){this._confirmOnNavigate(result);},this);return;}
this._confirmOnNavigate(result);},_handleFormResponseFailure:function(responseObject){if(!responseObject){this._displayErrorDialog(RightNow.Interface.getMessage("THERE_PROB_REQ_ACTION_COULD_COMPLETED_MSG"));return true;}
if(responseObject.errors){var errorMessage="";this.Y.Array.each(responseObject.errors,function(error){errorMessage+="<div><b>"+error.externalMessage+"</b></div>";});this._errorMessageDiv.append(errorMessage);this._onFormValidationFail();return true;}
if(!responseObject.result){this._displayErrorDialog();return true;}
return false;},_navigateToUrl:function(result){var url;if(result.redirectOverride){url=result.redirectOverride+result.sessionParam;}
else if(this.data.attrs.on_success_url){var paramsToAdd='';this.Y.Object.each(result.transaction,function(details){if(details.key){paramsToAdd+='/'+details.key+'/'+details.value;}});if(paramsToAdd){url=this.data.attrs.on_success_url+paramsToAdd+result.sessionParam;}
else{var sessionValue=result.sessionParam.substr(result.sessionParam.lastIndexOf("/")+1);if(!sessionValue&&this.data.js.redirectSession)
sessionValue=this.data.js.redirectSession;url=RightNow.Url.addParameter(this.data.attrs.on_success_url,'session',sessionValue);}}
else{url=window.location+result.sessionParam;}
RightNow.Url.navigate(url+this.data.attrs.add_params_to_url);},_confirmOnNavigate:function(result){if(this.data.attrs.on_success_url!=='none'){if(this.data.attrs.label_confirm_dialog!==''){RightNow.UI.Dialog.messageDialog(this.data.attrs.label_confirm_dialog,{exitCallback:{fn:function(){this._navigateToUrl(result);},scope:this},width:'250px'});}
else{if(this.Y.Lang.trim(this.data.attrs.on_success_url)!==''){this._navigateToUrlFlag=true;}
this._navigateToUrl(result);}}},_resetFormForSubmission:function(){this._navigateToUrlFlag=false;this._removeFormErrors();this._resetFormButton();},_onFormUpdated:function(){if(this._errorMessageDiv.all('[data-field]').size()===0){this._errorMessageDiv.addClass("rn_Hidden").set("innerHTML","");}},_onErrorResponse:function(response){this._displayErrorDialog(response.suggestedErrorMessage||RightNow.Interface.getMessage("THERE_PROB_REQ_ACTION_COULD_COMPLETED_MSG"));this._resetFormButton();},_resetFormButton:function(){if(this._navigateToUrlFlag){return;}
this._toggleLoadingIndicators(false);this._toggleClickListener(true);},_removeFormErrors:function(){this._errorMessageDiv.addClass("rn_Hidden").setHTML("");},_displayErrorDialog:function(message){RightNow.UI.Dialog.messageDialog(message||RightNow.Interface.getMessage('ERROR_PAGE_PLEASE_S_TRY_MSG'),{icon:"WARN"});},_toggleLoadingIndicators:function(turnOn){this._formButton.setHTML((turnOn)?this.data.attrs.label_submitting_message:this.data.attrs.label_button).toggleClass('rn_Loading',turnOn);},_toggleClickListener:function(enable){if(this.Y.UA.ie){this._formButton.set("disabled",false);this.Y.one(this.baseSelector+" button").toggleClass("rn_IeFormButton",!enable);}
else{this._formButton.set("disabled",!enable);}
this._requestInProgress=!enable;this.Y.Event[((enable)?"attach":"detach")]("click",this._onButtonClick,this._formButton,this);}});
RightNow.Widgets.ProductCategoryInput=RightNow.Field.extend({overrides:{constructor:function(){this.parent();this.Y.augment(this,RightNow.ProductCategory);this._maxDepth=this.data.attrs.max_lvl||6;this._notRequiredDueToProductLinking=false;this.displayField=this.Y.one(this.baseSelector+"_"+this.data.js.data_type+"_Button");this.requiredLabel=this.Y.one(this.baseSelector+"_RequiredLabel");this.errorLabel=this.Y.one(this.baseSelector+"_ErrorLabel");if(this.data.js.readOnly||!this.displayField)return;RightNow.Event.subscribe("evt_resetProductCategoryMenu",this._resetProductCategoryMenu,this);this.parentForm().on('submit',this._onValidate,this);if(this.data.attrs.set_button){this.Y.one(this.baseSelector+"_"+this.data.js.data_type+"_SetButton").on("click",this._setButtonClick,this);RightNow.Widgets.formTokenRegistration(this);}
if(this.data.attrs.hint){this._hintOverlay=this._initializeHint();}
this._eo=new RightNow.Event.EventObject(this,{data:{data_type:this.data.js.data_type,hm_type:this.data.js.hm_type,linking_on:this.data.js.linkingOn,linkingProduct:0,table:this.data.js.table,cache:[],name:((this.data.js.data_type.indexOf('prod')>-1)?'prod':'cat')}});this.on('constraintChange:required_lvl',this.updateRequiredLevel,this);if(this.data.attrs.verify_permissions!=='None'&&this.data.js.readableProdcatIds.length>0){this._updatePermissionedHierData('hierData');if(this.data.js.linkingOn&&(this.data.js.data_type==='Category')&&this.data.js.hierDataNone){this._updatePermissionedHierData('hierDataNone');}
var originalHierData=this.data.js.hierData;this.initializeTreeView(this.data.js.data_type);this.Y.Object.each(this.Y.Object.keys(originalHierData),function(key){this.disableNonPermissionedNodes(originalHierData[key]);},this);}
else{this.initializeTreeView(this.data.js.data_type);}
if(this.data.attrs.required_lvl&&this.requiredLabel){this.requiredLabel.replaceClass('rn_Hidden','rn_Required');}},_initializeHint:function(){if(this.Y.Overlay){var overlay;if(this.data.attrs.always_show_hint){overlay=this._createHintElement(true);var realignHintAfterFormValidation=this.Y.bind(this._realignHint,this,1);this.parentForm().on('validation:pass',realignHintAfterFormValidation).on('validation:fail',realignHintAfterFormValidation).on('response',realignHintAfterFormValidation);}
else{overlay=this._createHintElement(false);this.displayField.on("focus",overlay.show,overlay);this.displayField.on("blur",overlay.hide,overlay);}
return overlay;}
else{var hint=this.Y.Node.create('<span class="rn_HintText"/>').setHTML(this.data.attrs.hint);this.displayField.insert(hint,'after');}}},buildPanel:function(){RightNow.ProductCategory.prototype.buildPanel.call(this);this.dropdown.on('show',this.Y.bind(this._toggleHint,this,'show'));},_resetProductCategoryMenu:function(){this.tree.resetSelectedNode();this.displaySelectedNodesAndClose(false,false);this._removeErrorMessages();},_updatePermissionedHierData:function(dataType){if(!(this.data.js[dataType]&&this.Y.Lang.isObject(this.data.js[dataType]))){throw new Error("Widget does not have this.data.js."+dataType+" attribute set, or its value is not a valid object");}
this.Y.Object.each(this.Y.Object.keys(this.data.js[dataType]),function(key){this.data.js[dataType][key]=this.groomProdcats(this.data.js[dataType][key]);},this);},displaySelectedNodesAndClose:function(focus,fireSelectionEvent){fireSelectionEvent=typeof fireSelectionEvent!=='undefined'?fireSelectionEvent:true;this._eo.data.hierChain=this.tree.get('valueChain');if(fireSelectionEvent&&this._checkSelectionErrors()){RightNow.Event.fire("evt_productCategorySelected",this._eo);}
this.fire('change',this);delete this._eo.data.hierChain;RightNow.ProductCategory.prototype.displaySelectedNodesAndClose.call(this,focus);},selectNode:function(node){this._selected=true;if((!node.expanded&&node.value&&!node.loaded)||(this.data.js.linkingOn&&this.data.js.data_type==="Product")){this.getSubLevelRequest(node);}
else{this._errorLocation="";this._checkSelectionErrors();}
RightNow.ProductCategory.prototype.selectNode.call(this,node);},getSubLevelRequest:function(expandingNode){RightNow.ProductCategory.prototype.getSubLevelRequest.call(this,expandingNode);if(this._eo.data.link_map)
delete this._eo.data.link_map;},getSubLevelRequestEventObject:function(expandingNode){this._eo.data.level=expandingNode.depth+1;this._eo.data.value=expandingNode.value;this._eo.data.label=expandingNode.label;this._eo.data.reset=false;this._requestingParent=this._eo.data.value;if(this._eo.data.linking_on){if(this.data.js.data_type==="Category"){if(expandingNode.loaded){return;}
this._eo.data.reset=(this._eo.data.value<1);}
else if(this._eo.data.value<1&&this.data.js.data_type==="Product"){this._nodeBeingExpanded=false;RightNow.Event.fire("evt_menuFilterGetResponse",new RightNow.Event.EventObject(this,{data:{reset_linked_category:true,data_type:"Category",reset:true}}));return;}}
if(this.data.js.link_map){this._eo.data.link_map=this.data.js.link_map;delete this.data.js.link_map;}
return this._eo;},getSubLevelResponse:function(type,args){var evtObj=args[0],tempNode;if((evtObj.w_id&&evtObj.w_id===this.instanceID)||(this.data.js.linkingOn&&evtObj.data.data_type==="Category"&&this.data.js.data_type===evtObj.data.data_type)){var currentRoot;if(evtObj.data.reset_linked_category&&this.data.js.data_type==="Category"){if(this.data.js.link_map)
delete this.data.js.link_map;if(!this.tree||evtObj.data.reset){this.buildTree(true);this._linkedCategorySubset=false;if(this.data.attrs.verify_permissions!=='None'&&this.data.js.readableProdcatIds.length>0){this.Y.Object.each(this.Y.Object.keys(this.data.js.hierDataNone),function(key){this.disableNonPermissionedNodes(this.data.js.hierDataNone[key]);},this);}}
currentRoot=this._requestingParent=null;if(!evtObj.data.reset){this._linkedCategorySubset=true;this.tree.clear(this.data.attrs.label_all_values);}
this.dropdown.set('triggerText',this.data.attrs.label_nothing_selected);this._errorLocation='';this._checkSelectionErrors();}
else{currentRoot=this._requestingParent;}
var hierLevel=evtObj.data.level,hierData=evtObj.data.hier_data;if(hierLevel<=this._maxDepth){if(hierLevel===this._maxDepth){hierData=this.Y.Array.map(hierData,function(node){node.hasChildren=false;return node;});}
if(this.data.attrs.verify_permissions!=='None'&&this.data.js.readableProdcatIds.length>0){hierData=this.groomProdcats(hierData);this.insertChildrenForNode(hierData,currentRoot);this.disableNonPermissionedNodes(hierData);}
else{this.insertChildrenForNode(hierData,currentRoot);}}
if(this._selected){this._errorLocation="";this._checkSelectionErrors();if(this.data.attrs.required_lvl){this._selected=false;}}
if(this._requestingParent)
this.tree.selectNodeWithValue(this._requestingParent,true);}},_setButtonClick:function()
{var hierValues=[],labelChain=this.tree.get("labelChain"),valueChain=this.tree.get("valueChain");if(valueChain.length===0||valueChain[0]===0){if(!this._errorMessageDiv){this._errorMessageDiv=this.Y.Node.create("<div class='rn_MessageBox rn_ErrorMessage'/>");this.Y.one(this.baseSelector).prepend(this._errorMessageDiv);}
this._errorMessageDiv.setHTML("<b><a href='javascript:void(0);' onclick='document.getElementById(\""+this.displayField.get('id')+"\").focus(); return false;'>"+
this.data.attrs.label_nothing_selected+"</a></b>");this._errorMessageDiv.prepend("<h2>"+RightNow.Interface.getMessage("ERROR_LBL")+"</h2>");this._errorMessageDiv.one("h2").setAttribute('role','alert');RightNow.UI.show(this._errorMessageDiv);var errorLink=this._errorMessageDiv.one('a');if(errorLink){errorLink.focus();}
return;}
if(!this._checkSelectionErrors()){return;}
RightNow.UI.hide(this._errorMessageDiv);for(var i=0;i<labelChain.length;i++)
hierValues[i]={"id":valueChain[i],"label":labelChain[i]};this.tree.resetSelectedNode();this.displaySelectedNodesAndClose(false,false);this._eo.data.hierSetData=hierValues;this._eo.data.id=hierValues[hierValues.length-1].id;this._eo.data.f_tok=this.data.js.f_tok;RightNow.Event.fire("evt_menuFilterSelectRequest",this._eo);},_onValidate:function(type,args){var formEventObject=this.createEventObject();this._errorLocation=this.lastErrorLocation=args[0].data.error_location;if(this._checkSelectionErrors()){formEventObject.data.value=this.tree.get('value')||null;if(formEventObject.data.required&&this._notRequiredDueToProductLinking){formEventObject.data.required=false;}
RightNow.Event.fire("evt_formFieldValidatePass",formEventObject);return formEventObject;}
RightNow.Event.fire("evt_formFieldValidateFailure",this._eo);return false;},_createHintElement:function(visibility){var overlay=this.Y.Node.create("<span class='rn_HintBox'/>").set('id',this.baseDomID+'_Hint').setHTML(this.data.attrs.hint);if(visibility)
overlay.addClass("rn_AlwaysVisibleHint");return new this.Y.Overlay({visible:visibility,align:{node:this.displayField,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.TR]},bodyContent:overlay,render:this.Y.one(this.baseSelector)});},_toggleHint:function(hideOrShow){if(this._hintOverlay&&this._hintOverlay[hideOrShow]&&!this.data.attrs.always_show_hint)
this._hintOverlay[hideOrShow]();},_realignHint:function(delay){if(this._hintOverlay){if(delay){this.Y.later(delay,this._hintOverlay,this._hintOverlay.align);}
else{this._hintOverlay.align();}}},swapLabel:function(container,requiredLevel,label,template){var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,requiredLevel:requiredLevel,requiredMarkLabel:RightNow.Interface.getMessage("FIELD_REQUIRED_MARK_LBL"),requiredLabel:RightNow.Interface.getMessage("REQUIRED_LBL")};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},updateRequiredLevel:function(evt,constraint){var newLevel=constraint[0].constraint;if(newLevel>this.data.attrs.max_lvl||this.data.attrs.required_lvl===newLevel)return;if(this.data.attrs.required_lvl>0&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
this.swapLabel(this.Y.one(this.baseSelector+'_Label'),newLevel,this.data.attrs.label_input,this.getStatic().templates.label);this.data.attrs.required_lvl=newLevel;if(!newLevel){this.displayField.removeClass("rn_ErrorField");this.Y.one(this.baseSelector+"_Label").removeClass("rn_ErrorLabel");}
else{this._errorLocation="";this._checkSelectionErrors();}},_checkSelectionErrors:function(){var currentNode=this.tree.getSelectedNode(),currentDepth=(currentNode?currentNode.depth:0)+1,noErrorsFound=true;this._removeErrorMessages();this._notRequiredDueToProductLinking=false;if(this.data.js.linkingOn&&this.data.js.data_type==="Category"&&this._linkedCategorySubset){if(this.tree.getNumberOfNodes()===1){this._notRequiredDueToProductLinking=true;}}
if(this.data.attrs.required_lvl||!this.userHasFullProdcatPermissions()){if(!this.tree){this.buildTree();}
if(!this._notRequiredDueToProductLinking&&(!currentNode||!currentNode.value||((!currentNode.loaded||currentNode.hasChildren)&&(currentDepth<this.data.attrs.required_lvl)))){var message=(!currentNode||!currentNode.value)?this.data.attrs.label_nothing_selected:this.data.attrs.label_required;this._displayErrorMessage(message,currentNode);noErrorsFound=false;}}
if(currentNode&&currentNode.value&&!this.checkPermissionsOnNode(currentNode.value)){this._displayErrorMessage(this.data.attrs.label_not_permissioned,currentNode);noErrorsFound=false;}
return noErrorsFound;},_removeErrorMessages:function(){this.displayField.removeClass("rn_ErrorField");if(this.errorLabel){this.errorLabel.replaceClass('rn_ErrorLabel','rn_Hidden');}
RightNow.UI.hide(this._accessibleErrorMessageDiv);this._realignHint();if(!this.data.attrs.required_lvl&&this.requiredLabel){this.requiredLabel.replaceClass('rn_Required','rn_Hidden');}},_displayErrorMessage:function(message,currentNode){this.displayField.addClass("rn_ErrorField");if(this.requiredLabel){this.requiredLabel.replaceClass('rn_Hidden','rn_Required');}
message=(message.indexOf("%s")>-1)?RightNow.Text.sprintf(message,currentNode.label):message;if(this.errorLabel){this.errorLabel.setHTML(message).replaceClass('rn_Hidden','rn_ErrorLabel');}
var label=this.data.attrs.label_error||this.data.attrs.label_input;if(this._errorLocation){var commonErrorDiv=this.Y.one('#'+this._errorLocation);if(commonErrorDiv){commonErrorDiv.append("<div data-field=\""+this._fieldName+"\"><b><a href='#' onclick='document.getElementById(\""+this.displayField.get('id')+"\").focus(); return false;'>"+
label+" - "+message+"</a></b></div> ");}}
if(this.dialog){this.dialog.addErrorMessageForValue(message,currentNode.value);}
this._realignHint();}});
RightNow.Widgets.TextInput=RightNow.Field.extend({overrides:{constructor:function(){if(this.data.js.readOnly)return;this.parent();this._seenValues=[];this.input=this.Y.one(this._inputSelector);if(!this.input)return;if(this.data.attrs.hint&&!this.data.attrs.hide_hint&&!this.data.attrs.always_show_hint){this._initializeHint();}
if(this.data.attrs.initial_focus&&this.input.focus)
this.politeFocus(this.input);if(this.data.js.mask){this._initializeMask();}
if(RightNow.Text.beginsWith(this._fieldName,"Contact.Phones.")||this._fieldName==="Contact.Address.PostalCode"){RightNow.Event.on("evt_provinceResponse",this.onProvinceChange,this);}
if(this.data.attrs.validate_on_blur){this.input.on("blur",this._blurValidate,this);if(this.data.attrs.require_validation){this.Y.Event.attach("blur",this._blurValidate,this._inputSelector+'_Validate',this,true);}}
this.input.on('change',function(){RightNow.Event.fire("evt_formInputDataChanged",null);this.fire('change',this);},this);if(this.data.attrs.require_validation){this.Y.one(this._inputSelector+'_Validate').on('change',function(){this.fire('change',this);},this);}
this._isFormSubmitting=false;this.parentForm().on("submit",this.onValidate,this).on("send",this._toggleFormSubmittingFlag,this).on("response",this._toggleFormSubmittingFlag,this);this._subscribedToFormValidation=true;this.on("constraintChange",this.constraintChange,this);RightNow.Event.on("evt_formValidateFailure",this._onValidateFailure,this);}},swapLabel:function(container,requiredness,label,template){this.Y.augment(this,RightNow.RequiredLabel);var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,required:requiredness,hint:this.data.attrs.hint};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},setLabel:function(newLabel){if(newLabel){this.Y.one(this.baseSelector+' label.rn_Label').set('text',newLabel);}},reload:function(content,readOnly){this.data.js.initialValue=content||'';this.data.readOnly=typeof readOnly==='undefined'?this.data.attrs.read_only:readOnly;content=typeof content!=='undefined'?content:'';this._subscribeToFormValidation();this.Y.one('#rn_'+this.instanceID+' textarea.rn_TextArea').set('value',content);},_subscribeToFormValidation:function(){if(this.data.readOnly||this._subscribedToFormValidation)return;this.parentForm().on('submit',this.onValidate,this);this._subscribedToFormValidation=true;},constraintChange:function(evt,constraint){constraint=constraint[0];if(constraint.required===this.data.attrs.required)return;this.toggleErrorIndicator(false);if(this.data.attrs.require_validation){this.toggleErrorIndicator(false,this.Y.one(this._inputSelector+'_Validate'),this.Y.one(this._inputSelector+'_LabelValidate'));}
if(this.data.attrs.required&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
if(this.data.attrs.label_input){this.swapLabel(this.Y.one(this.baseSelector+'_LabelContainer'),constraint.required,this.data.attrs.label_input,this.getStatic().templates.label);}
if(this.data.attrs.require_validation){var labelValidate=RightNow.Text.sprintf(this.data.attrs.label_validation,this.data.attrs.label_input);this.swapLabel(this.Y.one(this.baseSelector+'_LabelValidateContainer'),constraint.required,labelValidate,this.getStatic().templates.labelValidate);}
this.data.attrs.required=constraint.required;},getVerificationValue:function(){return this._getTextFieldValue(this.Y.one(this._inputSelector+'_Validate'));},onValidate:function(type,args){var eventObject=this.createEventObject(),errors=[];this.toggleErrorIndicator(false);if(!this.validate(errors)||(this.data.attrs.require_validation&&!this._validateVerifyField(errors))||!this._compareInputToMask(true)){this.lastErrorLocation=args[0].data.error_location;this._displayError(errors,this.lastErrorLocation);RightNow.Event.fire("evt_formFieldValidateFailure",eventObject);return false;}
RightNow.Event.fire("evt_formFieldValidatePass",eventObject);this._seenValues.push(this._massageValueForModificationCheck(eventObject.data.value));return eventObject;},_displayError:function(errors,errorLocation){var commonErrorDiv=this.Y.one("#"+errorLocation),verifyField;if(commonErrorDiv){for(var i=0,errorString="",message,id=this.input.get("id");i<errors.length;i++){message=errors[i];if(typeof message==="object"&&message!==null&&message.id&&message.message){id=verifyField=message.id;message=message.message;}
else if(this.data.attrs.name==='SocialQuestion.Body'||this.data.attrs.name==='SocialQuestionComment.Body'){message=(message.indexOf("%s")>-1)?RightNow.Text.sprintf(message,this.data.attrs.label_input):message;}
else{message=(message.indexOf("%s")>-1)?RightNow.Text.sprintf(message,this.data.attrs.label_input):this.data.attrs.label_input+": "+message;}
errorString+="<div data-field=\""+this._fieldName+"\"><b><a href='javascript:void(0);' onclick='document.getElementById(\""+id+"\").focus(); return false;'>"+message+"</a></b></div> ";}
commonErrorDiv.append(errorString);}
if(!verifyField||errors.length>1){this.toggleErrorIndicator(true);}},toggleErrorIndicator:function(showOrHide,fieldToHighlight,labelToHighlight){var method=((showOrHide)?"addClass":"removeClass");if(fieldToHighlight&&labelToHighlight){fieldToHighlight[method]("rn_ErrorField");labelToHighlight[method]("rn_ErrorLabel");}
else{this.input[method]("rn_ErrorField");this.Y.one(this.baseSelector+"_Label")[method]("rn_ErrorLabel");}},_toggleFormSubmittingFlag:function(event){this._isFormSubmitting=(event==='send');},_blurValidate:function(event,validateVerifyField){if(this._dialogShowing)
return;this._trimField();if(validateVerifyField){this._validateVerifyField();}
else{var valid=this.validate();if(valid){if(this._fieldName==="Contact.Login"||this.isCommonEmailType()){this._checkExistingAccount();}}
this.toggleErrorIndicator(!valid);}},_validateVerifyField:function(errors){errors=errors||[];var valid=true,verifyField=this.Y.one(this._inputSelector+'_Validate'),verifyLabel=this.Y.one(this._inputSelector+'_LabelValidate');if(verifyField&&this.data.attrs.require_validation){if(this.getVerificationValue()!==this.getValue()){errors.push({message:RightNow.Text.sprintf(this.data.attrs.label_validation_incorrect,this.data.attrs.label_input),id:verifyField.get("id")});valid=false;}
this.toggleErrorIndicator(!valid,verifyField,verifyLabel);}
return valid;},_checkExistingAccount:function(){var massagedNewValue=this._massageValueForModificationCheck(this._value);if(this._value===""||this._seenValues.indexOf(massagedNewValue)!==-1||(this.data.js.previousValue&&this._value.replace('&','&amp;').replace("'",'&#039;')===this.data.js.previousValue))
return;this._seenValues.push(massagedNewValue);var eventObject=new RightNow.Event.EventObject(this,{data:{contactToken:this.data.js.contactToken}});if(this.isCommonEmailType())
eventObject.data.email=this._value;else if(this._fieldName==="Contact.Login")
eventObject.data.login=this._value;if(RightNow.Event.fire("evt_accountExistsRequest",eventObject)){RightNow.Ajax.makeRequest(this.data.attrs.existing_contact_check_ajax,eventObject.data,{successHandler:this._onAccountExistsResponse,scope:this,data:eventObject,json:true});}},_massageValueForModificationCheck:function(value){if(this.Y.Lang.isUndefined(value)||value===null||value===""){return"";}
if(this.isCommonEmailType()){value=value.toLowerCase();}
return value;},_onAccountExistsResponse:function(response,originalEventObject){if(RightNow.Event.fire("evt_accountExistsResponse",response,originalEventObject)){if(response!==false&&this._isFormSubmitting===false){this.toggleErrorIndicator(true);var warnDialog,handleOK=function(){warnDialog.hide();this._dialogShowing=false;this.input.focus();};warnDialog=RightNow.UI.Dialog.messageDialog(response.message,{icon:"WARN",exitCallback:{fn:handleOK,scope:this}});this._dialogShowing=true;warnDialog.show();}}},onProvinceChange:function(type,args)
{var eventObj=args[0],resetMask=false;if(!eventObj.ProvincesLength)
this.data.js.mask="";if(this._fieldName==="Contact.Address.PostalCode"&&"PostalMask"in eventObj)
{resetMask=true;this.data.js.mask=eventObj.PostalMask;}
else if("PhoneMask"in eventObj)
{resetMask=true;this.data.js.mask=eventObj.PhoneMask;}
if(this._maskNodeOnPage)
this._maskNodeOnPage.remove();if(resetMask&&this.data.js.mask)
this._initializeMask();},_initializeMask:function()
{this.input.on("keyup",this._compareInputToMask,this);this.input.on("blur",this._hideMaskMessage,this);this.input.on("focus",this._compareInputToMask,this);this.data.js.mask=this._createMaskArray(this.data.js.mask);var overlay=this.Y.Node.create("<div class='rn_MaskOverlay'>");if(this.Y.Overlay){this._maskNode=new this.Y.Overlay({bodyContent:overlay,visible:false,zIndex:1,align:{node:this.input,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.BL]}});this._maskNode.render(this.baseSelector);}
else{this._maskNode=overlay.addClass("rn_Hidden");this.input.insert(this._maskNode,"after");}
if(this.data.attrs.always_show_mask){var maskMessageOnPage=this._getSimpleMaskString(),widgetContainer=this.Y.one(this.baseSelector);if(maskMessageOnPage&&widgetContainer){var messageNode=this.Y.Node.create("<div class='rn_Mask'>"+RightNow.Interface.getMessage("EXPECTED_INPUT_LBL")+": "+maskMessageOnPage+"</div>");if(widgetContainer.get("lastChild").hasClass("rn_HintText")){messageNode.addClass("rn_MaskBuffer");}
this._maskNodeOnPage=messageNode;widgetContainer.append(messageNode);}}},_createMaskArray:function(mask)
{if(!mask)return;var maskArray=[];for(var i=0,j=0,size=mask.length/2;i<size;i++)
{maskArray[i]=mask.substring(j,j+2);j+=2;}
return maskArray;},_getSimpleMaskString:function(){if(!this.data.js.mask)return"";var maskString="";for(var i=0;i<this.data.js.mask.length;i++){switch(this.data.js.mask[i].charAt(0)){case"F":maskString+=this.data.js.mask[i].charAt(1);break;case"U":switch(this.data.js.mask[i].charAt(1)){case"#":maskString+="#";break;case"A":case"C":maskString+="@";break;case"L":maskString+="A";break;}
break;case"L":switch(this.data.js.mask[i].charAt(1)){case"#":maskString+="#";break;case"A":case"C":maskString+="@";break;case"L":maskString+="a";break;}
break;case"M":switch(this.data.js.mask[i].charAt(1)){case"#":maskString+="#";break;case"A":case"C":case"L":maskString+="@";break;}
break;}}
return maskString;},_compareInputToMask:function(submitting){if(!this.data.js.mask)return true;var error=[],value=this.input.get("value");if(value.length>0){for(var i=0,tempRegExVal;i<value.length;i++){if(i<this.data.js.mask.length){tempRegExVal="";switch(this.data.js.mask[i].charAt(0)){case'F':if(value.charAt(i)!==this.data.js.mask[i].charAt(1))
error.push([i,this.data.js.mask[i]]);break;case'U':switch(this.data.js.mask[i].charAt(1)){case'#':tempRegExVal=/^[0-9]+$/;break;case'A':tempRegExVal=/^[0-9A-Z]+$/;break;case'L':tempRegExVal=/^[A-Z]+$/;break;case'C':tempRegExVal=/^[^a-z]+$/;break;}
break;case'L':switch(this.data.js.mask[i].charAt(1)){case'#':tempRegExVal=/^[0-9]+$/;break;case'A':tempRegExVal=/^[0-9a-z]+$/;break;case'L':tempRegExVal=/^[a-z]+$/;break;case'C':tempRegExVal=/^[^A-Z]+$/;break;}
break;case'M':switch(this.data.js.mask[i].charAt(1)){case'#':tempRegExVal=/^[0-9]+$/;break;case'A':tempRegExVal=/^[0-9a-zA-Z]+$/;break;case'L':tempRegExVal=/^[a-zA-Z]+$/;break;}
break;}
if((tempRegExVal!=="")&&!(tempRegExVal.test(value.charAt(i))))
error.push([i,this.data.js.mask[i]]);}
else
{error.push([i,"LEN"]);}}
if((!error.length)&&(value.length<this.data.js.mask.length)&&(!this.data.attrs.always_show_mask||submitting===true))
{for(i=value.length;i<this.data.js.mask.length;i++)
error.push([i,"MISS"]);}
if(error.length>0)
{this._showMaskMessage(error);if(submitting===true)
this._reportError(RightNow.Interface.getMessage("PCT_S_DIDNT_MATCH_EXPECTED_INPUT_LBL"));return false;}
this._showMaskMessage(null);return true;}
if(!this.data.attrs.always_show_mask&&submitting!==true)
this._showMaskMessage(error);return true;},_showMaskMessage:function(error){if(error===null){this._hideMaskMessage();}
else{if(!this._showMaskMessage._maskMessages){this._showMaskMessage._maskMessages={"F":RightNow.Interface.getMessage('WAITING_FOR_CHARACTER_LBL'),"U#":RightNow.Interface.getMessage('PLEASE_TYPE_A_NUMBER_MSG'),"L#":RightNow.Interface.getMessage('PLEASE_TYPE_A_NUMBER_MSG'),"M#":RightNow.Interface.getMessage('PLEASE_TYPE_A_NUMBER_MSG'),"UA":RightNow.Interface.getMessage('PLEASE_ENTER_UPPERCASE_LETTER_MSG'),"UL":RightNow.Interface.getMessage('PLEASE_ENTER_AN_UPPERCASE_LETTER_MSG'),"UC":RightNow.Interface.getMessage('PLS_ENTER_UPPERCASE_LETTER_SPECIAL_MSG'),"LA":RightNow.Interface.getMessage('PLEASE_ENTER_LOWERCASE_LETTER_MSG'),"LL":RightNow.Interface.getMessage('PLEASE_ENTER_A_LOWERCASE_LETTER_MSG'),"LC":RightNow.Interface.getMessage('PLS_ENTER_LOWERCASE_LETTER_SPECIAL_MSG'),"MA":RightNow.Interface.getMessage('PLEASE_ENTER_A_LETTER_OR_A_NUMBER_MSG'),"ML":RightNow.Interface.getMessage('PLEASE_ENTER_A_LETTER_MSG'),"MC":RightNow.Interface.getMessage('PLEASE_ENTER_LETTER_SPECIAL_CHAR_MSG'),"LEN":RightNow.Interface.getMessage('THE_INPUT_IS_TOO_LONG_MSG'),"MISS":RightNow.Interface.getMessage('THE_INPUT_IS_TOO_SHORT_MSG')};}
var message="",sampleMaskString=this._getSimpleMaskString().split("");for(var i=0,type;i<error.length;i++){type=error[i][1];if(type.charAt(0)==="F"){message+="<b>"+RightNow.Interface.getMessage('CHARACTER_LBL')+" "+(error[i][0]+1)+"</b> "+RightNow.Interface.getMessage('WAITING_FOR_CHARACTER_LBL')+type.charAt(1)+" ' <br>";sampleMaskString[(error[i][0])]="<span style='color:#E80000;'>"+sampleMaskString[(error[i][0])]+"</span>";}
else{if(type!=="MISS"){message+="<b>"+RightNow.Interface.getMessage('CHARACTER_LBL')+" "+(error[i][0]+1)+"</b> "+this._showMaskMessage._maskMessages[type]+"<br>";if(type!=="LEN"){sampleMaskString[(error[i][0])]="<span style='color:#E80000;'>"+sampleMaskString[(error[i][0])]+"</span>";}
else{break;}}}}
sampleMaskString=sampleMaskString.join("");this._setMaskMessage(RightNow.Interface.getMessage('EXPECTED_INPUT_LBL')+": "+sampleMaskString+"<br>"+message);this._showMask();}},_setMaskMessage:function(message)
{var overlayContent=this._maskNode.get('bodyContent');if(overlayContent){overlayContent.set('innerHTML',message);}
else{this._maskNode.set('innerHTML',message);}},_showMask:function()
{if(this.Y.Overlay)
this._maskNode.show();else
RightNow.UI.show(this._maskNode);},_hideMaskMessage:function()
{if(this.Y.Overlay&&this._maskNode.get("visible")!==false)
this._maskNode.hide();else
RightNow.UI.hide(this._maskNode);},_onValidateFailure:function()
{if(this.data.js.mask&&this._maskNode.align&&this.Y.Overlay&&this._maskNode.get("visible")!==false){this._maskNode.align();}}});
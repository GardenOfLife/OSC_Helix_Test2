
RightNow.Field=RightNow.Field||RightNow.EventProvider.extend({overrides:{constructor:function(){this.parent();this.data.js.name&&(this._fieldName=this.data.js.name,this._inputSelector=this.baseSelector+"_"+this._fieldName.replace(/\./g,"\\."),this.parentForm().addField(this._fieldName,this),this._addEventHandler("change"),this._addEventHandler("constraintChange",{post:function(){this.parentForm().fire("formUpdated")}}),this.parentForm().on("collect",this.onCollect,this));this.excludeFromValidation=this.data.attrs.hide_on_load||!1}},setConstraints:function(a){this.Y.Object.each({required:function(a){return"false"===a?!1:!!a},required_lvl:function(a){return parseInt(a,10)},min_required_attachments:function(a){return parseInt(a,10)}},function(b,c){a[c]&&(a[c]=b(a[c]))});this.fire("constraintChange",a);this.Y.Object.each(a,function(a,c){this.fire("constraintChange:"+c,{constraint:a})},this);this.parentForm().fire("formUpdated")},onCollect:function(){return this.isVisible()?this._fieldName:!1},isVisible:function(){return!this.excludeFromValidation},hide:function(){RightNow.UI.hide(this.baseSelector);this.excludeFromValidation=!0;var a=this.Y.one("#"+this.lastErrorLocation);this.lastErrorLocation&&a&&a.all("[data-field='"+this._fieldName+"']").remove();this.parentForm().fire("formUpdated")},show:function(){RightNow.UI.show(this.baseSelector);this.excludeFromValidation=!1;this.parentForm().fire("formUpdated")},getFieldName:function(){return this._fieldName},parentForm:function(a){return RightNow.Form.find(a||this.baseDomID,this.instanceID)},getParentFormID:function(){return RightNow.Form.find(this.baseDomID,this.instanceID,!0)},createEventObject:function(){return new RightNow.Event.EventObject(this,{data:{name:this.data.js.name,value:this.getValue(),required:this._isRequired(),form:this._parentForm}})},is:function(a){var b=this.data.js.type;return"text"===a?"Integer"===b||"String"===b||"Thread"===b:"selection"===a?"Boolean"===b||"NamedIDLabel"===b||"Country"===b||"StateOrProvince"===b:"date"===a?"Date"===b||"DateTime"===b:"email"===a?this.isCommonEmailType()||!0===this.data.js.email:"url"===a?this.data.js.url?!0:!1:"product"===a?"ServiceProduct"===b:"category"===a?"ServiceCategory"===b:"attachment"===a?"FileAttachmentIncident"===b:"password"===a?"Contact.NewPassword"===this._fieldName||"Contact.NewPassword_Validate"===this._fieldName:!1},isCommonEmailType:function(){return"Contact.Emails.PRIMARY.Address"===this._fieldName||"Contact.Emails.ALT1.Address"===this._fieldName||"Contact.Emails.ALT2.Address"===this._fieldName||"Incident.CustomFields.c.alternateemail"===this._fieldName},_isRadio:function(){var a=this.input.get("type");return this.Y.Lang.isArray(a)&&"radio"===a[0]},_reportError:function(a){this._errors=this._errors||[];this._errors.push(a)},validate:function(a,b){this._errors=a||[];this._value="undefined"!==typeof b?b:this.getValue();this._checkRequired();this._checkValue();this.is("email")?this._errors.length||this._checkEmail():this.is("url")?this._errors.length||this._checkUrl():this._checkData();return!this._errors.length},_checkValue:function(){var a,b,c;if("Integer"===this.data.js.type){if(""!==this._value&&"number"!==typeof this._value)return this._reportError(RightNow.Interface.getMessage("VALUE_MUST_BE_AN_INTEGER_MSG"));a=parseInt(this._value,10);b=parseInt(this.data.js.constraints.maxValue,10);c=parseInt(this.data.js.constraints.minValue,10);if(this.Y.Lang.isNumber(b)&&a>b)return this._reportError(RightNow.Interface.getMessage("VALUE_IS_TOO_LARGE_MAX_VALUE_MSG")+b+")");if(this.Y.Lang.isNumber(c)&&a<c)return this._reportError(RightNow.Interface.getMessage("VALUE_IS_TOO_SMALL_MIN_VALUE_MSG")+c+")")}else if("Contact.NewPassword"===this.data.js.name&&this.data.js.passwordLength&&(a=RightNow.Text.Encoding.utf8Length(this._value),b=this.data.js.passwordLength,a<b))return this._reportError(RightNow.Text.sprintf(1===b-a?RightNow.Interface.getMessage("CONTAIN_1_CHARACTER_MSG"):RightNow.Interface.getMessage("PCT_D_CHARACTERS_MSG"),b));if(null!==this._value&&(this.data.js.constraints.maxLength||this.data.js.constraints.minLength)){a=this._value.length;c=this.data.js.constraints.maxLength;b=this.data.js.constraints.minLength;if(c&&c<a)return this._reportError(RightNow.Text.sprintf(1===a-c?RightNow.Interface.getMessage("EXCEEDS_SZ_LIMIT_PCT_D_CHARS_1_LBL"):RightNow.Interface.getMessage("EXCEEDS_SZ_LIMIT_PCT_D_CHARS_PCT_D_LBL"),c,a-c));if(b&&b>a)return this._reportError(RightNow.Text.sprintf(1===b-a?RightNow.Interface.getMessage("CONTAIN_1_CHARACTER_MSG"):RightNow.Interface.getMessage("PCT_D_CHARACTERS_MSG"),b))}},_checkData:function(){if(null!==this._value&&""!==this._value){var a=this.data.js.constraints?this.data.js.constraints.regex:null;if(RightNow.Text.beginsWith(this._fieldName,"Contact.Phones.")||"Contact.Address.PostalCode"===this._fieldName){if(!/^[-A-Za-z0-9,# +.()]+$/.test(this._value))return this._reportError("Contact.Address.PostalCode"===this._fieldName?RightNow.Interface.getMessage("PCT_S_IS_AN_INVALID_POSTAL_CODE_MSG"):RightNow.Interface.getMessage("PCT_S_IS_AN_INVALID_PHONE_NUMBER_MSG"))}else{if(a&&!(new RegExp(a)).test(this._value))return this._reportError("Contact.Login"===this._fieldName?RightNow.Interface.getMessage("PCT_S_CONT_SPACES_DOUBLE_QUOTES_LBL"):RightNow.Interface.getMessage("PCT_S_DIDNT_MATCH_EXPECTED_INPUT_LBL"));if(this.data.js.channelID&&/\s/.test(this._value))return this._reportError(RightNow.Interface.getMessage("CONTAIN_SPACES_PLEASE_TRY_MSG"))}}},_checkEmail:function(){if(this._value)if("Incident.CustomFields.c.alternateemail"===this._fieldName)for(var a=0,b=this._value.split(/[,;]+/),c;a<b.length;a++)(c=this.Y.Lang.trim(b[a]))&&!RightNow.Text.isValidEmailAddress(c)&&this._reportError(RightNow.Interface.getMessage("PCT_S_IS_INVALID_MSG"));else RightNow.Text.isValidEmailAddress(this._value)||this._reportError(RightNow.Interface.getMessage("PCT_S_IS_INVALID_MSG"))},_checkUrl:function(){null===this._value||""===this._value||RightNow.Text.isValidUrl(this._value)||this._reportError(RightNow.Interface.getMessage("IS_NOT_A_VALID_URL_MSG"))},_isRequired:function(){return this.is("product")||this.is("category")?this.data.attrs.required_lvl&&0<this.data.attrs.required_lvl||!1:this.is("attachment")?this.data.attrs.min_required_attachments&&0<this.data.attrs.min_required_attachments||!1:this.data.attrs.required?!0:!1},_checkRequired:function(){var a=!1;if(this._isRequired())if(this.is("date"))a=!/\d/.test(this._value);else if(""===this._value||!1===this._value||null===this._value)a=!0;a&&this._reportError(this.data.attrs.label_required);return a},getValue:function(){var a;if(this.is("selection"))this.input.size&&this._isRadio()?(a="",this.input.item(0).get("checked")?a=this.input.item(0).get("value"):this.input.item(1).get("checked")&&(a=this.input.item(1).get("value"))):a="checkbox"===this.input.get("type")?this.input.get("checked"):this.input.get("value");else if(this.is("date")){a="";var b={day:32,month:13,year:1900,hour:0,minute:0};this.input.each(function(a){var e=a.get("name").toLowerCase();this.Y.Object.each(b,function(f,d){null!==e.match(new RegExp(d+"$"))&&(b[d]=parseInt(a.get("value"),10))})},this);a=1900<b.year?b.year+"-"+b.month+"-"+b.day+" "+b.hour+":"+b.minute+":00":""}else this.is("product")||this.is("category")?a=this._selectedNode?this._selectedNode.hierValue||0:this._currentValue||0:this.input&&!this.is("attachment")&&(a=this._getTextFieldValue(this.input));return a},politeFocus:function(a){a&&(this.Y.all("[role=alert], [aria-live=assertive]").some(function(a){return!a.hasClass("rn_Hidden")&&(a.get("textContent")||a.get("innerText"))},this)||a.focus())},_getTextFieldValue:function(a){if(!a)return null;this._trimField(a);a=a.get("value");"Integer"===this.data.js.type?a=a&&!isNaN(Number(a))&&parseInt(a,10)===parseFloat(a)?parseInt(a,10):a:this.is("text")&&!this.is("password")&&""===a&&(a=null);return a},_trimField:function(a){a=a||this.input;if(this.is("text")&&!this.is("password")){var b=a.get("value");this.Y.Lang.isUndefined(b)||""===b||a.set("value",this.Y.Lang.trim(b))}},_initializeHint:function(){if(!this.data.attrs.always_show_hint)if(this.Y.Overlay){var a=this.Y.Node.create("<span id='"+this.baseDomID+"_Hint' aria-hidden='true'>"+this.data.attrs.hint+"</span>"),b={node:this.baseSelector,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.BL]};this.data.info&&"RightNow.Widgets.SelectionInput"===this.data.info.class_name&&"Boolean"!==this.data.js.type?(a.addClass("rn_HintBoxRight"),b.node=this.Y.one(this.baseSelector+" select"),b.points=[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.TR]):a.addClass("rn_HintBox");a=new this.Y.Overlay({bodyContent:a,visible:!1,zIndex:3,align:b});if(this.Y.UA.webkit&&("checkbox"===this.input.get("type")||this._isRadio())){for(var c=this.input instanceof this.Y.NodeList?this.input.item(this.input.size()-1):this.input;c.next();)c=c.next();this.input.on("click",function(){c.focus();a.show()})}else this.input.on("focus",function(){a.show()});this.input.on("blur",function(){a.hide()});a.render(this.baseSelector)}else this.input.get("parentNode").append(this.Y.Node.create("<span class='rn_HintText' aria-hidden='true'>"+this.data.attrs.hint+"</span>"))}},{requires:{standard:["overlay"]}});
RightNow.RequiredLabel=function(){var a=new EJS({text:'<span class="rn_Required" aria-label="<%= requiredLabel %>"><%= requiredMarkLabel %></span>'});EJS.Helpers.prototype.getRequiredLabel=function(b,c){return a.render({requiredLabel:b||RightNow.Interface.getMessage("REQUIRED_LBL"),requiredMarkLabel:c||RightNow.Interface.getMessage("FIELD_REQUIRED_MARK_LBL")})}};
RightNow.Avatar=RightNow.Widgets.extend({constructor:function(){var d=new EJS({text:'<span class="rn_UserAvatar" title="<%= displayName %>"><span class="rn_Avatar <%= (className ? className : "rn_Medium") %> <%= (avatarUrl) ? "rn_Image" : "rn_Placeholder" %>"><% if(avatarUrl){%><img itemprop="image" src="<%= avatarUrl %>" height="<%= size %>" width="<%= size %>" alt=""/><%}else{%><span class="rn_Default rn_DefaultColor<%= color %>" aria-hidden="true" role="presentation"><span class="rn_Liner"><%= text %></span></span><%}%></span></span>'});EJS.Helpers.prototype.getDefaultAvatar=function(a){var b="?",c=0;a.displayName=RightNow.Text.stripTags(a.displayName);a.displayName&&(b=a.isActive?a.displayName.charAt(0).toUpperCase():"!",c=a.displayName.length);a.color=a.isActive?c%5:5;a.text=b;a.userID?a.isActive||(a.displayName=RightNow.Interface.getMessage("INACTIVE_LC_LBL")):a.displayName=RightNow.Interface.getMessage("UNKNOWN_LWR_LBL");return d.render(a)}}});
(function(){var l=function(){var b={},a={},f={};return{getDeferred:function(k,d){if(b[k])return b[k];a[d]=a[d]||{events:[]};a[d].form=k;return{on:function(b,c,h){if(c&&"function"===typeof c)return a[d].events.push({name:b,handler:c,context:h}),this;throw Error("Handler specified isn't a callable function");},addField:function(a,c){if(a&&c&&"object"===typeof c)f[k]||(f[k]={}),f[k][a]=c;else throw Error("A non-object field cannot be added to a form");}}},getInstance:function(a){return b[a]},newInstance:function(a,d){d instanceof RightNow.Form&&(b[a]=d)},getDeferredEvents:function(b){var d,e,c={};for(d in a)if(e=a[d],a.hasOwnProperty(d)&&e.form===b&&e.events.length){e=e.events;for(var h=0;h<e.length;h++)c[e[h].name]=c[e[h].name]||[],c[e[h].name].push(e[h])}return c},getDeferredFields:function(a){return f[a]}}}(),g=function(){function b(c,a,b,d){var e={},f=c.getAttribute("target");c.all("input, select, textarea").each(function(c){var a=c.get("type");""!==c.get("name")&&"submit"!==a&&"image"!==a&&(e[c.get("name")]=c.get("value"))});c=a+RightNow.Url.convertToSegment(e)+b;RightNow.Url.getSession()&&(c=RightNow.Url.addParameter(c,"session",RightNow.Url.getSession()));c=d.Y.Node.create("<a class='rn_Hidden'>form</a>").setAttribute("href",c);f&&c.setAttribute("target",f);d.Y.one(document.body).append(c);c=d.Y.Node.getDOMNode(c);document.createEvent?(d=document.createEvent("MouseEvents"),d.initEvent("click",!1,!1),c.dispatchEvent(d)):c.fireEvent("onclick")}function a(c){this.fire("response",new RightNow.Event.EventObject(this,{data:c}))}function f(c){this.fire("responseError",new RightNow.Event.EventObject(this,{data:c}))}function k(c,h,b){if(RightNow.Event.noSessionCookies())for(var d=0,e=b.length;d<e;d++)if("Contact.Login"===b[d].name){document.cookie="cp_login_start=1;path=/";break}b=RightNow.JSON.stringify(b);var k={form:b,updateIDs:RightNow.JSON.stringify({asset_id:RightNow.Url.getParameter("asset_id"),qid:RightNow.Url.getParameter("qid"),product_id:RightNow.Url.getParameter("product_id"),serial_no:RightNow.Url.getParameter("serial_no"),i_id:RightNow.Url.getParameter("i_id"),user_id:RightNow.Url.getParameter("user")})},g={scope:h,json:!0,successHandler:a,failureHandler:f};b=RightNow.UI.Form;null!=b.smartAssistant&&(k.smrt_asst=b.smartAssistant);null!==b.smartAssistantToken&&(k.saToken=b.smartAssistantToken);h.data.attrs.flash_message&&(k.flash_message=h.data.attrs.flash_message);h._originalEventObject&&(h._originalEventObject.data.timeout&&(g.timeout=h._originalEventObject.data.timeout),g=function(c,a){var b=["challengeHandler","challengeHandlerContext"],h,d;for(h=0;h<b.length;++h)d=b[h],c[d]=a[d]||void 0;return c}(g,h._originalEventObject));RightNow.Form.formToken.onNewToken(function(a){k.f_tok=a;RightNow.Ajax.makeRequest(c,k,g)})}var d={},e={};return{submitForm:function(c,a,d){var f=d.Y.one("#"+c),g=f.getAttribute("method"),m=f.getAttribute("action");c=e[c];a=a||"";if(m&&!d.data.attrs.on_success_url)if("post"===g.toLowerCase()||!RightNow.Text.beginsWith(m,"/")&&RightNow.Url.isExternalUrl(m)){a&&f.set("action",m+a);for(a=0;a<c.length;a++)(g=c[a])&&g.value&&((m=f.one('input[name="'+g.name+'"]')||f.one('textarea[name="'+g.name+'"]'))?m.set("value",g.value):f.append(d.Y.Node.create('<input type="hidden" name="'+g.name+'" value="'+d.Y.Escape.html(g.value)+'"/>')));f.submit()}else b(f,m,a,d);else k((m||"/ci/ajaxRequest/sendForm")+a,d,c)},resetValidatedFields:function(a){e[a]=[]},addValidatedField:function(a,b){e[a]||this.resetFormFields(a);delete b.data.form;e[a].push(b.data)},getValidatedFields:function(a){return RightNow.Lang.cloneObject(e[a])},addField:function(a,b,f){d[a]||(d[a]={});d[a][b]=f},findField:function(a,b){return d[a][b]},getAllFields:function(a){return d[a]||{}}}}();RightNow.Form=RightNow.EventProvider.extend({overrides:{constructor:function(){this.parent();this._challengeDivID=this.data.attrs.challenge_location;this._parentForm=RightNow.UI.findParentForm(this.baseSelector);this.Y.one("#"+this._parentForm).on("submit",function(a){a.halt()});this._errorMessageDiv=this.Y.one("#"+this.data.attrs.error_location);this._formButton=this.Y.one(this.baseSelector+"_Button");this._errorMessageDiv||(this._errorMessageDiv=this.Y.Node.create("<div id='rn_"+this.instanceID+"_ErrorLocation'>"),this._formButton.insert(this._errorMessageDiv,"before"));if(this._parentForm){if(l.getInstance(this._parentForm))throw Error("Can't have two different FormSubmits for a single form");l.newInstance(this._parentForm,this)}else throw RightNow.UI.addDevelopmentHeaderError(RightNow.Interface.getMessage("FORMSUBMIT_PLACED_FORM_UNIQUE_ID_MSG")),Error("An inappropriate form was specified");this._events=l.getDeferredEvents(this._parentForm);this.Y.Object.each(l.getDeferredFields(this._parentForm),function(a,b){g.addField(this._parentForm,b,a)},this);this._widgetInstantiationComplete=RightNow.Widgets.isWidgetInstantiationComplete();if(!this._widgetInstantiationComplete)RightNow.Event.on("evt_WidgetInstantiationComplete",function(){this._widgetInstantiationComplete=!0},this);this._addSubscribersFilter("submit",this._filterSubmittedWidgets,this);this._addEventHandler("submit",{pre:function(a){RightNow.Form.formToken.requestNewToken();g.resetValidatedFields(this._parentForm);this._challengeDivID&&(a.challengeHandler=RightNow.Event.createDelegate(this,this._challengeHandler));this._originalEventObject=a},during:function(a){!1===a?this._eventCanceled=!0:a instanceof RightNow.Event.EventObject&&g.addValidatedField(this._parentForm,a)},post:function(a){var b=this._eventCanceled?"fail":"pass";this._eventCanceled=!1;this.fire("validation:"+b,a)}})._addEventHandler("send",{post:function(a){this._eventCanceled||g.submitForm(this._parentForm,this.data.attrs.add_params_to_url,this);this._eventCanceled=!1},during:function(a){!1===a&&(this._eventCanceled=!0)}})._addEventHandler("collect",{pre:function(){this._collectedFields=[]},during:function(a){a&&this._collectedFields.push(a)},post:function(a){this.fire("submit",a)}})._addEventHandler("formUpdated");if(this.data.js.challengeProvider){try{this._challengeProvider=eval(this.data.js.challengeProvider)}catch(b){throw"Failed while trying to parse a challenge provider.  "+b;}this._createChallengeDiv();this._challengeProvider.create(this._challengeDivID,RightNow.UI.AbuseDetection.options);this.on("submit",this._onValidateChallengeResponse,this)}if(!this.data.js.f_tok)throw Error("This widget is required to have a `f_tok` form submission token");RightNow.Form.formToken.init(this.data.js.f_tok,this.data.js.formExpiration)}},_filterSubmittedWidgets:function(b){var a=g.getAllFields(this._parentForm),f=[];this.Y.Object.each(a,function(a,d){this.Y.Array.each(b,function(b,c){b.context===a&&-1===this.Y.Array.indexOf(this._collectedFields,d)&&f.push(c)},this)},this);return f},getValidatedFields:function(){return g.getValidatedFields(this._parentForm)},addField:function(b,a){g.addField(this._parentForm,b,a)},findField:function(b){if(!this._widgetInstantiationComplete)throw Error("Widget instantiation has not completed. This method can only be used after all widgets are constructed");return g.findField(this._parentForm,b)},hide:function(){RightNow.UI.hide(this._formButton)},show:function(){RightNow.UI.show(this._formButton)},disable:function(){this._formButton.set("disabled",!0)},enable:function(){this._formButton.set("disabled",!1)},_createChallengeDiv:function(){this.Y.one("#"+this._challengeDivID)||this._formButton.insert(this.Y.Node.create("<div id='"+this._challengeDivID+"' tabindex='-1'>"),"before")},_reportChallengeError:function(b){b=b||RightNow.Interface.getMessage("PLS_VERIFY_REQ_ENTERING_TEXT_IMG_MSG");this._errorMessageDiv.append("<div><b><a id ='rn_ChallengeErrorLink' href='javascript:void(0);'>"+b+"</a></b></div>");this.Y.one("#rn_ChallengeErrorLink").on("click",RightNow.Event.createDelegate(this,function(){this._challengeProvider.focus(this._challengeDivID);return!1}))},_challengeHandler:function(b,a,f){this._createChallengeDiv();this._challengeProvider||(this._challengeProvider=RightNow.UI.AbuseDetection.getChallengeProvider(b),this.on("submit",this._onValidateChallengeResponse,this),this._challengeProvider.create(this._challengeDivID,RightNow.UI.AbuseDetection.options));this._reportChallengeError(RightNow.UI.AbuseDetection.getDialogCaption(b));this.fire("validation:fail")},_onValidateChallengeResponse:function(){new RightNow.Event.EventObject(this,{data:{form:!1}});var b=this._challengeProvider.getInputs(this._challengeDivID);if(b.abuse_challenge_response)for(var a in b)b.hasOwnProperty(a)&&RightNow.Ajax.addRequestData(a,b[a])}},{find:function(b,a,f){if(b=RightNow.UI.findParentForm(b))return f?b:l.getDeferred(b,a);throw Error("You're using a form that doesn't have a proper form submit button or an id");},formToken:function(){function b(b,h){var e=h[0];if(e.data.newToken&&(!e.w_id||"RightNow.Form"===e.w_id)){a=e.data.newToken;e=f;g=(new Date).getTime()+e;for(var e=0,l=d.length,n;e<l;e++)n=d[e],n.callback.call(n.context,a);d=[]}}var a,f,g,d=[],e;return{init:function(c,d){a=c;var l=f=d;g=(new Date).getTime()+l;e||(RightNow.Event.on("evt_formTokenUpdate",b),e=!0)},requestNewToken:function(){(new Date).getTime()>=g&&RightNow.Event.fire("evt_formTokenRequest",new RightNow.Event.EventObject({instanceID:"RightNow.Form"},{data:{formToken:a}}))},onNewToken:function(b,e){(new Date).getTime()>=g?d.push({callback:b,context:e}):setTimeout(function(){b.call(e,a)},1)}}}()})})();
RightNow.ProductCategory=RightNow.EventProvider.extend({initializeTreeView:function(a){this.dataType=a;this.displayField||(this.displayField=this.Y.one(this.baseSelector+"_"+this.dataType+"_Button"));this.buildPanel();this.Y.one(this.baseSelector+"_LinksTrigger").on("click",this.showAccessibleView,this);RightNow.Event.on("evt_accessibleTreeViewGetResponse",this.getAccessibleTreeViewResponse,this);RightNow.Event.on("evt_menuFilterGetResponse",this.getSubLevelResponse,this);this.data.js.hierData&&this.data.js.hierData[0]&&this.data.js.hierData[0].length&&this.buildTree()},buildPanel:function(){this.dropdown=new this.Y.RightNowTreeViewDropdown({srcNode:this.Y.one(this.baseSelector+"_TreeContainer").removeClass("rn_Hidden"),render:this.Y.one(this.baseSelector),trigger:this.displayField,visible:!1});this.dropdown.once("show",this.Y.bind(this.buildTree,this,!1));this.dropdown.on("show",function(){this.tree.focusOnSelectedNode()},this)},buildTree:function(a){if(!this.tree||a){this.tree&&this.tree.clear();this.data.js.linkingOn&&"Category"===this.dataType&&this.data.js.link_map[0]&&(this.data.js.hierData=this.data.js.link_map);this.tree=new this.Y.RightNowTreeView({hierarchyData:this.data.js.hierData,contentBox:this.Y.one(this.baseSelector+"_Tree").setStyles({"overflow-y":"auto",display:"block"})});this.tree.render();this.data.js.hierData&&this.data.js.hierDataNone&&delete this.data.js.hierData;this.tree.on("enterKey",this.selectNode,this);this.tree.on("dynamicNodeExpand",this.getSubLevelRequest,this);if(this.data.attrs.show_confirm_button_in_dialog)this.dropdown.set("confirmButton",this.Y.one(this.baseSelector+"_"+this.data.js.data_type+"_ConfirmButton")),this.dropdown.set("cancelButton",this.Y.one(this.baseSelector+"_"+this.data.js.data_type+"_CancelButton")),this.dropdown.on("confirm",function(){this.selectNode(this.tree.getFocusedNode())},this),this.Y.one(this.baseSelector+"_TreeContainer").setStyle("display","block");else this.tree.on("click",this.selectNode,this);this.tree.get("value")&&this.displaySelectedNodesAndClose(!1);this.dropdown.set("treeView",this.tree)}},pruneNonPermissionedAccessibleNodes:function(a){this.checkIdsAreValid("readableProdcatIds");if(0===this.data.js.readableProdcatIds.length)return a;var b=[];this.Y.Array.each(a,function(a){(this.checkPermissionsOnNode(a[1])||this.hasPermissionedAccessibleChildren(a))&&b.push(a)},this);return b},hasPermissionedAccessibleChildren:function(a){return this.checkForPermissionedChildren(a[1],a.level+1)},hasPermissionedChildren:function(a,b){return a.hasChildren?this.checkForPermissionedChildren(a.id,b):!1},checkForPermissionedChildren:function(a,b){if(!(this.data&&this.data.js&&this.data.js.readableProdcatIds&&this.Y.Lang.isArray(this.data.js.readableProdcatIds)))throw Error("Widget does not have this.data.js.readableProdcatIds attribute set, or its value is not an array");if(0===this.data.js.readableProdcatIds.length)return!0;var c="Level"+b;return this.Y.Array.some(this.data.js.permissionedProdcatList,function(b){if(b[c]===a&&b.ID!==a)return!0},this)},checkPermissionsOnNode:function(a){var b=this.data.js.permissionedProdcatIds&&this.Y.Lang.isArray(this.data.js.permissionedProdcatIds),c=this.data.js.readableProdcatIds&&this.Y.Lang.isArray(this.data.js.readableProdcatIds);if(!b&&!c)throw Error("Widget has neither this.data.js.readableProdcatIds or this.data.js.permissionedProdcatIds set, or their values are not an array.");return b&&0===this.data.js.permissionedProdcatIds.length||c&&0===this.data.js.readableProdcatIds.length?!0:b?this.isPermissionedNode(a):this.isReadableNode(a)},isPermissionedNode:function(a){return this.userHasFullProdcatPermissions()?!0:-1!==this.Y.Array.indexOf(this.data.js.permissionedProdcatIds,parseInt(a,10))},userHasFullProdcatPermissions:function(){this.checkIdsAreValid("permissionedProdcatIds");return"None"===this.data.attrs.verify_permissions||0===this.data.js.permissionedProdcatIds.length},isReadableNode:function(a){this.checkIdsAreValid("readableProdcatIds");return 0===this.data.js.readableProdcatIds.length?!0:-1!==this.Y.Array.indexOf(this.data.js.readableProdcatIds,parseInt(a,10))},disableNonPermissionedAccessibleNodes:function(a){this.checkIdsAreValid("readableProdcatIds");if(0!==this.data.js.readableProdcatIds.length&&this.data.attrs.label_selection_not_valid){var b;this.Y.Array.each(a,function(a){this.checkPermissionsOnNode(a[1])||(b=this.Y.one(this.baseSelector+"_AccessibleLink_"+a[1]),b.setHTML(RightNow.Text.sprintf(this.data.attrs.label_selection_not_valid,b.getHTML())))},this)}},disableNonPermissionedNodes:function(a){this.checkIdsAreValid("readableProdcatIds");0!==this.data.js.readableProdcatIds.length&&this.Y.Array.each(a,function(a){this.checkPermissionsOnNode(a.id)||this.Y.one("#ygtvlabelel"+this.tree.getNodeByValue(a.id).index).addClass("rn_Disabled")},this)},onAccessibleLinkClick:function(a){var b=a.valueChain[a.valueChain.length-1];this.tree.expandAndCreateNodes(a.valueChain);this.checkPermissionsOnNode(b)&&this.dialog.hide()},showAccessibleView:function(a){a.halt();this._eo||(this._eo=new RightNow.Event.EventObject(this));"Category"===this.dataType&&this.data.js.linkingOn&&(this._eo.data.linkingProduct=RightNow.UI.Form.currentProduct);this.dialog?this.displayAccessibleDialog():RightNow.Event.fire("evt_accessibleTreeViewRequest",this._eo)},getAccessibleTreeViewResponse:function(a,b){b=b[0];if(b.w_id===this._eo.w_id&&b.data.hm_type===this._eo.data.hm_type){var c=b.data.accessibleLinks;if("prod_chain"in c){c=[];delete b.data.accessibleLinks.prod_chain;for(var d in b.data.accessibleLinks)c.push(b.data.accessibleLinks[d])}c.unshift({0:this.data.attrs.label_all_values,1:0,hier_list:0,level:0});c=this.pruneNonPermissionedAccessibleNodes(c);this.createAccessibleDialog(c);this.buildTree();this.displayAccessibleDialog();this.disableNonPermissionedAccessibleNodes(c)}},createAccessibleDialog:function(a){this.dialog&&this.dialog.destroy();var b="Product"===this.dataType?RightNow.Interface.getMessage("SELECT_BELOW_USING_LINKS_PROVIDED_MSG"):RightNow.Interface.getMessage("CATEGORY_BELOW_USING_LINKS_PROVIDED_MSG"),c=RightNow.Interface.getMessage("DEPTH_ANNOUNCED_NAVIGATE_THROUGH_LIST_MSG");this.dialog=new this.Y.RightNowTreeViewDialog({id:"rn_"+this.instanceID,hierarchyData:a,contentBox:this.Y.one(this.baseSelector+"_Links"),dismissLabel:RightNow.Interface.getMessage("CANCEL_CMD"),titleLabel:this.data.attrs.label_nothing_selected,introLabel:b+" "+c,selectionPlaceholderLabel:RightNow.Interface.getMessage("SELECTION_PCT_S_ACTIVATE_LINK_JUMP_MSG"),levelLabel:this.data.attrs.label_level,noItemSelectedLabel:this.data.attrs.label_all_values});this.dialog.on("selectionMade",this.onAccessibleLinkClick,this);this.dialog.render()},displayAccessibleDialog:function(){this.dialog.set("selectedValue",this.tree.get("value"));this.dialog.set("selectedLabels",this.tree.get("labelChain"));this.dialog.show();var a=this.Y.one("p.rn_Intro a");a&&a.focus()},displaySelectedNodesAndClose:function(a){this._eo||(this._eo=new RightNow.Event.EventObject(this));this._eo.data.hierChain=this.tree.get("valueChain");RightNow.Event.fire("evt_productCategoryFilterSelected",this._eo);delete this._eo.data.hierChain;var b=this.tree.get("valueChain"),c=this.data.attrs.label_nothing_selected,d=this.data.attrs.label_nothing_selected;this.dropdown.hide();b[0]&&(c=this.tree.get("labelChain").join("<br>"),d=this.data.attrs.label_screen_reader_selected+c);this.dropdown.set("triggerText",c);this.Y.all(this.baseSelector+"_TreeDescription").setHTML(d);if(a&&!this.dialog)try{this.dropdown.get("trigger").focus()}catch(e){}},selectNode:function(a){this.displaySelectedNodesAndClose(!0)},getSubLevelRequest:function(a){if(!this._nodeBeingExpanded){this._nodeBeingExpanded=!0;if(a=this.getSubLevelRequestEventObject(a))"Product"===this.dataType&&(RightNow.UI.Form.currentProduct=a.data.value),this._requesting=a.data.value,RightNow.Event.fire("evt_menuFilterRequest",a);this._nodeBeingExpanded=!1;this._eo.data.link_map&&delete this._eo.data.link_map}},getSubLevelRequestEventObject:function(a){return new RightNow.Event.EventObject(this,{data:{level:a.depth+1,value:a.value,label:a.label,cache:{}}})},getSubLevelResponse:function(a,b){this.data.js.link_map&&delete this.data.js.link_map;var c=a.data.level,d=a.data.hier_data,e,d=this.groomProdcats(d);this.buildTree();!a.data.reset_linked_category&&this.getSubLevelRequestEventObject._origRequest&&this.getSubLevelRequestEventObject._origRequest[b]?e=this.getSubLevelRequestEventObject._origRequest[b]:a.data.reset_linked_category&&(this.tree.clear(this.data.attrs.label_all_values),this.dialog=null,this.selectNode(this.tree.getRoot()));7>c&&this.insertChildrenForNode(d,e);0===d.length&&this.displaySelectedNodesAndClose()},insertChildrenForNode:function(a,b){this.tree.insertChildHierarchyData(a,b)},removeNonReadableProdcats:function(a){this.checkIdsAreValid("readableProdcatIds");var b=this.data;return this.Y.Array.filter(a,function(a){if(-1!==this.Y.Array.indexOf(b.js.readableProdcatIds,a.id))return a},this)},updateProdcatsHasChildrenAttribute:function(a){this.checkIdsAreValid("readableProdcatIdsWithChildren");var b=this.data;return this.Y.Array.map(a,function(a){a.hasChildren=-1!==this.Y.Array.indexOf(b.js.readableProdcatIdsWithChildren,a.id)?!0:!1;return a},this)},groomProdcats:function(a){!1!==this.data.attrs.verify_permissions&&"None"!==this.data.attrs.verify_permissions&&0<this.data.js.readableProdcatIds.length&&(a=this.removeNonReadableProdcats(a),a=this.updateProdcatsHasChildrenAttribute(a));return a},checkIdsAreValid:function(a){if(!(this.data&&this.data.js&&this.data.js[a]&&this.Y.Lang.isArray(this.data.js[a])))throw Error("Widget does not have this.data.js."+a+" attribute set, or its value is not an array");}});
RightNow.Widgets.PasswordInput=RightNow.Field.extend({overrides:{constructor:function(){this.parent();this.input=this.Y.one(this._inputSelector);if(!this.input)return;this.inputLabel=this.Y.one(this.baseSelector+"_Label");this.currentPasswordField=this.Y.one(this._inputSelector+"_CurrentPassword");this.input.on('change',function(){this.fire('change',this);},this);this.on('constraintChange',this.constraintChange,this);if(this.data.attrs.require_validation){this.validation=this.Y.one(this._inputSelector+"_Validate");this.validationLabel=this.Y.one(this._inputSelector+"_LabelValidate");this.Y.one(this._inputSelector+'_Validate').on('change',function(){this.fire('change',this);},this);}
this.parentForm().on("submit",this.onValidate,this);if(this.data.js.requirements){this.initEvents();}
if(this.data.attrs.initial_focus){if(this.currentPasswordField&&this.currentPasswordField.focus)
this.currentPasswordField.focus();else if(this.input.focus)
this.input.focus();}},validate:function(errors){var attrs=this.data.attrs;this._value=this.input.get('value');this._checkData();if(this._errors){errors=this._errors.slice();}
if(attrs.required){this.toggleErrorIndicator(false,this.input,this.inputLabel);if(!this.input.get('value')){errors.push(attrs.label_required);this.toggleErrorIndicator(true,this.input,this.inputLabel);}}
if(!errors.length&&this.data.js.requirements&&!this.validateInput(true)){errors.push(RightNow.Interface.getMessage("PCT_S_REQUIREMENTS_MET_LBL"));}
if(attrs.require_validation){this.toggleErrorIndicator(false,this.validation,this.validationLabel);if(!this.validateValidation(true)){errors.push({text:RightNow.Text.sprintf(attrs.label_validation_incorrect,RightNow.Text.sprintf(attrs.label_validation,attrs.label_input))});this.toggleErrorIndicator(true,this.validation,this.validationLabel);}}
return!errors.length;}},swapLabel:function(container,requiredness,label,template){var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,required:requiredness,requiredMarkLabel:RightNow.Interface.getMessage("FIELD_REQUIRED_MARK_LBL"),requiredLabel:RightNow.Interface.getMessage("REQUIRED_LBL"),hint:this.data.attrs.hint};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},constraintChange:function(evt,constraint){constraint=constraint[0];if(this.data.js.requirements||(constraint.required===this.data.attrs.required))return;this.toggleErrorIndicator(false,this.input,this.inputLabel);if(this.data.attrs.require_validation){this.toggleErrorIndicator(false,this.validation,this.validationLabel);}
if(this.data.attrs.required&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
if(this.data.attrs.label_input){this.swapLabel(this.Y.one(this.baseSelector+'_LabelContainer'),constraint.required,this.data.attrs.label_input,this.getStatic().templates.label);this.inputLabel=this.Y.one(this.baseSelector+"_Label");}
if(this.data.attrs.require_validation){var labelValidate=RightNow.Text.sprintf(this.data.attrs.label_validation,this.data.attrs.label_input);this.swapLabel(this.Y.one(this.baseSelector+'_LabelValidateContainer'),constraint.required,labelValidate,this.getStatic().templates.labelValidate);this.validationLabel=this.Y.one(this._inputSelector+"_LabelValidate");}
this.data.attrs.required=constraint.required;},initEvents:function(){var input=this.input;input.on("focus",this.showOverlay,this,'input');input.on("blur",this.blurValidation,this,'input');input.on("keyup",this.validateInput,this);input.on('keydown',function(e){if(e.keyCode===RightNow.UI.KeyMap.TAB){this.blurValidation((e.shiftKey)?false:e,'input');}},this);if(this.data.attrs.require_validation){var validation=this.validation;validation.on("focus",function(e,type){if(!this.inputOverlay||!this.inputOverlay.get("visible")){this.showOverlay(e,type);}},this,'validation');validation.on("blur",this.blurValidation,this,'validation');validation.on("keyup",this.validateValidation,this);validation.on('keydown',function(e){if(e.keyCode===RightNow.UI.KeyMap.TAB){this.blurValidation((e.shiftKey)?false:e,'validation');}},this);}},getVerificationValue:function(){return this._getTextFieldValue(this.Y.one(this._inputSelector+'_Validate'));},onValidate:function(type,args){var eventObject=this.createEventObject(),errors=[];if(!this.validate(errors)){this.lastErrorLocation=args[0].data.error_location;this.displayError(errors,this.lastErrorLocation);RightNow.Event.fire("evt_formFieldValidateFailure",eventObject);return false;}
if(this.data.attrs.require_current_password&&this.currentPasswordField){eventObject.data.currentValue=this.currentPasswordField.get('value');}
RightNow.Event.fire("evt_formFieldValidatePass",eventObject);return eventObject;},displayError:function(errors,errorLocation){var commonErrorDiv=this.Y.one("#"+errorLocation),errorLength=errors.length;if(commonErrorDiv&&errorLength){for(var i=0,errorString="",message,id,defaultID=this.input.get("id");i<errorLength;i++){message=errors[i];id=defaultID;if(typeof message==='object'&&message.text){if(message.id){id=message.id;}
message=message.text;}
else{message=(message.indexOf("%s")>-1)?RightNow.Text.sprintf(message,this.data.attrs.label_input):this.data.attrs.label_input+" "+message;}
errorString+="<div data-field=\""+this._fieldName+"\"><b><a href='javascript:void(0);' onclick='document.getElementById(\""+id+"\").focus(); return false;'>"+message+"</a></b></div> ";}
commonErrorDiv.append(errorString);}},toggleErrorIndicator:function(showOrHide,fieldToHighlight,labelToHighlight){var method=((showOrHide)?"addClass":"removeClass");fieldToHighlight[method]("rn_ErrorField");labelToHighlight[method]("rn_ErrorLabel");},showOverlay:function(e,type){var name=type+"Overlay";if(!this[name]){var overlay,element=this[type],insertInto=this.Y.one(this.baseSelector+((type==='input')?'_PasswordHelp':'')),content;if(type==='input'){content=this.Y.Node.create('<div class="rn_PasswordOverlay" />').setHTML(new EJS({text:this.getStatic().templates.overlay}).render({title:this.data.attrs.label_validation_title,instanceID:this.instanceID,validations:this.data.js.requirements,passwordRequirementsLabel:RightNow.Interface.getMessage("PASSWD_VALIDATION_REQS_READ_L_MSG")}));}
else{content=this.Y.one(this.baseSelector+'_PasswordValidationHelp').addClass('rn_PasswordOverlay').removeClass('rn_ScreenReaderOnly');}
if(this.Y.Overlay){overlay=new this.Y.Overlay({bodyContent:content,visible:false,zIndex:1,align:{node:element,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.TR]}}).render(insertInto);}
else{insertInto.append(content);overlay={_body:content,show:function(){this._body.removeClass('rn_Hidden');},hide:function(){this._body.addClass('rn_Hidden');},get:function(what){if(what==='visible'){return!this._body.hasClass('rn_Hidden');}
if(what==='bodyContent'){return this._body;}}};}
this[name]=overlay;}
this[name].align&&this[name].align();this[name].show();},blurValidation:function(e,type){var overlay=this[type+"Overlay"];if(!overlay||this._alreadyBlurring)return;if(e===false){overlay.hide();return;}
this.toggleErrorIndicator(false,this[type],this[type+"Label"]);if(this["validate"+type.charAt(0).toUpperCase()+type.slice(1)](true)){overlay.hide();}
else if(overlay.get('visible')){this.toggleErrorIndicator(true,this[type],this[type+"Label"]);if(e.keyCode){var overlayBody=overlay.get('bodyContent');overlayBody=(overlayBody.item)?overlayBody.item(0):overlayBody.one('*');this._alreadyBlurring=true;this.Y.Node.getDOMNode(overlayBody.setAttribute("tabIndex","-1")).focus();this._alreadyBlurring=false;e.halt();}
else if(type==='validation'){overlay.hide();}}},validationClasses:function(){return this.validationClasses.classes||(this.validationClasses.classes={fail:'rn_Fail',pass:'rn_Pass',progress:[{className:'rn_NoValidations',label:RightNow.Interface.getMessage("PASSWORD_IS_TOO_SHORT_MSG")},{className:'rn_AllValidations',label:RightNow.Interface.getMessage("PERFECT_LBL")},{className:'rn_SomeValidations',label:RightNow.Interface.getMessage("PASSWORD_IS_TOO_INSECURE_MSG")}]});},validateInput:function(e){if(e.keyCode===RightNow.UI.KeyMap.TAB)return;var Y=this.Y,password=this.input.get("value"),passed=0,total=0,requirements=this.data.js.requirements,checks=this._getPasswordStats(password);Y.Object.each(checks,function(value,key,className,requirement){if(!(requirement=requirements[key]))return;if((requirement.bounds==='max'&&value>requirement.count)||(requirement.bounds==='min'&&value<requirement.count)){className='fail';}
else{passed++;className='pass';}
this.updatePasswordChecklist(key,className);total++;},this);var UI=RightNow.UI,baseSelector=this.baseSelector,quotient=passed/total,index=Math.round(quotient);if(quotient!==index&&quotient>0.3){index=2;}
index=this.validationClasses().progress[index];UI.show(baseSelector+" .rn_Strength");UI.hide(baseSelector+" .rn_Intro .rn_Text");var meter=Y.one(baseSelector+" .rn_Meter");if(meter){meter.setHTML('<div class="'+index.className+'"></div>');}
meter=Y.one(baseSelector+"_MeterLabel");if(meter){meter.set("innerHTML",index.label);}
return passed===total;},validateValidation:function(){var validationValue=this.validation.get('value'),addRemoveClassOrder=[this.validationClasses().fail,this.validationClasses().pass];if(validationValue===this.input.get("value")){addRemoveClassOrder.reverse();}
if(this.validationOverlay){this.validationOverlay.get("bodyContent").addClass(addRemoveClassOrder[0]).removeClass(addRemoveClassOrder[1]);}
return addRemoveClassOrder[0]===this.validationClasses().pass;},updatePasswordChecklist:function(name,action){if(!(this._passwordChecklist||(this._passwordChecklist=this.Y.one(this.baseSelector+" ul.rn_Requirements"))))return;var className=this.validationClasses()[action],label=((action==='pass')?RightNow.Interface.getMessage("COMPLETE_LBL"):RightNow.Interface.getMessage("INCOMPLETE_LBL"));this._passwordChecklist.one("li[data-validate='"+name+"']").set('className',className).one(".rn_ScreenReaderOnly").set("innerHTML",label);},_getPasswordStats:function(password){var checks={repetitions:0,occurrences:0,uppercase:0,lowercase:0,special:0,specialAndDigits:0,length:0},len=password.length,lastChar='',i,j,char,occur,reps,lc,uc;for(i=0;i<len;i++){occur=0;char=password[i]||password.substr(i,1);if(char===lastChar){reps++;if(reps>checks.repetitions){checks.repetitions=reps;}}
else{lastChar=char;reps=1;}
for(j=0;j<len;j++){if((password[j]||password.substr(j,1))===char){occur++;}}
if(occur>checks.occurrences){checks.occurrences=occur;}
uc=char.toLocaleUpperCase();lc=char.toLocaleLowerCase();if(uc===lc&&lc===char){if(!isNaN(parseInt(char,10))){checks.specialAndDigits++;}
else{checks.specialAndDigits++;checks.special++;}}
else if(lc===char){checks.lowercase++;}
else if(uc===char){checks.uppercase++;}}
checks.length=len;return checks;}});
RightNow.Widgets.SelectionInput=RightNow.Field.extend({overrides:{constructor:function(){if(this.data.js.readOnly)return;this.parent();var attrs=this.data.attrs;this.input=(this.data.js.type==="Boolean"&&!attrs.display_as_checkbox)?this.Y.all(this._inputSelector+"_1, "+this._inputSelector+"_0"):this.Y.one(this._inputSelector);if(!this.input)return;if(attrs.hint&&!attrs.hide_hint&&!attrs.always_show_hint){this._initializeHint();}
if(attrs.initial_focus&&this.input){if(this.data.js.type==="Boolean"&&this.input[0]&&this.input[0].focus)
this.input[0].focus();else if(this.input.focus)
this.input.focus();}
if(attrs.validate_on_blur&&attrs.required){this.Y.Event.attach('blur',this.blurValidate,this.input instanceof this.Y.NodeList?this.input.item(1):this.input,this);}
this.input.on('change',function(){RightNow.Event.fire("evt_formInputDataChanged",null);this.fire('change',this);},this);this.on("constraintChange",this.constraintChange,this);var fieldName=this.data.js.name;if(fieldName==="Contact.Address.Country"){this.input.on("change",this.countryChanged,this);if(this.input.get('value'))
this.countryChanged();}
else if(fieldName==="Contact.Address.StateOrProvince"){this.currentState=this.input.get('value');RightNow.Event.on("evt_provinceResponse",this.onProvinceResponse,this);}
else if(fieldName==='Incident.StatusWithType.Status'){this.on('change',this.onStatusChanged,this);}
this.parentForm().on("submit",this.onValidate,this);}},swapLabel:function(container,requiredness,label,template){this.Y.augment(this,RightNow.RequiredLabel);var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,required:requiredness,hint:this.data.attrs.hint};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},constraintChange:function(evt,constraint){constraint=constraint[0];if(constraint.required===this.data.attrs.required)return;this.toggleErrorIndicator(false);if(this.data.attrs.required&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
if(this.data.attrs.label_input){if(this.data.js.type==='Boolean'&&!this.data.attrs.display_as_checkbox){this.swapLabel(this.Y.one(this.baseSelector+'_Label'),constraint.required,this.data.attrs.label_input,this.getStatic().templates.legend);}
else{this.swapLabel(this.Y.one(this.baseSelector+'_LabelContainer'),constraint.required,this.data.attrs.label_input,this.getStatic().templates.label);}}
this.data.attrs.required=constraint.required;},onValidate:function(type,args){var eo=this.createEventObject(),errors=[];this.toggleErrorIndicator(false);if(!this.validate(errors)){this.lastErrorLocation=args[0].data.error_location;this.displayError(errors,this.lastErrorLocation);RightNow.Event.fire("evt_formFieldValidationFailure",eo);return false;}
RightNow.Event.fire("evt_formFieldValidationPass",eo);return eo;},displayError:function(errors,errorLocation){var commonErrorDiv=this.Y.one("#"+errorLocation);if(commonErrorDiv){for(var id=((this.input instanceof this.Y.NodeList)?this.input.item(0).get("id"):this.input.get("id")),i=0,message;i<errors.length;i++){message=errors[i];message=(message.indexOf("%s")>-1)?RightNow.Text.sprintf(message,this.data.attrs.label_input):this.data.attrs.label_input+" "+message;commonErrorDiv.append("<div data-field=\""+this._fieldName+"\"><b><a href='javascript:void(0);' onclick='document.getElementById(\""+id+"\").focus(); return false;'>"+message+"</a></b></div>");}}
this.toggleErrorIndicator(true);},toggleErrorIndicator:function(showOrHide){var method=((showOrHide)?"addClass":"removeClass");this.input[method]("rn_ErrorField");this.Y.one(this.baseSelector+"_Label")[method]("rn_ErrorLabel");},blurValidate:function(){this.toggleErrorIndicator(!this.getValue());},countryChanged:function(){var value=this.input.get("value"),fireResponse=function(response,eventObject){RightNow.Event.fire("evt_provinceResponse",response,eventObject);};if(value){var eventObject=new RightNow.Event.EventObject(this,{data:{country_id:value}});if(RightNow.Event.fire("evt_provinceRequest",eventObject)){this._provinces=this._provinces||{};if(this._provinces[value]){return fireResponse(this._provinces[value],eventObject);}
RightNow.Ajax.makeRequest("/ci/ajaxRequestMin/getCountryValues",eventObject.data,{successHandler:function(response){this._provinces[value]=response;fireResponse(response,eventObject);},scope:this,json:true,type:"GETPOST"});}}
else{fireResponse({ProvincesLength:0,Provinces:{}});}},onProvinceResponse:function(type,args){var response=args[0],options='',provinces=response.Provinces,i,length;this.input.set("innerHTML","");if(provinces){if(!this.Y.Lang.isArray(provinces)){var temp=[];this.Y.Object.each(provinces,function(val){temp.push(val);});provinces=temp;}
if(!provinces[0]||(provinces[0].Name!=="--"&&!this.data.hideEmptyOption)){provinces.unshift({Name:"--",ID:""});}
for(i=0,length=provinces.length;i<length;i++){options+="<option value='"+provinces[i].ID+"'>"+provinces[i].Name+"</option>";}
this.input.append(options);this.input.set('value',this.currentState);}
this.currentState='';},onStatusChanged:function(){var threadInput=this.parentForm().findField('Incident.Threads');if(threadInput){threadInput.setConstraints({required:this.input.get('value')==='0'});}}});
RightNow.Widgets.DateInput=RightNow.Field.extend({overrides:{constructor:function(){if(this.data.js.readOnly)return;this.parent();var widgetContainer=this.Y.one(this.baseSelector);if(!widgetContainer)return;this.input=widgetContainer.all('select');if(!this.input)return;if(this.data.attrs.hint&&!this.data.attrs.hide_hint&&!this.data.attrs.always_show_hint){this._initializeHint();}
if(this.data.attrs.initial_focus&&this.input.item(0)&&this.input.item(0).focus){this.input.item(0).focus();}
if(this.data.attrs.validate_on_blur){this.input.item(this.input.size()-1).on('blur',this.blurValidate,this);}
this.input.on('change',function(){RightNow.Event.fire("evt_formInputDataChanged",null);this.fire('change',this);},this);this.on("constraintChange",this.constraintChange,this);this.parentForm().on('submit',this.onValidate,this);}},swapLabel:function(container,requiredness,label,template){this.Y.augment(this,RightNow.RequiredLabel);var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,required:requiredness,hint:this.data.attrs.hint};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},constraintChange:function(evt,constraint){constraint=constraint[0];if(constraint.required===this.data.attrs.required)return;this.toggleErrorIndicator(false);if(this.data.attrs.required&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
if(this.data.attrs.label_input){this.swapLabel(this.Y.one(this.baseSelector+'_Legend'),constraint.required,this.data.attrs.label_input,this.getStatic().templates.legend);}
this.data.attrs.required=constraint.required;},onValidate:function(type,args){var eo=this.createEventObject(this),errors=[];this.toggleErrorIndicator(false);if(!this.validateValue(errors)||!this.validate(errors)){this.lastErrorLocation=args[0].data.error_location;this.displayError(errors,this.lastErrorLocation);RightNow.Event.fire("evt_formFieldValidateFailure",eo);return false;}
RightNow.Event.fire("evt_formFieldValidatePass",eo);return eo;},displayError:function(errors,errorLocation){var commonErrorDiv=this.Y.one("#"+errorLocation),fieldsToHighlight;if(commonErrorDiv){for(var id=((this.input instanceof this.Y.NodeList)?this.input.item(0).get("id"):this.input.get("id")),i=0,errorString="",message;i<errors.length;i++){message=errors[i];if(typeof message==="object"&&message.ids&&message.message){id=message.ids[0];fieldsToHighlight=message.ids;message=message.message;}
message=(message.indexOf("%s")>-1)?RightNow.Text.sprintf(message,this.data.attrs.label_input):this.data.attrs.label_input+" "+message;errorString+="<div data-field=\""+this._fieldName+"\"><b><a href='javascript:void(0);' onclick='document.getElementById(\""+id+"\").focus(); return false;'>"+message+"</a></b></div> ";}
commonErrorDiv.append(errorString);}
this.toggleErrorIndicator(true,fieldsToHighlight);},toggleErrorIndicator:function(showOrHide,fieldsToHighlight){var method=((showOrHide)?"addClass":"removeClass");if(fieldsToHighlight){this.input.each(function(field){if(this.Array.indexOf(fieldsToHighlight,field.get("id"))>-1){field[method]("rn_ErrorField");}},this.Y);}
else{this.input[method]("rn_ErrorField");}
this.Y.one(this.baseSelector+"_Legend")[method]("rn_ErrorLabel");},blurValidate:function(){this.toggleErrorIndicator((this.data.attrs.required&&!this.getValue())||!this.validateValue());},validateValue:function(errors){var errorNodes=[];this.input.each(function(input){if(input.get("value")==="")
errorNodes.push(input.get("id"));});if(errorNodes.length&&errorNodes.length!==this.input.size()){errors.push({ids:errorNodes,message:RightNow.Interface.getMessage("PCT_S_IS_NOT_COMPLETELY_FILLED_IN_MSG")});return false;}
else if(errorNodes.length===this.input.size()){return true;}
var year=this._getDateFieldValue('Year'),month=this._getDateFieldValue('Month'),day=this._getDateFieldValue('Day');if(new Date(year,month-1,day).getDate()!==day){errors.push(RightNow.Interface.getMessage("PCT_S_IS_NOT_A_VALID_DATE_MSG"));return false;}
if(this.data.attrs.min_year&&year<=this.data.attrs.min_year){var min=this.data.js.min,hour=this._getDateFieldValue('Hour');if(year<min.year||month<min.month||(month===min.month&&day<min.day)||(hour!==null&&(hour<min.hour&&day<=min.day))){errors.push(RightNow.Text.sprintf(RightNow.Interface.getMessage("VALUE_MIN_VALUE_PCT_S_MSG"),this.data.js.min_val));return false;}}
return true;},_getDateFieldValue:function(fieldName){var element=this.Y.one(this._inputSelector+'_'+fieldName);return(element)?parseInt(element.get('value'),10):null;}});
RightNow.Widgets.SmartAssistantDialog=RightNow.Field.extend({overrides:{constructor:function(){this.parent();try{this.parentForm().on("response",this._displayResults,this);this._parentFormID=this.getParentFormID();}
catch(e){RightNow.Event.on('evt_formButtonSubmitResponse',this._displayResults,this);}
RightNow.UI.Form.smartAssistant=true;this.sessionParameter='';this.Y.augment(this,RightNow.Avatar);}},_displayResults:function(evt,args)
{var result=args[0];if(result&&result.data&&result.data.result&&result.data.result.sa)
{if(result.data.result.newFormToken)
{RightNow.Event.fire("evt_formTokenUpdate",new RightNow.Event.EventObject(null,{data:{newToken:result.data.result.newFormToken}}));}
if(!this._parentFormID&&result.data.form)
{this._parentFormID=result.data.form;}
this.sessionParameter=result.data.result.sessionParam||'';result=result.data.result.sa;if(result.token){RightNow.UI.Form.smartAssistantToken=result.token;}
RightNow.UI.Form.smartAssistant=false;if(typeof result.canEscalate!=='undefined')
this._doNotCreateIncidentOrSocialQuestion=!result.canEscalate;else if(typeof result.canCreate!=='undefined')
this._doNotCreateIncidentOrSocialQuestion=!result.canCreate;var dialogHeading=this.Y.one("#rn_"+this.instanceID+"_DialogHeading");if(dialogHeading)
dialogHeading.set("innerHTML",this.data.attrs.label_banner);var saDisplay,accessKeyPrompt="",displayButton=true,inlineContent=false,inlineAnswerDiscussions=false,suggestions=result.suggestions,i,accessKeyNumber=0;if(suggestions&&suggestions.length>0)
{var suggestion;for(i=0;i<suggestions.length;i++)
{suggestion=suggestions[i];if(suggestion.type==='AnswerSummary'||suggestion.type==='QuestionSummary')
{if(this.data.attrs.accesskeys_enabled&&this.data.attrs.label_accesskey&&this.data.attrs.display_inline)
{accessKeyNumber+=suggestion.list.length;}
if(this.data.attrs.display_inline)
inlineAnswerDiscussions=true;}
else
{inlineContent=true;}}
if(accessKeyNumber>0){var keyComboString=RightNow.Interface.getMessage("ACCESSKEY_LBL"),UA=this.Y.UA,OS=UA.os;if(UA.ie)
keyComboString=RightNow.Interface.getMessage("ALT_LBL");else if(UA.gecko)
keyComboString=(OS==="windows"||!OS)?RightNow.Interface.getMessage("ALT_PLUS_SHIFT_LBL"):RightNow.Interface.getMessage("CTRL_LBL");else if(UA.webkit)
keyComboString=(OS==="windows"||!OS)?RightNow.Interface.getMessage("ALT_LBL"):RightNow.Interface.getMessage("CTRL_PLUS_OPT_LBL");accessKeyPrompt=RightNow.Text.sprintf("<span class='rn_ScreenReaderOnly'>"+this.data.attrs.label_accesskey+"</span>",keyComboString,accessKeyNumber);}
if(suggestions.length>0){var data={'suggestions':suggestions,'accessKeyPrompt':accessKeyPrompt,'sessionParam':this.sessionParameter,'baseDomID':this.baseDomID,'attrs':{'label_prompt':this.data.attrs.label_prompt,'accesskeys_enabled':this.data.attrs.accesskeys_enabled,'label_accesskey':this.data.attrs.label_accesskey,'display_inline':this.data.attrs.display_inline,'label_collapsed':this.data.attrs.label_collapsed},'answerUrl':RightNow.Interface.getConfig('CP_ANSWERS_DETAIL_URL')};saDisplay=this._generateViewData(suggestions,data);}}
else
{saDisplay=this.data.attrs.label_no_results;}
if(this._doNotCreateIncidentOrSocialQuestion)
{RightNow.ActionCapture.record('incident','doNotCreateState');RightNow.UI.Form.smartAssistant=true;if(this.data.attrs.dnc_label_banner&&dialogHeading)
dialogHeading.set("innerHTML",this.data.attrs.dnc_label_banner);displayButton=false;}
this._dialogBody=this.Y.one(this.baseSelector);this._dialogContent=this.Y.one(this.baseSelector+"_DialogContent");if(this._dialogBody)
{var handlers={label_submit_button:{fn:this._submitButtonAction,scope:this},label_cancel_button:{fn:this._cancelButtonAction,scope:this},label_solved_button:{fn:this._solvedButtonAction,scope:this}},dialogContent=this._dialogContent,buttons=[],links=[],buttonOrder=this.data.attrs.button_ordering,index=0,button;if(displayButton)
{for(i=0;i<buttonOrder.length;i++)
{button=buttonOrder[i];buttons.push({text:button.label,handler:handlers[button.name],isDefault:(buttons.length===0)});if(button.displayAsLink)
{links.push({index:index,handler:handlers[button.name],label:button.label});}
index++;}}
else if(this.data.attrs.label_cancel_button)
{buttons.push({text:(this._doNotCreateIncidentOrSocialQuestion&&this.data.attrs.dnc_label_cancel_button)?this.data.attrs.dnc_label_cancel_button:this.data.attrs.label_cancel_button,handler:handlers.label_cancel_button,isDefault:true});}
if(dialogContent)
{dialogContent.set("innerHTML",saDisplay);if(inlineAnswerDiscussions&&saDisplay!==this.data.attrs.label_no_results)
this._enableInlineAnswerDiscussions();if(inlineContent||!inlineAnswerDiscussions)
this._modifyLinkTargets(dialogContent);}
this._dialog=RightNow.UI.Dialog.actionDialog((this._doNotCreateIncidentOrSocialQuestion&&this.data.attrs.dnc_label_dialog_title)?this.data.attrs.dnc_label_dialog_title:this.data.attrs.label_dialog_title,this._dialogBody,{"buttons":buttons});var panel=this.Y.one('#'+this._dialog.id).ancestor('.yui3-panel');if(panel)
panel.addClass("rn_SmartAssistantDialogContainer");RightNow.UI.show(this._dialogBody);if(links.length)
{var dialogButtons=this._dialog.getButtons(),link,handler,buttonContainer;for(i=0;i<links.length;i++)
{button=dialogButtons.item?dialogButtons.item(links[i].index):dialogButtons[links[i].index];handler=links[i].handler;link=this.Y.Node.create("<a href='javascript:void(0);'>"+links[i].label+"</a>");link.on('click',(typeof handler==="function")?handler:handler.fn,links[i].handler.scope||this._dialog);buttonContainer=button.get('parentNode')||null;if(buttonContainer)
{button.insert(link,'after');button.remove();}}}
this._dialog.show();}}},_generateViewData:function(result,viewData)
{var viewDisplay=this.data.attrs.label_no_results;if(result.length>0)
viewDisplay=new EJS({text:this.getStatic().templates.displayResults}).render(viewData);return viewDisplay;},_submitButtonAction:function()
{this._dialog.hide();this.parentForm(this._parentFormID).fire("submitRequest");},_cancelButtonAction:function()
{if(!this._doNotCreateIncident||!this.data.attrs.dnc_redirect_url)
this._dialog.hide();else
RightNow.Url.navigate(this.data.attrs.dnc_redirect_url);},_solvedButtonAction:function()
{RightNow.ActionCapture.record('incident','deflect');RightNow.ActionCapture.flush(function(){var redirectUrl=this.data.attrs.solved_url;if(RightNow.UI.Form.smartAssistantToken&&RightNow.Text.beginsWith(redirectUrl,'/app')){redirectUrl=RightNow.Url.addParameter(redirectUrl,'saResultToken',RightNow.UI.Form.smartAssistantToken);}
RightNow.Url.navigate(redirectUrl);},this);},_modifyAnchorLinks:function(rootElement)
{var baseHrefFragment=this.Y.one('base');var href="";baseHrefFragment=(baseHrefFragment)?baseHrefFragment.get("href"):"";if(baseHrefFragment.substr(-1)==='/')
baseHrefFragment=baseHrefFragment.slice(0,-1);rootElement.all('a').each(function(node){if((href=node.get("href"))!==""){var hashLocation=href.split("#");if(hashLocation[0].substr(-1)==='/')
hashLocation[0]=hashLocation[0].slice(0,-1);if((hashLocation[0]===undefined||hashLocation[0]===baseHrefFragment)&&hashLocation[1]!==undefined){node.set("href",window.location.pathname+"#"+hashLocation[1]);}
else{node.setAttribute("target","_blank");}}});},_modifyLinkTargets:function(rootElement)
{if(this.data.attrs.display_answers_inline)
this._modifyAnchorLinks(rootElement);else
rootElement.all('a').setAttribute("target","_blank");},_enableInlineAnswerDiscussions:function()
{this._answersLoaded={};this._discussionsLoaded={};this.Y.one(this.baseSelector).delegate('click',function(evt)
{var clicked=evt.target,objectID=clicked.getAttribute('data-id');this._type=clicked.getAttribute('data-object-type');if(objectID===""){return;}
evt.halt();if(this._showingAnswerDiscussion===clicked)
return;if((typeof this._answersLoaded[objectID]==="undefined"&&this._type==='answer')||(typeof this._discussionsLoaded[objectID]==="undefined"&&this._type==='discussion'))
{clicked.append("<span class='rn_Loading' aria-live='assertive'><span class='rn_ScreenReaderOnly'>"+RightNow.Interface.getMessage("LOADING_ELLIPSES_LBL")+"</span></span>");this._showingAnswerDiscussion=clicked;if(this._dialogBody)
this._dialogBody.setAttribute("aria-busy","true");var eventObject=new RightNow.Event.EventObject(this,{data:{objectID:objectID}}),contentEndpoint;if(this._type==='answer'&&RightNow.Event.fire('evt_getAnswerRequest',eventObject)){contentEndpoint=this.data.attrs.get_answer_content;}
else if(this._type==='discussion'&&RightNow.Event.fire('evt_getDiscussionRequest',eventObject)){contentEndpoint=this.data.attrs.get_discussion_content;}
if(contentEndpoint)
this._getContent(clicked,eventObject,contentEndpoint);}
else
{this._toggleContent(objectID,!this._answersLoaded[objectID]);}},'ul',this);},_getContent:function(clickedLink,eventObject,contentEndpoint)
{RightNow.Ajax.makeRequest(contentEndpoint,eventObject.data,{successHandler:this._displayContent,scope:this,data:eventObject,json:true,isResponseObject:true});},_showContent:function(objectID,type,contentWrapper)
{this._modifyLinkTargets(contentWrapper);this._insertContent(contentWrapper);this._showingAnswerDiscussion.removeChild(this._showingAnswerDiscussion.get('lastChild'));this._showingAnswerDiscussion=null;this._toggleContent(objectID,true);if(this._dialog.resizeToWindow)
this._dialog.resizeToWindow();if(this._dialogBody)
this._dialogBody.setAttribute('aria-busy','false');RightNow.ActionCapture.record(type,'view',objectID);},_insertContent:function(contentWrapper)
{this._showingAnswerDiscussion.insert(contentWrapper,'after');},_displayContent:function(response,originalEventObject)
{var objectID=response.ID,answerDiscussionWrapper;if(this._type==='answer'&&RightNow.Event.fire("evt_getAnswerResponse",{data:originalEventObject,response:response})){if(this._showingAnswerDiscussion&&this._showingAnswerDiscussion.get('id').indexOf(response.ID)>-1&&response.ID){answerDiscussionWrapper=this.Y.Node.create(new EJS({text:this.getStatic().templates.answerContent}).render({spanID:this.baseDomID+'_AnswerContent'+objectID,question:(response.Question&&!response.GuidedAssistance)?response.Question:null,contents:this._getContents(objectID,response)}));this._answersLoaded[objectID]=true;}}
else if(this._type==='discussion'&&RightNow.Event.fire("evt_getDiscussionResponse",{data:originalEventObject,response:response})){if(this._showingAnswerDiscussion&&this._showingAnswerDiscussion.get('id').indexOf(response.ID)>-1&&response.ID){answerDiscussionWrapper=this.Y.Node.create(new EJS({text:this.getStatic().templates.discussionContent}).render({spanID:this.baseDomID+'_AnswerContent'+objectID,objectID:objectID,discussion:response.Body,solution:response.BestSocialQuestionAnswers,avatarURL:response.CreatedBySocialUser.AvatarURL,displayName:response.CreatedBySocialUser.DisplayName,sessionParam:this.sessionParameter,bestAnswerExists:this._bestAnswerExists(response.BestSocialQuestionAnswers),userStatus:response.CreatedBySocialUser.StatusWithType.Status.ID,js:this.data.js}));this._discussionsLoaded[objectID]=true;}}
this._showContent(objectID,this._type,answerDiscussionWrapper);},_bestAnswerExists:function(bestAnswers)
{for(var i in bestAnswers){if(bestAnswers[i].SocialQuestionComment.Body!==null){return true;}}
return false;},_getContents:function(answerID,response)
{if(response.FileAttachments){var attachmentLinks='';this.Y.Object.each(response.FileAttachments,function(attachment){attachmentLinks+=this._getAnswerLink(answerID,'/ci/fattach/get/'+attachment.ID+this.sessionParameter,attachment.FileName||this.data.attrs.label_download_attachment)+'<br />';},this);return(response.Solution?response.Solution:'')+attachmentLinks;}
if(response.URL){return this._getAnswerLink(answerID,response.URL,response.URL);}
if(response.GuidedAssistance){return this._getAnswerLink(answerID,'/app/'+RightNow.Interface.getConfig('CP_ANSWERS_DETAIL_URL')+'/a_id/'+answerID+this.sessionParameter,this.data.attrs.label_view_guide);}
return response.Solution;},_getAnswerLink:function(answerID,href,text)
{return new EJS({text:this.getStatic().templates.answerLink}).render({answerID:answerID,href:href,text:text});},_toggleContent:function(answerID,expand)
{var id=this.baseSelector+"_Answer",toggle=this.Y.one(id+answerID),answer=this.Y.one(id+"Content"+answerID),alt=this.Y.one(id+answerID+"_Alternative");this._expand=expand;if(expand)
{this._expandAnswerContent(id,answerID,answer,toggle,alt);}
else
{this._collapseAnswerContent(answerID,answer,toggle,alt);}
this._answersLoaded[answerID]=expand;},_expandAnswerContent:function(id,answerID,answer,toggle,alt)
{for(var i in this._answersLoaded)
{if(this._answersLoaded.hasOwnProperty(i)&&i!==answerID&&this._answersLoaded[i]===true)
{this.Y.one(id+i).replaceClass("rn_ExpandedAnswer","rn_ExpandAnswer");this.Y.one(id+"Content"+i).replaceClass("rn_ExpandedAnswerContent","rn_Hidden");this.Y.one(id+i+"_Alternative").set("innerHTML",this.data.attrs.label_collapsed);this._answersLoaded[i]=false;}}
answer.replaceClass("rn_Hidden","rn_ExpandedAnswerContent");toggle.replaceClass("rn_ExpandAnswer","rn_ExpandedAnswer");alt.set("innerHTML",this.data.attrs.label_expanded);if(!this.Y.DOM.contains(window,this.Y.Node.getDOMNode(toggle)))
{if(toggle.getY()<=0&&toggle.scrollIntoView)
toggle.scrollIntoView();else
window.scrollTo(0,toggle.getY()-20);}},_collapseAnswerContent:function(answerID,answer,toggle,alt)
{answer.replaceClass("rn_ExpandedAnswerContent","rn_Hidden");toggle.replaceClass("rn_ExpandedAnswer","rn_ExpandAnswer");alt.set("innerHTML",this.data.attrs.label_collapsed);}});
RightNow.Widgets.UserInfoDialog=RightNow.Widgets.extend({constructor:function(){this._dialog=null;this._keyListener=null;this._container=this.Y.one(this.baseSelector);this.Y.one(this.baseSelector+"_DisplayName").on("blur",this._toggleErrorClass,this);if(this.data.attrs.display_on_page_load){this._launchDialog();}
else{RightNow.Event.on('evt_userInfoRequired',this._launchDialog,this);}},_launchDialog:function(){if(!this._dialog){this._dialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_dialog_title,this._container,{buttons:[{text:this.data.attrs.label_submit_button,handler:{fn:this._onSubmit,scope:this},name:'submit'},{text:this.data.attrs.label_cancel_button,handler:{fn:this._onCancel,scope:this,href:'javascript:void(0)'}}],width:'400px'});}
this._keyListener=RightNow.UI.Dialog.addDialogEnterKeyListener(this._dialog,this._onSubmit,this,'input');this._dialog.validate=function(){return false;};RightNow.UI.show(this._container);if(RightNow.Env('module')==='standard'){this._dialog.cancelEvent.subscribe(this._onCancel,null,this);}
RightNow.UI.Dialog.enableDialogControls(this._dialog,this._keyListener);this._clearErrorMessage();this._dialog.show();},_onCancel:function(){this._clearErrorMessage();RightNow.UI.Dialog.disableDialogControls(this._dialog,this._keyListener);this.Y.one(this.baseSelector+"_DisplayName").set("value","");this._toggleErrorClass(false);this._dialog.hide();},_clearErrorMessage:function(){this.Y.all(this.baseSelector+"_UserInfoErrorMessage").each(function(errorNode){errorNode.setHTML('').removeClass('rn_MessageBox rn_ErrorMessage');},this);},_onSubmit:function(){var displayName=this.Y.one(this.baseSelector+"_DisplayName");if(displayName){this._toggleLoading(true);var eventObject=new RightNow.Event.EventObject(this,{data:{displayName:this.Y.Lang.trim(displayName.get('value'))||'',url:window.location.pathname,w_id:this.data.info.w_id}});if(RightNow.Event.fire("evt_createUserInfoRequest",eventObject)){RightNow.Ajax.makeRequest(this.data.attrs.create_social_user_ajax,eventObject.data,{successHandler:this._onSocialUserInfoResponse,scope:this,data:eventObject,json:true},this);}}},_toggleErrorClass:function(e){var toggleClass='addClass';if((e&&e.target&&this.Y.one(this.baseSelector+"_DisplayName").get('value')!=='')||(e===false)){toggleClass='removeClass';}
this.Y.one(this.baseSelector+"_DisplayName")[toggleClass]("rn_ErrorField");this.Y.one(this.baseSelector+"_DisplayName_Label")[toggleClass]("rn_ErrorLabel");},_onSocialUserInfoResponse:function(response,originalEventObject){if(response.success){RightNow.Url.navigate(window.location.pathname);}
else if(this._errorDisplay=this.Y.one(this.baseSelector+"_UserInfoErrorMessage")){this._toggleLoading(false);this._toggleErrorClass(true);this._addErrorMessage(this.Y.Lang.isArray(response.errors)?response.errors[0]:this.data.attrs.label_incorrect_display_name,this.baseDomID+"_DisplayName",true);}},_addErrorMessage:function(message,focusElement,showLink){this._errorDisplay||(this._errorDisplay=this.Y.one(this.baseSelector+"_UserInfoErrorMessage"));if(this._errorDisplay)
{this._errorDisplay.addClass('rn_MessageBox rn_ErrorMessage');if(showLink===false)
{this._errorDisplay.set("innerHTML",message);}
else
{this._errorDisplay.set("innerHTML",'<a href="javascript:void(0);" onclick="document.getElementById(\''+focusElement+'\').focus(); return false;">'+message+'</a>').get("firstChild").focus();}
this._errorDisplay.one("h2")?this._errorDisplay.one("h2").setHTML(RightNow.Interface.getMessage("ERRORS_LBL")):this._errorDisplay.prepend("<h2>"+RightNow.Interface.getMessage("ERROR_LBL")+"</h2>");this._errorDisplay.one("h2").setAttribute('role','alert');}},_toggleLoading:function(turnOn){this._dialogContent||(this._dialogContent=this.Y.one(this.baseSelector+"_UserInfoContent"));this._dialogContent.all('input')[(turnOn)?'setAttribute':'removeAttribute']('disabled',true);if(!this.Y.UA.ie||this.Y.UA.ie>8){this._dialogContent.transition({opacity:turnOn?0:1,duration:0.4});this.Y.one(this.baseSelector)[(turnOn)?'addClass':'removeClass']('rn_Loading');}}});
RightNow.Widgets.DiscussionAuthorSubscription=RightNow.Field.extend({overrides:{constructor:function(){this.parent();this.subscribedDiv=this.Y.one(this.baseSelector+'_Subscribed');this.subscribeMeDiv=this.Y.one(this.baseSelector+'_SubscribeMe');this.subscribeMeCheckbox=this.Y.one(this.baseSelector+'_SubscribeMe_Check');this.loadingIcon=this.Y.one(this.baseSelector+'_LoadingIcon');this.authorSubscriptionDiv=this.Y.one(this.baseSelector+'_AuthorSubscription');RightNow.Event.subscribe('evt_productCategorySelected',this._getProdCatID,this);this.parentForm().on('submit',this._onSubmit,this);}},_getProdCatID:function(evt,eventData){this.loadingIcon.toggleClass("rn_Hidden");this.authorSubscriptionDiv.toggleClass("rn_Hidden");RightNow.Event.fire("evt_formToggleButton",false);var eventObject=new RightNow.Event.EventObject(this,{data:{prodCatID:eventData[0].data.hierChain[eventData[0].data.hierChain.length-1],w_id:this.data.info.w_id}});RightNow.Ajax.makeRequest(this.data.attrs.fetch_prodcat_subscription_ajax,eventObject.data,{successHandler:this._onResponse,scope:this,data:eventObject,json:true});},_onResponse:function(response,eventObject){this.loadingIcon.toggleClass("rn_Hidden");RightNow.Event.fire("evt_formToggleButton",true);this.authorSubscriptionDiv.toggleClass("rn_Hidden");if(response){this.subscribedDiv.removeClass("rn_Hidden");this.subscribeMeDiv.addClass("rn_Hidden");this.subscribeMeCheckbox.set('checked',false);}
else{this.subscribedDiv.addClass("rn_Hidden");this.subscribeMeDiv.removeClass("rn_Hidden");if(this.data.attrs.subscribe_me_default){this.subscribeMeCheckbox.set('checked',true);}}},_onSubmit:function(type,args){var eventObject=this.createEventObject();if(this.subscribeMeCheckbox.get('checked')){eventObject.data.value=this.subscribeMeCheckbox.get('value');eventObject.data.name=this.subscribeMeCheckbox.get('name');RightNow.Event.fire('evt_formFieldValidatePass',eventObject);return eventObject;}
return true;}});
RightNow.Widgets.RichTextInput=RightNow.Field.extend({overrides:{constructor:function(){this.parent();this.data.isTouchDevice=this._isTouchDevice;this.data.readOnly=this.data.attrs.read_only;this.data.isSubscribed=false;this.data.label=this.data.attrs.label_input;this.data.contentWasPruned=false;var data=this.data,instanceID=this.instanceID,Y=this.Y,self=RightNow.Widgets.RichTextInput,converter=new self.converter(data,instanceID,Y),viewController=new self.viewController(data,instanceID,Y);viewController.converter=converter;viewController.setEditor(new self.editor(data,instanceID,Y));viewController.setMenu(new self.menu(data,instanceID+'_Editor',Y));viewController.setInsertLinkDialog(new self.insertLinkDialog(data,instanceID,Y));viewController.setTooltip(new self.tooltip(data,instanceID,Y));this.viewController=viewController;this.Y.one(window).on('windowresize',this.Y.throttle(RightNow.Event.createDelegate(this,function(){this.viewController.editor.queueRegrow();}),200));this._subscribeToFormValidation();this._hintOverlay=null;this._initialInputHeight=null;},getValue:function(type){return this.viewController.getValue(type);}},setLabel:function(newLabel){if(newLabel){this.data.label=newLabel;this.Y.one(this.baseSelector+' label .rn_LabelInput').set('text',newLabel);}},getLabel:function(){return this.data.label;},reload:function(content,readOnly){this.data.js.initialValue=content||'';this.data.readOnly=typeof readOnly==='undefined'?this.data.attrs.read_only:readOnly;this._subscribeToFormValidation();this.viewController.reloadEditor();this.viewController.updateMenuForReadOnlyState();this._toggleErrorIndicator(false);},_subscribeToFormValidation:function(){if(this.data.readOnly||this._subscribedToFormValidation)return;this.parentForm().on('submit',this.onValidate,this);this._subscribedToFormValidation=true;},_displayError:function(message,errorLocation){var commonErrorDiv=this.Y.one('#'+errorLocation),label=this.getLabel();if(this.data.attrs.label_error_fieldname){label=this.data.attrs.label_error_fieldname;}
else if(this.data.attrs.name==='SocialQuestion.Body'){label=RightNow.Interface.getMessage('QUESTION_LBL');}
else if(this.data.attrs.name==='SocialQuestionComment.Body'){label=RightNow.Interface.getMessage('COMMENT_LBL');}
if(commonErrorDiv){if(message.indexOf("%s")>-1){message=RightNow.Text.sprintf(message,label);}
else if(!RightNow.Text.beginsWith(message,label)){message=(label+' '+message);}
commonErrorDiv.append("<div><b><a href='javascript:void(0);' onclick='document.getElementById(\""+
this.baseDomID+'_Iframe'+"\").contentWindow.document.body.focus(); return false;'>"+message+"</a></b></div>");}
this._toggleErrorIndicator(true);},_toggleErrorIndicator:function(show){var method=(show)?'addClass':'removeClass';this.Y.one(this.baseSelector+'_Input')[method]('rn_ErrorField');this.Y.one(this.baseSelector+'_Label')[method]('rn_ErrorLabel');},onValidate:function(type,args){var eventObject=this.createEventObject(),globalEvent='evt_formFieldValidate',result='Pass',errors=[],error_location=args[0].data.error_location,label=this.getLabel(),value=this.getValue(),errorMessage;eventObject.data.value=value.text;this._toggleErrorIndicator(false);if(value.error){this._displayError(value.error,error_location);result='Failure';}
else if(!this.validate(errors,this.Y.Lang.trim(value.text))){this.Y.Array.each(errors,function(error){this._displayError(error,error_location);},this);result='Failure';if(!(eventObject.data.value=this.Y.Lang.trim(value.text)?value.text:'')&&this.data.contentWasPruned){this._displayError(this.data.attrs.label_content_stripped,error_location);}}
RightNow.Event.fire(globalEvent+result,eventObject);return result==='Pass'?eventObject:false;},_isTouchDevice:'ontouchstart'in window||(window.DocumentTouch&&document instanceof DocumentTouch)});RightNow.Widgets.RichTextInput.viewController=RightNow.Widgets.extend({editor:null,menu:null,tooltip:null,insertLinkDialog:null,advancedMode:false,constructor:function(){},getValue:function(type){var result=this.editor.getContent(),response={};try{if(this.advancedMode){result=this.converter.mdToHTML(this.Y.Lang.trim(this.converter.browserHTMLToMarkdown(result)));}
result=this._removeDisallowedContent(result);if(type==='html'){response.html=result.html;}
else if(this.advancedMode){response.text=this.converter.htmlToMd(this.Y.Lang.trim(result.html));}
else{response.text=this.converter.htmlToMd(result.html).replace(/\n/g,"\n\n");}}
catch(e){response.error=this.data.attrs.label_parsing_error;}
return response;},setEditor:function(editor){editor.on({'mouseup':this._updateTextState,'keydown':this._updateTextState,'keyboardFormattingChange':this._keyboardFormattingChange},null,this);this.editor=editor;},reloadEditor:function(){this.editor.reload();},setMenu:function(menu){menu.after({bold:this._bolden,italic:this._italicize,link:this._showLinkDialog,unlink:this._unlink,bullet:this._insertBullet,advanced:this._toggleAdvancedMode},null,this);this.menu=menu;this.updateMenuForReadOnlyState();},updateMenuForReadOnlyState:function(){this.menu.updateForReadOnlyState();},setTooltip:function(tooltip){this.tooltip=tooltip;},setInsertLinkDialog:function(dialog){dialog.on('insertLink',this._insertLink,this);this.insertLinkDialog=dialog;},_updateTextState:function(e){var selection=e.selection,selectionMade=selection&&!selection.collapsed;if(selectionMade&&(e.event.type!=='mouseup'||e.event.button===1)){this.menu.show(e.event,selectionMade);}
else{this.menu.hide(selectionMade);this.menu.toggleLimitedFunctionality(false,'.rn_SlideMenu');}
if(e.event.type==='keydown'){RightNow.Event.fire("evt_formInputDataChanged",null);}
this._showStateOfSelectedText(selection);},_keyboardFormattingChange:function(e){if(e.automatic){this.menu.refreshSelectedStateOfButtons(e);}},_showStateOfSelectedText:function(selection){if(!selection||!selection.elements.size()){this.menu.deselectAllButtons();this.tooltip.hide();return false;}
var selectionData=this._getSelectionData(selection.elements),selectedNode=selectionData.node,aTag=selectionData.tag==='A',ancestors=selection.ancestors;this.menu.refreshSelectedStateOfButtons({link:aTag,bold:selectedNode&&this._nodeIsBold(selectedNode,ancestors),italic:selectedNode&&this._nodeIsItalic(selectedNode,ancestors),bullet:this._nodeIsListItem(ancestors)});if(aTag&&!selectionData.otherTextSelected&&!selection.collapsed){this._showLinkTooltip(selectedNode);return false;}
return true;},_getSelectionData:function(list){var otherTextSelected=false,selectedNode=null,tag=null,_tag,text;list.some(function(node){if(selectedNode&&otherTextSelected){return true;}
if(this.Y.Lang.trim(node.get('text'))){if(!selectedNode&&(_tag=node.get('tagName'))){selectedNode=node;tag=_tag;}
else{otherTextSelected=true;}}},this);return{node:selectedNode,tag:tag,otherTextSelected:otherTextSelected}},_nodeIsBold:function(node,ancestors){var match=/^(STRONG|B)$/,tagName=node.get('tagName');return!!tagName&&(match.test(tagName)||node.getStyle('fontWeight')==='bold'||(ancestors&&!!this.Y.Array.grep(ancestors,match).length)||this._wraps(node,'bold'));},_nodeIsItalic:function(node,ancestors){var match=/^(I|EM)$/,tagName=node.get('tagName');return!!tagName&&(match.test(tagName)||node.getStyle('fontStyle')==='italic'||(ancestors&&!!this.Y.Array.grep(ancestors,match).length)||this._wraps(node,'italic'));},_nodeIsListItem:function(ancestors){return!!this.Y.Array.grep(ancestors,/^UL$/).length;},_wraps:function(node,type){if(node.all('*').size()===1){var child=node.get('firstChild'),text=node.get('textContent')||node.get('innerText'),childText=node.get('textContent')||node.get('innerText');if(text===childText){if(type==='bold'){return this._nodeIsBold(child);}
else if(type==='italic'){return this._nodeIsItalic(child);}}}
return false;},_showLinkDialog:function(){var selection=this.editor.getSelection('text'),placeholderText='',url='',selected;this.data.globalObject=this;if(selection){placeholderText=selection;selection=this.editor.getSelection();selected=selection.elements.item(0);if(selected.get('tagName')==='A'){url=selected.getAttribute('href');}}
this.editor.stashIESelection();this.insertLinkDialog.show(placeholderText,url);},_showLinkTooltip:function(node){var href=node.getAttribute('href');this.tooltip.setContent('<a href="'+href+'" target="_blank">'+href+'</a>').reposition(node,this.Y.one(this.baseSelector+'_Input')).show();var hideTooltipOnClick=function(){this.tooltip.hide();};this.Y.one(document.body).once('click',hideTooltipOnClick,this);this.editor.getBody().once('click',hideTooltipOnClick,this);},_insertLink:function(link){this.editor.insertLink(link);this.menu.toggleLimitedFunctionality(false,'.rn_SlideMenu');this.menu.hide();},_unlink:function(){this.editor.unlink();this.menu.toggleLimitedFunctionality(false,'.rn_SlideMenu');this.menu.hide();},_bolden:function(){this.editor.boldTheSelection();this._showStateOfSelectedText(this.editor.getSelection());this._focusOnEventWidgetIframe();},_italicize:function(){this.editor.italicizeTheSelection();this._showStateOfSelectedText(this.editor.getSelection());this._focusOnEventWidgetIframe();},_insertBullet:function(){this.editor.insertBullet();this._showStateOfSelectedText(this.editor.getSelection());this._focusOnEventWidgetIframe();},_focusOnEventWidgetIframe:function(){var iframe=this.Y.one(this.baseSelector+'_Iframe');if(iframe){iframe.focus();}},_toggleAdvancedMode:function(){var output=this.editor.getContent();if(this.advancedMode){this.menu.enableRichMode();this.menu.toggleLimitedFunctionality();output=this.converter.extractNormalizedMDFromHTML(output);output=this.converter.mdToHTML(output);}
else{this.menu.deselectAllButtons();this.menu.disableRichMode();output=this.converter.htmlToMd(output);output=output.replace(/\n/g,"<br>");}
this.editor.setContent(output);this.advancedMode=!this.advancedMode;this.editor.setAdvancedMode(this.advancedMode);},_removeDisallowedContent:function(html){var content=this.Y.Node.create('<div>'+html+'</div>');content.all(this.converter.disallowedContent).remove();pruned=content.getHTML();this.data.contentWasPruned=html.length>pruned.length;return{html:pruned};}});RightNow.Widgets.RichTextInput.editor=RightNow.Widgets.extend({_advancedMode:false,constructor:function(){this.widget=this.Y.one(this.baseSelector+'_Input');this.editor=this._initializeEditor();if(!this.Y.UA.ie||this.Y.UA.ie>8){this.Y.later(200,this,this._autoGrowInputHeight,null,true);}
this.Y.augment(this,this.Y.EventTarget);},getContent:function(){return this.editor.getContent();},setContent:function(html){this.editor.frame.getInstance().one('body').setHTML(html);},getBody:function(){return this.editor.frame.getInstance().one('body');},setAdvancedMode:function(mode){this._advancedMode=mode;},queueRegrow:function(){this._recomputeHeightWhenVisible=true;},reload:function(){this.editor.frame.destroy();this.editor=this._initializeEditor(true);if(this.shadowInput){this.shadowInput.destroy();this.shadowInput=null;}},_initializeEditor:function(focusWhenReady){this.widget.addClass('rn_Loading');var frame=new this.Y.Frame({content:this.data.js.initialValue||'',extracss:this._getDefaultStyles(),title:this.data.label});frame.onceAfter('render',this.Y.later(this.data.js.initialValue?800:300,this.widget,this.widget.removeClass,'rn_Loading'));frame.after('dom:mouseup',function(e){this.Y.Lang.later(100,this,this._onMouseUp,e);},this);if(this.Y.UA.os==='macintosh'){frame.on(['dom:keydown','dom:keyup'],function(e){var cmdKeys=[91,93,224,];this.cmdKeyDown=e.type==='keydown'&&this.Y.Array.indexOf(cmdKeys,e.keyCode)>-1;},this);}
frame.on('dom:keydown',this._onKeyDown,this);frame.render(this.widget);frame.get('node').setAttribute('title',frame.get('title')).setAttribute('id',this.baseDomID+'_Iframe');var doc=this.Y.Node.getDOMNode(frame.get('node')).contentDocument;if(!this.data.readOnly){doc.body.setAttribute("contenteditable","true");}
this._recomputeHeightWhenVisible=true;try{doc.execCommand('styleWithCSS',false);doc.execCommand('enableObjectResizing',true);}
catch(IEDoesNotSupportTheseCommands_){}
if(this.data.attrs.hint&&!this.data.attrs.always_show_hint){this._initializeHint(doc.body);}
focusWhenReady||(focusWhenReady=this.data.attrs.initial_focus);if(focusWhenReady){doc.body.focus();}
return{win:this.Y.Node.getDOMNode(frame.getInstance().one('window')),doc:doc,frame:frame,getContent:function(){return frame.get('content');}};},_initializeHint:function(input){var overlay=this._hintOverlay=new this.Y.Overlay({bodyContent:this.Y.Node.create('<span class="rn_RichTextInputHint rn_HintBox">'+this.data.attrs.hint+'</span>'),visible:false,zIndex:3,align:{node:this.baseSelector+'_Iframe',points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.BL]}});input.addEventListener('focus',function(){overlay.show();});input.addEventListener('blur',function(){overlay.hide();});overlay.render();},_createShadowInput:function(bottomPadding){this.originalMinHeight=parseInt(this.widget.getComputedStyle('minHeight'),10)||100;this.maxGrowHeight=parseInt(this.widget.getComputedStyle('maxHeight'),10)||500;var shadowContainer=this.Y.Node.create('<div aria-hidden="true"></div>').setStyles({visibility:'hidden',height:0});this.Y.one(this.baseSelector).append(shadowContainer);var shadowInput=new this.Y.Frame({extracss:this._getDefaultStyles()+'body{padding-bottom:'+bottomPadding+'px;}',title:this.data.label+' shadow'});shadowInput.render(shadowContainer);shadowInput.get('node').setAttribute('title',shadowInput.get('title'));return shadowInput;},_autoGrowInputHeight:function(){var yInstance=(this.editor.frame)?this.editor.frame.getInstance():null,body=(yInstance)?yInstance.one('body'):null;if(!yInstance|!body)return;var bottomPadding=60,inputHeight=parseInt(this.widget.getComputedStyle('height'),10),newInput=this.editor.getContent(),isVisible=this._elementIsVisible(this.editor.frame.get('node')),shadowInstance,shadowBody,height;(this.shadowInput||(this.shadowInput=this._createShadowInput(bottomPadding)));if(newInput!==this.previousInput||(this._recomputeHeightWhenVisible&&isVisible)){if(this._advancedMode){newInput.replace(/\n/,'<br>');}
shadowInstance=this.shadowInput.getInstance();if(shadowInstance){shadowBody=shadowInstance.one('body').setHTML(newInput);shadowHeight=shadowBody.get('scrollHeight');if(shadowHeight!==inputHeight){if(shadowHeight===this.originalMinHeight+bottomPadding){shadowHeight=this.originalMinHeight;}
shadowHeight+=bottomPadding;height=(shadowHeight<this.maxGrowHeight)?shadowHeight:this.maxGrowHeight;(this._initialInputHeight||(this._initialInputHeight=height));if(this._hintOverlay&&height>this._initialInputHeight){this._hintOverlay.hide();}
this.widget.setStyle('minHeight',height);this.editor.frame.get('node').setAttribute('height','99%').setStyle('minHeight',height-20);if(isVisible){this._recomputeHeightWhenVisible=false;}}
else if(typeof this.previousInput==='undefined'&&!this._elementIsVisible(this.editor.frame.get('node'))){this._recomputeHeightWhenVisible=true;}}
this.previousInput=newInput;}},_elementIsVisible:function(el){if(!el||!el.get('tagName'))return true;if(el.getComputedStyle('display')==='none')return false;return this._elementIsVisible(el.get('parentNode'));},_onMouseUp:function(e){if(this._advancedMode)return;this.fire('mouseup',{event:e,selection:this.getSelection()});},_keyCombos:{'boldTheSelection':66,'italicizeTheSelection':73},_onKeyDown:function(e){if(!e.shiftKey&&((this.cmdKeyDown&&!e.ctrlKey)||(typeof this.cmdKeyDown==='undefined'&&e.ctrlKey))){this.Y.Object.some(this._keyCombos,function(keyCode,method){if(e.keyCode===keyCode){if(this.cmdKeyDown){this[method]();}
this.fire('keyboardFormattingChange',{bold:method.indexOf('bold')>-1,italic:method.indexOf('italicize')>-1,automatic:!this.cmdKeyDown});return true;}},this);}
if(!this._advancedMode){this.fire('keydown',{event:e,selection:this.getSelection('cursor')});}},getSelection:function(type){var subWindow=this.editor.win,selection=subWindow.getSelection?subWindow.getSelection():null,range;if(!selection){range=this.editor.doc.selection.createRange();if(type==='text')return range.text;}
else if(selection&&type==='text'){return selection.toString();}
else if(selection.rangeCount){range=selection.getRangeAt(0);}
if(!range)return;return this._captureSelectionWithParent(range);},_captureSelectionWithParent:function(range){var parent,collapsed,ancestors=[],selectedFragment;if(range.cloneContents){selectedFragment=range.cloneContents();collapsed=range.collapsed;var startParent=range.startContainer.firstChild||range.startContainer.parentNode,endParent=range.endContainer.firstChild||range.endContainer.parentNode;if(startParent.tagName&&startParent.tagName!=='BODY'){if(startParent===endParent||startParent.contains(endParent)){parent=startParent;}}}
else{collapsed=!range.text;parent=range.parentElement();}
if(parent){for(var nextParent=parent,tagName;nextParent&&nextParent.tagName!=='BODY';nextParent=nextParent.parentNode){tagName=nextParent.tagName;if(tagName==='SPAN'){if(nextParent.style.fontStyle==='italic')tagName='EM';else if(nextParent.style.fontWeight==='bold')tagName='STRONG';}
ancestors.push(tagName);}
if(parent.setAttribute){parent.setAttribute('data-offsetTop',parent.offsetTop);parent.setAttribute('data-offsetLeft',parent.offsetLeft);parent.setAttribute('data-offsetHeight',parent.offsetHeight);parent.setAttribute('data-offsetWidth',parent.offsetWidth);}
parent=parent.cloneNode(true);}
var holder=this.editor.frame.getInstance().Node.create('<div>');holder.appendChild(parent||selectedFragment);return{elements:holder.get('childNodes'),collapsed:collapsed,ancestors:ancestors};},stashIESelection:function(){if(!this.Y.UA.ie)return;var selection,doc=this.editor.doc;if(doc.getSelection){if(doc.getSelection().toString()){if(this.Y.UA.ie>='11'){selection=doc.getSelection();this.liveRange=selection.getRangeAt(0);this.currentRange=this.liveRange.cloneRange();}
else{this.currentSelection=doc.selection.createRange();}}
else{this.currentRange=doc.getSelection();}}
else{var textRange=doc.selection.createRange();this.currentSelection=(textRange.text)?textRange:null;}},_insertHTMLForIE:function(html){if(!this.Y.UA.ie)return false;var iframe=this.Y.Node.getDOMNode(this.Y.one(this.baseSelector+'_Input iframe')),doc=iframe.contentDocument;if(doc.getSelection&&doc.getSelection().toString()){doc.selection.createRange().pasteHTML(html);}
else if(this.currentSelection){var selection=this.currentSelection;selection.pasteHTML(html);selection.collapse(false);selection.select();this.currentSelection=null;}
else if(this.currentRange){this.editor.frame.focus(RightNow.Event.createDelegate(this,function(){var frag,node;if(!doc.getSelection().rangeCount)return;frag=doc.createDocumentFragment();node=this.editor.frame.getInstance().Node.getDOMNode(this.editor.frame.getInstance().Node.create(html));frag.appendChild(node);this.liveRange.insertNode(frag);this.liveRange.collapse(false);}));this.currentRange.deleteContents();}
return true;},_insertHTMLForNonIE:function(html){var editor=this.editor;editor.frame.focus(function(){var selection=editor.win.getSelection();if(selection.getRangeAt&&selection.rangeCount){var range=selection.getRangeAt(0);range.deleteContents();var el=document.createElement('div');el.innerHTML=html;var frag=document.createDocumentFragment(),node,last;while(node=el.firstChild){last=frag.appendChild(node);}
range.insertNode(frag);if(last){range=range.cloneRange();range.setStartAfter(last);range.collapse(true);selection.removeAllRanges();selection.addRange(range);}}});},_insertHTML:function(html){return this._insertHTMLForIE(html)||this._insertHTMLForNonIE(html);},insertLink:function(link){this._insertHTML("<a href='"+link.url+"'>"+(link.text||link.url)+"</a>");},unlink:function(){this.editor.doc.execCommand('unlink');},boldTheSelection:function(){this._applyFormatting('bold');},italicizeTheSelection:function(){this._applyFormatting('italic');},insertBullet:function(){this._applyFormatting('insertUnorderedList');},_applyFormatting:function(command){this.editor.doc.execCommand(command);},_getDefaultStyles:function(){if(!this._defaultStyle){var styles=this.getStatic().editor.editorCSS,styleString='';this.Y.Object.each(styles,function(rules,selector,dynamicRules){dynamicRules=(selector==='body')?'font-family:'+this.Y.one(document.body).getComputedStyle('fontFamily')+';':'';styleString+=selector+'{'+rules.join(';')+';'+dynamicRules+'}';},this);this._defaultStyle=styleString;}
return this._defaultStyle;}},{editorCSS:{'html':['height: 100%'],'body':['background:none','height: 100% !important','font-size: 1em'],'body > p:first-child':['margin:0'],'iframe,img':['display:none']}});RightNow.Widgets.RichTextInput.menu=RightNow.Widgets.extend({_events:{'click .rn_Bolden':'bold','click .rn_Italicize':'italic','click .rn_InsertLink':'link','click .rn_RemoveLink':'unlink','click .rn_InsertBullet':'bullet','click .rn_AdvancedMode button':'advanced'},_buttonClasses:{bold:'.rn_Bolden',italic:'.rn_Italicize',bullet:'.rn_InsertBullet',link:'.rn_InsertLink'},_keyShortcuts:{'rn_Bolden':{win:'CTRL + B',mac:'B'},'rn_Italicize':{win:'CTRL + I',mac:'I'}},popupMenu:null,slideMenu:null,limitedFunctionality:null,richButtonsEnabled:true,constructor:function(){this.Y.augment(this,this.Y.EventTarget);this.widget=this.Y.one(this.baseSelector);this._initializeEvents();if(this.Y.UA.ie){this.limitedFunctionality={severe:this.Y.UA.ie<9};}},updateForReadOnlyState:function(){var button=this.widget.one('button.rn_MenuButton');if(this.data.readOnly){RightNow.UI.hide(button);this.widget.one('.rn_InputArea').setStyle('backgroundColor','#EFEFEF');}
else{RightNow.UI.show(button);}},refreshSelectedStateOfButtons:function(states){var selectedClass='rn_Selected';this.Y.Object.each(states,function(toggleOnOrOff,stateName){this.widget.all(this._buttonClasses[stateName]).toggleClass(selectedClass,toggleOnOrOff);},this);},deselectAllButtons:function(){this.widget.all('.rn_Menu .rn_RichMode button').removeClass('rn_Selected');},disableRichMode:function(){this.widget.all(this._getSelectorForSelection('rich')+' button').addClass('rn_Hidden');this.widget.all(this._getSelectorForSelection('advanced')+' a').removeClass('rn_Hidden');},enableRichMode:function(section){this.widget.all(this._getSelectorForSelection('rich')+' button').removeClass('rn_Hidden');this.widget.all(this._getSelectorForSelection('advanced')+' a').addClass('rn_Hidden');},toggleLimitedFunctionality:function(onOrOff,classOfButtons){if(!this.limitedFunctionality||(this.richButtonsEnabled===onOrOff&&!classOfButtons))return;if(this.limitedFunctionality.severe){this.widget.all('.rn_Menu'+(classOfButtons||'')+' .rn_RichMode').each(function(div,parent,clone){parent=div.get('parentNode');clone=div.cloneNode(true);div.remove();clone.all('button')[(onOrOff)?'removeAttribute':'setAttribute']('disabled',true);parent.insert(clone,0);});}
else{this.widget.all('.rn_Menu'+(classOfButtons||'')+' .rn_RichMode button.rn_FormatAction')
[(onOrOff)?'removeAttribute':'setAttribute']('disabled',true);}
this.richButtonsEnabled=onOrOff;},show:function(clickEvent,somethingIsSelected){if(this.data.isTouchDevice||this.data.readOnly)return false;if(somethingIsSelected){this.slideMenu||(this.slideMenu=this._createSlideMenu());this.slideMenu.one('.rn_RichMode button.rn_InsertLink').removeAttribute('disabled');this.slideMenu.one('.rn_RichMode button.rn_InsertLink').addClass('rn_SelectedText');if(this.Y.UA.ie){this.slideMenu.one('.rn_RichMode button.rn_Bolden').removeAttribute('disabled');this.slideMenu.one('.rn_RichMode button.rn_Italicize').removeAttribute('disabled');this.slideMenu.one('.rn_RichMode button.rn_InsertBullet').removeAttribute('disabled');}
return true;}},hide:function(somethingIsSelected){if(!somethingIsSelected){this.slideMenu||(this.slideMenu=this._createSlideMenu());this.slideMenu.one('.rn_RichMode button.rn_InsertLink').setAttribute('disabled',true);this.slideMenu.one('.rn_RichMode button.rn_InsertLink').removeClass('rn_SelectedText');this.slideMenu.one('.rn_RichMode button.rn_Bolden').removeClass('rn_SelectedText');this.slideMenu.one('.rn_RichMode button.rn_Italicize').removeClass('rn_SelectedText');this.slideMenu.one('.rn_RichMode button.rn_InsertBullet').removeClass('rn_SelectedText');}},destroy:function(){if(this.slideMenu){this.slideMenu.remove();this.slideMenu=null;}},_getSelectorForSelection:function(section){if(!section||section==='all')return'.rn_Menu';return(section==='advanced')?'.rn_AdvancedMode':'.rn_RichMode';},_initializeEvents:function(){this.widget.one('button.rn_MenuButton').on('click',this._toggleSlideMenu,this);var container=this.widget.get('parentNode');this.Y.Object.each(this._events,function(event,action){action=action.split(' ');this.publish(event,{emitFacade:true});container.delegate(action[0],this._onEventDelegate,action.slice(1).join(' '),this,event);},this);},_onEventDelegate:function(e,eventToFire){if(e.currentTarget.getAttribute('disabled'))return;if(eventToFire==='advanced'){e.currentTarget.toggleClass('rn_Selected');}
this.fire(eventToFire,{type:eventToFire});},_toggleSlideMenu:function(e){e.currentTarget.toggleClass('rn_Selected');this.slideMenu||(this.slideMenu=this._createSlideMenu());var to,eventKey;if(this.slideMenu.hasClass('rn_Hidden')){eventKey='start';var parentWidth=parseInt(this.Y.one(this.baseSelector).getComputedStyle('width'),10);if(this.Y.UA.ie){to=parentWidth-(parentWidth-parseInt(e.currentTarget.getComputedStyle('width'),10))+25;}
else{to=parentWidth-(parentWidth-parseInt(e.currentTarget.getComputedStyle('width'),10))-1;}}
else{eventKey='end';to=-200;}
var anim=new this.Y.Anim({node:this.slideMenu,to:{right:to},duration:0.4});anim.on(eventKey,function(){anim.get('node').toggleClass('rn_Hidden');});anim.run();var linkButton=this.slideMenu.one('.rn_RichMode button.rn_InsertLink');if(!linkButton.hasClass('rn_SelectedText')){linkButton.setAttribute('disabled',true);}},_createSlideMenu:function(){var menu=this._renderMenu('rn_SlideMenu').setStyle('right',-200);this._supplyButtonTitles(menu);this._matchExistingSelection(menu);menu.one('.rn_AdvancedMode').removeClass('rn_Hidden');this.widget.one('button.rn_MenuButton').insert(menu,'before');this.toggleLimitedFunctionality(false,'.rn_SlideMenu');return menu;},_renderMenu:function(className){return this.Y.Node.create(new EJS({text:this.getStatic().templates.menu}).render({messages:{label_advanced_mode:this.data.attrs.label_advanced_mode,label_insert_link_dialog:this.data.attrs.label_insert_link_dialog,label_help_link:this.data.attrs.label_help_link},attrs:{editor_help_url:this.data.attrs.editor_help_url},formatContent:!this.data.isTouchDevice})).addClass('rn_Hidden').addClass(className);},_supplyButtonTitles:function(menu){var platform=this.Y.UA.os==='macintosh'?'mac':'win',firefox=this.Y.UA.gecko>0;menu.all('.rn_ScreenReaderOnly').each(function(span,parent,keyLabel){parent=span.ancestor('button');if(parent){keyLabel='';this.Y.Object.some(this._keyShortcuts,function(labels,className){if(!firefox&&parent.hasClass(className)){return keyLabel=' ('+labels[platform]+') ';}});parent.setAttribute('title',span.getHTML()+keyLabel);}},this);},_matchExistingSelection:function(newMenu){var selections=this.widget.all('.rn_Menu button').hasClass('rn_Selected');if(selections.toString().indexOf('true')>-1){var buttons=newMenu.all('button');this.Y.Array.each(selections,function(selected,index){if(selected){buttons.item(index).addClass('rn_Selected');}});}}});RightNow.Widgets.RichTextInput.dialog=RightNow.Widgets.extend({dialog:null,title:null,templateName:null,constructor:function(){this.Y.augment(this,this.Y.EventTarget);this.Y.augment(this,RightNow.RequiredLabel);},show:function(){this.dialog||(this.dialog=this._createDialog());this.dialog.show();var focusFirst=this.dialog.get('contentBox').one('input,a');focusFirst&&focusFirst.focus();},hide:function(){if(this.dialog){this.dialog.hide();this._resetUIControls();}},destroy:function(){if(this.dialog){this.dialog.destroy();this.dialog=null;}},_createDialog:function(templateData,options,globalObject){var initialContent=this.templateName?this.getStatic().templates[this.templateName]:'<form>Provide a template name</form>';if(templateData){initialContent=new EJS({text:initialContent}).render(templateData);}
options=options||{};var buttons=[{text:RightNow.Interface.getMessage("CANCEL_LBL"),handler:options.exitCallback||function(){this.hide();}}];if(options&&options.buttons){buttons=options.buttons.concat(buttons);}
var dialog=new RightNow.UI.Dialog.actionDialog(this.data.attrs[this.title],this.Y.Node.create(initialContent),{cssClass:'rn_RichTextInput',buttons:buttons,exitCallback:options.exitCallback||null}),enterPressHandler=buttons[0].handler,context=null;if('fn'in enterPressHandler&&'scope'in enterPressHandler){context=enterPressHandler.scope;enterPressHandler=enterPressHandler.fn;}
RightNow.UI.Dialog.addDialogEnterKeyListener(dialog,function(name,e,target){target=e[1].target;if(target.get('tagName')==='INPUT'&&target.getAttribute('type')!=='file'){enterPressHandler.call(this,e);}},context);dialog.get('contentBox').all('form').on('submit',function(e){e.halt();});return dialog;},_resetUIControls:function(){var dialogContent=this.dialog.get('contentBox');dialogContent.all('.rn_Loading').addClass('rn_Hidden');dialogContent.all('input').set('value','');dialogContent.all('.rn_ErrorMessage').remove();return dialogContent;},_insertErrorMessage:function(message,fieldID){var form=this.dialog.get('contentBox').one('form'),error=form.one('.rn_MessageBox');if(!error){error=this.Y.Node.create(new EJS({text:this.getStatic().templates.errorMessage}).render({error:{id:fieldID,msg:message}}));form.insert(error,0);}
form.all('input[type="file"]').set('value','');error.focus();}});RightNow.Widgets.RichTextInput.insertLinkDialog=RightNow.Widgets.RichTextInput.dialog.extend({overrides:{title:'label_insert_link_dialog',templateName:'insertLinkForm',_createDialog:function(templateData){templateData||(templateData={});templateData.messages={link_text:this.data.attrs.label_link_text,link_to:this.data.attrs.label_link_to,domID:this.baseDomID};var globalObject=this.data.globalObject;var dialog=this.parent(templateData||true,{buttons:[{text:RightNow.Interface.getMessage("OK_LBL"),handler:{fn:this._onFormSubmit,scope:this}}],exitCallback:function(){this.hide();if(globalObject.editor.Y.UA.ie){globalObject.menu.hide();}
globalObject.menu.toggleLimitedFunctionality(false,'.rn_SlideMenu');}},this.data.globalObject);return dialog;},show:function(placeholderText,url){this.dialog||(this.dialog=this._createDialog());var contentBox=this.dialog.get('contentBox');contentBox.all('.rn_LinkUrlInput input').set('value',url||'');if(!url){contentBox.all('.rn_LinkTextInput input').set('value','');}
contentBox.all('.rn_ErrorMessage').remove();if(placeholderText){contentBox.one('input').set('value',placeholderText);}
this.dialog.show();contentBox.one('input,a').focus();}},_onFormSubmit:function(){var inputs=this.dialog.get('contentBox').all('input'),text=this.Y.Escape.html(inputs.item(0).get('value')),url=inputs.item(1).get('value');if(url&&RightNow.Text.isValidUrl(url)&&url.indexOf('ftp:')!==0){this.Y.later(200,this,function(){if(this.dialog)
this.dialog.hide();});if(url.indexOf('http')!==0){url='http://'+url;}
this.fire('insertLink',{text:text,url:url});}
else{this._insertErrorMessage(RightNow.Interface.getMessage("VALID_URL_REQ_MSG"),inputs.item(1).get("id"));}}});RightNow.Widgets.RichTextInput.converter=RightNow.Widgets.extend({disallowedContent:'iframe,img,table',constructor:function(){},htmlToMd:function(input){if(!input)return'';var output=this._convertEditorMarkupIntoSemanticMarkup(input);output=output.replace(/<\/ul>/g,'</ul><br>');output=new reMarked({link_list:true,gfm_del:false,gfm_tbls:false,h1_setext:false,h2_setext:false}).render(output);return output.replace(/&#x2F;/g,'/');},extractNormalizedMDFromHTML:function(content){var marker=+new Date(),converted=content.replace(/<br>/gi,marker);if(converted===content){converted=content.replace(/ &nbsp;(<div)/gi," "+marker+"$1");}
converted=this.Y.one(document.createDocumentFragment()).setHTML(converted).get('textContent');converted=converted.replace(new RegExp(marker,'g')," \n\n");return converted;},mdToHTML:function(input){if(!input)return'';input=this._prepareStyleTagsForConversionToHTML(input);input=this._escape(input);var html=(new Markdown.Converter()).makeHtml(input);html=this._removeSpacesAddedForConversion(html);return this.Y.Node.create('<div>'+html+'</div>').getHTML();},browserHTMLToMarkdown:function(input){if(!input)return'';var node=this.Y.Node.create('<div>'+input+'</div>'),advancedResultContent='',processSubNodes=function(subnode){if(subnode.get('nodeName')==='BR'){advancedResultContent+="\n\n";}
else if(subnode.get('childNodes').size()===0){advancedResultContent+=subnode.get('text');}
else{if(subnode.get('nodeName')==='DIV'||subnode.get('nodeName')==='P')
advancedResultContent+="\n\n";subnode.get('childNodes').each(processSubNodes);}};node.get('childNodes').each(processSubNodes);return advancedResultContent;},_convertEditorMarkupIntoSemanticMarkup:function(input){var output=this.Y.Node.create('<div>'+input+'</div>'),replacement;this._fixWhitespace(output);this._swapStyleTags(output);this._removeExtraSpanTags(output);output.all('div,p').each(function(node){replacement=this._fixBlockElements(node);if(replacement){node.replace(replacement);}},this);var nodeToCheck=output.get('childNodes');if((nodeToCheck=nodeToCheck.item(0))&&nodeToCheck.get('nodeName').toLowerCase()==='br'){nodeToCheck.remove();}
output.all(this.disallowedContent).remove();this._fixMultilineFormatting(output);this._fixWhitespace(output);var outputHTML=output.getHTML();if(outputHTML.search(/>(&nbsp;)+</)!==-1){outputHTML='<p>'+outputHTML+'</p>';}
return outputHTML;},_swapStyleTags:function(node){if(node.hasChildNodes()){node.get('children').each(function(child){this._swapStyleTags(child);},this);}
if(node.get('nodeName').search(/^(font|span|i|b|strong|em|a)$/i)!==-1){var replacement=this._createSemanticReplacementNode(node);if(replacement){node.replace(replacement);}}},_removeExtraSpanTags:function(node){if(node.hasChildNodes()){node.get('children').each(function(child){this._removeExtraSpanTags(child);},this);}
if(node.get('nodeName')==='SPAN'){node.replace(this.Y.Node.create(node.getHTML()));}},_fixWhitespace:function(node){if(node.hasChildNodes()){node.get('children').each(function(child){this._fixWhitespace(child);},this);}
if(node.get('nodeName').search(/^(font|span|i|b|strong|em|a)$/i)!==-1){var html=node.getHTML(),matches=html.match(/^((?:\s|&nbsp;|<br ?\/?>)*)(.*?)((?:\s|&nbsp;|<br ?\/?>)*)$/),whiteSpace=matches?matches.slice(1):[];if(!whiteSpace[0]&&!whiteSpace[2]){return;}
node.insert(whiteSpace[0].replace(/\s/g,'&nbsp;'),'before');node.setHTML(whiteSpace[1]);node.insert(whiteSpace[2].replace(/\s/g,'&nbsp;'),'after');}},_fixBlockElements:function(node){if(node.get('nodeName').toLowerCase()==='div'||node.get('nodeName').toLowerCase()==='p'){return this.Y.Node.create('<br/><span>'+node.getHTML()+'</span>');}},_fixMultilineFormatting:function(node){if(node.hasChildNodes()){node.get('children').each(function(child){this._fixMultilineFormatting(child);},this);}
if(node.get('nodeName').search(/^(strong|em)$/i)!==-1){var html=node.getHTML(),nodeName=node.get('nodeName').toLowerCase(),replacement=html.replace(/<br>/g,'</'+nodeName+'><br><'+nodeName+'>');node.replace(this.Y.Node.create('<'+nodeName+'>'+replacement+'</'+nodeName+'>'));}},_prepareStyleTagsForConversionToHTML:function(input){input=input.replace(/(\*{2}[^\*]+\*{2})+/g,function(match){return" "+match+" ";});input=input.replace(/(_{2}[^_]+_{2})+/g,function(match){return" "+match+" ";});input=input.replace(/(^|[^\*])(\*[^\*]+[^\n]\*)+/g,function(match){return match.slice(0,match.indexOf('*'))+" "+match.slice(match.indexOf('*'),match.length)+" ";});input=input.replace(/(^|[^_])(_[^_]+[^\n]_)+/g,function(match){return match.slice(0,match.indexOf('_'))+" "+match.slice(match.indexOf('_'),match.length)+" ";});return input;},_removeSpacesAddedForConversion:function(html){html=html.replace(/( <strong>)+/g,'<strong>');html=html.replace(/(<\/strong> )+/g,'</strong>');html=html.replace(/( <em>)+/g,'<em>');html=html.replace(/(<\/em> )+/g,'</em>');return html;},_createSemanticReplacementNode:function(node){if(!node.get('textContent')&&!this.Y.Lang.trim(node.get('innerText')))return'<br><br>';var replacement,domNode=this.Y.Node.getDOMNode(node);if(domNode.style.fontWeight==='bold'&&!this._isSemanticTag(domNode.tagName,'bold')){replacement=this.Y.Node.create(this._wrapHtmlWithTag(this._getReplacementContent(node),'strong'));}
if(domNode.style.fontStyle==='italic'&&!this._isSemanticTag(domNode.tagName,'italic')){replacement=(replacement)?replacement.setHTML(this._wrapHtmlWithTag(replacement.getHTML(),'em')):this.Y.Node.create(this._wrapHtmlWithTag(this._getReplacementContent(node),'em'));}
return replacement;},_getReplacementContent:function(node){return(this._isSemanticTag(node.get('tagName')))?this._getOuterHTML(node):node.getHTML();},_getOuterHTML:function(node){return node.get('outerHTML')||this.Y.Node.create('<div>').append(node).getHTML();},_wrapHtmlWithTag:function(html,tag){return'<'+tag+'>'+html+'</'+tag+'>';},_isSemanticTag:function(tag,which){if((!which||which==='italic')&&(tag==='I'||tag==='EM'))return true;if((!which||which==='bold')&&(tag==='B'||tag==='STRONG'))return true;return false;},_escapeMapping:{'`':'&#x60;','<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;',"'":'&#x27;'},_escape:function(string){var mapping=this._escapeMapping;return(string+'').replace(/[&<>"'`]/g,function(match){return mapping[match];});}});RightNow.Widgets.RichTextInput.tooltip=RightNow.Widgets.extend({element:null,xOffset:15,yOffset:10,bottomBuffer:50,constructor:function(){},_create:function(){this.element=this.Y.Node.create(new EJS({text:this.getStatic().templates.tooltip}).render({messages:{label_change_link:this.data.attrs.label_change_link,label_remove_link:this.data.attrs.label_remove_link}}));this.Y.one(this.baseSelector).append(this.element);},setContent:function(content){this.element||this._create();this.element.one('.rn_ToolTipContent').setHTML(content||'');return this;},hide:function(){this.element&&this.element.addClass('rn_Hidden');return this;},show:function(){this.element||this._create();this.element.removeClass('rn_Hidden');return this;},remove:function(){if(this.element){this.element.remove();this.element=null;}
return this;},reposition:function(reference,container){var coordinates={};this.Y.Object.each({x:['offsetLeft'],y:['offsetTop','offsetHeight']},function(prop,coordinate,value,propName,offset){propName=prop[0];value=(reference.get(propName)||parseInt(reference.getAttribute('data-'+propName),10))+container.get(propName);if(propName=prop[1]){value+=(reference.get(propName)||parseInt(reference.getAttribute('data-'+propName),10));}
offset=this[coordinate+'Offset'];if(value<offset)value=offset+10;coordinates[coordinate]=value;},this);this.element||this._create();if(coordinates.y+this.yOffset>=container.get('offsetHeight')-this.bottomBuffer){this.element.setStyles({top:'auto',bottom:(container.get('offsetHeight')-coordinates.y+this.bottomBuffer)+'px',left:(coordinates.x-this.xOffset)+'px'});}
else{this.element.setStyles({top:(coordinates.y+this.yOffset)+'px',left:(coordinates.x-this.xOffset)+'px',bottom:'auto'});}
return this;}});
RightNow.Widgets.FormSubmit=RightNow.Form.extend({overrides:{constructor:function(){this.parent();this.inputDataChanged=false;this._formButton=this.Y.one(this.baseSelector+"_Button");this._formSubmitFlag=this.Y.one(this.baseSelector+"_Submission");this._navigateToUrlFlag=false;if(!this._formButton||!this._formSubmitFlag)return;if(this._formSubmitFlag.get("checked")){this._formButton.set("disabled","true");return;}
this.on("validation:fail",this._onFormValidationFail,this).on("validation:fail",this._resetFormButton,this,false).on("validation:pass",this._onFormValidated,this).on("response",this._defaultFormSubmitResponse,this).on("response",this._resetFormButton,this).on("submitRequest",this._onButtonClick,this).on("reset",this._resetFormForSubmission,this).on("responseError",this._onErrorResponse,this).on("formUpdated",this._onFormUpdated,this);this._toggleClickListener(true);RightNow.Event.subscribe("evt_formToggleButton",function(type,args){this._toggleClickListener(args[0]);},this);RightNow.Event.subscribe("evt_formInputDataChanged",function(){this.inputDataChanged=true;},this);if(this.data.attrs.unsaved_data_dialog){var that=this;window.onbeforeunload=function(e){if(that.inputDataChanged){return"";}};}}},_onButtonClick:function(evt){this.inputDataChanged=false;if(evt&&evt.halt){evt.halt();}
if(this._requestInProgress)return false;this._toggleClickListener(false);this._removeFormErrors();if(this.Y.UA.ie&&window.external&&"AutoCompleteSaveForm"in window.external){window.external.AutoCompleteSaveForm(document.getElementById(this._parentForm));}
this._fireSubmitRequest();},_fireSubmitRequest:function(){var eo=new RightNow.Event.EventObject(this,{data:{form:this._parentForm,f_tok:this.data.js.f_tok,error_location:this._errorMessageDiv.get("id"),timeout:this.data.attrs.timeout*1000}});RightNow.Event.fire("evt_formButtonSubmitRequest",eo);this.fire("collect",eo);},_onFormValidated:function(){this._toggleLoadingIndicators(true);this.fire("send",this.getValidatedFields());},_onFormValidationFail:function(){this._displayErrorMessages(this._errorMessageDiv);RightNow.Event.fire("evt_formValidateFailure",new RightNow.Event.EventObject(this));},_clearFlashData:function(){var infoDiv=this.Y.one('.rn_MessageBox.rn_InfoMessage');if(infoDiv){var parentClass=infoDiv.ancestor().getAttribute('class');if(parentClass&&parentClass.search("rn_SmartAssistantDialog")===-1)
infoDiv.set('innerHTML','').removeClass('rn_InfoMessage');}},_absoluteOffset:function(element){var top=0;do{top+=element.get('offsetTop');element=element.get('offsetParent');}
while(element);return top;},_displayErrorMessages:function(messageArea){messageArea.addClass("rn_MessageBox").addClass("rn_ErrorMessage").removeClass("rn_Hidden");this._clearFlashData();if(!this.Y.DOM.inViewportRegion(this.Y.Node.getDOMNode(messageArea),true)){(new this.Y.Anim({node:this.Y.one(document.body),to:{scrollTop:this._absoluteOffset(messageArea)-40},duration:0.5})).run();}
var firstField=messageArea.one("a");if(firstField){firstField.focus();firstField.setAttribute('role','alert');messageArea.removeAttribute('tabIndex');}
else{messageArea.set('tabIndex',0);messageArea.setAttribute('role','alert');messageArea.focus();}
var errorLbl=messageArea.all("div").size()>1?RightNow.Interface.getMessage("ERRORS_LBL"):RightNow.Interface.getMessage("ERROR_LBL");messageArea.prepend("<h2>"+errorLbl+"</h2>");messageArea.one("h2").setAttribute('role','alert');},_defaultFormSubmitResponse:function(type,args){if(this.fire('defaultResponseHandler',args[0])){this._formSubmitResponse(type,args);}},_formSubmitResponse:function(type,args){var responseObject=args[0].data,result;if(!this._handleFormResponseFailure(responseObject)&&responseObject.result){result=responseObject.result;if(!result.sa){if(result.transaction||result.redirectOverride){return this._handleFormResponseSuccess(result);}
else{this._displayErrorDialog();}}}
args[0].data||(args[0].data={});args[0].data.form=this._parentForm;RightNow.Event.fire('evt_formButtonSubmitResponse',args[0]);},_handleFormResponseSuccess:function(result){this._formSubmitFlag.set("checked",true);if(this.data.attrs.label_on_success_banner){RightNow.UI.displayBanner(this.data.attrs.label_on_success_banner,{focusElement:this._formButton}).on('close',function(){this._confirmOnNavigate(result);},this);return;}
this._confirmOnNavigate(result);},_handleFormResponseFailure:function(responseObject){if(!responseObject){this._displayErrorDialog(RightNow.Interface.getMessage("THERE_PROB_REQ_ACTION_COULD_COMPLETED_MSG"));return true;}
if(responseObject.errors){var errorMessage="";this.Y.Array.each(responseObject.errors,function(error){errorMessage+="<div><b>"+error.externalMessage+"</b></div>";});this._errorMessageDiv.append(errorMessage);this._onFormValidationFail();return true;}
if(!responseObject.result){this._displayErrorDialog();return true;}
return false;},_navigateToUrl:function(result){var url;if(result.redirectOverride){url=result.redirectOverride+result.sessionParam;}
else if(this.data.attrs.on_success_url){var paramsToAdd='';this.Y.Object.each(result.transaction,function(details){if(details.key){paramsToAdd+='/'+details.key+'/'+details.value;}});if(paramsToAdd){url=this.data.attrs.on_success_url+paramsToAdd+result.sessionParam;}
else{var sessionValue=result.sessionParam.substr(result.sessionParam.lastIndexOf("/")+1);if(!sessionValue&&this.data.js.redirectSession)
sessionValue=this.data.js.redirectSession;url=RightNow.Url.addParameter(this.data.attrs.on_success_url,'session',sessionValue);}}
else{url=window.location+result.sessionParam;}
RightNow.Url.navigate(url+this.data.attrs.add_params_to_url);},_confirmOnNavigate:function(result){if(this.data.attrs.on_success_url!=='none'){if(this.data.attrs.label_confirm_dialog!==''){RightNow.UI.Dialog.messageDialog(this.data.attrs.label_confirm_dialog,{exitCallback:{fn:function(){this._navigateToUrl(result);},scope:this},width:'250px'});}
else{if(this.Y.Lang.trim(this.data.attrs.on_success_url)!==''){this._navigateToUrlFlag=true;}
this._navigateToUrl(result);}}},_resetFormForSubmission:function(){this._navigateToUrlFlag=false;this._removeFormErrors();this._resetFormButton();},_onFormUpdated:function(){if(this._errorMessageDiv.all('[data-field]').size()===0){this._errorMessageDiv.addClass("rn_Hidden").set("innerHTML","");}},_onErrorResponse:function(response){this._displayErrorDialog(response.suggestedErrorMessage||RightNow.Interface.getMessage("THERE_PROB_REQ_ACTION_COULD_COMPLETED_MSG"));this._resetFormButton();},_resetFormButton:function(){if(this._navigateToUrlFlag){return;}
this._toggleLoadingIndicators(false);this._toggleClickListener(true);},_removeFormErrors:function(){this._errorMessageDiv.addClass("rn_Hidden").setHTML("");},_displayErrorDialog:function(message){RightNow.UI.Dialog.messageDialog(message||RightNow.Interface.getMessage('ERROR_PAGE_PLEASE_S_TRY_MSG'),{icon:"WARN"});},_toggleLoadingIndicators:function(turnOn){this._formButton.setHTML((turnOn)?this.data.attrs.label_submitting_message:this.data.attrs.label_button).toggleClass('rn_Loading',turnOn);},_toggleClickListener:function(enable){if(this.Y.UA.ie){this._formButton.set("disabled",false);this.Y.one(this.baseSelector+" button").toggleClass("rn_IeFormButton",!enable);}
else{this._formButton.set("disabled",!enable);}
this._requestInProgress=!enable;this.Y.Event[((enable)?"attach":"detach")]("click",this._onButtonClick,this._formButton,this);}});
RightNow.Widgets.ProductCategoryInput=RightNow.Field.extend({overrides:{constructor:function(){this.parent();this.Y.augment(this,RightNow.ProductCategory);this._maxDepth=this.data.attrs.max_lvl||6;this._notRequiredDueToProductLinking=false;this.displayField=this.Y.one(this.baseSelector+"_"+this.data.js.data_type+"_Button");this.requiredLabel=this.Y.one(this.baseSelector+"_RequiredLabel");this.errorLabel=this.Y.one(this.baseSelector+"_ErrorLabel");if(this.data.js.readOnly||!this.displayField)return;RightNow.Event.subscribe("evt_resetProductCategoryMenu",this._resetProductCategoryMenu,this);this.parentForm().on('submit',this._onValidate,this);if(this.data.attrs.set_button){this.Y.one(this.baseSelector+"_"+this.data.js.data_type+"_SetButton").on("click",this._setButtonClick,this);RightNow.Widgets.formTokenRegistration(this);}
if(this.data.attrs.hint){this._hintOverlay=this._initializeHint();}
this._eo=new RightNow.Event.EventObject(this,{data:{data_type:this.data.js.data_type,hm_type:this.data.js.hm_type,linking_on:this.data.js.linkingOn,linkingProduct:0,table:this.data.js.table,cache:[],name:((this.data.js.data_type.indexOf('prod')>-1)?'prod':'cat')}});this.on('constraintChange:required_lvl',this.updateRequiredLevel,this);if(this.data.attrs.verify_permissions!=='None'&&this.data.js.readableProdcatIds.length>0){this._updatePermissionedHierData('hierData');if(this.data.js.linkingOn&&(this.data.js.data_type==='Category')&&this.data.js.hierDataNone){this._updatePermissionedHierData('hierDataNone');}
var originalHierData=this.data.js.hierData;this.initializeTreeView(this.data.js.data_type);this.Y.Object.each(this.Y.Object.keys(originalHierData),function(key){this.disableNonPermissionedNodes(originalHierData[key]);},this);}
else{this.initializeTreeView(this.data.js.data_type);}
if(this.data.attrs.required_lvl&&this.requiredLabel){this.requiredLabel.replaceClass('rn_Hidden','rn_Required');}},_initializeHint:function(){if(this.Y.Overlay){var overlay;if(this.data.attrs.always_show_hint){overlay=this._createHintElement(true);var realignHintAfterFormValidation=this.Y.bind(this._realignHint,this,1);this.parentForm().on('validation:pass',realignHintAfterFormValidation).on('validation:fail',realignHintAfterFormValidation).on('response',realignHintAfterFormValidation);}
else{overlay=this._createHintElement(false);this.displayField.on("focus",overlay.show,overlay);this.displayField.on("blur",overlay.hide,overlay);}
return overlay;}
else{var hint=this.Y.Node.create('<span class="rn_HintText"/>').setHTML(this.data.attrs.hint);this.displayField.insert(hint,'after');}}},buildPanel:function(){RightNow.ProductCategory.prototype.buildPanel.call(this);this.dropdown.on('show',this.Y.bind(this._toggleHint,this,'show'));},_resetProductCategoryMenu:function(){this.tree.resetSelectedNode();this.displaySelectedNodesAndClose(false,false);this._removeErrorMessages();},_updatePermissionedHierData:function(dataType){if(!(this.data.js[dataType]&&this.Y.Lang.isObject(this.data.js[dataType]))){throw new Error("Widget does not have this.data.js."+dataType+" attribute set, or its value is not a valid object");}
this.Y.Object.each(this.Y.Object.keys(this.data.js[dataType]),function(key){this.data.js[dataType][key]=this.groomProdcats(this.data.js[dataType][key]);},this);},displaySelectedNodesAndClose:function(focus,fireSelectionEvent){fireSelectionEvent=typeof fireSelectionEvent!=='undefined'?fireSelectionEvent:true;this._eo.data.hierChain=this.tree.get('valueChain');if(fireSelectionEvent&&this._checkSelectionErrors()){RightNow.Event.fire("evt_productCategorySelected",this._eo);}
this.fire('change',this);delete this._eo.data.hierChain;RightNow.ProductCategory.prototype.displaySelectedNodesAndClose.call(this,focus);},selectNode:function(node){this._selected=true;if((!node.expanded&&node.value&&!node.loaded)||(this.data.js.linkingOn&&this.data.js.data_type==="Product")){this.getSubLevelRequest(node);}
else{this._errorLocation="";this._checkSelectionErrors();}
RightNow.ProductCategory.prototype.selectNode.call(this,node);},getSubLevelRequest:function(expandingNode){RightNow.ProductCategory.prototype.getSubLevelRequest.call(this,expandingNode);if(this._eo.data.link_map)
delete this._eo.data.link_map;},getSubLevelRequestEventObject:function(expandingNode){this._eo.data.level=expandingNode.depth+1;this._eo.data.value=expandingNode.value;this._eo.data.label=expandingNode.label;this._eo.data.reset=false;this._requestingParent=this._eo.data.value;if(this._eo.data.linking_on){if(this.data.js.data_type==="Category"){if(expandingNode.loaded){return;}
this._eo.data.reset=(this._eo.data.value<1);}
else if(this._eo.data.value<1&&this.data.js.data_type==="Product"){this._nodeBeingExpanded=false;RightNow.Event.fire("evt_menuFilterGetResponse",new RightNow.Event.EventObject(this,{data:{reset_linked_category:true,data_type:"Category",reset:true}}));return;}}
if(this.data.js.link_map){this._eo.data.link_map=this.data.js.link_map;delete this.data.js.link_map;}
return this._eo;},getSubLevelResponse:function(type,args){var evtObj=args[0],tempNode;if((evtObj.w_id&&evtObj.w_id===this.instanceID)||(this.data.js.linkingOn&&evtObj.data.data_type==="Category"&&this.data.js.data_type===evtObj.data.data_type)){var currentRoot;if(evtObj.data.reset_linked_category&&this.data.js.data_type==="Category"){if(this.data.js.link_map)
delete this.data.js.link_map;if(!this.tree||evtObj.data.reset){this.buildTree(true);this._linkedCategorySubset=false;if(this.data.attrs.verify_permissions!=='None'&&this.data.js.readableProdcatIds.length>0){this.Y.Object.each(this.Y.Object.keys(this.data.js.hierDataNone),function(key){this.disableNonPermissionedNodes(this.data.js.hierDataNone[key]);},this);}}
currentRoot=this._requestingParent=null;if(!evtObj.data.reset){this._linkedCategorySubset=true;this.tree.clear(this.data.attrs.label_all_values);}
this.dropdown.set('triggerText',this.data.attrs.label_nothing_selected);this._errorLocation='';this._checkSelectionErrors();}
else{currentRoot=this._requestingParent;}
var hierLevel=evtObj.data.level,hierData=evtObj.data.hier_data;if(hierLevel<=this._maxDepth){if(hierLevel===this._maxDepth){hierData=this.Y.Array.map(hierData,function(node){node.hasChildren=false;return node;});}
if(this.data.attrs.verify_permissions!=='None'&&this.data.js.readableProdcatIds.length>0){hierData=this.groomProdcats(hierData);this.insertChildrenForNode(hierData,currentRoot);this.disableNonPermissionedNodes(hierData);}
else{this.insertChildrenForNode(hierData,currentRoot);}}
if(this._selected){this._errorLocation="";this._checkSelectionErrors();if(this.data.attrs.required_lvl){this._selected=false;}}
if(this._requestingParent)
this.tree.selectNodeWithValue(this._requestingParent,true);}},_setButtonClick:function()
{var hierValues=[],labelChain=this.tree.get("labelChain"),valueChain=this.tree.get("valueChain");if(valueChain.length===0||valueChain[0]===0){if(!this._errorMessageDiv){this._errorMessageDiv=this.Y.Node.create("<div class='rn_MessageBox rn_ErrorMessage'/>");this.Y.one(this.baseSelector).prepend(this._errorMessageDiv);}
this._errorMessageDiv.setHTML("<b><a href='javascript:void(0);' onclick='document.getElementById(\""+this.displayField.get('id')+"\").focus(); return false;'>"+
this.data.attrs.label_nothing_selected+"</a></b>");this._errorMessageDiv.prepend("<h2>"+RightNow.Interface.getMessage("ERROR_LBL")+"</h2>");this._errorMessageDiv.one("h2").setAttribute('role','alert');RightNow.UI.show(this._errorMessageDiv);var errorLink=this._errorMessageDiv.one('a');if(errorLink){errorLink.focus();}
return;}
if(!this._checkSelectionErrors()){return;}
RightNow.UI.hide(this._errorMessageDiv);for(var i=0;i<labelChain.length;i++)
hierValues[i]={"id":valueChain[i],"label":labelChain[i]};this.tree.resetSelectedNode();this.displaySelectedNodesAndClose(false,false);this._eo.data.hierSetData=hierValues;this._eo.data.id=hierValues[hierValues.length-1].id;this._eo.data.f_tok=this.data.js.f_tok;RightNow.Event.fire("evt_menuFilterSelectRequest",this._eo);},_onValidate:function(type,args){var formEventObject=this.createEventObject();this._errorLocation=this.lastErrorLocation=args[0].data.error_location;if(this._checkSelectionErrors()){formEventObject.data.value=this.tree.get('value')||null;if(formEventObject.data.required&&this._notRequiredDueToProductLinking){formEventObject.data.required=false;}
RightNow.Event.fire("evt_formFieldValidatePass",formEventObject);return formEventObject;}
RightNow.Event.fire("evt_formFieldValidateFailure",this._eo);return false;},_createHintElement:function(visibility){var overlay=this.Y.Node.create("<span class='rn_HintBox'/>").set('id',this.baseDomID+'_Hint').setHTML(this.data.attrs.hint);if(visibility)
overlay.addClass("rn_AlwaysVisibleHint");return new this.Y.Overlay({visible:visibility,align:{node:this.displayField,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.TR]},bodyContent:overlay,render:this.Y.one(this.baseSelector)});},_toggleHint:function(hideOrShow){if(this._hintOverlay&&this._hintOverlay[hideOrShow]&&!this.data.attrs.always_show_hint)
this._hintOverlay[hideOrShow]();},_realignHint:function(delay){if(this._hintOverlay){if(delay){this.Y.later(delay,this._hintOverlay,this._hintOverlay.align);}
else{this._hintOverlay.align();}}},swapLabel:function(container,requiredLevel,label,template){var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,requiredLevel:requiredLevel,requiredMarkLabel:RightNow.Interface.getMessage("FIELD_REQUIRED_MARK_LBL"),requiredLabel:RightNow.Interface.getMessage("REQUIRED_LBL")};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},updateRequiredLevel:function(evt,constraint){var newLevel=constraint[0].constraint;if(newLevel>this.data.attrs.max_lvl||this.data.attrs.required_lvl===newLevel)return;if(this.data.attrs.required_lvl>0&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
this.swapLabel(this.Y.one(this.baseSelector+'_Label'),newLevel,this.data.attrs.label_input,this.getStatic().templates.label);this.data.attrs.required_lvl=newLevel;if(!newLevel){this.displayField.removeClass("rn_ErrorField");this.Y.one(this.baseSelector+"_Label").removeClass("rn_ErrorLabel");}
else{this._errorLocation="";this._checkSelectionErrors();}},_checkSelectionErrors:function(){var currentNode=this.tree.getSelectedNode(),currentDepth=(currentNode?currentNode.depth:0)+1,noErrorsFound=true;this._removeErrorMessages();this._notRequiredDueToProductLinking=false;if(this.data.js.linkingOn&&this.data.js.data_type==="Category"&&this._linkedCategorySubset){if(this.tree.getNumberOfNodes()===1){this._notRequiredDueToProductLinking=true;}}
if(this.data.attrs.required_lvl||!this.userHasFullProdcatPermissions()){if(!this.tree){this.buildTree();}
if(!this._notRequiredDueToProductLinking&&(!currentNode||!currentNode.value||((!currentNode.loaded||currentNode.hasChildren)&&(currentDepth<this.data.attrs.required_lvl)))){var message=(!currentNode||!currentNode.value)?this.data.attrs.label_nothing_selected:this.data.attrs.label_required;this._displayErrorMessage(message,currentNode);noErrorsFound=false;}}
if(currentNode&&currentNode.value&&!this.checkPermissionsOnNode(currentNode.value)){this._displayErrorMessage(this.data.attrs.label_not_permissioned,currentNode);noErrorsFound=false;}
return noErrorsFound;},_removeErrorMessages:function(){this.displayField.removeClass("rn_ErrorField");if(this.errorLabel){this.errorLabel.replaceClass('rn_ErrorLabel','rn_Hidden');}
RightNow.UI.hide(this._accessibleErrorMessageDiv);this._realignHint();if(!this.data.attrs.required_lvl&&this.requiredLabel){this.requiredLabel.replaceClass('rn_Required','rn_Hidden');}},_displayErrorMessage:function(message,currentNode){this.displayField.addClass("rn_ErrorField");if(this.requiredLabel){this.requiredLabel.replaceClass('rn_Hidden','rn_Required');}
message=(message.indexOf("%s")>-1)?RightNow.Text.sprintf(message,currentNode.label):message;if(this.errorLabel){this.errorLabel.setHTML(message).replaceClass('rn_Hidden','rn_ErrorLabel');}
var label=this.data.attrs.label_error||this.data.attrs.label_input;if(this._errorLocation){var commonErrorDiv=this.Y.one('#'+this._errorLocation);if(commonErrorDiv){commonErrorDiv.append("<div data-field=\""+this._fieldName+"\"><b><a href='#' onclick='document.getElementById(\""+this.displayField.get('id')+"\").focus(); return false;'>"+
label+" - "+message+"</a></b></div> ");}}
if(this.dialog){this.dialog.addErrorMessageForValue(message,currentNode.value);}
this._realignHint();}});
RightNow.Widgets.TextInput=RightNow.Field.extend({overrides:{constructor:function(){if(this.data.js.readOnly)return;this.parent();this._seenValues=[];this.input=this.Y.one(this._inputSelector);if(!this.input)return;if(this.data.attrs.hint&&!this.data.attrs.hide_hint&&!this.data.attrs.always_show_hint){this._initializeHint();}
if(this.data.attrs.initial_focus&&this.input.focus)
this.politeFocus(this.input);if(this.data.js.mask){this._initializeMask();}
if(RightNow.Text.beginsWith(this._fieldName,"Contact.Phones.")||this._fieldName==="Contact.Address.PostalCode"){RightNow.Event.on("evt_provinceResponse",this.onProvinceChange,this);}
if(this.data.attrs.validate_on_blur){this.input.on("blur",this._blurValidate,this);if(this.data.attrs.require_validation){this.Y.Event.attach("blur",this._blurValidate,this._inputSelector+'_Validate',this,true);}}
this.input.on('change',function(){RightNow.Event.fire("evt_formInputDataChanged",null);this.fire('change',this);},this);if(this.data.attrs.require_validation){this.Y.one(this._inputSelector+'_Validate').on('change',function(){this.fire('change',this);},this);}
this._isFormSubmitting=false;this.parentForm().on("submit",this.onValidate,this).on("send",this._toggleFormSubmittingFlag,this).on("response",this._toggleFormSubmittingFlag,this);this._subscribedToFormValidation=true;this.on("constraintChange",this.constraintChange,this);RightNow.Event.on("evt_formValidateFailure",this._onValidateFailure,this);}},swapLabel:function(container,requiredness,label,template){this.Y.augment(this,RightNow.RequiredLabel);var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,required:requiredness,hint:this.data.attrs.hint};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},setLabel:function(newLabel){if(newLabel){this.Y.one(this.baseSelector+' label.rn_Label').set('text',newLabel);}},reload:function(content,readOnly){this.data.js.initialValue=content||'';this.data.readOnly=typeof readOnly==='undefined'?this.data.attrs.read_only:readOnly;content=typeof content!=='undefined'?content:'';this._subscribeToFormValidation();this.Y.one('#rn_'+this.instanceID+' textarea.rn_TextArea').set('value',content);},_subscribeToFormValidation:function(){if(this.data.readOnly||this._subscribedToFormValidation)return;this.parentForm().on('submit',this.onValidate,this);this._subscribedToFormValidation=true;},constraintChange:function(evt,constraint){constraint=constraint[0];if(constraint.required===this.data.attrs.required)return;this.toggleErrorIndicator(false);if(this.data.attrs.require_validation){this.toggleErrorIndicator(false,this.Y.one(this._inputSelector+'_Validate'),this.Y.one(this._inputSelector+'_LabelValidate'));}
if(this.data.attrs.required&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
if(this.data.attrs.label_input){this.swapLabel(this.Y.one(this.baseSelector+'_LabelContainer'),constraint.required,this.data.attrs.label_input,this.getStatic().templates.label);}
if(this.data.attrs.require_validation){var labelValidate=RightNow.Text.sprintf(this.data.attrs.label_validation,this.data.attrs.label_input);this.swapLabel(this.Y.one(this.baseSelector+'_LabelValidateContainer'),constraint.required,labelValidate,this.getStatic().templates.labelValidate);}
this.data.attrs.required=constraint.required;},getVerificationValue:function(){return this._getTextFieldValue(this.Y.one(this._inputSelector+'_Validate'));},onValidate:function(type,args){var eventObject=this.createEventObject(),errors=[];this.toggleErrorIndicator(false);if(!this.validate(errors)||(this.data.attrs.require_validation&&!this._validateVerifyField(errors))||!this._compareInputToMask(true)){this.lastErrorLocation=args[0].data.error_location;this._displayError(errors,this.lastErrorLocation);RightNow.Event.fire("evt_formFieldValidateFailure",eventObject);return false;}
RightNow.Event.fire("evt_formFieldValidatePass",eventObject);this._seenValues.push(this._massageValueForModificationCheck(eventObject.data.value));return eventObject;},_displayError:function(errors,errorLocation){var commonErrorDiv=this.Y.one("#"+errorLocation),verifyField;if(commonErrorDiv){for(var i=0,errorString="",message,id=this.input.get("id");i<errors.length;i++){message=errors[i];if(typeof message==="object"&&message!==null&&message.id&&message.message){id=verifyField=message.id;message=message.message;}
else if(this.data.attrs.name==='SocialQuestion.Body'||this.data.attrs.name==='SocialQuestionComment.Body'){message=(message.indexOf("%s")>-1)?RightNow.Text.sprintf(message,this.data.attrs.label_input):message;}
else{message=(message.indexOf("%s")>-1)?RightNow.Text.sprintf(message,this.data.attrs.label_input):this.data.attrs.label_input+": "+message;}
errorString+="<div data-field=\""+this._fieldName+"\"><b><a href='javascript:void(0);' onclick='document.getElementById(\""+id+"\").focus(); return false;'>"+message+"</a></b></div> ";}
commonErrorDiv.append(errorString);}
if(!verifyField||errors.length>1){this.toggleErrorIndicator(true);}},toggleErrorIndicator:function(showOrHide,fieldToHighlight,labelToHighlight){var method=((showOrHide)?"addClass":"removeClass");if(fieldToHighlight&&labelToHighlight){fieldToHighlight[method]("rn_ErrorField");labelToHighlight[method]("rn_ErrorLabel");}
else{this.input[method]("rn_ErrorField");this.Y.one(this.baseSelector+"_Label")[method]("rn_ErrorLabel");}},_toggleFormSubmittingFlag:function(event){this._isFormSubmitting=(event==='send');},_blurValidate:function(event,validateVerifyField){if(this._dialogShowing)
return;this._trimField();if(validateVerifyField){this._validateVerifyField();}
else{var valid=this.validate();if(valid){if(this._fieldName==="Contact.Login"||this.isCommonEmailType()){this._checkExistingAccount();}}
this.toggleErrorIndicator(!valid);}},_validateVerifyField:function(errors){errors=errors||[];var valid=true,verifyField=this.Y.one(this._inputSelector+'_Validate'),verifyLabel=this.Y.one(this._inputSelector+'_LabelValidate');if(verifyField&&this.data.attrs.require_validation){if(this.getVerificationValue()!==this.getValue()){errors.push({message:RightNow.Text.sprintf(this.data.attrs.label_validation_incorrect,this.data.attrs.label_input),id:verifyField.get("id")});valid=false;}
this.toggleErrorIndicator(!valid,verifyField,verifyLabel);}
return valid;},_checkExistingAccount:function(){var massagedNewValue=this._massageValueForModificationCheck(this._value);if(this._value===""||this._seenValues.indexOf(massagedNewValue)!==-1||(this.data.js.previousValue&&this._value.replace('&','&amp;').replace("'",'&#039;')===this.data.js.previousValue))
return;this._seenValues.push(massagedNewValue);var eventObject=new RightNow.Event.EventObject(this,{data:{contactToken:this.data.js.contactToken}});if(this.isCommonEmailType())
eventObject.data.email=this._value;else if(this._fieldName==="Contact.Login")
eventObject.data.login=this._value;if(RightNow.Event.fire("evt_accountExistsRequest",eventObject)){RightNow.Ajax.makeRequest(this.data.attrs.existing_contact_check_ajax,eventObject.data,{successHandler:this._onAccountExistsResponse,scope:this,data:eventObject,json:true});}},_massageValueForModificationCheck:function(value){if(this.Y.Lang.isUndefined(value)||value===null||value===""){return"";}
if(this.isCommonEmailType()){value=value.toLowerCase();}
return value;},_onAccountExistsResponse:function(response,originalEventObject){if(RightNow.Event.fire("evt_accountExistsResponse",response,originalEventObject)){if(response!==false&&this._isFormSubmitting===false){this.toggleErrorIndicator(true);var warnDialog,handleOK=function(){warnDialog.hide();this._dialogShowing=false;this.input.focus();};warnDialog=RightNow.UI.Dialog.messageDialog(response.message,{icon:"WARN",exitCallback:{fn:handleOK,scope:this}});this._dialogShowing=true;warnDialog.show();}}},onProvinceChange:function(type,args)
{var eventObj=args[0],resetMask=false;if(!eventObj.ProvincesLength)
this.data.js.mask="";if(this._fieldName==="Contact.Address.PostalCode"&&"PostalMask"in eventObj)
{resetMask=true;this.data.js.mask=eventObj.PostalMask;}
else if("PhoneMask"in eventObj)
{resetMask=true;this.data.js.mask=eventObj.PhoneMask;}
if(this._maskNodeOnPage)
this._maskNodeOnPage.remove();if(resetMask&&this.data.js.mask)
this._initializeMask();},_initializeMask:function()
{this.input.on("keyup",this._compareInputToMask,this);this.input.on("blur",this._hideMaskMessage,this);this.input.on("focus",this._compareInputToMask,this);this.data.js.mask=this._createMaskArray(this.data.js.mask);var overlay=this.Y.Node.create("<div class='rn_MaskOverlay'>");if(this.Y.Overlay){this._maskNode=new this.Y.Overlay({bodyContent:overlay,visible:false,zIndex:1,align:{node:this.input,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.BL]}});this._maskNode.render(this.baseSelector);}
else{this._maskNode=overlay.addClass("rn_Hidden");this.input.insert(this._maskNode,"after");}
if(this.data.attrs.always_show_mask){var maskMessageOnPage=this._getSimpleMaskString(),widgetContainer=this.Y.one(this.baseSelector);if(maskMessageOnPage&&widgetContainer){var messageNode=this.Y.Node.create("<div class='rn_Mask'>"+RightNow.Interface.getMessage("EXPECTED_INPUT_LBL")+": "+maskMessageOnPage+"</div>");if(widgetContainer.get("lastChild").hasClass("rn_HintText")){messageNode.addClass("rn_MaskBuffer");}
this._maskNodeOnPage=messageNode;widgetContainer.append(messageNode);}}},_createMaskArray:function(mask)
{if(!mask)return;var maskArray=[];for(var i=0,j=0,size=mask.length/2;i<size;i++)
{maskArray[i]=mask.substring(j,j+2);j+=2;}
return maskArray;},_getSimpleMaskString:function(){if(!this.data.js.mask)return"";var maskString="";for(var i=0;i<this.data.js.mask.length;i++){switch(this.data.js.mask[i].charAt(0)){case"F":maskString+=this.data.js.mask[i].charAt(1);break;case"U":switch(this.data.js.mask[i].charAt(1)){case"#":maskString+="#";break;case"A":case"C":maskString+="@";break;case"L":maskString+="A";break;}
break;case"L":switch(this.data.js.mask[i].charAt(1)){case"#":maskString+="#";break;case"A":case"C":maskString+="@";break;case"L":maskString+="a";break;}
break;case"M":switch(this.data.js.mask[i].charAt(1)){case"#":maskString+="#";break;case"A":case"C":case"L":maskString+="@";break;}
break;}}
return maskString;},_compareInputToMask:function(submitting){if(!this.data.js.mask)return true;var error=[],value=this.input.get("value");if(value.length>0){for(var i=0,tempRegExVal;i<value.length;i++){if(i<this.data.js.mask.length){tempRegExVal="";switch(this.data.js.mask[i].charAt(0)){case'F':if(value.charAt(i)!==this.data.js.mask[i].charAt(1))
error.push([i,this.data.js.mask[i]]);break;case'U':switch(this.data.js.mask[i].charAt(1)){case'#':tempRegExVal=/^[0-9]+$/;break;case'A':tempRegExVal=/^[0-9A-Z]+$/;break;case'L':tempRegExVal=/^[A-Z]+$/;break;case'C':tempRegExVal=/^[^a-z]+$/;break;}
break;case'L':switch(this.data.js.mask[i].charAt(1)){case'#':tempRegExVal=/^[0-9]+$/;break;case'A':tempRegExVal=/^[0-9a-z]+$/;break;case'L':tempRegExVal=/^[a-z]+$/;break;case'C':tempRegExVal=/^[^A-Z]+$/;break;}
break;case'M':switch(this.data.js.mask[i].charAt(1)){case'#':tempRegExVal=/^[0-9]+$/;break;case'A':tempRegExVal=/^[0-9a-zA-Z]+$/;break;case'L':tempRegExVal=/^[a-zA-Z]+$/;break;}
break;}
if((tempRegExVal!=="")&&!(tempRegExVal.test(value.charAt(i))))
error.push([i,this.data.js.mask[i]]);}
else
{error.push([i,"LEN"]);}}
if((!error.length)&&(value.length<this.data.js.mask.length)&&(!this.data.attrs.always_show_mask||submitting===true))
{for(i=value.length;i<this.data.js.mask.length;i++)
error.push([i,"MISS"]);}
if(error.length>0)
{this._showMaskMessage(error);if(submitting===true)
this._reportError(RightNow.Interface.getMessage("PCT_S_DIDNT_MATCH_EXPECTED_INPUT_LBL"));return false;}
this._showMaskMessage(null);return true;}
if(!this.data.attrs.always_show_mask&&submitting!==true)
this._showMaskMessage(error);return true;},_showMaskMessage:function(error){if(error===null){this._hideMaskMessage();}
else{if(!this._showMaskMessage._maskMessages){this._showMaskMessage._maskMessages={"F":RightNow.Interface.getMessage('WAITING_FOR_CHARACTER_LBL'),"U#":RightNow.Interface.getMessage('PLEASE_TYPE_A_NUMBER_MSG'),"L#":RightNow.Interface.getMessage('PLEASE_TYPE_A_NUMBER_MSG'),"M#":RightNow.Interface.getMessage('PLEASE_TYPE_A_NUMBER_MSG'),"UA":RightNow.Interface.getMessage('PLEASE_ENTER_UPPERCASE_LETTER_MSG'),"UL":RightNow.Interface.getMessage('PLEASE_ENTER_AN_UPPERCASE_LETTER_MSG'),"UC":RightNow.Interface.getMessage('PLS_ENTER_UPPERCASE_LETTER_SPECIAL_MSG'),"LA":RightNow.Interface.getMessage('PLEASE_ENTER_LOWERCASE_LETTER_MSG'),"LL":RightNow.Interface.getMessage('PLEASE_ENTER_A_LOWERCASE_LETTER_MSG'),"LC":RightNow.Interface.getMessage('PLS_ENTER_LOWERCASE_LETTER_SPECIAL_MSG'),"MA":RightNow.Interface.getMessage('PLEASE_ENTER_A_LETTER_OR_A_NUMBER_MSG'),"ML":RightNow.Interface.getMessage('PLEASE_ENTER_A_LETTER_MSG'),"MC":RightNow.Interface.getMessage('PLEASE_ENTER_LETTER_SPECIAL_CHAR_MSG'),"LEN":RightNow.Interface.getMessage('THE_INPUT_IS_TOO_LONG_MSG'),"MISS":RightNow.Interface.getMessage('THE_INPUT_IS_TOO_SHORT_MSG')};}
var message="",sampleMaskString=this._getSimpleMaskString().split("");for(var i=0,type;i<error.length;i++){type=error[i][1];if(type.charAt(0)==="F"){message+="<b>"+RightNow.Interface.getMessage('CHARACTER_LBL')+" "+(error[i][0]+1)+"</b> "+RightNow.Interface.getMessage('WAITING_FOR_CHARACTER_LBL')+type.charAt(1)+" ' <br>";sampleMaskString[(error[i][0])]="<span style='color:#E80000;'>"+sampleMaskString[(error[i][0])]+"</span>";}
else{if(type!=="MISS"){message+="<b>"+RightNow.Interface.getMessage('CHARACTER_LBL')+" "+(error[i][0]+1)+"</b> "+this._showMaskMessage._maskMessages[type]+"<br>";if(type!=="LEN"){sampleMaskString[(error[i][0])]="<span style='color:#E80000;'>"+sampleMaskString[(error[i][0])]+"</span>";}
else{break;}}}}
sampleMaskString=sampleMaskString.join("");this._setMaskMessage(RightNow.Interface.getMessage('EXPECTED_INPUT_LBL')+": "+sampleMaskString+"<br>"+message);this._showMask();}},_setMaskMessage:function(message)
{var overlayContent=this._maskNode.get('bodyContent');if(overlayContent){overlayContent.set('innerHTML',message);}
else{this._maskNode.set('innerHTML',message);}},_showMask:function()
{if(this.Y.Overlay)
this._maskNode.show();else
RightNow.UI.show(this._maskNode);},_hideMaskMessage:function()
{if(this.Y.Overlay&&this._maskNode.get("visible")!==false)
this._maskNode.hide();else
RightNow.UI.hide(this._maskNode);},_onValidateFailure:function()
{if(this.data.js.mask&&this._maskNode.align&&this.Y.Overlay&&this._maskNode.get("visible")!==false){this._maskNode.align();}}});
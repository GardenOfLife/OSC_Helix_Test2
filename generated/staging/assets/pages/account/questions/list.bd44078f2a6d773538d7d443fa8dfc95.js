
(function(){function r(f){function h(a,b){b=b?RightNow.Url.convertToSegment(RightNow.Url.convertToArray(1,b)):"";d.add({state:a},{url:p.getCurrentPage()+b})}function k(a){return function(){g||a.apply(this,arguments)}}var c={},e={},a={},b="",g=!1,d=new f.HistoryHTML5;d.on("change",function(a){var b;a.src===f.HistoryHTML5.SRC_POPSTATE&&(a=a.changed.state||a.changed[RightNow.Event.browserHistoryManagementKey],b=m.get(),g=!0,a?f.Object.each(a.newVal,function(a){q.ajaxCallback(a.response,a.data)}):f.Object.each(b,function(a){a.fire("reset").fire("send")}),g=!1)});return{enabled:!0,setCache:function(a,b,g){c[a]||(c[a]={});c[a][b]=g},checkCache:function(a,b){return c[a]?c[a][b]:null},restoreCache:k(function(c){if(f.Object.isEmpty(e)){var g=Object.keys(a)[0];g&&a[g]&&(a={newTransactionID:c});h(a,b+=c.friendly)}b=""}),addRequest:k(function(c,g){f.Object.isEmpty(e)&&(q.searchesPerformed++,a={},b="");e[g]=c}),addResponse:k(function(c,g){var d=e[g];if(d){var k=b+=d.friendly,d=f.merge(d,c);a[g]=d;delete e[g];f.Object.isEmpty(e)&&h(a,k)}}),clearCache:function(a){c[a]=null},doesCacheExist:function(a){return c[a]?!0:!1}}}var l,q,p,m;"pushState"in window.history?YUI().use("history-html5",function(f){l=r(f)}):l={enabled:!1};q=function(){function f(a,b,c){var d="undefined"===typeof c;a&&!d&&l.addResponse({response:a,data:b},c);l.setCache(b.searchSource,b.cacheKey,a);c=m.get(b.searchSource);d&&(c.once("send",function(){return!1}).fire("send",b.allFilters),a.fromHistoryManager=!0);c.fire("response",new RightNow.Event.EventObject(null,{data:a,filters:b.allFilters}))}function h(a,b,c,d){a=RightNow.Ajax.makeRequest(a,b,{successHandler:f,failureHandler:function(a){var b=RightNow.Interface.getMessage("THERE_PROB_REQ_ACTION_COULD_COMPLETED_MSG");403===a.status&&void 0!==a.responseText&&(b=a.responseText);RightNow.UI.Dialog.messageDialog(b,{icon:"WARN",exitCallback:function(){window.location.reload(!0)}})},json:!0,data:c,timeout:1E4});l.addRequest(d,a.id+"")}function k(a,b,c,d){var f=["keyword"].concat(a.filters||[]),s=f.length,h,k,l={};c=RightNow.Lang.cloneObject(c);a.params&&(c=e.mix(c,a.params));if(b&&b.allFilters)for(a=0;a<s;a++)h=f[a],(k=b.allFilters[h])&&k.filters&&k.filters.data&&!c[h]&&("keyword"!==h||d||(h="kw"),l[h]=c[h]=k.filters.data);c.page&&!l.page&&(l.page=c.page);return{filtersToInclude:l,params:c}}function c(a,b){b&&1!==b||(a=RightNow.Url.addParameter(a,"search","1"));return a}var e=YUI();return{searchesPerformed:0,go:function(a,b,g,d,e){if("report"===d.type){if("undefined"===typeof b)throw Error("No search filters have been defined for report "+d.id);RightNow.Event.fire("evt_searchRequest",new RightNow.Event.EventObject(this,{filters:b}));if(!l.enabled||!0===a.newPage||a.reportPage&&!RightNow.Url.isSameUrl(a.reportPage))if(g=RightNow.Url,d=a.reportPage||p.getCurrentPage(),e=a.target||"_self",!a.page&&b.allFilters.page&&(a.page=1,b.allFilters.page=1),d=g.convertSearchFiltersToParms(d,b.allFilters,0),d=g.addParameter(d,"session",g.getSession()),d=c(d,b.allFilters.page),a.popupWindow){b=window.screenX||window.screenLeft;g=window.screenY||window.screenTop;var f;f=b+document.body.clientWidth;e=screen.width*a.width/100;a=screen.height*a.height/100;f=b>screen.width-f?b-e-15:f+15;var n=window.screenY?window.screenY:window.screenTop;0>f&&(f=b+100);0>n&&(n=g+100);window.open(d,"_blank","scrollbars=1,resizable=1,left="+f+",top="+n+",width="+e+"px,height="+a+"px")}else window.open(d,e);else a.page?delete b.allFilters.search:b.allFilters.page=1,a=d.id,d=d.type+d.id,g=p.buildReportRequestParameters(a,b.allFilters,b.format,b.token,0),e=RightNow.Url.convertSearchFiltersToParms("",b.allFilters,""),f=g.sf,1===f.page&&(f.search=1),f=RightNow.JSON.stringify(f),n=l.checkCache(d,f),e={friendly:e,response:n,data:{allFilters:b,cacheKey:f,key:d}},n?(l.restoreCache(e),m.get(d).fire("response",new RightNow.Event.EventObject(null,{data:n,filters:b}))):h("/ci/ajaxRequest/getReportData",{filters:f,report_id:a,r_tok:g.token,format:RightNow.JSON.stringify(g.fmt)},{searchSource:d,allFilters:b,cacheKey:f},e)}else if(g&&"object"===typeof g&&d.id)if(RightNow.Event.fire("evt_searchRequest",new RightNow.Event.EventObject(this,{filters:b})),l.enabled&&!0!==a.newPage){a=e.endpoint;b=k(e,b,g,!0);g=b.filtersToInclude;b=b.params;if(!a)throw Error("An endpoint hasn't been specified");d=d.type+d.id;e=RightNow.JSON.stringify(b);f=l.checkCache(d,e);g={key:d,friendly:RightNow.Url.convertToSegment(g)};f?(l.restoreCache(g),m.get(d).fire("response",new RightNow.Event.EventObject(null,{data:f,filters:b}))):h(a,b,{searchSource:d,allFilters:b,cacheKey:e},g)}else a=RightNow.Url,d=p.getCurrentPage(),b=k(e,b,g,!1).filtersToInclude,d+=a.convertToSegment(b),d=a.addParameter(d,"session",a.getSession()),d=c(d,b.page),window.open(d,"_self")},ajaxCallback:f}}();p={buildReportRequestParameters:function(f,h,k,c,e){var a=RightNow.Lang.cloneObject(h),b;for(b in a)a.hasOwnProperty(b)&&(a[b].filters&&(a[b].filters.report_id=parseInt(f,10)),a[b].data&&delete a[b].data);k||(k={});k.urlParms=RightNow.Url.buildUrlLinkString(h,k.parmList);return{c:e,id:f,sf:a,fmt:k,token:c}},getCurrentPage:function(){var f=window.location,h=f.pathname,f=f.origin||f.protocol+"//"+f.host;return"/"===h||"/app"===h||"/app/"===h?f+"/app/"+RightNow.Interface.getConfig("CP_HOME_URL"):h.split("/").slice(0,RightNow.Url.getParameterSegment()-1).join("/")}};m=function(){function f(c){if(!c||!c.length||2>c.length)throw Error("You're doing it wrong");this.sources=c;this.multiple=!0}var h={},k=RightNow.EventProvider.extend({overrides:{constructor:function(c,e){this.parent();this.Y=c;delete this.data;delete this.baseDomID;delete this.baseSelector;this.searchSource=e;this.instanceID=e.id;this._addEventHandler("search",{pre:function(a){this._params||(this._params={});a instanceof RightNow.Event.EventObject&&(this._originalEventObject=RightNow.Lang.cloneObject(a),this._collectSearchFilters(a),this._params.newPage=a.filters.newPage)},during:function(a){a instanceof RightNow.Event.EventObject&&this._collectSearchFilters(a)},post:function(){var a,b;if(this._excludedFilters)for(a=0;a<this._excludedFilters.length;a++)b=this._excludedFilters[a],this._respondingFilters&&!this._respondingFilters[b]&&(b=this._filters.allFilters[b])&&b.filters&&(b.filters.data[0]?b.filters.data[0]=null:b.filters.data=null);this.fire("send",this._filters,this._params)}})._addEventHandler("send",{pre:function(a){this._originalEventObject||(this._originalEventObject={filters:{page:1,newPage:!1}});this._eventCancelled=!1},during:function(a){!1===a&&(this._eventCancelled=!0)},post:function(a){this._eventCancelled||(this._excludedFilters=[],q.go(this._originalEventObject.filters,this._filters,this._params,this.searchSource,this))}})._addEventHandler("setInitialFilters",{post:function(a){this._setInitialFilters(a)}})._addEventHandler("appendFilter",{post:function(a){this._originalEventObject||(this._originalEventObject=RightNow.Lang.cloneObject(a));this._mergeFilters(a)}})._addEventHandler("excludeFilterFromNextSearch",{post:function(a){this._excludedFilters||(this._excludedFilters=[]);this._excludedFilters.push(a.data.name)}})._addEventHandler("reset").on("reset",function(){this._filters=RightNow.Lang.cloneObject(this._initialFilters);if(this._params&&this._filters&&this._filters.allFilters){var a=this._filters.allFilters;this._initialParams&&(this._params=RightNow.Lang.cloneObject(this._initialParams));this.Y.Object.each(this._params,function(b,c,d){a[c]&&a[c].filters&&"data"in a[c].filters&&(d[c]=a[c].filters.data)})}},this)}},clearCache:function(){l.enabled&&l.clearCache(this.searchSource.type+this.searchSource.id)},doesCacheExist:function(){return l.enabled?l.doesCacheExist(this.searchSource.type+this.searchSource.id):!1},_setFilters:function(c){this._filters=c},_setInitialFilters:function(c){c instanceof RightNow.Event.EventObject&&(this.Y.Object.isEmpty(c.filters)||(this._filters=c.filters,this._initialFilters=RightNow.Lang.cloneObject(c.filters)),this.Y.Object.isEmpty(c.data)||(this._params=c.data,this._initialParams=RightNow.Lang.cloneObject(c.data)))},_mergeFilters:function(c){this._filters.allFilters=this.Y.mix(this._filters.allFilters,c.filters,!0,null,0,!0)},_collectSearchFilters:function(c){c=new RightNow.Event.EventObject({instanceID:c.w_id},RightNow.Lang.cloneObject(c));c.filters.searchName?(this._respondingFilters||(this._respondingFilters={}),this._respondingFilters[c.filters.searchName]=!0,this._filters||(this._filters={}),this._filters.allFilters||(this._filters.allFilters={}),this._filters.allFilters[c.filters.searchName]=c):"generic"===this.searchSource.type&&(this._params=this.Y.mix(this._params||{},c.data,!0))}});f.prototype={_invoke:function(c,e,a,b){for(var f=0;f<this.sources.length;f++)this.sources[f][c](e,a,b);return this},on:function(c,e,a){return this._invoke("on",c,e,a)},fire:function(c,e,a){return this._invoke("fire",c,e,a)}};return{multipleSourcesWrapper:f,get:function(c){return"undefined"===typeof c?h:h[c]},add:function(c,e){if(c&&e instanceof k&&!h[c])return h[c]=e},getSearchSources:function(c,e){var a=c?(c+"").split(","):[],b=e?(e+"").split(","):[],f=[],d;for(d=0;d<a.length;d++)f.push({type:"report",id:a[d]});for(d=0;d<b.length;d++)f.push({type:"generic",id:b[d]});return{report:a,source:b,keys:f}},searchSource:k,findNamedSource:function(c,e){if(e){this.findNamedSource.findSource||(this.findNamedSource.findSource=function(a,b){if(b.multiple)for(var c=0;c<b.sources.length;c++){if(b.sources[c].instanceID===a)return b.sources[c]}else if(b.instanceID===a)return b});this.findNamedSource.warning||(this.findNamedSource.warning=function(a){RightNow.UI.DevelopmentHeader&&RightNow.UI.DevelopmentHeader.addJavascriptWarning(RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_D_SRCH_SRC_ID_RPT_ID_SRC_ID_LBL"),a))});var a=[],b=[];if("string"===typeof e||"number"===typeof e){e=(e+"").split(",");if(1<e.length){for(var g=0,d;g<e.length;g++)(d=this.findNamedSource.findSource(e[g],c))?a.push(d):b.push(e[g]);b.length&&this.findNamedSource.warning(b.join(", "));if(a.length)return 1<a.length?new f(a):a[0]}else if(a=this.findNamedSource.findSource(e[0],c))return a;!b.length&&this.findNamedSource.warning(e[0]);return c}if("object"===typeof e){for(g in e)e.hasOwnProperty(g)&&((d=this.findNamedSource.findSource(g,c))?(d=YUI().mix(d,e[g]),a.push(d)):b.push(g));b.length&&this.findNamedSource.warning(b.join(", "));if(a.length)return 1<a.length?new f(a):a[0]}}if(!c)throw Error("The widget extending from RightNow.SearchFilter doesn't have report_id or source_id attributes.");return c}}}();RightNow.SearchFilter=RightNow.Widgets.extend({constructor:function(){for(var f=m.getSearchSources(this.data.attrs.report_id,this.data.attrs.source_id),h=[],k=0,c,e;k<f.keys.length;k++)e=f.keys[k],c=m.get(e.type+e.id),c||(c=new m.searchSource(this.Y,e),m.add(e.type+e.id,c)),h.push(c);1<h.length&&(c=new m.multipleSourcesWrapper(h));this.searchSource=function(a){return m.findNamedSource(c,a)}}});RightNow.ResultsDisplay=RightNow.SearchFilter})();
RightNow.ProductCategory=RightNow.EventProvider.extend({initializeTreeView:function(a){this.dataType=a;this.displayField||(this.displayField=this.Y.one(this.baseSelector+"_"+this.dataType+"_Button"));this.buildPanel();this.Y.one(this.baseSelector+"_LinksTrigger").on("click",this.showAccessibleView,this);RightNow.Event.on("evt_accessibleTreeViewGetResponse",this.getAccessibleTreeViewResponse,this);RightNow.Event.on("evt_menuFilterGetResponse",this.getSubLevelResponse,this);this.data.js.hierData&&this.data.js.hierData[0]&&this.data.js.hierData[0].length&&this.buildTree()},buildPanel:function(){this.dropdown=new this.Y.RightNowTreeViewDropdown({srcNode:this.Y.one(this.baseSelector+"_TreeContainer").removeClass("rn_Hidden"),render:this.Y.one(this.baseSelector),trigger:this.displayField,visible:!1});this.dropdown.once("show",this.Y.bind(this.buildTree,this,!1));this.dropdown.on("show",function(){this.tree.focusOnSelectedNode()},this)},buildTree:function(a){if(!this.tree||a){this.tree&&this.tree.clear();this.data.js.linkingOn&&"Category"===this.dataType&&this.data.js.link_map[0]&&(this.data.js.hierData=this.data.js.link_map);this.tree=new this.Y.RightNowTreeView({hierarchyData:this.data.js.hierData,contentBox:this.Y.one(this.baseSelector+"_Tree").setStyles({"overflow-y":"auto",display:"block"})});this.tree.render();this.data.js.hierData&&this.data.js.hierDataNone&&delete this.data.js.hierData;this.tree.on("enterKey",this.selectNode,this);this.tree.on("dynamicNodeExpand",this.getSubLevelRequest,this);if(this.data.attrs.show_confirm_button_in_dialog)this.dropdown.set("confirmButton",this.Y.one(this.baseSelector+"_"+this.data.js.data_type+"_ConfirmButton")),this.dropdown.set("cancelButton",this.Y.one(this.baseSelector+"_"+this.data.js.data_type+"_CancelButton")),this.dropdown.on("confirm",function(){this.selectNode(this.tree.getFocusedNode())},this),this.Y.one(this.baseSelector+"_TreeContainer").setStyle("display","block");else this.tree.on("click",this.selectNode,this);this.tree.get("value")&&this.displaySelectedNodesAndClose(!1);this.dropdown.set("treeView",this.tree)}},pruneNonPermissionedAccessibleNodes:function(a){this.checkIdsAreValid("readableProdcatIds");if(0===this.data.js.readableProdcatIds.length)return a;var b=[];this.Y.Array.each(a,function(a){(this.checkPermissionsOnNode(a[1])||this.hasPermissionedAccessibleChildren(a))&&b.push(a)},this);return b},hasPermissionedAccessibleChildren:function(a){return this.checkForPermissionedChildren(a[1],a.level+1)},hasPermissionedChildren:function(a,b){return a.hasChildren?this.checkForPermissionedChildren(a.id,b):!1},checkForPermissionedChildren:function(a,b){if(!(this.data&&this.data.js&&this.data.js.readableProdcatIds&&this.Y.Lang.isArray(this.data.js.readableProdcatIds)))throw Error("Widget does not have this.data.js.readableProdcatIds attribute set, or its value is not an array");if(0===this.data.js.readableProdcatIds.length)return!0;var c="Level"+b;return this.Y.Array.some(this.data.js.permissionedProdcatList,function(b){if(b[c]===a&&b.ID!==a)return!0},this)},checkPermissionsOnNode:function(a){var b=this.data.js.permissionedProdcatIds&&this.Y.Lang.isArray(this.data.js.permissionedProdcatIds),c=this.data.js.readableProdcatIds&&this.Y.Lang.isArray(this.data.js.readableProdcatIds);if(!b&&!c)throw Error("Widget has neither this.data.js.readableProdcatIds or this.data.js.permissionedProdcatIds set, or their values are not an array.");return b&&0===this.data.js.permissionedProdcatIds.length||c&&0===this.data.js.readableProdcatIds.length?!0:b?this.isPermissionedNode(a):this.isReadableNode(a)},isPermissionedNode:function(a){return this.userHasFullProdcatPermissions()?!0:-1!==this.Y.Array.indexOf(this.data.js.permissionedProdcatIds,parseInt(a,10))},userHasFullProdcatPermissions:function(){this.checkIdsAreValid("permissionedProdcatIds");return"None"===this.data.attrs.verify_permissions||0===this.data.js.permissionedProdcatIds.length},isReadableNode:function(a){this.checkIdsAreValid("readableProdcatIds");return 0===this.data.js.readableProdcatIds.length?!0:-1!==this.Y.Array.indexOf(this.data.js.readableProdcatIds,parseInt(a,10))},disableNonPermissionedAccessibleNodes:function(a){this.checkIdsAreValid("readableProdcatIds");if(0!==this.data.js.readableProdcatIds.length&&this.data.attrs.label_selection_not_valid){var b;this.Y.Array.each(a,function(a){this.checkPermissionsOnNode(a[1])||(b=this.Y.one(this.baseSelector+"_AccessibleLink_"+a[1]),b.setHTML(RightNow.Text.sprintf(this.data.attrs.label_selection_not_valid,b.getHTML())))},this)}},disableNonPermissionedNodes:function(a){this.checkIdsAreValid("readableProdcatIds");0!==this.data.js.readableProdcatIds.length&&this.Y.Array.each(a,function(a){this.checkPermissionsOnNode(a.id)||this.Y.one("#ygtvlabelel"+this.tree.getNodeByValue(a.id).index).addClass("rn_Disabled")},this)},onAccessibleLinkClick:function(a){var b=a.valueChain[a.valueChain.length-1];this.tree.expandAndCreateNodes(a.valueChain);this.checkPermissionsOnNode(b)&&this.dialog.hide()},showAccessibleView:function(a){a.halt();this._eo||(this._eo=new RightNow.Event.EventObject(this));"Category"===this.dataType&&this.data.js.linkingOn&&(this._eo.data.linkingProduct=RightNow.UI.Form.currentProduct);this.dialog?this.displayAccessibleDialog():RightNow.Event.fire("evt_accessibleTreeViewRequest",this._eo)},getAccessibleTreeViewResponse:function(a,b){b=b[0];if(b.w_id===this._eo.w_id&&b.data.hm_type===this._eo.data.hm_type){var c=b.data.accessibleLinks;if("prod_chain"in c){c=[];delete b.data.accessibleLinks.prod_chain;for(var d in b.data.accessibleLinks)c.push(b.data.accessibleLinks[d])}c.unshift({0:this.data.attrs.label_all_values,1:0,hier_list:0,level:0});c=this.pruneNonPermissionedAccessibleNodes(c);this.createAccessibleDialog(c);this.buildTree();this.displayAccessibleDialog();this.disableNonPermissionedAccessibleNodes(c)}},createAccessibleDialog:function(a){this.dialog&&this.dialog.destroy();var b="Product"===this.dataType?RightNow.Interface.getMessage("SELECT_BELOW_USING_LINKS_PROVIDED_MSG"):RightNow.Interface.getMessage("CATEGORY_BELOW_USING_LINKS_PROVIDED_MSG"),c=RightNow.Interface.getMessage("DEPTH_ANNOUNCED_NAVIGATE_THROUGH_LIST_MSG");this.dialog=new this.Y.RightNowTreeViewDialog({id:"rn_"+this.instanceID,hierarchyData:a,contentBox:this.Y.one(this.baseSelector+"_Links"),dismissLabel:RightNow.Interface.getMessage("CANCEL_CMD"),titleLabel:this.data.attrs.label_nothing_selected,introLabel:b+" "+c,selectionPlaceholderLabel:RightNow.Interface.getMessage("SELECTION_PCT_S_ACTIVATE_LINK_JUMP_MSG"),levelLabel:this.data.attrs.label_level,noItemSelectedLabel:this.data.attrs.label_all_values});this.dialog.on("selectionMade",this.onAccessibleLinkClick,this);this.dialog.render()},displayAccessibleDialog:function(){this.dialog.set("selectedValue",this.tree.get("value"));this.dialog.set("selectedLabels",this.tree.get("labelChain"));this.dialog.show();var a=this.Y.one("p.rn_Intro a");a&&a.focus()},displaySelectedNodesAndClose:function(a){this._eo||(this._eo=new RightNow.Event.EventObject(this));this._eo.data.hierChain=this.tree.get("valueChain");RightNow.Event.fire("evt_productCategoryFilterSelected",this._eo);delete this._eo.data.hierChain;var b=this.tree.get("valueChain"),c=this.data.attrs.label_nothing_selected,d=this.data.attrs.label_nothing_selected;this.dropdown.hide();b[0]&&(c=this.tree.get("labelChain").join("<br>"),d=this.data.attrs.label_screen_reader_selected+c);this.dropdown.set("triggerText",c);this.Y.all(this.baseSelector+"_TreeDescription").setHTML(d);if(a&&!this.dialog)try{this.dropdown.get("trigger").focus()}catch(e){}},selectNode:function(a){this.displaySelectedNodesAndClose(!0)},getSubLevelRequest:function(a){if(!this._nodeBeingExpanded){this._nodeBeingExpanded=!0;if(a=this.getSubLevelRequestEventObject(a))"Product"===this.dataType&&(RightNow.UI.Form.currentProduct=a.data.value),this._requesting=a.data.value,RightNow.Event.fire("evt_menuFilterRequest",a);this._nodeBeingExpanded=!1;this._eo.data.link_map&&delete this._eo.data.link_map}},getSubLevelRequestEventObject:function(a){return new RightNow.Event.EventObject(this,{data:{level:a.depth+1,value:a.value,label:a.label,cache:{}}})},getSubLevelResponse:function(a,b){this.data.js.link_map&&delete this.data.js.link_map;var c=a.data.level,d=a.data.hier_data,e,d=this.groomProdcats(d);this.buildTree();!a.data.reset_linked_category&&this.getSubLevelRequestEventObject._origRequest&&this.getSubLevelRequestEventObject._origRequest[b]?e=this.getSubLevelRequestEventObject._origRequest[b]:a.data.reset_linked_category&&(this.tree.clear(this.data.attrs.label_all_values),this.dialog=null,this.selectNode(this.tree.getRoot()));7>c&&this.insertChildrenForNode(d,e);0===d.length&&this.displaySelectedNodesAndClose()},insertChildrenForNode:function(a,b){this.tree.insertChildHierarchyData(a,b)},removeNonReadableProdcats:function(a){this.checkIdsAreValid("readableProdcatIds");var b=this.data;return this.Y.Array.filter(a,function(a){if(-1!==this.Y.Array.indexOf(b.js.readableProdcatIds,a.id))return a},this)},updateProdcatsHasChildrenAttribute:function(a){this.checkIdsAreValid("readableProdcatIdsWithChildren");var b=this.data;return this.Y.Array.map(a,function(a){a.hasChildren=-1!==this.Y.Array.indexOf(b.js.readableProdcatIdsWithChildren,a.id)?!0:!1;return a},this)},groomProdcats:function(a){!1!==this.data.attrs.verify_permissions&&"None"!==this.data.attrs.verify_permissions&&0<this.data.js.readableProdcatIds.length&&(a=this.removeNonReadableProdcats(a),a=this.updateProdcatsHasChildrenAttribute(a));return a},checkIdsAreValid:function(a){if(!(this.data&&this.data.js&&this.data.js[a]&&this.Y.Lang.isArray(this.data.js[a])))throw Error("Widget does not have this.data.js."+a+" attribute set, or its value is not an array");}});
RightNow.Widgets.ResultInfo=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._searchSources=0;if(this.data.attrs.display_knowledgebase_results){this.searchSource(this.data.attrs.report_id).on('response',this._onReportChanged,this);}
if(this.data.attrs.combined_results){this._searchTerm=this.data.js.searchTerm;if(this.data.js.social){if(this.data.js.social){this._searchSources++;}
this.searchSource(this.data.attrs.source_id).on('response',this._reportCombinedResults,this);}
this.searchSource().on('appendFilter',function(evt,args){if(args[0].filters.page&&args[0].data){this._page=args[0].data.page;}},this);this.searchSource(this.data.attrs.report_id).on('send',this._watchSearchFilterChange,this);}
if(this.data.js.error){RightNow.UI.Dialog.messageDialog(this.data.js.error,{"icon":"WARN"});}}},_onReportChanged:function(type,args)
{var newData=args[0].data,resultQuery="",parameterList=(this.data.attrs.add_params_to_url)?RightNow.Url.buildUrlLinkString(args[0].filters.allFilters,this.data.attrs.add_params_to_url):'';this._determineNewResults(args[0]);if(!this.data.attrs.combined_results&&this.data.attrs.display_results&&newData.search_term)
{var stopWords=newData.stopword,noDictWords=newData.not_dict,searchTerms=newData.search_term.split(" "),displayedNoResultsMsg=false;for(var i=0,word,strippedWord;i<searchTerms.length;i++)
{word=searchTerms[i];strippedWord=word.replace(/\W/,"");if(stopWords&&strippedWord&&stopWords.indexOf(strippedWord)!==-1)
word="<span class='rn_Strike' title='"+this.data.attrs.label_common+"'>"+word+"</span>";else if(noDictWords&&strippedWord&&noDictWords.indexOf(strippedWord)!==-1)
word="<span class='rn_Strike' title='"+this.data.attrs.label_dictionary+"'>"+word+"</span>";else
word="<a href='"+RightNow.Url.addParameter(this.data.js.linkUrl+encodeURIComponent(word.replace(/\&amp;/g,"&"))+parameterList+"/search/1","session",RightNow.Url.getSession())+"'>"+word+"</a>";resultQuery+=word+" ";}
resultQuery=this.Y.Lang.trim(resultQuery);}
var suggestedDiv=this.Y.one(this.baseSelector+"_Suggestion");if(suggestedDiv)
{if(newData.ss_data)
{var links=this.data.attrs.label_suggestion+" <ul>";for(var i=0;i<newData.ss_data.length;i++)
links+='<li><a href="'+this.data.js.linkUrl+newData.ss_data[i]+'/suggested/1'+parameterList+'">'+newData.ss_data[i]+'</a></li>';links+="</ul>";suggestedDiv.set('innerHTML',links).removeClass('rn_Hidden');}
else
{RightNow.UI.hide(suggestedDiv);}}
var spellingDiv=this.Y.one(this.baseSelector+"_Spell");if(spellingDiv)
{if(newData.spelling)
{spellingDiv.set('innerHTML',this.data.attrs.label_spell+' <a href="'+this.data.js.linkUrl+newData.spelling+'/dym/1/'+parameterList+'">'+newData.spelling+' </a>').removeClass('rn_Hidden');}
else
{RightNow.UI.hide(spellingDiv);}}
if(!(newData.data!==undefined&&newData.data.length!==undefined&&newData.data.length=='0'&&RightNow.Url.getParameter('page')!=='1'))
this._updateSearchResults({searchTermToDisplay:resultQuery,userSearchedOn:newData.search_term,topics:newData.topics,truncated:newData.truncated});if(!this.data.attrs.combined_results)
{this.data.js.totalResults=0;this.data.js.firstResult=0;this.data.js.lastResult=0;}},_updateSearchResults:function(options)
{options=options||{};var noResultsDiv=this.Y.one(this.baseSelector+"_NoResults"),resultsDiv=this.Y.one(this.baseSelector+"_Results"),searchTermToDisplay=options.searchTermToDisplay,displayedNoResultsMsg=false;if(noResultsDiv)
{if(this.data.js.totalResults===0&&options.userSearchedOn&&(!options.topics||options.topics.length===0))
{noResultsDiv.set('innerHTML',this.data.attrs.label_no_results+"<br/><br/>"+this.data.attrs.label_no_results_suggestions).removeClass('rn_Hidden');displayedNoResultsMsg=true;}
else
{RightNow.UI.hide(noResultsDiv);}}
if(resultsDiv)
{if(!displayedNoResultsMsg&&!options.truncated)
{resultsDiv.set('innerHTML',(searchTermToDisplay&&searchTermToDisplay.length>0)?RightNow.Text.sprintf(this.data.attrs.label_results_search_query,this.data.js.firstResult,this.data.js.lastResult,this.data.js.totalResults,searchTermToDisplay):RightNow.Text.sprintf(this.data.attrs.label_results,this.data.js.firstResult,this.data.js.lastResult,this.data.js.totalResults));RightNow.UI.show(resultsDiv);}
else
{RightNow.UI.hide(resultsDiv);}}},_determineNewResults:function(eventObject){var reportData=eventObject.data;if(this.data.attrs.combined_results){if(this.data.js.totalResults===0||this.data.js.totalResults===this.data.js.combinedResults){this.data.js.totalResults+=reportData.total_num;}
if(typeof reportData.pruned==="number"){this.data.js.totalResults-=reportData.pruned;}
if(typeof this.data.js.prunedAnswers==="number"&&!reportData.pruned){reportData.start_num-=this.data.js.prunedAnswers;reportData.end_num-=this.data.js.prunedAnswers;reportData.pruned=true;}}
else{this.data.js.totalResults=reportData.total_num;}
this.data.js.firstResult=reportData.start_num;if(reportData.page!==1){this.data.js.firstResult+=this.data.js.combinedResults;}
if(this.data.js.firstResult===0&&this.data.js.combinedResults!==0){this.data.js.firstResult=1;}
this.data.js.lastResult=reportData.end_num+this.data.js.combinedResults;this._page=reportData.page;if(reportData.pruned&&eventObject.w_id&&eventObject.w_id.indexOf("CombinedSearchResults")>-1){this.data.js.prunedAnswers=(this.data.js.prunedAnswers===reportData.pruned)?false:reportData.pruned;}},_reportCombinedResults:function(evt,args){args=args[0];if(!args.data)return;var newTotal=0,argData=args.data,jsData=this.data.js;if(jsData.social&&argData.social){newTotal+=Math.min(argData.social.data.totalResults,20)||0;}
if(!this._page||this._page<2){jsData.combinedResults+=newTotal;jsData.lastResult+=newTotal;jsData.totalResults+=newTotal;jsData.firstResult=((jsData.combinedResults)?1:0);if(jsData.totalResults===0||this.data.js.combinedResults>0){this._updateSearchResults({userSearchedOn:true});}}},_watchSearchFilterChange:function(evt,args){args=args[0];if(!args)return;var filters=args.allFilters;if(filters&&((filters.keyword&&filters.keyword.filters.data!==this._searchTerm)||(filters.page===1))){this._page=1;this._searchTerm=filters.keyword.filters.data;this.data.js.totalResults=0;this.data.js.combinedResults=0;this.data.js.lastResult=0;this.data.js.firstResult=0;this.data.js.prunedAnswers=false;}}});
RightNow.Widgets.Grid=RightNow.ResultsDisplay.extend({overrides:{constructor:function(){this.parent();this._modActionPerformed=false;this._contentName=this.baseSelector+'_Content';this._contentDiv=this.Y.one(this._contentName);this._gridName=this.baseSelector+'_Grid';this._loadingDiv=this.Y.one(this.baseSelector+'_Loading');this._dataTable=null;this._columns=[];this._data=[];this._sortOn=null;RightNow.Event.subscribe('evt_getFiltersRequest',this._fireSortEvent,this);RightNow.Event.subscribe('evt_sortTypeResponse',this._onSortTypeResponse,this);this.searchSource().on('response',this._onReportChanged,this).on('send',this._searchInProgress,this);this._setFilter();if(this.data.attrs.headers){this._generateYUITable(this.data.js.headers);this._setSortableLabel(this.data.js.headers);}
else{this._contentDiv.addClass('rn_NoHeader');}
if(RightNow.Event.isHistoryManagerFragment()){this._setLoading(true);}
else{this._updateAriaAlert((this._dataTable&&this._data.length>0)?this.data.attrs.label_screen_reader_search_success_alert:this.data.attrs.label_screen_reader_search_no_results_alert);}}},_setFilter:function(){this._sortFilters=new RightNow.Event.EventObject(this,{filters:{searchName:this.data.js.searchName,report_id:this.data.attrs.report_id,data:{}}});this._setSortData();var eo=new RightNow.Event.EventObject(this,{filters:{report_id:this.data.attrs.report_id,token:this.data.js.token,allFilters:this.data.js.filters,format:this.data.js.format}});eo.filters.format.parmList=this.data.attrs.add_params_to_url;this.searchSource().fire('setInitialFilters',eo);},_setSortData:function(columnID,sortDirection){this._sortFilters.filters.data.col_id=(columnID||this.data.js.columnID);this._sortFilters.filters.data.sort_direction=(sortDirection||this.data.js.sortDirection);},_searchInProgress:function(evt,args){var params=args[1];if(!params||!params.newPage)
{document.body.setAttribute('aria-busy','true');this._setLoading(true);}},_setLoading:function(loading){var toOpacity=1,method='removeClass';if(loading){this._contentDiv.setStyle('height',this._contentDiv.get('offsetHeight')+'px');toOpacity=0;method='addClass';}
this._contentDiv.transition({opacity:toOpacity,duration:0.4});this._loadingDiv[method]('rn_Loading');},_onReportChanged:function(type,args){var sortData=RightNow.Event.getDataFromFiltersEventResponse(args,this.data.js.searchName,this.data.attrs.report_id);if(sortData)
this._sortFilters.filters.data=sortData;else
this._setSortData();var newdata=args[0].data;this._setLoading(false);var currentPageSize=newdata.per_page,cols=newdata.headers.length,data={instanceID:this.instanceID,tableID:this.baseDomID+'_Grid',caption:this.data.attrs.label_caption,attrs:this.data.attrs,headers:[],rows:[],js:this.data.js,hiddenHeaders:[],hiddenRows:[]},anchor,width,row,hiddenRow,i,j,td,currentDataLength;if(newdata.error){RightNow.UI.Dialog.messageDialog(newdata.error,{"icon":"WARN"});}
if(this.data.attrs.headers){if(newdata.row_num){data.headers.push({label:this.data.attrs.label_row_number});}
for(i=0;i<cols;i++){td={label:newdata.headers[i].heading};if(width=newdata.headers[i].width){td.style='width: "'+width+'%"';}
if(newdata.headers[i].visible){data.headers.push(td);}
else{data.hiddenHeaders[i]=td;}}}
if(newdata.total_num>0){currentDataLength=newdata.data.length;for(i=0;i<currentPageSize&&i<currentDataLength;i++){row=[];hiddenRow=[];if(newdata.row_num){row.push(i+1);}
for(j=0;j<cols;j++){if(!newdata.headers[j].visible){hiddenRow[j]=newdata.data[i][j];}
else{row.push(newdata.data[i][j]);}}
data.rows.push(row);data.hiddenRows.push(hiddenRow);}
if(this.data.attrs.hide_when_no_results)
RightNow.UI.show(this.baseSelector);}
else if(this.data.attrs.hide_when_no_results){RightNow.UI.hide(this.baseSelector);}
this._contentDiv.set('innerHTML',new EJS({text:this.getStatic().templates.dataTable}).render(data));if(this.data.attrs.headers){this._generateYUITable(newdata.headers);this._setSortableLabel(newdata.headers);if(!this._modActionPerformed){this._setFocusAfterSort(this._sortFilters.filters.data.col_id);}}
this._contentDiv.setStyle('height','auto');RightNow.Url.transformLinks(this._contentDiv);document.body.setAttribute('aria-busy','false');if(!this._modActionPerformed){this._updateAriaAlert((newdata.total_num>0)?this.data.attrs.label_screen_reader_search_success_alert:this.data.attrs.label_screen_reader_search_no_results_alert);}
else{this._modActionPerformed=false;}},_setTableData:function(headers){var dataTypes=this.data.js.dataTypes,sortDirection=this._sortFilters.filters.data.sort_direction,sortColumnID=this._sortFilters.filters.data.col_id,sortDirectivesPresent=(sortDirection!==null&&sortColumnID!==null),rowNumbersPresent=this.data.js.rowNumber,key,columnID,header,rowObj,rows,i,tableHeaderID,iconColumns=this.data.attrs.icon_cols.split(",")||[];this._columns=[];this._data=[];if(rowNumbersPresent){this._columns.push({key:'c0',label:this.data.attrs.label_row_number,sortable:false});}
for(i=0;i<headers.length;i++){header=headers[i];if(!header.visible)
continue;columnID=header.col_id;key='c'+columnID;tableHeaderID=this.instanceID+'_'+key;if(sortDirectivesPresent&&sortColumnID===columnID){this._sortOn={key:key,dir:sortDirection};}
var isSortable=!this.Y.Lang.isArray(this.data.attrs.exclude_from_sorting)||this.Y.Array.indexOf(this.data.attrs.exclude_from_sorting,(i+1).toString())===-1;this._columns.push({id:tableHeaderID,key:key,label:(iconColumns.indexOf(columnID.toString())!==-1)?"<span class='rn_ScreenReaderOnly'>"+header.heading+"</span>":header.heading,columnID:columnID,sortable:isSortable,emptyCellValue:"&nbsp;",allowHTML:true,className:"rn_GridColumn_"+columnID,title:isSortable?header.heading:"",cellTemplate:'<td class="{className}" headers="'+tableHeaderID+'">{content}</td>'});}
if(rows=this.Y.all(this._gridName+' tbody tr')){rows.each(function(row){rowObj={};row.all('td').each(function(td,i){rowObj[this._columns[i].key]=td.getContent();},this);this._data.push(rowObj);},this);}},_generateYUITable:function(headers){this._setTableData(headers);this._dataTable=new this.Y.DataTable({data:this._data,columns:this._columns,caption:this.data.attrs.label_caption,strings:{asc:RightNow.Interface.getMessage('ASCENDING_LBL'),desc:RightNow.Interface.getMessage('DESCENDING_LBL'),sortBy:RightNow.Text.sprintf(RightNow.Interface.getMessage('SORT_BY_S_LBL'),'{title}'),reverseSortBy:RightNow.Interface.getMessage('REVERSE_SORT_BY_COLUMN_LBL')}});this._dataTable.on('sort',this._onSort,this);this.Y.one(this._gridName).remove();this._dataTable.render(this._contentName);if(!this._data.length){this._dataTable.showMessage(RightNow.Interface.getMessage('NO_RECORDS_FOUND_MSG'));this._dataTable.setAttrs({'sortable':false});this._sortOn=null;}
else{this.Y.one(this._contentName+' .yui3-datatable-message-content').remove();}
if(this._sortOn){this._setSortedColumn(this._sortOn.key,this._sortOn.dir);}
this.Y.all(this._contentName+" th .yui3-datatable-sort-liner").each(function(node){node.setAttribute('aria-labelledby',node.ancestor('th').get('id'));},this);},_setSortableLabel:function(headers){var yuiHeaderPrefix='yui3-datatable-header.rn_GridColumn_',table=this.Y.one('#'+this._dataTable.get('id')),columnID=0;for(var i=0;i<headers.length;i++){if(headers[i].visible){columnID=i+1;header=table.one('th.'+yuiHeaderPrefix+columnID);if(header!==null){headerLiner=header.one('.yui3-datatable-sort-liner');if(headerLiner!==null){headerLiner.append('<span class="rn_ScreenReaderOnly">'+'&nbsp;'+this.data.attrs.label_sortable+'</span>');}}}}},_onSort:function(sortEvent){if(!sortEvent.sortBy)return;this.Y.Object.each(sortEvent.sortBy[0],function(value,columnID){this._setSortData(parseInt(RightNow.Text.getSubstringAfter(columnID,'c'),10),this._getDirectionToSort(columnID));},this);RightNow.Event.fire("evt_sortChange",this._sortFilters);this.searchSource().fire('search',this._sortFilters);sortEvent.halt();},_setFocusAfterSort:function(columnID){var yuiHeaderPrefix='yui3-datatable-header.rn_GridColumn_',header=this.Y.one('#'+this._dataTable.get('id')).one('th.'+yuiHeaderPrefix+columnID);if(header){headerLiner=header.one('.yui3-datatable-sort-liner');if(headerLiner!==null){headerLiner.focus();}}},_directions:{desc:2,asc:1},_getDirectionToSort:function(columnID){var yuiPrefix='yui3-datatable-',header=this.Y.one('#'+this._dataTable.get('id')).one('th.'+yuiPrefix+'col-'+columnID+'.'+yuiPrefix+'sortable-column');return(header&&header.hasClass(yuiPrefix+'sorted-desc'))?this._directions.asc:this._directions.desc;},_setSortedColumn:function(columnID,dir){var yuiPrefix='yui3-datatable-',sortedClass=yuiPrefix+'sorted',descClass=yuiPrefix+'sorted-desc',table=this.Y.one('#'+this._dataTable.get('id')),header=table.one('th.'+yuiPrefix+'col-'+columnID+'.'+yuiPrefix+'sortable-column');if(header){var headerLiner=header.one('.yui3-datatable-sort-liner'),sortLabel=(dir===this._directions.asc)?RightNow.Interface.getMessage('SORTED_ASCENDING_LBL'):RightNow.Interface.getMessage('SORTED_DESCENDING_LBL');headerLiner.append('<span class="rn_ScreenReaderOnly">'+sortLabel+'</span>');}
if(!this._prevSorted&&this.data.js.columnID){this._prevSorted='c'+this.data.js.columnID;}
if(this._prevSorted){table.all('.'+yuiPrefix+'col-'+this._prevSorted).removeClass(sortedClass).removeClass(descClass);}
if(header){if(dir===this._directions.asc){header.removeClass(descClass);}
else{header.addClass(descClass);}
header.addClass(sortedClass);}
table.all('td.'+yuiPrefix+'col-'+columnID).addClass(sortedClass);this._prevSorted=columnID;},_fireSortEvent:function(){RightNow.Event.fire('evt_searchFiltersResponse',new RightNow.Event.EventObject(this,{filters:this._sortFilters}));},_onSortTypeResponse:function(type,args){var evt=args[0];this._setSortData(evt.filters.data.col_id,evt.filters.data.sort_direction);},_updateAriaAlert:function(text){this._ariaAlert=this._ariaAlert||this.Y.one(this.baseSelector+'_Alert');if(this._ariaAlert){this._ariaAlert.set('innerHTML',text);}}});
RightNow.Widgets.KeywordText=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._textElement=this.Y.one(this.baseSelector+"_Text");this.data.js.initialValue=this._decoder(this.data.js.initialValue);if(this._textElement){this._searchedOn=this._textElement.get("value");if(this._searchedOn!==this.data.js.initialValue)
this._textElement.set("value",this.data.js.initialValue);this._setFilter();this._textElement.on("change",this._onChange,this);this.searchSource().on("keywordChanged",this._onChangedResponse,this).on("search",this._onGetFiltersRequest,this).on("reset",this._onResetRequest,this);this.searchSource(this.data.attrs.report_id).on("response",this._onChangedResponse,this);if(this.data.attrs.initial_focus)
this._textElement.focus();}}},_onChange:function(evt){this._eo.data=this._textElement.get("value");this._eo.filters.data=this._textElement.get("value");this.searchSource().fire("keywordChanged",this._eo);},_onGetFiltersRequest:function(type,args){this._eo.filters.data=this.Y.Lang.trim(this._textElement.get("value"));this._searchedOn=this._eo.filters.data;return this._eo;},_setFilter:function(){this._eo=new RightNow.Event.EventObject(this,{filters:{searchName:this.data.js.searchName,data:this.data.js.initialValue,rnSearchType:this.data.js.rnSearchType,report_id:this.data.attrs.report_id}});},_onChangedResponse:function(type,args){var data=RightNow.Event.getDataFromFiltersEventResponse(args,this.data.js.searchName),newValue=(data===null)?this.data.js.initialValue:data;newValue=this._decoder(newValue);if(this._textElement.get("value")!==newValue)
this._textElement.set("value",newValue);},_onResetRequest:function(type,args){if(!args[0]||args[0].data.name===this.data.js.searchName){this._textElement.set('value',this.data.js.initialValue);}
else if(args[0].data.name==='all'){this._textElement.set('value',this._searchedOn);}},_decoder:function(value){if(value)
return value.replace(/&gt;/g,'>').replace(/&lt;/g,'<').replace(/&#039;/g,"'").replace(/&quot;/g,'"');return value;}});
RightNow.Widgets.SearchButton=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._requestInProgress=false;this._searchButton=this.Y.one(this.baseSelector+"_SubmitButton");if(this._searchButton){this._searchButton.on("click",this._startSearch,this);this.searchSource().on("response",this._enableClickListener,this);}}},_startSearch:function(evt){if(this._requestInProgress)return;if(!this.data.attrs.popup_window&&(!this.data.attrs.report_page_url||(this.data.attrs.target==='_self')))
this._disableClickListener();if(this.Y.UA.ie){this._parentForm=this._parentForm||this.Y.one(this.baseSelector).ancestor("form");if(this._parentForm&&window.external&&"AutoCompleteSaveForm"in window.external){window.external.AutoCompleteSaveForm(this.Y.Node.getDOMNode(this._parentForm));}}
var searchPage=this.data.attrs.report_page_url;this.searchSource().fire("search",new RightNow.Event.EventObject(this,{filters:{report_id:this.data.attrs.report_id,source_id:this.data.attrs.source_id,reportPage:searchPage,newPage:this.data.attrs.force_page_flip||top!==self||(searchPage!==""&&searchPage!=="{current_page}"&&!RightNow.Url.isSameUrl(searchPage)),target:this.data.attrs.target,popupWindow:this.data.attrs.popup_window,width:this.data.attrs.popup_window_width_percent,height:this.data.attrs.popup_window_height_percent}}));},_enableClickListener:function(){if(this._requestInProgress){this._searchButton.on("click",this._startSearch,this);}
this._requestInProgress=false;},_disableClickListener:function(){this._requestInProgress=true;this._searchButton.detach("click",this._startSearch);}});
RightNow.Widgets.ProductCategorySearchFilter=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this.Y.augment(this,RightNow.ProductCategory);this._getFiltersRequest.lastInstance=this._getFiltersRequest.lastInstance||{};this.searchSource(this.data.attrs.report_id).on('search',this._getFiltersRequest,this).on('response',this._onReportResponse,this).on('reset',this._onResetRequest,this);this._initializeFilter();this.initializeTreeView(this.data.attrs.filter_type);}},selectNode:function(node){if(node!==null){this._getFiltersRequest.lastInstance[this.data.attrs.filter_type]=this.baseDomID;if((node.expanded||!node.value)&&!this.data.js.linkingOn){this._eo.data.level=node.depth+1;if(this._eo.data.level!==this._eo.filters.data[0].length){this._eo.filters.data[0]=node.valueChain;}
else{this._eo.filters.data[0][this._eo.data.level-1]=node.value||this._eo.data.value;for(var i=this._eo.data.level;i<this._eo.filters.data[0].length;i++)
delete this._eo.filters.data[0][i];}}
else if(this.data.attrs.search_on_select&&!RightNow.Url.isSameUrl(this.data.attrs.report_page_url)){this._eo.data.level=node.depth+1;this._eo.data.label=node.label;this._eo.data.value=node.value;this._eo.filters.data[0][node.depth]=node.value;}
else{this.getSubLevelRequest(node);this.tree.collapseAll();}
RightNow.ProductCategory.prototype.selectNode.call(this,node);if(this.data.attrs.search_on_select){this._eo.filters.reportPage=this.data.attrs.report_page_url;this.searchSource().fire('search',this._eo);}}},getSubLevelRequestEventObject:function(expandingNode){if(expandingNode.expanded&&!this.data.js.linkingOn)return;this._eo.data.level=expandingNode.depth+1;this._eo.data.label=expandingNode.label;this._eo.data.value=expandingNode.value;this.getSubLevelRequestEventObject._origRequest=this.getSubLevelRequestEventObject._origRequest||[];this.getSubLevelRequestEventObject._origRequest[this._dataType]=expandingNode.value;if(this.data.js.link_map){this._eo.data.link_map=this.data.js.link_map;this.data.js.link_map=null;}
if(this._eo.data.level!==this._eo.filters.data[0].length){this._eo.filters.data[0]=this.tree.get('valueChain');}
else{this._eo.filters.data[0][this._eo.data.level-1]=this._eo.data.value;for(var i=this._eo.data.level;i<this._eo.filters.data[0].length;i++)
delete this._eo.filters.data[0][i];}
if(!expandingNode.loaded||this.data.js.linkingOn)
return this._eo;},getSubLevelResponse:function(type,args){var eventObject=args[0];if(!((eventObject.data.linking_on&&((!eventObject.data.value&&eventObject.data.via_hier_request)||(eventObject.data.via_product_click)))||(eventObject.data.data_type!==this._dataType)||(eventObject.filters.report_id!==this.data.attrs.report_id))){RightNow.ProductCategory.prototype.getSubLevelResponse.call(this,eventObject,this._dataType);}},_onReportResponse:function(type,args){var data=RightNow.Event.getDataFromFiltersEventResponse(args,this.data.js.searchName);this._getFiltersRequest.cachedWidgetHier={};if(data[0]&&data[0].length){this.buildTree();if(typeof data[0]==="string")
data[0]=data[0].split(",");var finalData=RightNow.Lang.arrayFilter(data[0]);this.tree.expandAndCreateNodes(finalData);if(this.data.attrs.show_confirm_button_in_dialog){this.dropdown.fire('confirm');}
this._eo.filters.data[0]=finalData;this._lastSearchValue=finalData.slice(0);if(this._eo.filters.data.reconstructData){this._eo.filters.data.level=this._eo.filters.data.reconstructData.level;this._eo.filters.data.label=this._eo.filters.data.reconstructData.label;}}
else{this._eo.filters.data[0]=[];if(this.tree){this.tree.resetSelectedNode();this.displaySelectedNodesAndClose();}}},_getFiltersRequest:function(type,args){this._getFiltersRequest.lastInstance[this.data.attrs.filter_type]=this._getFiltersRequest.lastInstance[this.data.attrs.filter_type]||null;this._getFiltersRequest.cachedWidgetHier=this._getFiltersRequest.cachedWidgetHier||{};var filterName=(this._eo.filters.searchName||"")+this.data.attrs.report_id,filterKey=filterName+this.baseDomID,mostRecentFilterKey=filterName+this._getFiltersRequest.lastInstance[this.data.attrs.filter_type],cachedHier=this._getFiltersRequest.cachedWidgetHier[mostRecentFilterKey];this._eo.filters.data.reconstructData=[];if(this.tree&&this.tree.get('value')){this._eo.data.level=this.tree.get('depth');this._eo.data.label=this.tree.get('label');this._eo.data.value=this.tree.get('value');var labelChain=this.tree.get('labelChain');for(var i=0;i<labelChain.length;i++){this._eo.filters.data.reconstructData.push({level:i+1,label:labelChain[i],hierList:this._eo.filters.data[0].slice(0,i+1).join(",")});}
if(cachedHier&&filterKey!==mostRecentFilterKey){this._eo.filters.data=cachedHier;}
else{this._getFiltersRequest.cachedWidgetHier[filterKey]=RightNow.Lang.cloneObject(this._eo.filters.data);}}
else if(cachedHier){this._eo.filters.data=cachedHier;this._eo.data.value=cachedHier[0][0];}
else{this._eo.filters.data[0]=[];this._eo.data.value=0;}
this._lastSearchValue=this._eo.filters.data[0].slice(0);return this._eo;},_onResetRequest:function(type,args){args=args[0];if(this.tree&&(!args||args.data.name==='all'||args.data.name===this.data.js.searchName)){if(args&&args.data.name==="all"&&this._lastSearchValue){this._eo.filters.data[0]=this._lastSearchValue;}
else{if(args&&args.data.reset&&this.data.js.linkingOn&&this._dataType==="Category"){RightNow.Event.fire('evt_resetFilterRequest',args);if(this.data.js.link_map)
delete this.data.js.link_map;this.buildTree(true);}
if(!args)
this._eo.filters.data=[(this.data.js.initial)?this.data.js.initial:[]];else
this._eo.filters.data[0]=[];this._lastSearchValue=this._eo.filters.data[0].slice(0);this._getFiltersRequest.cachedWidgetHier={};}
this.tree.selectNodeWithValue(this._lastSearchValue[this._lastSearchValue.length-1]||0);this.displaySelectedNodesAndClose();}},_initializeFilter:function(){this._eo=new RightNow.Event.EventObject(this,{data:{data_type:this._dataType=this.data.attrs.filter_type,linking_on:this.data.js.linkingOn,cache:[],hm_type:this.data.js.hm_type,linkingProduct:0},filters:{rnSearchType:"menufilter",searchName:this.data.js.searchName,report_id:this.data.attrs.report_id,fltr_id:this.data.js.fltr_id,oper_id:this.data.js.oper_id,data:[(this.data.js.initial)?this.data.js.initial:[]]}});this._lastSearchValue=this._eo.filters.data[0].slice(0);if(this._dataType==="Product"){RightNow.UI.Form.currentProduct=this._eo.filters.data[0][this._eo.filters.data[0].length-1];}}});
RightNow.Widgets.Paginator=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._currentPage=this.data.js.currentPage;for(var i=this.data.js.startPage;i<=this.data.js.endPage;i++)
{var pageLinkID=this.baseSelector+"_PageLink_"+i;if(this.Y.one(pageLinkID))
this.Y.one(pageLinkID).on("click",this._onPageChange,this,i);}
this._instanceElement=this.Y.one(this.baseSelector);this._cloneForwardAndBackwardButton();this.Y.one(this.baseSelector).delegate("click",this._onDirection,".rn_NextPage",this,true);this.Y.one(this.baseSelector).delegate("click",this._onDirection,".rn_PreviousPage",this,false);this._eo=new RightNow.Event.EventObject(this,{filters:{report_id:this.data.attrs.report_id,per_page:this.data.attrs.per_page,page:this._currentPage}});this.searchSource(this.data.attrs.report_id).on("response",this._onReportChanged,this);}},_onPageChange:function(evt,pageNumber)
{evt.preventDefault();if(this._currentlyChangingPage||!pageNumber||pageNumber===this._currentPage)
return;this._currentlyChangingPage=true;pageNumber=(pageNumber<1)?1:pageNumber;this._eo.filters.page=this._currentPage=pageNumber;if(RightNow.Event.fire("evt_switchPagesRequest",this._eo)){this.searchSource().fire("appendFilter",this._eo).fire("search",this._eo);}},_onDirection:function(evt,isForward)
{evt.preventDefault();if(this._currentlyChangingPage)
return;this._currentlyChangingPage=true;if(isForward)
this._currentPage++;else
this._currentPage--;this._eo.filters.page=this._currentPage;if(RightNow.Event.fire("evt_switchPagesRequest",this._eo)){this.searchSource().fire("appendFilter",this._eo).fire("search",this._eo);}},_onReportChanged:function(type,args)
{var newData=args[0];newData=newData.data;if(args[0].filters.report_id==this.data.attrs.report_id)
{this._currentPage=newData.page;var totalPages=newData.total_pages;if(totalPages<2||newData.truncated)
{RightNow.UI.hide(this._instanceElement);}
else
{var pagesContainer=this.Y.one(this.baseSelector+" ul");if(pagesContainer)
{pagesContainer.set('innerHTML',"");var startPage,endPage;if(totalPages>this.data.attrs.maximum_page_links)
{var split=Math.round(this.data.attrs.maximum_page_links/2);if(this._currentPage<=split)
{startPage=1;endPage=this.data.attrs.maximum_page_links;}
else
{var offsetFromMiddle=this._currentPage-split;var maxOffset=offsetFromMiddle+this.data.attrs.maximum_page_links;if(maxOffset<=newData.total_pages)
{startPage=1+offsetFromMiddle;endPage=maxOffset;}
else
{startPage=newData.total_pages-(this.data.attrs.maximum_page_links-1);endPage=newData.total_pages;}}}
else
{startPage=1;endPage=totalPages;}
pagesContainer.appendChild(this._backButton);for(var i=startPage,link,titleString;i<=endPage;i++)
{if(i===this._currentPage)
{var currentPageTitle=RightNow.Text.sprintf(this.data.attrs.label_current_page,i,totalPages)
link=this.Y.Node.create("<span/>").addClass("rn_CurrentPage").set('innerHTML',i).set('title',currentPageTitle).set('aria-label',currentPageTitle).setAttribute('tabindex','0');}
else if(this._shouldShowPageNumber(i,this._currentPage,endPage))
{link=this.Y.Node.create("<a/>").set('id',this.baseDomID+"_PageLink_"+i).set('href',this.data.js.pageUrl+i).set('innerHTML',i+'<span class="rn_ScreenReaderOnly">'+RightNow.Text.sprintf(this.data.attrs.label_page,i,totalPages)+'</span>');titleString=this.data.attrs.label_page;if(titleString)
{titleString=titleString.replace(/%s/,i).replace(/%s/,newData.total_pages);link.set('title',titleString);}}
else if(this._shouldShowHellip(i,this._currentPage,endPage))
{link=this.Y.Node.create("<span/>").set('class','rn_PageHellip').set('innerHTML',"&hellip;");}
else{continue;}
pagesContainer.appendChild(this.Y.Node.create("<li/>").append(link));link.on("click",this._onPageChange,this,i);}
pagesContainer.appendChild(this._forwardButton);RightNow.UI.show(this._instanceElement);}}
if(this._backButton)
{if(newData.page>1)
this._backButton.removeClass("rn_Hidden").set('href',this.data.js.pageUrl+(this._currentPage-1));else
RightNow.UI.hide(this._backButton);}
if(this._forwardButton)
{if(newData.total_pages>newData.page)
this._forwardButton.removeClass("rn_Hidden").set('href',this.data.js.pageUrl+(this._currentPage+1));else
RightNow.UI.hide(this._forwardButton);}
this._cloneForwardAndBackwardButton();}
this._currentlyChangingPage=false;},_shouldShowHellip:function(pageNumber,currentPage,endPage){return Math.abs(pageNumber-currentPage)===((currentPage===1||currentPage===endPage)?3:2);},_shouldShowPageNumber:function(pageNumber,currentPage,endPage){return pageNumber===1||(pageNumber===endPage)||(Math.abs(pageNumber-currentPage)<=((currentPage===1||currentPage===endPage)?2:1));},_cloneForwardAndBackwardButton:function(){this._forwardButton=this.Y.one(this.baseSelector+" .rn_NextPage").cloneNode(true);this._backButton=this.Y.one(this.baseSelector+" .rn_PreviousPage").cloneNode(true);}});
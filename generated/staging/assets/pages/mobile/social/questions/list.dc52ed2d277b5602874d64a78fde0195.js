
(function(){function p(a){var b={},d=new a.HistoryHTML5;d.on("change",function(c){if(c.src===a.HistoryHTML5.SRC_POPSTATE){l=!0;var b=c.changed.state;b?f.RefreshSources(b.newVal):(c.halt(!0),window.history.go(-1));l=!1}});return{enabled:!0,addState:function(a,b,q){d[q?"replace":"add"]({state:b},{url:h.getCurrentPage()+a})},checkCache:function(a){return a in b?b[a]:null},setCache:function(a,d){b[a]=d}}}var k,n,h,f,l=!1;RightNow.ParameterContext={};"pushState"in window.history?YUI().use("history-html5",function(a){k=p(a)}):k={enabled:!1};n=function(){function a(a,b){this.sourceCollection[b.sourceID]={response:a,filters:b.filters,sourceID:b.sourceID};this.completedSearches++;k.setCache(b.sourceID+b.historyKey,this.sourceCollection[b.sourceID]);this.completedSearches===this.sourceCount&&(f.RefreshSources(this.sourceCollection),k.addState(b.historyKey,this.sourceCollection,b.isRestoring),this.completedSearches=0,this.sourceCollection={})}function b(b,c,d){RightNow.Ajax.makeRequest(b,c,{successHandler:a,failureHandler:function(a){var b=RightNow.Interface.getMessage("THERE_PROB_REQ_ACTION_COULD_COMPLETED_MSG");403===a.status&&void 0!==a.responseText&&(b=a.responseText);RightNow.UI.Dialog.messageDialog(b,{icon:"WARN",exitCallback:function(){window.location.reload(!0)}})},json:!0,data:d,timeout:1E4})}function d(a,c,d,g,r){this.sourceCount=g;g=h.getFilterUrl(a);var m=k.checkCache(d+g);if("/"===g)r.fire("response",new RightNow.Event.EventObject(null,{data:{}}));else if(g=RightNow.Url.addParameter(g,"session",RightNow.Url.getSession()),m)this.completedSearches++,this.sourceCollection[m.sourceID]=m,this.completedSearches===this.sourceCount&&(f.RefreshSources(this.sourceCollection),k.addState(g,this.sourceCollection,l),this.completedSearches=0,this.sourceCollection={});else{if(!c.endpoint)throw Error("An endpoint hasn't been specified");b(c.endpoint,e.mix({sourceID:d,filters:RightNow.JSON.stringify(a),limit:c.limit},c.params),{sourceID:d,historyKey:g,filters:a,isRestoring:l})}}function c(a,b){if(!this.refreshInProgress){var c=RightNow.Url.addParameter((b.new_page||h.getCurrentPage())+h.getFilterUrl(a),"session",RightNow.Url.getSession());"_self"===b.target?RightNow.Url.navigate(c,!0):window.open(c,b.target||"_self");this.refreshInProgress=!0}}var e=YUI();this.completedSearches=this.sourceCount=0;this.sourceCollection={};return{go:function(a,b,e,g,f){!k.enabled||b&&(b.new_page||!b.endpoint)?c(a,b):d(a,b,e,g,f)}}}();h={alphanumericSort:function(a,b){return a<b?-1:a>b?1:0},getFilterUrl:function(a){var b=[],d={},c,e;for(c in a)a.hasOwnProperty(c)&&(e=a[c],!e.key||d[e.key]||!e.value&&0!==e.value&&!1!==e.value||(b.push(e.key),d[e.key]=e.value));b.sort(h.alphanumericSort);for(a="";c=b.shift();)a+="/"+c+"/"+encodeURIComponent(d[c]);return a},getFlattenedFilters:function(a){var b={},d,c;for(c in a)a.hasOwnProperty(c)&&"object"===typeof a[c]&&(d=h.getFlattenedFilter(a[c]))&&(b[c]=d);return b},getWidgetData:function(a){var b={};a&&a.data&&(b.w_id=a.w_id,b.rn_contextData=a.data.rn_contextData,b.rn_contextToken=a.data.rn_contextToken,b.rn_timestamp=a.data.rn_timestamp,b.rn_formToken=a.data.rn_formToken);return b},getFlattenedFilter:function(a){if("value"in a&&"type"in a&&"key"in a)return{value:a.value,key:a.key,type:a.type}},getCurrentPage:function(){var a=window.location,b=a.pathname,a=a.origin||a.protocol+"//"+a.host;return"/"===b||"/app"===b||"/app/"===b?a+"/app/"+RightNow.Interface.getConfig("CP_HOME_URL"):b.split("/").slice(0,RightNow.Url.getParameterSegment()-1).join("/")}};f=function(){function a(a){return a?c[a]:c}function b(a){if(!a||!a.length||2>a.length)throw Error("You're doing it wrong");this.sources=a;this.multiple=!0}function d(a){return function(){for(var b=0,c=arguments,g;b<this.sources.length;b++)g=this.sources[b],g[a].apply(g,c);return this}}var c={},e=RightNow.EventProvider.extend({overrides:{constructor:function(a,b,d){this.parent();this.sourceID=b;this.Y=a;this.initialFilters={};this.filters={};this.widgetData={};this.options={};this.cancelSearch=!1;delete this.data;delete this.baseDomID;delete this.baseSelector;this._addEventHandler("collect",{pre:function(){this.filters=this.initialFilters},during:function(a){a&&a instanceof RightNow.Event.EventObject&&((a=h.getFlattenedFilter(a.data))&&a.value?this.filters[a.type]=a:delete this.filters[a.type])}});this._addEventHandler("search",{pre:function(b){if(RightNow.isInstance(b,RightNow.Event.EventObject)){var c=this.options.limit!==b.data.limit?this.options.limit:null;this.options=a.merge(this.options,b.data);c&&(this.options.limit=c)}this.options.params=a.merge(this.options.params,this.widgetData);"page"in this.options&&(this.Y.Object.isEmpty(this.filters)&&(this.filters=this.initialFilters),this.filters.page=this.options.page);this.cancelSearch=!1},during:function(a){!1===a&&(this.cancelSearch=!0)},post:function(){this.cancelSearch?this.fire("searchCancelled",this.filters,this.options):n.go(this.filters,this.options,b,this.options.sourceCount||Object.keys(c).length,this);delete this.options.sourceCount}});this._addEventHandler("initializeFilters",{pre:function(b){if(RightNow.isInstance(b,RightNow.Event.EventObject)&&(RightNow.ParameterContext[this.instanceID]=this.initialFilters=h.getFlattenedFilters(b.data),this.widgetData=h.getWidgetData(b),k.enabled&&(b=Object.keys(c),b[b.length-1]===this.instanceID))){b={};for(var d in RightNow.ParameterContext)b=a.merge(b,RightNow.ParameterContext[d]);var e=h.getFilterUrl(b),f={},e=RightNow.Url.addParameter(e,"session",RightNow.Url.getSession());this.Y.Object.each(c,function(a,b){var c=this.Y.one("#rn_"+a.widgetData.w_id+"_HistoryData"),d=this.Y.one("#rn_"+a.widgetData.w_id+"_Content");c&&d&&(c=JSON.parse(c.getHTML()),c.html=d.getHTML(),c._isParsed=!0,f[b]={response:c,filters:this.initialFilters,sourceID:b},k.setCache(e+b,f[b]))},this);k.addState(e,f,!0)}}});this._addEventHandler("updateHistoryEntry",{pre:function(b){if(k.enabled&&b&&b instanceof RightNow.Event.EventObject){this.options=a.merge(this.options,b.data.data);this.options.params=a.merge(this.options.params,this.widgetData);"page"in this.options&&(this.Y.Object.isEmpty(this.filters)&&(this.filters=this.initialFilters),this.filters.page=this.options.page);for(var c in b.data.update)this.filters[c]=b.data.update[c];b=h.getFilterUrl(this.filters);b=RightNow.Url.addParameter(b,"session",RightNow.Url.getSession());k.addState(b,null,!0)}}});this._addEventHandler("updateFilters");this._addEventHandler("reset");this.on("reset",function(){this.filters=this.initialFilters;this.page=0},this)},setOptions:function(a){a&&this.sourceID in a&&a[this.sourceID]&&(a=a[this.sourceID]);this.options=this.Y.mix(this.options,a,!0);return this}}});b.prototype={on:d("on"),fire:d("fire"),setOptions:d("setOptions")};return{SearchSource:e,MultipleSourcesWrapper:b,RefreshSources:function(b){var c,d;for(d in b)b.hasOwnProperty(d)&&(c=a(d))&&c.fire("response",new RightNow.Event.EventObject(null,{data:b[d].response})).fire("updateFilters",new RightNow.Event.EventObject(null,{data:b[d].filters}))},get:a,getSearchSources:function(a){return a?(a+"").split(","):[]},add:function(a,b){if(a&&RightNow.isInstance(b,e)&&!c[a])return c[a]=b}}}();RightNow.SearchConsumer=RightNow.Widgets.extend({constructor:function(){var a=f.getSearchSources(this.data.attrs.source_id),b=f.get(a[0]);1<a.length&&RightNow.UI.DevelopmentHeader.addJavascriptError("A search consumer cannot have more than one search source");b||(b=new f.SearchSource(this.Y,a[0]),f.add(a[0],b));this.searchSource=function(){return b}}});RightNow.SearchProducer=RightNow.Widgets.extend({constructor:function(){for(var a=f.getSearchSources(this.data.attrs.source_id),b=[],d=0,c;d<a.length;d++)c=c=f.get(a[d]),c||(c=new f.SearchSource(this.Y,a[d]),f.add(a[d],c)),b.push(c);if(!b.length)throw Error("No search sources were given");c=1===b.length?c:new f.MultipleSourcesWrapper(b);this.searchSource=function(){return c}}})})();
RightNow.ProductCategory=RightNow.EventProvider.extend({initializeTreeView:function(a){this.dataType=a;this.displayField||(this.displayField=this.Y.one(this.baseSelector+"_"+this.dataType+"_Button"));this.buildPanel();this.Y.one(this.baseSelector+"_LinksTrigger").on("click",this.showAccessibleView,this);RightNow.Event.on("evt_accessibleTreeViewGetResponse",this.getAccessibleTreeViewResponse,this);RightNow.Event.on("evt_menuFilterGetResponse",this.getSubLevelResponse,this);this.data.js.hierData&&this.data.js.hierData[0]&&this.data.js.hierData[0].length&&this.buildTree()},buildPanel:function(){this.dropdown=new this.Y.RightNowTreeViewDropdown({srcNode:this.Y.one(this.baseSelector+"_TreeContainer").removeClass("rn_Hidden"),render:this.Y.one(this.baseSelector),trigger:this.displayField,visible:!1});this.dropdown.once("show",this.Y.bind(this.buildTree,this,!1));this.dropdown.on("show",function(){this.tree.focusOnSelectedNode()},this)},buildTree:function(a){if(!this.tree||a){this.tree&&this.tree.clear();this.data.js.linkingOn&&"Category"===this.dataType&&this.data.js.link_map[0]&&(this.data.js.hierData=this.data.js.link_map);this.tree=new this.Y.RightNowTreeView({hierarchyData:this.data.js.hierData,contentBox:this.Y.one(this.baseSelector+"_Tree").setStyles({"overflow-y":"auto",display:"block"})});this.tree.render();this.data.js.hierData&&this.data.js.hierDataNone&&delete this.data.js.hierData;this.tree.on("enterKey",this.selectNode,this);this.tree.on("dynamicNodeExpand",this.getSubLevelRequest,this);if(this.data.attrs.show_confirm_button_in_dialog)this.dropdown.set("confirmButton",this.Y.one(this.baseSelector+"_"+this.data.js.data_type+"_ConfirmButton")),this.dropdown.set("cancelButton",this.Y.one(this.baseSelector+"_"+this.data.js.data_type+"_CancelButton")),this.dropdown.on("confirm",function(){this.selectNode(this.tree.getFocusedNode())},this),this.Y.one(this.baseSelector+"_TreeContainer").setStyle("display","block");else this.tree.on("click",this.selectNode,this);this.tree.get("value")&&this.displaySelectedNodesAndClose(!1);this.dropdown.set("treeView",this.tree)}},pruneNonPermissionedAccessibleNodes:function(a){this.checkIdsAreValid("readableProdcatIds");if(0===this.data.js.readableProdcatIds.length)return a;var b=[];this.Y.Array.each(a,function(a){(this.checkPermissionsOnNode(a[1])||this.hasPermissionedAccessibleChildren(a))&&b.push(a)},this);return b},hasPermissionedAccessibleChildren:function(a){return this.checkForPermissionedChildren(a[1],a.level+1)},hasPermissionedChildren:function(a,b){return a.hasChildren?this.checkForPermissionedChildren(a.id,b):!1},checkForPermissionedChildren:function(a,b){if(!(this.data&&this.data.js&&this.data.js.readableProdcatIds&&this.Y.Lang.isArray(this.data.js.readableProdcatIds)))throw Error("Widget does not have this.data.js.readableProdcatIds attribute set, or its value is not an array");if(0===this.data.js.readableProdcatIds.length)return!0;var c="Level"+b;return this.Y.Array.some(this.data.js.permissionedProdcatList,function(b){if(b[c]===a&&b.ID!==a)return!0},this)},checkPermissionsOnNode:function(a){var b=this.data.js.permissionedProdcatIds&&this.Y.Lang.isArray(this.data.js.permissionedProdcatIds),c=this.data.js.readableProdcatIds&&this.Y.Lang.isArray(this.data.js.readableProdcatIds);if(!b&&!c)throw Error("Widget has neither this.data.js.readableProdcatIds or this.data.js.permissionedProdcatIds set, or their values are not an array.");return b&&0===this.data.js.permissionedProdcatIds.length||c&&0===this.data.js.readableProdcatIds.length?!0:b?this.isPermissionedNode(a):this.isReadableNode(a)},isPermissionedNode:function(a){return this.userHasFullProdcatPermissions()?!0:-1!==this.Y.Array.indexOf(this.data.js.permissionedProdcatIds,parseInt(a,10))},userHasFullProdcatPermissions:function(){this.checkIdsAreValid("permissionedProdcatIds");return"None"===this.data.attrs.verify_permissions||0===this.data.js.permissionedProdcatIds.length},isReadableNode:function(a){this.checkIdsAreValid("readableProdcatIds");return 0===this.data.js.readableProdcatIds.length?!0:-1!==this.Y.Array.indexOf(this.data.js.readableProdcatIds,parseInt(a,10))},disableNonPermissionedAccessibleNodes:function(a){this.checkIdsAreValid("readableProdcatIds");if(0!==this.data.js.readableProdcatIds.length&&this.data.attrs.label_selection_not_valid){var b;this.Y.Array.each(a,function(a){this.checkPermissionsOnNode(a[1])||(b=this.Y.one(this.baseSelector+"_AccessibleLink_"+a[1]),b.setHTML(RightNow.Text.sprintf(this.data.attrs.label_selection_not_valid,b.getHTML())))},this)}},disableNonPermissionedNodes:function(a){this.checkIdsAreValid("readableProdcatIds");0!==this.data.js.readableProdcatIds.length&&this.Y.Array.each(a,function(a){this.checkPermissionsOnNode(a.id)||this.Y.one("#ygtvlabelel"+this.tree.getNodeByValue(a.id).index).addClass("rn_Disabled")},this)},onAccessibleLinkClick:function(a){var b=a.valueChain[a.valueChain.length-1];this.tree.expandAndCreateNodes(a.valueChain);this.checkPermissionsOnNode(b)&&this.dialog.hide()},showAccessibleView:function(a){a.halt();this._eo||(this._eo=new RightNow.Event.EventObject(this));"Category"===this.dataType&&this.data.js.linkingOn&&(this._eo.data.linkingProduct=RightNow.UI.Form.currentProduct);this.dialog?this.displayAccessibleDialog():RightNow.Event.fire("evt_accessibleTreeViewRequest",this._eo)},getAccessibleTreeViewResponse:function(a,b){b=b[0];if(b.w_id===this._eo.w_id&&b.data.hm_type===this._eo.data.hm_type){var c=b.data.accessibleLinks;if("prod_chain"in c){c=[];delete b.data.accessibleLinks.prod_chain;for(var d in b.data.accessibleLinks)c.push(b.data.accessibleLinks[d])}c.unshift({0:this.data.attrs.label_all_values,1:0,hier_list:0,level:0});c=this.pruneNonPermissionedAccessibleNodes(c);this.createAccessibleDialog(c);this.buildTree();this.displayAccessibleDialog();this.disableNonPermissionedAccessibleNodes(c)}},createAccessibleDialog:function(a){this.dialog&&this.dialog.destroy();var b="Product"===this.dataType?RightNow.Interface.getMessage("SELECT_BELOW_USING_LINKS_PROVIDED_MSG"):RightNow.Interface.getMessage("CATEGORY_BELOW_USING_LINKS_PROVIDED_MSG"),c=RightNow.Interface.getMessage("DEPTH_ANNOUNCED_NAVIGATE_THROUGH_LIST_MSG");this.dialog=new this.Y.RightNowTreeViewDialog({id:"rn_"+this.instanceID,hierarchyData:a,contentBox:this.Y.one(this.baseSelector+"_Links"),dismissLabel:RightNow.Interface.getMessage("CANCEL_CMD"),titleLabel:this.data.attrs.label_nothing_selected,introLabel:b+" "+c,selectionPlaceholderLabel:RightNow.Interface.getMessage("SELECTION_PCT_S_ACTIVATE_LINK_JUMP_MSG"),levelLabel:this.data.attrs.label_level,noItemSelectedLabel:this.data.attrs.label_all_values});this.dialog.on("selectionMade",this.onAccessibleLinkClick,this);this.dialog.render()},displayAccessibleDialog:function(){this.dialog.set("selectedValue",this.tree.get("value"));this.dialog.set("selectedLabels",this.tree.get("labelChain"));this.dialog.show();var a=this.Y.one("p.rn_Intro a");a&&a.focus()},displaySelectedNodesAndClose:function(a){this._eo||(this._eo=new RightNow.Event.EventObject(this));this._eo.data.hierChain=this.tree.get("valueChain");RightNow.Event.fire("evt_productCategoryFilterSelected",this._eo);delete this._eo.data.hierChain;var b=this.tree.get("valueChain"),c=this.data.attrs.label_nothing_selected,d=this.data.attrs.label_nothing_selected;this.dropdown.hide();b[0]&&(c=this.tree.get("labelChain").join("<br>"),d=this.data.attrs.label_screen_reader_selected+c);this.dropdown.set("triggerText",c);this.Y.all(this.baseSelector+"_TreeDescription").setHTML(d);if(a&&!this.dialog)try{this.dropdown.get("trigger").focus()}catch(e){}},selectNode:function(a){this.displaySelectedNodesAndClose(!0)},getSubLevelRequest:function(a){if(!this._nodeBeingExpanded){this._nodeBeingExpanded=!0;if(a=this.getSubLevelRequestEventObject(a))"Product"===this.dataType&&(RightNow.UI.Form.currentProduct=a.data.value),this._requesting=a.data.value,RightNow.Event.fire("evt_menuFilterRequest",a);this._nodeBeingExpanded=!1;this._eo.data.link_map&&delete this._eo.data.link_map}},getSubLevelRequestEventObject:function(a){return new RightNow.Event.EventObject(this,{data:{level:a.depth+1,value:a.value,label:a.label,cache:{}}})},getSubLevelResponse:function(a,b){this.data.js.link_map&&delete this.data.js.link_map;var c=a.data.level,d=a.data.hier_data,e,d=this.groomProdcats(d);this.buildTree();!a.data.reset_linked_category&&this.getSubLevelRequestEventObject._origRequest&&this.getSubLevelRequestEventObject._origRequest[b]?e=this.getSubLevelRequestEventObject._origRequest[b]:a.data.reset_linked_category&&(this.tree.clear(this.data.attrs.label_all_values),this.dialog=null,this.selectNode(this.tree.getRoot()));7>c&&this.insertChildrenForNode(d,e);0===d.length&&this.displaySelectedNodesAndClose()},insertChildrenForNode:function(a,b){this.tree.insertChildHierarchyData(a,b)},removeNonReadableProdcats:function(a){this.checkIdsAreValid("readableProdcatIds");var b=this.data;return this.Y.Array.filter(a,function(a){if(-1!==this.Y.Array.indexOf(b.js.readableProdcatIds,a.id))return a},this)},updateProdcatsHasChildrenAttribute:function(a){this.checkIdsAreValid("readableProdcatIdsWithChildren");var b=this.data;return this.Y.Array.map(a,function(a){a.hasChildren=-1!==this.Y.Array.indexOf(b.js.readableProdcatIdsWithChildren,a.id)?!0:!1;return a},this)},groomProdcats:function(a){!1!==this.data.attrs.verify_permissions&&"None"!==this.data.attrs.verify_permissions&&0<this.data.js.readableProdcatIds.length&&(a=this.removeNonReadableProdcats(a),a=this.updateProdcatsHasChildrenAttribute(a));return a},checkIdsAreValid:function(a){if(!(this.data&&this.data.js&&this.data.js[a]&&this.Y.Lang.isArray(this.data.js[a])))throw Error("Widget does not have this.data.js."+a+" attribute set, or its value is not an array");}});
RightNow.Widgets.SourceSearchField=RightNow.SearchProducer.extend({overrides:{constructor:function(){this.parent();this.input=this.Y.one(this.baseSelector+'_SearchInput');if(this.data.attrs.initial_focus){this.input.focus();}
this.searchSource().on('collect',this.onCollect,this).on('updateFilters',this.onFilterUpdate,this).on('reset',this.onReset,this);RightNow.Event.subscribe('evt_getSearchField',function(){RightNow.Event.fire("evt_sendSearchField",new RightNow.Event.EventObject(this,{data:this.input}));},this);}},onCollect:function(){var searchTerm="";var keywordEntered=this.Y.Lang.trim(this.input.get('value'));if(this.data.attrs.allow_empty_search&&!keywordEntered){searchTerm="*";}
else if(keywordEntered){searchTerm=keywordEntered;}
this.searchSource().setOptions({page:{key:"page",type:"page",value:1}});return new RightNow.Event.EventObject(this,{data:this.Y.merge(this.data.js.filter,{value:searchTerm})});},onFilterUpdate:function(e,eo){this.Y.Object.some(eo[0].data,function(filter){if(filter.key===this.data.js.filter.key){var filterValue=this.Y.Node.create('<textarea>'+filter.value+'</textarea>').get('innerText');this.input.set('value',(filter.value!=='*')?filterValue:'');return true;}},this);},onReset:function(){this.input.set('value',this.data.js.prefill);}});
RightNow.Widgets.SourceSearchButton=RightNow.SearchProducer.extend({overrides:{constructor:function(){this.parent();this.searchButton=this.Y.one(this.baseSelector+"_SubmitButton");RightNow.Event.subscribe("evt_sendSearchField",function(evt,evtData){this.searchField=evtData[0].data;this.search();},this);if(this.searchButton){this.enableClickListener();this.searchSource().setOptions(this.searchOptions()).setOptions(this.data.js.sources).on('response',this.enableClickListener,this);}}},searchOptions:function(){return this._searchOptions||(this._searchOptions={new_page:this.data.attrs.search_results_url,target:this.data.attrs.target,limit:this.data.attrs.per_page});},search:function(e){if(e)
e.halt();if(!this.searchField){RightNow.Event.fire("evt_getSearchField",new RightNow.Event.EventObject(this));return;}
if(this.searchInProgress)return;this.searchSource().fire('collect');if(this.searchSource().multiple){this.filters=this.searchSource().sources[0].filters;}
else{this.filters=this.searchSource().filters;}
if(this.filters.query&&this.Y.Lang.trim(this.filters.query.value)!==''){if(this.filters.query.key==="kw"&&this.Y.Lang.trim(this.filters.query.value)==="*"){this.filters.direction=this.filters.direction||{};this.filters.direction.value=0;this.filters.sort=this.filters.sort||{};this.filters.sort.value=1;}
this.disableClickListener();this.searchSource().fire('search',new RightNow.Event.EventObject(this,{data:this.searchOptions()}));}
else{RightNow.UI.displayBanner(this.data.attrs.label_enter_search_keyword,{type:'WARNING',focusElement:this.searchField});}},enableClickListener:function(evt){this.searchInProgress=false;this.searchButton.set('disabled',false).on('click',this.search,this);if(evt){this.searchButton.focus();}},disableClickListener:function(){this.searchInProgress=true;this.searchButton.set('disabled',true).detach('click',this.search,this);}});
RightNow.Widgets.SourceResultDetails=RightNow.SearchConsumer.extend({overrides:{constructor:function(){this.parent();this.searchSource().on('response',this.onSearchComplete,this);}},onSearchComplete:function(evt,args){this.Y.one(this.baseSelector).setHTML(this.getResultText(args[0].data));},getResultText:function(result){if(!result.size)return'';var label=(result.total&&this.data.attrs.label_known_results)?this.data.attrs.label_known_results:this.data.attrs.label_results;return RightNow.Text.sprintf(label,result.offset+1,result.offset+result.size,result.total);}});
RightNow.Widgets.SourcePagination=RightNow.SearchProducer.extend({overrides:{constructor:function(){this.parent();this.Y.one(this.baseSelector).delegate('click',this.onPageClick,'a',this);this.searchSource().setOptions(this.data.js.sources).on('response',this.onSearchComplete,this);}},onPageClick:function(e){e.halt();var pageNumber=this.determinePageNumber(e.currentTarget.getAttribute('data-rel'));if(pageNumber){this.data.js.filter.value=pageNumber;this.triggerSearch();}},triggerSearch:function(){this.searchSource().fire('search',new RightNow.Event.EventObject(this,{data:{page:this.data.js.filter,sourceCount:1}}));},determinePageNumber:function(domPageValue){if(!domPageValue||domPageValue==this.data.js.currentPage)return;if(domPageValue==='next'){return this.data.js.filter.value+1;}
if(domPageValue==='previous'){return this.data.js.filter.value-1;}
return parseInt(domPageValue,10);},onSearchComplete:function(evt,args){var result=args[0].data;this.data.js.currentPage=result.filters.page.value;if(result.filters.page.value!==this.data.js.filter.value){this.data.js.filter.value=result.filters.page.value;}
var previousLink=this.renderPreviousLink(result),nextLink=this.renderNextLink(result),pages=this.renderPageLinks(result);this.Y.one(this.baseSelector+' ul').setHTML(previousLink+pages+nextLink);},renderPreviousLink:function(result){if(this.data.js.filter.value<=1||!result.size)return'';var previousPage=this.data.js.filter.value-1;return new EJS({text:this.getStatic().templates.navigationLink}).render({href:this.url(previousPage),rel:'previous',label:RightNow.Interface.getMessage('PREVIOUS_LBL'),className:'rn_PreviousPage'});},renderNextLink:function(result){if(result.total>result.size&&result.offset+result.size<result.total){var nextPage=this.data.js.filter.value+1;return new EJS({text:this.getStatic().templates.navigationLink}).render({href:this.url(nextPage),rel:'next',label:RightNow.Interface.getMessage('NEXT_LBL'),className:'rn_NextPage'});}
return'';},renderPageLinks:function(result){var numberOfPages=result.size?Math.ceil(result.total/this.data.js.limit):0;if(numberOfPages<=1)return'';return new EJS({text:this.getStatic().templates.pageLink}).render({numberOfPages:numberOfPages,currentPage:this.data.js.filter.value,label_page:this.data.attrs.label_page,label_current_page:this.data.attrs.label_current_page,filter:this.data.js.filter,paginationLinkTitle:this.Y.bind(this.paginationLinkTitle,this),pageLink:this.Y.bind(this.url,this),shouldShowPageNumber:this.Y.bind(this.shouldShowPageNumber,this),shouldShowHellip:this.Y.bind(this.shouldShowHellip,this)});},url:function(pageNumber){return RightNow.Url.addParameter(window.location.href,this.data.js.filter.key,pageNumber);},shouldShowHellip:function(pageNumber,currentPage,endPage){return Math.abs(pageNumber-currentPage)===((currentPage===1||currentPage===endPage)?3:2);},shouldShowPageNumber:function(pageNumber,currentPage,endPage){return pageNumber===1||(pageNumber===endPage)||(Math.abs(pageNumber-currentPage)<=((currentPage===1||currentPage===endPage)?2:1));},paginationLinkTitle:function(labelPage,pageNumber,endPage){return RightNow.Text.sprintf(labelPage,pageNumber,endPage);}});
RightNow.Widgets.MobileSourceProductCategorySearchFilter=RightNow.SearchProducer.extend({overrides:{constructor:function(){this.parent();this.Y.augment(this,RightNow.ProductCategory);this._selections=[];this._currentLevel=1;this._currentScreenIndex=1;this._baseID=this.baseSelector+"_"+this.data.attrs.filter_type;this.Y.Event.attach("click",this.openDialog,this._baseID+"_Launch",this);this.Y.Event.attach("click",function(){this.clearSelection();if(this.data.js.linkingOn&&this.data.attrs.filter_type==="Product"){RightNow.Event.fire("evt_menuFilterRequest",this.updateEventObject({data:{level:this._currentLevel,value:-1}}));}},this._baseID+"_FilterRemove",this);if(this.data.js.initial){this._somethingWasSelected=true;for(var i=0;i<this.data.js.initial.length;i++){this._selections.push({value:this.data.js.initial[i].id,label:this.Y.Escape.html(this.data.js.initial[i].label)});}
this.commitSelection(this._selections);}
RightNow.Event.subscribe("evt_menuFilterGetResponse",this.getSubLevelResponse,this);this.searchSource(this.data.attrs.report_id).on('collect',this.collectFilters,this).on("response",this.onSearchResponse,this).on('reset',this.onReset,this);this.initializeEventObject();}},openDialog:function(){(this._dialog||this.createDialog());this._dialog.show();},createDialog:function(element){element||(element=this.Y.one(this._baseID+"_Level1Input"));if(!element)return;this._dialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_prompt,element,{navButtons:true,cssClass:"rn_MobileSourceProductCategorySearchFilter"});this._dialog.backEvent.subscribe(function(){this._currentLevel=Math.max(this._currentLevel-1,1);this._currentScreenIndex=Math.max(this._currentScreenIndex-1,1);},this,true);this._dialog.hideEvent.subscribe(function(){if(this._currentLevel===1&&!this._somethingWasSelected&&this._selections.length){this.clearSelection();if(this.data.js.linkingOn&&this.data.attrs.filter_type==="Product"){RightNow.Event.fire("evt_menuFilterRequest",this.updateEventObject({data:{level:this._currentLevel,value:-1}}));}}},this,true);element.removeClass("rn_Hidden").delegate("click",this.getSubLevelRequest,"input",this);},selectionAllMade:function(parentSelected){this.selectionMade(parentSelected);if(this.data.js.linkingOn&&this.data.attrs.filter_type==="Product"){this._currentScreenIndex--;RightNow.Event.fire("evt_menuFilterRequest",this._eo);}},selectionMade:function(parentSelected){if(this._selections.length===0)return;var index=0,filterDiv=this.Y.one(this._baseID+"_Filters"),eventData=[],eventReconstructData=[];if(filterDiv){if(parentSelected){while(parentSelected!==this._selections[this._selections.length-1].value){this._selections.pop();}
this._currentValue=this._selections[this._selections.length-1].value;this._currentLevel=this._selections.length;}
filterDiv.set("innerHTML","");var anchor,urlParams="",selected,page=this.data.js.searchPage+'/'+this.data.js.filter.key+'/';do{if(this._selections[index].value){selected=((index===this._selections.length-1)?" rn_Selected":"");anchor=this.Y.Node.create("<a href='"+((!selected)?page+this._selections[index].value:'javascript:void(0);')+"'>"+this._selections[index].label+"</a>");anchor.set("className","rn_FilterItem"+selected);filterDiv.append(anchor);urlParams+=this._selections[index].value+",";eventReconstructData.push({value:this._selections[index].value,label:this._selections[index].label,url:urlParams});eventData.push(this._selections[index].value);}
index++;}
while(index<this._currentLevel&&this._selections[index]);}
this._somethingWasSelected=true;(this._dialog&&this._dialog.hide());this.Y.one(this._baseID+"_FilterRemove")[(this._selections[0].value)?"removeClass":"addClass"]("rn_Hidden");this.markSelectionInDialog();this.commitSelection(this._selections);this.updateEventObject({data:{level:this._currentLevel,value:this._currentValue},filters:{data:{0:eventData,reconstructData:eventReconstructData}}});this._eo.data.hierChain=this.getCommittedSelection(true);RightNow.Event.fire("evt_productCategoryFilterSelected",this._eo);delete this._eo.data.hierChain;if(this.data.attrs.search_on_select){this.searchSource().fire('collect').fire("search",this._eo);}},clearSelection:function(){this._selections=[{"value":0}];if(this._dialog){while(this._dialog.hasPreviousContent()){this._dialog.previousScreen();}}
this._currentLevel=1;this._currentScreenIndex=1;this._currentValue=0;this.selectionMade();},markSelectionInDialog:function(deselectAll){if(deselectAll){deselectAll.all("div").removeClass("rn_Selected");}
else{if(this._dialog&&this._dialog._panel&&this._dialog._panel.id){this.Y.one("#"+this._dialog._panel.id).all("div.rn_Selected").removeClass("rn_Selected");}
for(var i=0,currentValue,currentNode,length=this._selections.length+1,markSelection=(this._selections[0]&&this._selections[0].value),apply=function(node){node.removeClass("rn_Selected");if(markSelection&&parseInt(node.one("input").get("value"),10)===currentValue){node.addClass("rn_Selected");}};i<length;i++){currentValue=(this._selections[i])?this._selections[i].value:this._selections[this._selections.length-1].value;currentNode=this.Y.one(this._baseID+"_Level"+(i+1)+"Input"+((i===0)?"":"_"+this._selections[i-1].value));if(currentNode){currentNode.all("div").each(apply);}}}},getSubLevelRequest:function(clickEvent){if(!this._beingSelected){this.toggleLoadingIcon(clickEvent.target);var input=clickEvent.target,label=input.next("label"),hasChildren;if(label&&label.get("innerHTML")){hasChildren=label.hasClass("rn_HasChildren");this._currentLabel=this.Y.Lang.trim(label.get("childNodes").item(0).get("text"));}
this._currentValue=parseInt(input.get("value"),10);this._selections=this._selections.slice(0,this._currentScreenIndex-1);this._selections.push({value:this._currentValue,label:this.Y.Escape.html(this._currentLabel)});this._currentLevel=this._selections.length;if(this.data.js.linkingOn&&this.data.attrs.filter_type==="Product"){this._currentValue=this._currentValue||-1;this._backButtonLabel=(this._currentLevel===1)?this.data.attrs.label_filter_type:this._selections[this._currentLevel-2].label;RightNow.Event.fire("evt_menuFilterRequest",this.updateEventObject({data:{level:this._currentLevel,value:this._currentValue}}));if(!hasChildren){this.selectionMade();}
this.toggleLoadingIcon(clickEvent.target);return;}
if(!hasChildren){this.selectionMade();this.toggleLoadingIcon();}
else if(this._currentValue){this._backButtonLabel=(this._currentLevel===1)?this.data.attrs.label_filter_type:this._selections[this._currentLevel-2].label;RightNow.Event.fire("evt_menuFilterRequest",this.updateEventObject({data:{level:this._currentLevel,value:this._currentValue}}));if(this._eo.data.link_map)
delete this._eo.data.link_map;}}},buildDialogContent:function(data,level){if(data.length&&level<7&&this._dialog){var id=this._baseID+"_Level"+level+"Input_"+this._currentValue,existingElement=this.Y.one(id);this._currentScreenIndex++;if(existingElement){var committedSelections=this.getCommittedSelection();var isSameSelection=false;for(var i in committedSelections){if(committedSelections[i].value===this._currentValue){isSameSelection=true;break;}}
if(!isSameSelection&&!(committedSelections.length+1===this._currentLevel&&committedSelections[committedSelections.length-1].value===this._currentValue)){this.markSelectionInDialog(existingElement);}
this._dialog.showScreen(id);}
else{data.unshift({id:this._currentValue,label:RightNow.Text.sprintf(RightNow.Interface.getMessage("ALL_PCT_S_LBL"),this._currentLabel)});var currentSelections=this.getCommittedSelection(),alreadySelected=(currentSelections[level-1])?currentSelections[level-1].value:(currentSelections[level-2]?currentSelections[level-2].value:false),form=new EJS({text:this.getStatic().templates.view}).render({inputID:id.substr(1),labelID:(this._baseID+"_Level"+level+"Label_"+this._currentValue).substr(1),level:level,data:data,alreadySelected:alreadySelected,parentAlt:this.data.attrs.label_parent_menu_alt,escapeHtml:this.Y.Escape.html});this._dialog.nextScreen(form,null,this._backButtonLabel);var allItem=this.Y.one(id).one('input');this.Y.one(id).delegate("click",function(e){if(e.target.compareTo(allItem)){this.selectionAllMade(data[0].id);}
else{this.getSubLevelRequest(e);}},"input",this);}}},buildLinkedCategoryContent:function(level,data,selectedItem){var id=this._baseID+"_Level1Input",firstLevelItems=document.getElementById(id.substr(1)),element;if(this._dialog&&firstLevelItems){firstLevelItems=this.Y.one(firstLevelItems);element=firstLevelItems.next();while(element){this._dialog.previousScreen();element.remove();element=firstLevelItems.next();}
firstLevelItems.remove();}
data.unshift({id:0,label:RightNow.Text.sprintf(this.data.attrs.label_all_values,this._currentLabel)});firstLevelItems=this.Y.Node.create(new EJS({text:this.getStatic().templates.view}).render({inputID:id.substr(1),labelID:(this._baseID+"_Level"+level+"Label_"+this._currentValue).substr(1),level:level,data:data,alreadySelected:selectedItem,parentAlt:this.data.attrs.label_parent_menu_alt,escapeHtml:this.Y.Escape.html}));this.createDialog(firstLevelItems);return firstLevelItems;},getSubLevelResponse:function(type,args){var evtObj=args[0];if((evtObj.w_id&&evtObj.w_id===this.instanceID)||(this.data.js.linkingOn&&evtObj.data.data_type==="Category"&&this.data.attrs.filter_type===evtObj.data.data_type)){if(evtObj.data.reset_linked_category){if(this.data.js.linkMap)
delete this.data.js.linkMap;if(!evtObj.data.hier_data.length){this.clearSelection();this.Y.one(this.baseSelector).setStyle("visibility","hidden");}
else{evtObj.data.hier_data=this.groomProdcats(evtObj.data.hier_data);if(this._selections.length){var currentSelections=this._selections.slice(0),currentIndex=0;for(var i=0,firstItem=this._selections[0].value,newData=evtObj.data.hier_data,stillSelected;i<newData.length;i++){if(newData[i].id===firstItem){stillSelected=firstItem;break;}}
if(!stillSelected){this.clearSelection();this.buildLinkedCategoryContent(1,evtObj.data.hier_data,stillSelected);}
else{var firstLevelItems=this.buildLinkedCategoryContent(1,evtObj.data.hier_data,stillSelected),baseID=this._baseID,thisY=this.Y,firstSelectedNode=firstLevelItems.one("input[value='"+firstItem+"']"),followTree=function(input){if(!input)
return;currentIndex++;var thisRoot=baseID+"_Level"+currentIndex+"Input_"+currentSelections[currentIndex-2].value,thisRootNode=thisY.one(thisRoot),selectedNode;if(currentIndex>currentSelections.length){if(thisRootNode&&(selectedNode=thisRootNode.one("input[value='"+currentSelections[currentIndex-2].value+"']")))
selectedNode.getDOMNode().click();return;}
if(thisRootNode&&(selectedNode=thisRootNode.one("input[value='"+currentSelections[currentIndex-2].value+"']")))
selectedNode.getDOMNode().click();if(thisRootNode&&(selectedNode=thisRootNode.one("input[value='"+currentSelections[currentIndex-1].value+"']"))){selectedNode.getDOMNode().click();followTree(selectedNode);}};if(firstSelectedNode){currentIndex++;firstSelectedNode.getDOMNode().click();followTree(firstSelectedNode);}}}
else{this._buildLinkedCategoryContent(1,evtObj.data.hier_data);}
this.Y.one(this.baseSelector).setStyle("visibility","visible");}
return;}
this._currentLevel=(evtObj.data.hier_data.length)?evtObj.data.level:this._currentLevel;if(evtObj.data.hier_data.length===0){this.selectionMade();}
else{evtObj.data.hier_data=this.groomProdcats(evtObj.data.hier_data);this.buildDialogContent(evtObj.data.hier_data,this._currentLevel);}
this.toggleLoadingIcon();}},commitSelection:function(selection){this._committedSelection=RightNow.Lang.cloneObject(selection);},getCommittedSelection:function(justValues){if(justValues&&this._committedSelection){for(var i=0,values=[];i<this._committedSelection.length;i++){values.push(this._committedSelection[i].value);}
return values;}
return this._committedSelection||[];},onSearchResponse:function(type,args){if(this.data.js.linkingOn&&this.data.attrs.filter_type==="Product"&&typeof this._currentValue!=="undefined"){RightNow.Event.fire("evt_menuFilterRequest",this.updateEventObject({data:{level:this._currentLevel,value:this._currentValue||-1}}));}},updateEventObject:function(options){var widgetData=this.data.js;if(!this._initialized){this._eo=new RightNow.Event.EventObject(this,{data:{key:widgetData.filter.key,type:widgetData.filter.type,cache:[],hm_type:widgetData.hm_type,data_type:this.data.attrs.filter_type,linking_on:widgetData.linkingOn,linkingProduct:0},filters:{rnSearchType:"menufilter",searchName:widgetData.searchName,report_id:this.data.attrs.report_id,fltr_id:widgetData.fltr_id,oper_id:widgetData.oper_id,data:[]}});if(widgetData.initial){for(var i=0,length=widgetData.initial.length,initialVals=[];i<length;i++){initialVals.push(widgetData.initial[i].id);}
this._eo.filters.data[0]=initialVals;}
else{this._eo.filters.data[0]=[];}
this.updateEventObject._updateVals=function(origArray,properties){for(var i in properties){if(properties.hasOwnProperty(i)){origArray[i]=properties[i];}}};this._initialized=true;}
if(options){if(options.data){this.updateEventObject._updateVals(this._eo.data,options.data);}
if(options.filters&&options.filters.data){this.updateEventObject._updateVals(this._eo.filters.data,options.filters.data);}}
if(widgetData.linkMap){this._eo.data.link_map=widgetData.linkMap;delete widgetData.linkMap;}
return this._eo;},eventObjectCreated:function(){return this._initialized;},toggleLoadingIcon:function(toggleNode){if(toggleNode&&!toggleNode.hasClass('rn_LoadingIcon')){this._beingSelected=true;this.Y.one(toggleNode).next().addClass('rn_LoadingIcon');}
else{this._beingSelected=false;var existingLoadingIcon=this.Y.one('.rn_MobileSourceProductCategorySearchFilter .rn_LoadingIcon');if(existingLoadingIcon){existingLoadingIcon.removeClass('rn_LoadingIcon');}}},collectFilters:function(){return this._eo;},onReset:function(){if(this.tree){this.tree.selectNodeWithValue(this.data.js.initial[this.data.js.initial.length-1]||0);this.displaySelectedNodesAndClose();}},initializeEventObject:function(){this._eo=new RightNow.Event.EventObject(this,{data:this.Y.merge(this.data.js.filter,{data_type:this.dataType=this.data.attrs.filter_type,new_page:this.data.attrs.search_results_url,linking_on:this.data.js.linkingOn,hm_type:this.data.js.hm_type,cache:[]})});if(this.dataType==="Product"){RightNow.UI.Form.currentProduct=this.data.js.initial[this.data.js.initial.length-1];}}});
RightNow.Widgets.SourceFilter=RightNow.SearchProducer.extend({overrides:{constructor:function(){this.parent();this.input=this.Y.one(this.baseSelector+'_Dropdown');this.initialValue=this.data.js.filter.value;if(this.data.attrs.initial_focus){this.input.focus();}
this.searchSource().on('collect',this.onCollect,this).on('updateFilters',this.onFilterUpdate,this).on('reset',this.onReset,this);if(this.data.attrs.search_on_select){this.input.on('change',this.onChange,this);}}},onChange:function(){this.searchSource().setOptions({page:{key:"page",type:"page",value:1}}).fire('collect').fire('search');},onCollect:function(){var value=this.input.get('value');if(value=='0'||value=='-1'){value='';}
return new RightNow.Event.EventObject(this,{data:this.Y.merge(this.data.js.filter,{value:value})});},onFilterUpdate:function(e,eo){this.Y.Object.each(eo[0].data,function(filter){if(filter.key===this.data.js.filter.key){this.input.set('value',filter.value);}},this);},onReset:function(){this.input.set('value',this.initialValue);}});
RightNow.Widgets.SourceResultListing=RightNow.SearchConsumer.extend({overrides:{constructor:function(){this.parent();this._contentDiv=this.Y.one(this.baseSelector+"_Content");if(!this._contentDiv)return;var searchSourceOptions={endpoint:this.data.attrs.search_results_ajax}
if('per_page'in this.data.attrs){searchSourceOptions.limit=this.data.attrs.per_page;}
this.searchSource().setOptions(searchSourceOptions).on('search',this.searchInProgress,this).on('response',this.onSearchComplete,this).fire('initializeFilters',new RightNow.Event.EventObject(this,{data:this.data.js.filters}));}},onSearchComplete:function(e,result){var results=result[0].data;this.updateLoadingIndicators(false);this.updateAriaAlert(results&&results.total);RightNow.Url.transformLinks(this._contentDiv.setHTML(results.html));this.updateMoreLink(results);if(this.data.attrs.hide_when_no_results){this.Y.one(this.baseSelector).toggleClass('rn_Hidden',!results.total);}},searchInProgress:function(){this._contentDiv.setHTML('');this.updateLoadingIndicators(true);},updateMoreLink:function(results){if(!this.data.attrs.more_link_url)return;var label=this.data.attrs.label_heading?(this.data.attrs.label_more_link+' '+this.data.attrs.label_heading):this.data.attrs.label_more_link;var link=(results.total>0&&results.total>results.filters.limit.value)?new EJS({text:this.getStatic().templates.moreResultsLink}).render({href:this.addSearchParametersToUrl(this.data.attrs.more_link_url,results.filters),label:label}):'';this.Y.one(this.baseSelector+' .rn_AdditionalResults').setHTML(link);},addSearchParametersToUrl:function(url,filters){this.Y.Object.each(filters,function(filter){if(filter.key&&filter.value){url=RightNow.Url.addParameter(url,filter.key,filter.value);}});return RightNow.Url.addParameter(url,'session',RightNow.Url.getSession());},updateLoadingIndicators:function(loading){var loadingState={toLoading:{ariaBusy:true,method:'addClass',opacity:0},fromLoading:{ariaBusy:false,method:'removeClass',opacity:1}},state=loadingState[loading?'toLoading':'fromLoading'];this._contentDiv.setStyle("height",loading?this._contentDiv.get("offsetHeight")+"px":"auto");document.body.setAttribute("aria-busy",state.ariaBusy+"");if(this.Y.UA.ie&&this.Y.UA.ie<11){this._contentDiv[state.method]("rn_Hidden");}
else{this._contentDiv[state.method]("rn_Loading");this._contentDiv.transition({opacity:state.opacity,duration:1.5});}},updateAriaAlert:function(newResults){var label=(newResults)?this.data.attrs.label_screen_reader_search_success_alert:this.data.attrs.label_screen_reader_search_no_results_alert;if(!label)return;this._ariaAlert=this._ariaAlert||this.Y.one(this.baseSelector+"_Alert");if(this._ariaAlert){this._ariaAlert.set("innerHTML",this.data.attrs.label_heading+' '+label);}}});

RightNow.Avatar=RightNow.Widgets.extend({constructor:function(){var d=new EJS({text:'<span class="rn_UserAvatar" title="<%= displayName %>"><span class="rn_Avatar <%= (className ? className : "rn_Medium") %> <%= (avatarUrl) ? "rn_Image" : "rn_Placeholder" %>"><% if(avatarUrl){%><img itemprop="image" src="<%= avatarUrl %>" height="<%= size %>" width="<%= size %>" alt=""/><%}else{%><span class="rn_Default rn_DefaultColor<%= color %>" aria-hidden="true" role="presentation"><span class="rn_Liner"><%= text %></span></span><%}%></span></span>'});EJS.Helpers.prototype.getDefaultAvatar=function(a){var b="?",c=0;a.displayName=RightNow.Text.stripTags(a.displayName);a.displayName&&(b=a.isActive?a.displayName.charAt(0).toUpperCase():"!",c=a.displayName.length);a.color=a.isActive?c%5:5;a.text=b;a.userID?a.isActive||(a.displayName=RightNow.Interface.getMessage("INACTIVE_LC_LBL")):a.displayName=RightNow.Interface.getMessage("UNKNOWN_LWR_LBL");return d.render(a)}}});
RightNow.ProductCategory=RightNow.EventProvider.extend({initializeTreeView:function(a){this.dataType=a;this.displayField||(this.displayField=this.Y.one(this.baseSelector+"_"+this.dataType+"_Button"));this.buildPanel();this.Y.one(this.baseSelector+"_LinksTrigger").on("click",this.showAccessibleView,this);RightNow.Event.on("evt_accessibleTreeViewGetResponse",this.getAccessibleTreeViewResponse,this);RightNow.Event.on("evt_menuFilterGetResponse",this.getSubLevelResponse,this);this.data.js.hierData&&this.data.js.hierData[0]&&this.data.js.hierData[0].length&&this.buildTree()},buildPanel:function(){this.dropdown=new this.Y.RightNowTreeViewDropdown({srcNode:this.Y.one(this.baseSelector+"_TreeContainer").removeClass("rn_Hidden"),render:this.Y.one(this.baseSelector),trigger:this.displayField,visible:!1});this.dropdown.once("show",this.Y.bind(this.buildTree,this,!1));this.dropdown.on("show",function(){this.tree.focusOnSelectedNode()},this)},buildTree:function(a){if(!this.tree||a){this.tree&&this.tree.clear();this.data.js.linkingOn&&"Category"===this.dataType&&this.data.js.link_map[0]&&(this.data.js.hierData=this.data.js.link_map);this.tree=new this.Y.RightNowTreeView({hierarchyData:this.data.js.hierData,contentBox:this.Y.one(this.baseSelector+"_Tree").setStyles({"overflow-y":"auto",display:"block"})});this.tree.render();this.data.js.hierData&&this.data.js.hierDataNone&&delete this.data.js.hierData;this.tree.on("enterKey",this.selectNode,this);this.tree.on("dynamicNodeExpand",this.getSubLevelRequest,this);if(this.data.attrs.show_confirm_button_in_dialog)this.dropdown.set("confirmButton",this.Y.one(this.baseSelector+"_"+this.data.js.data_type+"_ConfirmButton")),this.dropdown.set("cancelButton",this.Y.one(this.baseSelector+"_"+this.data.js.data_type+"_CancelButton")),this.dropdown.on("confirm",function(){this.selectNode(this.tree.getFocusedNode())},this),this.Y.one(this.baseSelector+"_TreeContainer").setStyle("display","block");else this.tree.on("click",this.selectNode,this);this.tree.get("value")&&this.displaySelectedNodesAndClose(!1);this.dropdown.set("treeView",this.tree)}},pruneNonPermissionedAccessibleNodes:function(a){this.checkIdsAreValid("readableProdcatIds");if(0===this.data.js.readableProdcatIds.length)return a;var b=[];this.Y.Array.each(a,function(a){(this.checkPermissionsOnNode(a[1])||this.hasPermissionedAccessibleChildren(a))&&b.push(a)},this);return b},hasPermissionedAccessibleChildren:function(a){return this.checkForPermissionedChildren(a[1],a.level+1)},hasPermissionedChildren:function(a,b){return a.hasChildren?this.checkForPermissionedChildren(a.id,b):!1},checkForPermissionedChildren:function(a,b){if(!(this.data&&this.data.js&&this.data.js.readableProdcatIds&&this.Y.Lang.isArray(this.data.js.readableProdcatIds)))throw Error("Widget does not have this.data.js.readableProdcatIds attribute set, or its value is not an array");if(0===this.data.js.readableProdcatIds.length)return!0;var c="Level"+b;return this.Y.Array.some(this.data.js.permissionedProdcatList,function(b){if(b[c]===a&&b.ID!==a)return!0},this)},checkPermissionsOnNode:function(a){var b=this.data.js.permissionedProdcatIds&&this.Y.Lang.isArray(this.data.js.permissionedProdcatIds),c=this.data.js.readableProdcatIds&&this.Y.Lang.isArray(this.data.js.readableProdcatIds);if(!b&&!c)throw Error("Widget has neither this.data.js.readableProdcatIds or this.data.js.permissionedProdcatIds set, or their values are not an array.");return b&&0===this.data.js.permissionedProdcatIds.length||c&&0===this.data.js.readableProdcatIds.length?!0:b?this.isPermissionedNode(a):this.isReadableNode(a)},isPermissionedNode:function(a){return this.userHasFullProdcatPermissions()?!0:-1!==this.Y.Array.indexOf(this.data.js.permissionedProdcatIds,parseInt(a,10))},userHasFullProdcatPermissions:function(){this.checkIdsAreValid("permissionedProdcatIds");return"None"===this.data.attrs.verify_permissions||0===this.data.js.permissionedProdcatIds.length},isReadableNode:function(a){this.checkIdsAreValid("readableProdcatIds");return 0===this.data.js.readableProdcatIds.length?!0:-1!==this.Y.Array.indexOf(this.data.js.readableProdcatIds,parseInt(a,10))},disableNonPermissionedAccessibleNodes:function(a){this.checkIdsAreValid("readableProdcatIds");if(0!==this.data.js.readableProdcatIds.length&&this.data.attrs.label_selection_not_valid){var b;this.Y.Array.each(a,function(a){this.checkPermissionsOnNode(a[1])||(b=this.Y.one(this.baseSelector+"_AccessibleLink_"+a[1]),b.setHTML(RightNow.Text.sprintf(this.data.attrs.label_selection_not_valid,b.getHTML())))},this)}},disableNonPermissionedNodes:function(a){this.checkIdsAreValid("readableProdcatIds");0!==this.data.js.readableProdcatIds.length&&this.Y.Array.each(a,function(a){this.checkPermissionsOnNode(a.id)||this.Y.one("#ygtvlabelel"+this.tree.getNodeByValue(a.id).index).addClass("rn_Disabled")},this)},onAccessibleLinkClick:function(a){var b=a.valueChain[a.valueChain.length-1];this.tree.expandAndCreateNodes(a.valueChain);this.checkPermissionsOnNode(b)&&this.dialog.hide()},showAccessibleView:function(a){a.halt();this._eo||(this._eo=new RightNow.Event.EventObject(this));"Category"===this.dataType&&this.data.js.linkingOn&&(this._eo.data.linkingProduct=RightNow.UI.Form.currentProduct);this.dialog?this.displayAccessibleDialog():RightNow.Event.fire("evt_accessibleTreeViewRequest",this._eo)},getAccessibleTreeViewResponse:function(a,b){b=b[0];if(b.w_id===this._eo.w_id&&b.data.hm_type===this._eo.data.hm_type){var c=b.data.accessibleLinks;if("prod_chain"in c){c=[];delete b.data.accessibleLinks.prod_chain;for(var d in b.data.accessibleLinks)c.push(b.data.accessibleLinks[d])}c.unshift({0:this.data.attrs.label_all_values,1:0,hier_list:0,level:0});c=this.pruneNonPermissionedAccessibleNodes(c);this.createAccessibleDialog(c);this.buildTree();this.displayAccessibleDialog();this.disableNonPermissionedAccessibleNodes(c)}},createAccessibleDialog:function(a){this.dialog&&this.dialog.destroy();var b="Product"===this.dataType?RightNow.Interface.getMessage("SELECT_BELOW_USING_LINKS_PROVIDED_MSG"):RightNow.Interface.getMessage("CATEGORY_BELOW_USING_LINKS_PROVIDED_MSG"),c=RightNow.Interface.getMessage("DEPTH_ANNOUNCED_NAVIGATE_THROUGH_LIST_MSG");this.dialog=new this.Y.RightNowTreeViewDialog({id:"rn_"+this.instanceID,hierarchyData:a,contentBox:this.Y.one(this.baseSelector+"_Links"),dismissLabel:RightNow.Interface.getMessage("CANCEL_CMD"),titleLabel:this.data.attrs.label_nothing_selected,introLabel:b+" "+c,selectionPlaceholderLabel:RightNow.Interface.getMessage("SELECTION_PCT_S_ACTIVATE_LINK_JUMP_MSG"),levelLabel:this.data.attrs.label_level,noItemSelectedLabel:this.data.attrs.label_all_values});this.dialog.on("selectionMade",this.onAccessibleLinkClick,this);this.dialog.render()},displayAccessibleDialog:function(){this.dialog.set("selectedValue",this.tree.get("value"));this.dialog.set("selectedLabels",this.tree.get("labelChain"));this.dialog.show();var a=this.Y.one("p.rn_Intro a");a&&a.focus()},displaySelectedNodesAndClose:function(a){this._eo||(this._eo=new RightNow.Event.EventObject(this));this._eo.data.hierChain=this.tree.get("valueChain");RightNow.Event.fire("evt_productCategoryFilterSelected",this._eo);delete this._eo.data.hierChain;var b=this.tree.get("valueChain"),c=this.data.attrs.label_nothing_selected,d=this.data.attrs.label_nothing_selected;this.dropdown.hide();b[0]&&(c=this.tree.get("labelChain").join("<br>"),d=this.data.attrs.label_screen_reader_selected+c);this.dropdown.set("triggerText",c);this.Y.all(this.baseSelector+"_TreeDescription").setHTML(d);if(a&&!this.dialog)try{this.dropdown.get("trigger").focus()}catch(e){}},selectNode:function(a){this.displaySelectedNodesAndClose(!0)},getSubLevelRequest:function(a){if(!this._nodeBeingExpanded){this._nodeBeingExpanded=!0;if(a=this.getSubLevelRequestEventObject(a))"Product"===this.dataType&&(RightNow.UI.Form.currentProduct=a.data.value),this._requesting=a.data.value,RightNow.Event.fire("evt_menuFilterRequest",a);this._nodeBeingExpanded=!1;this._eo.data.link_map&&delete this._eo.data.link_map}},getSubLevelRequestEventObject:function(a){return new RightNow.Event.EventObject(this,{data:{level:a.depth+1,value:a.value,label:a.label,cache:{}}})},getSubLevelResponse:function(a,b){this.data.js.link_map&&delete this.data.js.link_map;var c=a.data.level,d=a.data.hier_data,e,d=this.groomProdcats(d);this.buildTree();!a.data.reset_linked_category&&this.getSubLevelRequestEventObject._origRequest&&this.getSubLevelRequestEventObject._origRequest[b]?e=this.getSubLevelRequestEventObject._origRequest[b]:a.data.reset_linked_category&&(this.tree.clear(this.data.attrs.label_all_values),this.dialog=null,this.selectNode(this.tree.getRoot()));7>c&&this.insertChildrenForNode(d,e);0===d.length&&this.displaySelectedNodesAndClose()},insertChildrenForNode:function(a,b){this.tree.insertChildHierarchyData(a,b)},removeNonReadableProdcats:function(a){this.checkIdsAreValid("readableProdcatIds");var b=this.data;return this.Y.Array.filter(a,function(a){if(-1!==this.Y.Array.indexOf(b.js.readableProdcatIds,a.id))return a},this)},updateProdcatsHasChildrenAttribute:function(a){this.checkIdsAreValid("readableProdcatIdsWithChildren");var b=this.data;return this.Y.Array.map(a,function(a){a.hasChildren=-1!==this.Y.Array.indexOf(b.js.readableProdcatIdsWithChildren,a.id)?!0:!1;return a},this)},groomProdcats:function(a){!1!==this.data.attrs.verify_permissions&&"None"!==this.data.attrs.verify_permissions&&0<this.data.js.readableProdcatIds.length&&(a=this.removeNonReadableProdcats(a),a=this.updateProdcatsHasChildrenAttribute(a));return a},checkIdsAreValid:function(a){if(!(this.data&&this.data.js&&this.data.js[a]&&this.Y.Lang.isArray(this.data.js[a])))throw Error("Widget does not have this.data.js."+a+" attribute set, or its value is not an array");}});
RightNow.Widgets.SmartAssistantDialog=RightNow.Field.extend({overrides:{constructor:function(){this.parent();try{this.parentForm().on("response",this._displayResults,this);this._parentFormID=this.getParentFormID();}
catch(e){RightNow.Event.on('evt_formButtonSubmitResponse',this._displayResults,this);}
RightNow.UI.Form.smartAssistant=true;this.sessionParameter='';this.Y.augment(this,RightNow.Avatar);}},_displayResults:function(evt,args)
{var result=args[0];if(result&&result.data&&result.data.result&&result.data.result.sa)
{if(result.data.result.newFormToken)
{RightNow.Event.fire("evt_formTokenUpdate",new RightNow.Event.EventObject(null,{data:{newToken:result.data.result.newFormToken}}));}
if(!this._parentFormID&&result.data.form)
{this._parentFormID=result.data.form;}
this.sessionParameter=result.data.result.sessionParam||'';result=result.data.result.sa;if(result.token){RightNow.UI.Form.smartAssistantToken=result.token;}
RightNow.UI.Form.smartAssistant=false;if(typeof result.canEscalate!=='undefined')
this._doNotCreateIncidentOrSocialQuestion=!result.canEscalate;else if(typeof result.canCreate!=='undefined')
this._doNotCreateIncidentOrSocialQuestion=!result.canCreate;var dialogHeading=this.Y.one("#rn_"+this.instanceID+"_DialogHeading");if(dialogHeading)
dialogHeading.set("innerHTML",this.data.attrs.label_banner);var saDisplay,accessKeyPrompt="",displayButton=true,inlineContent=false,inlineAnswerDiscussions=false,suggestions=result.suggestions,i,accessKeyNumber=0;if(suggestions&&suggestions.length>0)
{var suggestion;for(i=0;i<suggestions.length;i++)
{suggestion=suggestions[i];if(suggestion.type==='AnswerSummary'||suggestion.type==='QuestionSummary')
{if(this.data.attrs.accesskeys_enabled&&this.data.attrs.label_accesskey&&this.data.attrs.display_inline)
{accessKeyNumber+=suggestion.list.length;}
if(this.data.attrs.display_inline)
inlineAnswerDiscussions=true;}
else
{inlineContent=true;}}
if(accessKeyNumber>0){var keyComboString=RightNow.Interface.getMessage("ACCESSKEY_LBL"),UA=this.Y.UA,OS=UA.os;if(UA.ie)
keyComboString=RightNow.Interface.getMessage("ALT_LBL");else if(UA.gecko)
keyComboString=(OS==="windows"||!OS)?RightNow.Interface.getMessage("ALT_PLUS_SHIFT_LBL"):RightNow.Interface.getMessage("CTRL_LBL");else if(UA.webkit)
keyComboString=(OS==="windows"||!OS)?RightNow.Interface.getMessage("ALT_LBL"):RightNow.Interface.getMessage("CTRL_PLUS_OPT_LBL");accessKeyPrompt=RightNow.Text.sprintf("<span class='rn_ScreenReaderOnly'>"+this.data.attrs.label_accesskey+"</span>",keyComboString,accessKeyNumber);}
if(suggestions.length>0){var data={'suggestions':suggestions,'accessKeyPrompt':accessKeyPrompt,'sessionParam':this.sessionParameter,'baseDomID':this.baseDomID,'attrs':{'label_prompt':this.data.attrs.label_prompt,'accesskeys_enabled':this.data.attrs.accesskeys_enabled,'label_accesskey':this.data.attrs.label_accesskey,'display_inline':this.data.attrs.display_inline,'label_collapsed':this.data.attrs.label_collapsed},'answerUrl':RightNow.Interface.getConfig('CP_ANSWERS_DETAIL_URL')};saDisplay=this._generateViewData(suggestions,data);}}
else
{saDisplay=this.data.attrs.label_no_results;}
if(this._doNotCreateIncidentOrSocialQuestion)
{RightNow.ActionCapture.record('incident','doNotCreateState');RightNow.UI.Form.smartAssistant=true;if(this.data.attrs.dnc_label_banner&&dialogHeading)
dialogHeading.set("innerHTML",this.data.attrs.dnc_label_banner);displayButton=false;}
this._dialogBody=this.Y.one(this.baseSelector);this._dialogContent=this.Y.one(this.baseSelector+"_DialogContent");if(this._dialogBody)
{var handlers={label_submit_button:{fn:this._submitButtonAction,scope:this},label_cancel_button:{fn:this._cancelButtonAction,scope:this},label_solved_button:{fn:this._solvedButtonAction,scope:this}},dialogContent=this._dialogContent,buttons=[],links=[],buttonOrder=this.data.attrs.button_ordering,index=0,button;if(displayButton)
{for(i=0;i<buttonOrder.length;i++)
{button=buttonOrder[i];buttons.push({text:button.label,handler:handlers[button.name],isDefault:(buttons.length===0)});if(button.displayAsLink)
{links.push({index:index,handler:handlers[button.name],label:button.label});}
index++;}}
else if(this.data.attrs.label_cancel_button)
{buttons.push({text:(this._doNotCreateIncidentOrSocialQuestion&&this.data.attrs.dnc_label_cancel_button)?this.data.attrs.dnc_label_cancel_button:this.data.attrs.label_cancel_button,handler:handlers.label_cancel_button,isDefault:true});}
if(dialogContent)
{dialogContent.set("innerHTML",saDisplay);if(inlineAnswerDiscussions&&saDisplay!==this.data.attrs.label_no_results)
this._enableInlineAnswerDiscussions();if(inlineContent||!inlineAnswerDiscussions)
this._modifyLinkTargets(dialogContent);}
this._dialog=RightNow.UI.Dialog.actionDialog((this._doNotCreateIncidentOrSocialQuestion&&this.data.attrs.dnc_label_dialog_title)?this.data.attrs.dnc_label_dialog_title:this.data.attrs.label_dialog_title,this._dialogBody,{"buttons":buttons});var panel=this.Y.one('#'+this._dialog.id).ancestor('.yui3-panel');if(panel)
panel.addClass("rn_SmartAssistantDialogContainer");RightNow.UI.show(this._dialogBody);if(links.length)
{var dialogButtons=this._dialog.getButtons(),link,handler,buttonContainer;for(i=0;i<links.length;i++)
{button=dialogButtons.item?dialogButtons.item(links[i].index):dialogButtons[links[i].index];handler=links[i].handler;link=this.Y.Node.create("<a href='javascript:void(0);'>"+links[i].label+"</a>");link.on('click',(typeof handler==="function")?handler:handler.fn,links[i].handler.scope||this._dialog);buttonContainer=button.get('parentNode')||null;if(buttonContainer)
{button.insert(link,'after');button.remove();}}}
this._dialog.show();}}},_generateViewData:function(result,viewData)
{var viewDisplay=this.data.attrs.label_no_results;if(result.length>0)
viewDisplay=new EJS({text:this.getStatic().templates.displayResults}).render(viewData);return viewDisplay;},_submitButtonAction:function()
{this._dialog.hide();this.parentForm(this._parentFormID).fire("submitRequest");},_cancelButtonAction:function()
{if(!this._doNotCreateIncident||!this.data.attrs.dnc_redirect_url)
this._dialog.hide();else
RightNow.Url.navigate(this.data.attrs.dnc_redirect_url);},_solvedButtonAction:function()
{RightNow.ActionCapture.record('incident','deflect');RightNow.ActionCapture.flush(function(){var redirectUrl=this.data.attrs.solved_url;if(RightNow.UI.Form.smartAssistantToken&&RightNow.Text.beginsWith(redirectUrl,'/app')){redirectUrl=RightNow.Url.addParameter(redirectUrl,'saResultToken',RightNow.UI.Form.smartAssistantToken);}
RightNow.Url.navigate(redirectUrl);},this);},_modifyAnchorLinks:function(rootElement)
{var baseHrefFragment=this.Y.one('base');var href="";baseHrefFragment=(baseHrefFragment)?baseHrefFragment.get("href"):"";if(baseHrefFragment.substr(-1)==='/')
baseHrefFragment=baseHrefFragment.slice(0,-1);rootElement.all('a').each(function(node){if((href=node.get("href"))!==""){var hashLocation=href.split("#");if(hashLocation[0].substr(-1)==='/')
hashLocation[0]=hashLocation[0].slice(0,-1);if((hashLocation[0]===undefined||hashLocation[0]===baseHrefFragment)&&hashLocation[1]!==undefined){node.set("href",window.location.pathname+"#"+hashLocation[1]);}
else{node.setAttribute("target","_blank");}}});},_modifyLinkTargets:function(rootElement)
{if(this.data.attrs.display_answers_inline)
this._modifyAnchorLinks(rootElement);else
rootElement.all('a').setAttribute("target","_blank");},_enableInlineAnswerDiscussions:function()
{this._answersLoaded={};this._discussionsLoaded={};this.Y.one(this.baseSelector).delegate('click',function(evt)
{var clicked=evt.target,objectID=clicked.getAttribute('data-id');this._type=clicked.getAttribute('data-object-type');if(objectID===""){return;}
evt.halt();if(this._showingAnswerDiscussion===clicked)
return;if((typeof this._answersLoaded[objectID]==="undefined"&&this._type==='answer')||(typeof this._discussionsLoaded[objectID]==="undefined"&&this._type==='discussion'))
{clicked.append("<span class='rn_Loading' aria-live='assertive'><span class='rn_ScreenReaderOnly'>"+RightNow.Interface.getMessage("LOADING_ELLIPSES_LBL")+"</span></span>");this._showingAnswerDiscussion=clicked;if(this._dialogBody)
this._dialogBody.setAttribute("aria-busy","true");var eventObject=new RightNow.Event.EventObject(this,{data:{objectID:objectID}}),contentEndpoint;if(this._type==='answer'&&RightNow.Event.fire('evt_getAnswerRequest',eventObject)){contentEndpoint=this.data.attrs.get_answer_content;}
else if(this._type==='discussion'&&RightNow.Event.fire('evt_getDiscussionRequest',eventObject)){contentEndpoint=this.data.attrs.get_discussion_content;}
if(contentEndpoint)
this._getContent(clicked,eventObject,contentEndpoint);}
else
{this._toggleContent(objectID,!this._answersLoaded[objectID]);}},'ul',this);},_getContent:function(clickedLink,eventObject,contentEndpoint)
{RightNow.Ajax.makeRequest(contentEndpoint,eventObject.data,{successHandler:this._displayContent,scope:this,data:eventObject,json:true,isResponseObject:true});},_showContent:function(objectID,type,contentWrapper)
{this._modifyLinkTargets(contentWrapper);this._insertContent(contentWrapper);this._showingAnswerDiscussion.removeChild(this._showingAnswerDiscussion.get('lastChild'));this._showingAnswerDiscussion=null;this._toggleContent(objectID,true);if(this._dialog.resizeToWindow)
this._dialog.resizeToWindow();if(this._dialogBody)
this._dialogBody.setAttribute('aria-busy','false');RightNow.ActionCapture.record(type,'view',objectID);},_insertContent:function(contentWrapper)
{this._showingAnswerDiscussion.insert(contentWrapper,'after');},_displayContent:function(response,originalEventObject)
{var objectID=response.ID,answerDiscussionWrapper;if(this._type==='answer'&&RightNow.Event.fire("evt_getAnswerResponse",{data:originalEventObject,response:response})){if(this._showingAnswerDiscussion&&this._showingAnswerDiscussion.get('id').indexOf(response.ID)>-1&&response.ID){answerDiscussionWrapper=this.Y.Node.create(new EJS({text:this.getStatic().templates.answerContent}).render({spanID:this.baseDomID+'_AnswerContent'+objectID,question:(response.Question&&!response.GuidedAssistance)?response.Question:null,contents:this._getContents(objectID,response)}));this._answersLoaded[objectID]=true;}}
else if(this._type==='discussion'&&RightNow.Event.fire("evt_getDiscussionResponse",{data:originalEventObject,response:response})){if(this._showingAnswerDiscussion&&this._showingAnswerDiscussion.get('id').indexOf(response.ID)>-1&&response.ID){answerDiscussionWrapper=this.Y.Node.create(new EJS({text:this.getStatic().templates.discussionContent}).render({spanID:this.baseDomID+'_AnswerContent'+objectID,objectID:objectID,discussion:response.Body,solution:response.BestSocialQuestionAnswers,avatarURL:response.CreatedBySocialUser.AvatarURL,displayName:response.CreatedBySocialUser.DisplayName,sessionParam:this.sessionParameter,bestAnswerExists:this._bestAnswerExists(response.BestSocialQuestionAnswers),userStatus:response.CreatedBySocialUser.StatusWithType.Status.ID,js:this.data.js}));this._discussionsLoaded[objectID]=true;}}
this._showContent(objectID,this._type,answerDiscussionWrapper);},_bestAnswerExists:function(bestAnswers)
{for(var i in bestAnswers){if(bestAnswers[i].SocialQuestionComment.Body!==null){return true;}}
return false;},_getContents:function(answerID,response)
{if(response.FileAttachments){var attachmentLinks='';this.Y.Object.each(response.FileAttachments,function(attachment){attachmentLinks+=this._getAnswerLink(answerID,'/ci/fattach/get/'+attachment.ID+this.sessionParameter,attachment.FileName||this.data.attrs.label_download_attachment)+'<br />';},this);return(response.Solution?response.Solution:'')+attachmentLinks;}
if(response.URL){return this._getAnswerLink(answerID,response.URL,response.URL);}
if(response.GuidedAssistance){return this._getAnswerLink(answerID,'/app/'+RightNow.Interface.getConfig('CP_ANSWERS_DETAIL_URL')+'/a_id/'+answerID+this.sessionParameter,this.data.attrs.label_view_guide);}
return response.Solution;},_getAnswerLink:function(answerID,href,text)
{return new EJS({text:this.getStatic().templates.answerLink}).render({answerID:answerID,href:href,text:text});},_toggleContent:function(answerID,expand)
{var id=this.baseSelector+"_Answer",toggle=this.Y.one(id+answerID),answer=this.Y.one(id+"Content"+answerID),alt=this.Y.one(id+answerID+"_Alternative");this._expand=expand;if(expand)
{this._expandAnswerContent(id,answerID,answer,toggle,alt);}
else
{this._collapseAnswerContent(answerID,answer,toggle,alt);}
this._answersLoaded[answerID]=expand;},_expandAnswerContent:function(id,answerID,answer,toggle,alt)
{for(var i in this._answersLoaded)
{if(this._answersLoaded.hasOwnProperty(i)&&i!==answerID&&this._answersLoaded[i]===true)
{this.Y.one(id+i).replaceClass("rn_ExpandedAnswer","rn_ExpandAnswer");this.Y.one(id+"Content"+i).replaceClass("rn_ExpandedAnswerContent","rn_Hidden");this.Y.one(id+i+"_Alternative").set("innerHTML",this.data.attrs.label_collapsed);this._answersLoaded[i]=false;}}
answer.replaceClass("rn_Hidden","rn_ExpandedAnswerContent");toggle.replaceClass("rn_ExpandAnswer","rn_ExpandedAnswer");alt.set("innerHTML",this.data.attrs.label_expanded);if(!this.Y.DOM.contains(window,this.Y.Node.getDOMNode(toggle)))
{if(toggle.getY()<=0&&toggle.scrollIntoView)
toggle.scrollIntoView();else
window.scrollTo(0,toggle.getY()-20);}},_collapseAnswerContent:function(answerID,answer,toggle,alt)
{answer.replaceClass("rn_ExpandedAnswerContent","rn_Hidden");toggle.replaceClass("rn_ExpandedAnswer","rn_ExpandAnswer");alt.set("innerHTML",this.data.attrs.label_collapsed);}});
RightNow.Widgets.MobileProductCategoryInput=RightNow.Field.extend({overrides:{constructor:function(){this.parent();this.Y.augment(this,RightNow.ProductCategory);this._selections=[];this._currentValue=0;this._currentLabel='';this._currentLevel=1;this._currentScreenIndex=1;this._maxDepth=this.data.attrs.max_lvl||6;this._hasChildren=false;this._baseID=this.baseSelector+"_"+this.data.js.data_type;this._launchButton=this.Y.one(this._baseID+"_Launch");if(this.data.js.readOnly)return;if(this.data.js.initial.length!==0){for(var i=0,currentItem;i<this.data.js.initial.length;i++){currentItem=this.data.js.initial[i];this._selections.push({value:currentItem.id,label:this.Y.Escape.html(currentItem.label)});}
if(typeof currentItem!=="undefined"){this._currentValue=currentItem.id;this._currentLabel=currentItem.label;this._hasChildren=currentItem.hasChildren;}
this._commitSelection(this._selections);}
else if(this.data.js.linkingOn&&this.data.js.data_type==="Category"&&this.data.js.linkMap&&typeof this.data.js.linkMap[0]==="undefined"){this._setCategoryUnavailable();}
this._launchButton.on("click",this._openDialog,this);RightNow.Event.subscribe("evt_menuFilterGetResponse",this._getSubLevelResponse,this);this.parentForm().on("submit",this._onValidateRequest,this);this.on('constraintChange:required_lvl',this.updateRequiredLevel,this);}},_openDialog:function(){(this._dialog||this._createDialog());this._dialog.show();},_createDialog:function(element){var firstLevelItems=element||this.Y.one(this._baseID+"_Level1Input");if(!firstLevelItems)return;this._dialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_prompt,firstLevelItems,{navButtons:true,cssClass:"rn_MobileProductCategoryInput"});this._dialog.hideEvent.subscribe(this._resetView,this,true);this._dialog.backEvent.subscribe(function(){this._currentLevel=Math.max(this._currentLevel-1,1);this._currentScreenIndex=Math.max(this._currentScreenIndex-1,1);},this,true);firstLevelItems.removeClass("rn_Hidden").delegate("click",this._getSubLevelRequest,"input",this);},_selectionAllMade:function(parentSelected){this._selectionMade(parentSelected);if(this.data.js.linkingOn&&this.data.attrs.filter_type==="Product"){this._currentScreenIndex--;RightNow.Event.fire("evt_menuFilterRequest",this._eo);}},_selectionMade:function(parentSelected){var index=0,buttonText="",ariaText="";if(parentSelected){while(parentSelected!==this._selections[this._selections.length-1].value){this._selections.pop();}
this._currentValue=this._selections[this._selections.length-1].value;this._currentLabel=this._selections[this._selections.length-1].label;this._currentLevel=this._selections.length;}
if(this._launchButton){do{if(this._selections[index].value){buttonText+=this._selections[index].label+"<br>";ariaText+=this._selections[index].label+" ";}
index++;}
while(index<this._currentLevel&&this._selections[index]);if(ariaText){ariaText=RightNow.Text.sprintf(this.data.attrs.label_current_selection_screenreader,ariaText);}
this._launchButton.set("innerHTML",buttonText||this.data.attrs.label_prompt);this.swapLabel(this.Y.one(this._baseID+'_Label'),this.data.attrs.required_lvl,this.data.attrs.label_input,this.getStatic().templates.label,ariaText);}
if(this._dialog&&this._dialog.visible()){this._dialog.hide();}
this._markSelectionInDialog();this._commitSelection(this._selections);this._updateEventObject({data:{level:this._currentLevel,value:this._currentValue}});if(this._launchButton){this._launchButton.focus();}
this._eo.data.hierChain=this._getCommittedSelection(true);RightNow.Event.fire("evt_productCategorySelected",this._eo);this.fire('change',this);delete this._eo.data.hierChain;},_resetView:function(){if(!this._launchButton)return;if(this._launchButton.intersect(this._launchButton.get('viewportRegion'))){this._launchButton.scrollIntoView();}},_clearSelection:function(){this._selections=[{value:0}];if(this._dialog){while(this._dialog.hasPreviousContent()){this._dialog.previousScreen();}}
this._currentLevel=1;this._currentValue=0;this._currentLabel='';this._hasChildren=false;this._selectionMade();},_markSelectionInDialog:function(deselectAll){if(deselectAll){deselectAll.all("div").removeClass("rn_Selected");}
else{if(this._dialog&&this._dialog._panel&&this._dialog._panel.id){this.Y.one("#"+this._dialog._panel.id).all("div.rn_Selected").removeClass("rn_Selected");}
for(var i=0,currentValue,currentNode,length=this._selections.length+1,markSelection=(this._selections[0]&&this._selections[0].value),apply=function(node){node.removeClass("rn_Selected");if(markSelection&&parseInt(node.one("input").get("value"),10)===currentValue){node.addClass("rn_Selected");}};i<length;i++){currentValue=(this._selections[i])?this._selections[i].value:this._selections[this._selections.length-1].value;currentNode=this.Y.one(this._baseID+"_Level"+(i+1)+"Input"+((i===0)?"":"_"+this._selections[i-1].value));if(currentNode){currentNode.all("div").each(apply);}}}},_getSubLevelRequest:function(clickEvent){if(!this._beingSelected){this._toggleLoadingIcon(clickEvent.target);var input=clickEvent.target,label=input.next("label");if(label&&label.get("innerHTML")){this._hasChildren=label.hasClass("rn_HasChildren");this._currentLabel=this.Y.Lang.trim(label.get("childNodes").item(0).get("text"));}
this._currentValue=parseInt(input.get("value"),10);this._selections=this._selections.slice(0,this._currentScreenIndex-1);this._selections.push({value:this._currentValue,label:this.Y.Escape.html(this._currentLabel)});this._currentLevel=this._selections.length;if(this.data.js.linkingOn&&this.data.js.data_type==="Product"){this._currentValue=this._currentValue||-1;this._backButtonLabel=(this._currentLevel===1)?this.data.attrs.label_data_type:this._selections[this._currentLevel-2].label;RightNow.Event.fire("evt_menuFilterRequest",this._updateEventObject({"data":{"level":this._currentLevel,"value":this._currentValue}}));if(!this._hasChildren){this._selectionMade();}
this._toggleLoadingIcon(clickEvent.target);return;}
if(!this._hasChildren){this._selectionMade();this._toggleLoadingIcon();}
else if(this._currentValue){this._backButtonLabel=(this._currentLevel===1)?this.data.attrs.label_data_type:this._selections[this._currentLevel-2].label;RightNow.Event.fire("evt_menuFilterRequest",this._updateEventObject({data:{level:this._currentLevel,value:this._currentValue}}));if(this._eo.data.link_map)
delete this._eo.data.link_map;}}},_buildDialogContent:function(data,level){if(data.length&&level<=this._maxDepth&&this._dialog){var id=this._baseID+"_Level"+level+"Input_"+this._currentValue,existingElement=this.Y.one(id),requirementMet=false;this._currentScreenIndex++;if(existingElement){var committedSelections=this._getCommittedSelection();var isSameSelection=false;for(var i in committedSelections){if(committedSelections[i].value===this._currentValue){isSameSelection=true;break;}}
if(!isSameSelection&&!(committedSelections.length+1===this._currentLevel&&committedSelections[committedSelections.length-1].value===this._currentValue)){this._markSelectionInDialog(existingElement);}
this._dialog.showScreen(id);}
else{if((!this.data.attrs.required_lvl||this._currentLevel>this.data.attrs.required_lvl)&&this.checkPermissionsOnNode(this._currentValue)){data.unshift({id:this._currentValue,label:RightNow.Text.sprintf(RightNow.Interface.getMessage("ALL_PCT_S_LBL"),this._currentLabel)});requirementMet=true;}
var maxDepth=this._maxDepth,currentSelections=this._getCommittedSelection(),alreadySelected=(currentSelections[level-1])?currentSelections[level-1].value:((currentSelections[level-2])?currentSelections[level-2].value:false),div=new EJS({text:this.getStatic().templates.view}).render({inputID:id.substr(1),labelID:(this._baseID+"_Level"+level+"Label_"+this._currentValue).substr(1),level:level,data:data,parentAlt:this.data.attrs.label_parent_menu_alt,getContainerClass:function(item,i){return((i===0)?"rn_Parent":"rn_SubItem")+((item.id===alreadySelected)?" rn_Selected":"");},getLabelClass:function(item){return(level!==maxDepth&&item.hasChildren)?"rn_HasChildren":"";},escapeHtml:this.Y.Escape.html});this._dialog.nextScreen(div,null,this._backButtonLabel);var allItem=(requirementMet)?this.Y.one(id).one('input'):null;this.Y.one(id).delegate("click",function(e){if(allItem&&e.target.compareTo(allItem)){this._selectionAllMade(data[0].id);}
else{this._getSubLevelRequest(e);}},"input",this);}}},_buildLinkedCategoryContent:function(level,data,selectedItem){var id=this._baseID+"_Level1Input",firstLevelItems=this.Y.one(id),element,maxDepth=this._maxDepth;if(this._dialog&&firstLevelItems){element=firstLevelItems.next();while(element){this._dialog.previousScreen();element.remove();element=firstLevelItems.next();}
firstLevelItems.remove();}
data.unshift({id:0,label:RightNow.Text.sprintf(this.data.attrs.label_all_values,this._currentLabel)});firstLevelItems=this.Y.Node.create(new EJS({text:this.getStatic().templates.view}).render({inputID:id.substr(1),labelID:(this._baseID+"_Level"+level+"Label_"+this._currentValue).substr(1),level:level,data:data,parentAlt:this.data.attrs.label_parent_menu_alt,getContainerClass:function(item,i){return((i===0)?"rn_Parent":"rn_SubItem")+((item.id===selectedItem)?" rn_Selected":"");},getLabelClass:function(item){return(level!==maxDepth&&item.hasChildren)?"rn_HasChildren":"";},escapeHtml:this.Y.Escape.html}));this._createDialog(firstLevelItems);return firstLevelItems;},_getSubLevelResponse:function(type,args){var evtObj=args[0];if((evtObj.w_id&&evtObj.w_id===this.instanceID)||(this.data.js.linkingOn&&evtObj.data.data_type==="Category"&&this.data.js.data_type===evtObj.data.data_type)){if(evtObj.data.reset_linked_category){if(this.data.js.linkMap)
delete this.data.js.linkMap;if(!evtObj.data.hier_data.length){this._setCategoryUnavailable();}
else{this._categoryUnavailable=false;evtObj.data.hier_data=this.groomProdcats(evtObj.data.hier_data);if(this._selections.length){var currentSelections=this._selections.slice(0),currentIndex=0;for(var i=0,firstItem=this._selections[0].value,newData=evtObj.data.hier_data,stillSelected;i<newData.length;i++){if(newData[i].id===firstItem){stillSelected=firstItem;break;}}
if(!stillSelected){this._clearSelection();this._buildLinkedCategoryContent(1,evtObj.data.hier_data,stillSelected);}
else{var firstLevelItems=this._buildLinkedCategoryContent(1,evtObj.data.hier_data,stillSelected),baseID=this._baseID,thisY=this.Y,firstSelectedNode=firstLevelItems.one("input[value='"+firstItem+"']"),followTree=function(input){if(!input)
return;currentIndex++;var thisRoot=baseID+"_Level"+currentIndex+"Input_"+currentSelections[currentIndex-2].value,thisRootNode=thisY.one(thisRoot),selectedNode;if(currentIndex>currentSelections.length){if(thisRootNode&&(selectedNode=thisRootNode.one("input[value='"+currentSelections[currentIndex-2].value+"']")))
selectedNode.getDOMNode().click();return;}
if(thisRootNode&&(selectedNode=thisRootNode.one("input[value='"+currentSelections[currentIndex-2].value+"']")))
selectedNode.getDOMNode().click();if(thisRootNode)
followTree(thisRootNode.one("input[value='"+currentSelections[currentIndex-1].value+"']"));};if(firstSelectedNode){currentIndex++;firstSelectedNode.getDOMNode().click();followTree(firstSelectedNode);}}}
else{this._buildLinkedCategoryContent(1,evtObj.data.hier_data);}
this.Y.one(this.baseSelector).setStyle("visibility","visible");}
return;}
this._currentLevel=(evtObj.data.hier_data.length)?evtObj.data.level:this._currentLevel;if(evtObj.data.hier_data.length===0){this._selectionMade();}
else{evtObj.data.hier_data=this.groomProdcats(evtObj.data.hier_data);this._buildDialogContent(evtObj.data.hier_data,this._currentLevel);}
this._toggleLoadingIcon();}},_onValidateRequest:function(type,args){this._errorLocation=this.lastErrorLocation=args[0].data.error_location;if(this._checkSelectionErrors()){var formEventObject=this.createEventObject(),value=this._getCommittedSelection(true);if(value.length){formEventObject.data.value=value[value.length-1];}
RightNow.Event.fire("evt_formFieldValidatePass",formEventObject);return formEventObject;}
RightNow.Event.fire("evt_formFieldValidateFailure",this._eo);return false;},swapLabel:function(container,requiredLevel,label,template,screenReaderText){this.Y.augment(this,RightNow.RequiredLabel);var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,requiredLevel:requiredLevel,requiredLabel:RightNow.Interface.getMessage("REQUIRED_LBL"),screenReaderText:screenReaderText||""};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},updateRequiredLevel:function(evt,constraint){var newLevel=constraint[0].constraint;if(newLevel>this.data.attrs.max_lvl||this.data.attrs.required_lvl===newLevel)return;if(this.data.attrs.required_lvl>0&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
this.swapLabel(this.Y.one(this._baseID+'_Label'),newLevel,this.data.attrs.label_input,this.getStatic().templates.label);this.data.attrs.required_lvl=newLevel;this._toggleErrorLabels(newLevel);},_checkSelectionErrors:function(){if(this.data.attrs.required_lvl){this._toggleErrorLabels();if(this._categoryUnavailable){return true;}
if(this._currentValue===0||(this._hasChildren&&(this._getCommittedSelection()).length<this.data.attrs.required_lvl)){this._displayErrorMessage();return false;}}
if(!this.checkPermissionsOnNode(this._currentValue)){this._displayErrorMessage();return false;}
return true;},_toggleErrorLabels:function(addErrorClass){var css,label;if(addErrorClass){if(this._failedPreviousCheck)return;this._failedPreviousCheck=true;css="addClass";}
else if(this._failedPreviousCheck){this._failedPreviousCheck=false;css="removeClass";}
else return;if(label=this.Y.one(this._baseID+"_Label")){label[css]("rn_ErrorLabel");}},_displayErrorMessage:function(){this._toggleErrorLabels(true);var commonErrorDiv,message,label;if(this._errorLocation&&(commonErrorDiv=this.Y.one("#"+this._errorLocation))){if(!this.checkPermissionsOnNode(this._currentValue)&&this._currentLabel){label=this.data.attrs.label_not_permissioned;message=this.data.attrs.label_input+" - "+((label.indexOf("%s")>-1)?RightNow.Text.sprintf(label,this._currentLabel):label);}
else if(this._currentLabel){label=this.data.attrs.label_required;message=this.data.attrs.label_input+" - "+((label.indexOf("%s")>-1)?RightNow.Text.sprintf(label,this._currentLabel):label);}
else{message=this.data.attrs.label_prompt;}
commonErrorDiv.append(new EJS({text:this.getStatic().templates.error}).render({id:this._baseID.substr(1)+"_Launch",errorLink:message,escapeHtml:this.Y.Escape.html,fieldName:this._fieldName}));}},_commitSelection:function(selection){this._committedSelection=RightNow.Lang.cloneObject(selection);},_getCommittedSelection:function(justValues){if(justValues&&this._committedSelection){for(var i=0,values=[];i<this._committedSelection.length;i++){values.push(this._committedSelection[i].value);}
return values;}
return this._committedSelection||[];},_setCategoryUnavailable:function(){this._categoryUnavailable=true;this._clearSelection();this.Y.one(this.baseSelector).setStyle("visibility","hidden");},_updateEventObject:function(options){if(!this._initialized){this._eo=new RightNow.Event.EventObject(this,{data:{data_type:this.data.js.data_type,hm_type:this.data.js.hm_type,linking_on:this.data.js.linkingOn,linkingProduct:0,table:this.data.js.table,cache:[],name:((this.data.js.data_type==="Product")?'prod':'cat')}});this._updateEventObject._updateVals=function(origArray,properties){for(var i in properties){if(properties.hasOwnProperty(i)){origArray[i]=properties[i];}}};this._initialized=true;}
if(options&&options.data){this._updateEventObject._updateVals(this._eo.data,options.data);}
if(this.data.js.linkMap){this._eo.data.link_map=this.data.js.linkMap;delete this.data.js.linkMap;}
return this._eo;},_toggleLoadingIcon:function(toggleNode){if(toggleNode&&!toggleNode.hasClass('rn_LoadingIcon')){this._beingSelected=true;this.Y.one(toggleNode).next().addClass('rn_LoadingIcon');}
else{this._beingSelected=false;this.Y.one('.rn_MobileProductCategoryInput .rn_LoadingIcon').removeClass('rn_LoadingIcon');}}});
RightNow.Widgets.FileAttachmentUpload=RightNow.Field.extend({overrides:{constructor:function(){this.parent();this.input=this.Y.one(this.baseSelector+"_FileInput");if(!this.input)return;this._eo=new RightNow.Event.EventObject(this);this._attachmentCount=this.data.js.attachmentCount||0;this._attachments=[];this._statusMessage=this.Y.one(this.baseSelector+"_StatusMessage");this._parentFormElement=this.input.ancestor('form');if(this._parentFormElement){this._origEncType=this._parentFormElement.get('enctype');this.input.on("change",this._onFileAdded,this);this.input.on("keypress",this._onKeyPress,this);this.input.on("paste",function(){return false;});RightNow.Form.find(this.input.get('id'),this.instanceID).on("submit",this._onValidateUpdate,this);this.on("constraintChange:min_required_attachments",this.updateMinAttachments,this);}
else{RightNow.UI.addDevelopmentHeaderError("FileAttachmentUpload must be placed within a form with a unique ID.");}
this.data.attrs.max_attachments=(this.data.attrs.max_attachments===0)?Number.MAX_VALUE:this.data.attrs.max_attachments;if(this._attachmentCount===this.data.attrs.max_attachments)
this.input.set("disabled",true);},getValue:function(){return this._attachments;}},swapLabel:function(container,minAttachments,label,template){this.Y.augment(this,RightNow.RequiredLabel);var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,minAttachments:minAttachments};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},updateMinAttachments:function(evt,constraint){var minAttachments=constraint[0].constraint;if(minAttachments>this.data.attrs.max_attachments||minAttachments===this.data.attrs.min_required_attachments)return;this.toggleErrorIndicator(false);if(this.data.attrs.min_required_attachments>0&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
if(this.data.attrs.label_input){this.swapLabel(this.Y.one(this.baseSelector+'_LabelContainer'),minAttachments,this.data.attrs.label_input,this.getStatic().templates.label);}
this.data.attrs.min_required_attachments=minAttachments;},_onKeyPress:function(event)
{var keyPressed=event.keyCode;if(keyPressed&&(keyPressed!==RightNow.UI.KeyMap.ENTER&&keyPressed!==RightNow.UI.KeyMap.TAB)||(keyPressed===RightNow.UI.KeyMap.ENTER&&this.Y.UA.ie))
{event.halt();}},_onFileAdded:function(e){var value=e.target.get('value');if(this._uploading||value===""||!this._validateFileExtension(value))return;this._sendUploadRequest();},_validateFileExtension:function(fileName){if(!this.data.attrs.valid_file_extensions)return true;this._validExtensions||(this._validExtensions=this.data.attrs.valid_file_extensions.toLowerCase().replace(' ','').split(','));var index=fileName.lastIndexOf('.'),fileExtension=(index!==-1&&index!==(fileName.length-1))?fileName.substring(index+1).toLowerCase():null,extensionIsValid=fileExtension&&this.Y.Array.indexOf(this._validExtensions,fileExtension)>-1;if(extensionIsValid){this.toggleErrorIndicator(false);return true;}
this.toggleErrorIndicator(true);this._displayStatus(RightNow.Text.sprintf(this.data.attrs.label_invalid_extension,'.'+this._validExtensions.join(", .")));return false;},_displayStatus:function(message){this._statusMessage.removeClass("rn_ScreenReaderOnly").set('innerHTML',message);},_sendUploadRequest:function(){this._eo.data.filename=this.input.get('value');var postData={name:this.data.js.id,path:this.data.js.path,ext:this.data.attrs.valid_file_extensions,constraints:this.data.js.constraints};this._localFile=this._getFileFromInput();if(RightNow.Event.fire("evt_fileUploadRequest",this._eo)){this._setLoading(true);this._parentFormElement.set('enctype','multipart/form-data').set('encoding','multipart/form-data');this._errorNotified=false;this._fileUploadReq=RightNow.Ajax.makeRequest("/ci/fattach/upload",postData,{json:true,data:this._eo,scope:this,timeout:(RightNow.Interface.getConfig("CP_FILE_UPLOAD_MAX_TIME")||300)*1000,upload:this._parentFormElement.get('id'),successHandler:this._fileUploadReturn,failureHandler:this._fileUploadFailure});this.input.set("disabled",true);this._parentFormElement.set('enctype',this._origEncType).set('encoding',this._origEncType);}
else{this.resetInput();}},_processServerError:function(response){var attachmentErrorInfo=this.getAttachmentErrorInfo(response);if(attachmentErrorInfo&&attachmentErrorInfo.errorMessage){attachmentErrorInfo.focusElement=this.input;if(!this._errorNotified){RightNow.UI.Dialog.messageDialog(attachmentErrorInfo.errorMessage,attachmentErrorInfo);this._errorNotified=true;}
return true;}
return false;},_processAttachmentThreshold:function(count){if(count>=this.data.attrs.max_attachments){this.input.set("disabled",true);return count>this.data.attrs.max_attachments;}
return false;},_fileUploadReturn:function(response,originalEventObject){var originalFileName=originalEventObject.data.filename;this._setLoading(false);this.resetInput();if(RightNow.Event.fire("evt_fileUploadResponse",response,originalEventObject)){var attachmentInfo=response;if(this._processServerError(attachmentInfo)||this._processAttachmentThreshold(++this._attachmentCount))return;var filename=this._normalizeFilename(attachmentInfo.name,originalFileName);this._attachments.push({userName:filename,localName:attachmentInfo.tmp_name,contentType:attachmentInfo.type||'application/octet-stream'});this.fire('change',this);this._renderNewAttachmentItem(filename,this._attachments.length);}},_getFileFromInput:function(){if(this.data.attrs.display_thumbnail&&window.FileReader){var files=this.Y.Node.getDOMNode(this.input).files,file;if(files&&(file=files[0])&&RightNow.Text.beginsWith(file.type,'image')){return file;}}},_renderNewAttachmentItem:function(filename,count){var attachmentItem=this.Y.Node.create(new EJS({text:this.getStatic().templates.attachmentItem}).render({id:this.baseDomID+'_Item'+count,name:filename,displayThumbnail:!!this._localFile,attrs:this.data.attrs}));if(this._localFile){this._loadThumbnail(this._localFile,new FileReader(),function(img){attachmentItem.one('.rn_Thumbnail').append(img);});}
attachmentItem.one("a.rn_fileRemove").on("click",this.removeClick,this,count-1);if(!this._attachmentList){this._attachmentList=this.Y.Node.create("<ul>");this._attachmentList.setAttribute("role","alert");this._statusMessage.insert(this._attachmentList,"after");}
this._attachmentList.append(attachmentItem);if(this.data.attrs.max_attachments===this._attachmentCount){this._attachmentList.append(new EJS({text:this.getStatic().templates.maxMessage}).render({maxMessage:this.data.attrs.label_max_attachment_limit}));}},_normalizeFilename:function(filename,originalFileName){if(filename.lastIndexOf('*')!==-1){originalFileName=originalFileName.replace(/\\/g,'/');var lastIndex=originalFileName.lastIndexOf('/');if(lastIndex!==-1){originalFileName=originalFileName.substr(lastIndex+1);}
filename=originalFileName;}
filename=filename.replace("&amp;","&");return this._renameDuplicateFilename(filename);},_renameDuplicateFilename:function(filename){var duplicateFilename,renamedFilename=filename,duplicates=0;function filenameIsDuplicate(file){return file.userName===renamedFilename;}
function addCounterToFilename(name,counter){var lastDot=name.lastIndexOf('.');if(lastDot===-1){return name+counter;}
else{return name.substr(0,lastDot)+counter+name.substr(lastDot);}}
do{duplicateFilename=this.Y.Array.find(this._attachments,filenameIsDuplicate);if(duplicateFilename){renamedFilename=addCounterToFilename(filename,++duplicates);}}
while(duplicateFilename);return renamedFilename;},_loadThumbnail:function(file,reader,callback){var maxHeight=this.data.attrs.max_thumbnail_height,width,height;reader.onload=function(){var image=new Image();image.src=reader.result;image.onload=function(){width=image.width;height=image.height;if(width>height&&width>maxHeight){height=Math.round(height*(maxHeight/width));width=maxHeight;}
else if(height>maxHeight){width=Math.round(width*(maxHeight/height));height=maxHeight;}
image.alt=file.name;image.width=width;image.height=height;callback(image);};};reader.readAsDataURL(file);},_fileUploadFailure:function(response){if(this._fileUploadReq===undefined)return;RightNow.Ajax.abortRequest(this._fileUploadReq,null);this._setLoading(false,'');this.resetInput();},getAttachmentErrorInfo:function(attachmentInfo){if(!attachmentInfo)
{return{errorMessage:RightNow.Interface.getMessage("THERE_PROB_REQ_ACTION_COULD_COMPLETED_MSG"),icon:"WARN"};}
else if(attachmentInfo.error===2)
{return{errorMessage:this.data.attrs.label_generic_error,icon:"WARN"};}
else if(attachmentInfo.error===4||attachmentInfo.error===88)
{return{errorMessage:RightNow.Interface.getMessage("FILE_PATH_FOUND_MSG"),icon:"WARN"};}
else if(attachmentInfo.error===10)
{return{errorMessage:RightNow.Interface.getMessage("FILE_ATT_UPLOAD_EMPTY_PLS_ENSURE_MSG")};}
else if(attachmentInfo.error===20)
{return{errorMessage:RightNow.Interface.getMessage("FILE_UPLOAD_ALLOWED_FILE_MSG"),icon:"WARN"};}
else if(attachmentInfo.errorMessage)
{return{errorMessage:attachmentInfo.errorMessage,icon:"WARN"};}
else
{return null;}},resetInput:function(){this.input.set("value","").set("disabled",false);this.recreateInput();},recreateInput:function(){if(this.Y.UA.ie||this.Y.UA.webkit){var inputField=this.input.cloneNode(false);this.input.replace(inputField);this.input=this.Y.one("#"+inputField.get('id'));if(this.Y.UA.ie>8||this.Y.UA.webkit)
this.input.on("change",this._onFileAdded,this);}},removeClick:function(event,index){this._attachments.splice(index,1);event.target.get("parentNode").remove();if(this._statusMessage){this._statusMessage.set("innerHTML",RightNow.Interface.getMessage("FILE_DELETED_LBL")).addClass("rn_ScreenReaderOnly").setAttribute("tabIndex",0);RightNow.UI.updateVirtualBuffer();this._statusMessage.focus();}
this._attachmentCount--;this.input.set("disabled",false);if(this._attachmentCount===this.data.attrs.max_attachments-1)
this._attachmentList.removeChild(this._attachmentList.get("lastChild"));this.fire('change',this);},_onValidateUpdate:function(type,args){this.toggleErrorIndicator(false);var eventObject=this.createEventObject();if(this._uploading||this._attachmentCount<this.data.attrs.min_required_attachments){var message=this._uploading?this.data.attrs.label_still_uploading_error:RightNow.Text.sprintf(this.data.attrs.label_min_required,this.data.attrs.label_input,this.data.attrs.min_required_attachments);this.lastErrorLocation=args[0].data.error_location;this._displayError(message,this.lastErrorLocation);RightNow.Event.fire("evt_formFieldValidateFailure",this._eo);return false;}
if(this._attachmentCount>0){eventObject.data.value=this._attachments;}
RightNow.Event.fire("evt_formFieldValidatePass",eventObject);return eventObject;},toggleErrorIndicator:function(showOrHide){var method=((showOrHide)?"addClass":"removeClass");this.input[method]("rn_ErrorField");this.Y.one(this.baseSelector+"_Label")[method]("rn_ErrorLabel");},_setLoading:function(turnOn,statusMessage){this._uploading=turnOn;this._loading||(this._loading=this.Y.one(this.baseSelector+"_LoadingIcon"));var useMessage=typeof statusMessage==='string';if(turnOn){RightNow.UI.show(this._loading);if(this._statusMessage){this._statusMessage.removeClass("rn_ScreenReaderOnly").setHTML(useMessage?statusMessage:RightNow.Interface.getMessage("UPLOADING_ELLIPSIS_MSG"));this._statusMessage.setAttribute("role","alert");}}
else{RightNow.UI.hide(this._loading);if(this._statusMessage){this._statusMessage.addClass("rn_ScreenReaderOnly").setHTML(useMessage?statusMessage:RightNow.Interface.getMessage("FILE_UPLOAD_COMPLETE_LBL"));if(!useMessage||statusMessage!==''){this._statusMessage.setAttribute("tabIndex",0);RightNow.UI.updateVirtualBuffer();this._statusMessage.focus();this._statusMessage.setAttribute("role","alert");}}}},_displayError:function(errorMessage,errorLocation){var commonErrorDiv=this.Y.one("#"+errorLocation);if(commonErrorDiv){commonErrorDiv.append(new EJS({text:this.getStatic().templates.error}).render({errorLink:(this.data.attrs.label_error.indexOf("%s")>-1)?RightNow.Text.sprintf(this.attrs.label_error,this.data.attrs.label_input):errorMessage,id:this.input.get('id'),fieldName:this._fieldName}));}
this.toggleErrorIndicator(true);}});
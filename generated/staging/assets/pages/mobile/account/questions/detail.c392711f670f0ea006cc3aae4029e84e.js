
RightNow.Widgets.FileAttachmentUpload=RightNow.Field.extend({overrides:{constructor:function(){this.parent();this.input=this.Y.one(this.baseSelector+"_FileInput");if(!this.input)return;this._eo=new RightNow.Event.EventObject(this);this._attachmentCount=this.data.js.attachmentCount||0;this._attachments=[];this._statusMessage=this.Y.one(this.baseSelector+"_StatusMessage");this._parentFormElement=this.input.ancestor('form');if(this._parentFormElement){this._origEncType=this._parentFormElement.get('enctype');this.input.on("change",this._onFileAdded,this);this.input.on("keypress",this._onKeyPress,this);this.input.on("paste",function(){return false;});RightNow.Form.find(this.input.get('id'),this.instanceID).on("submit",this._onValidateUpdate,this);this.on("constraintChange:min_required_attachments",this.updateMinAttachments,this);}
else{RightNow.UI.addDevelopmentHeaderError("FileAttachmentUpload must be placed within a form with a unique ID.");}
this.data.attrs.max_attachments=(this.data.attrs.max_attachments===0)?Number.MAX_VALUE:this.data.attrs.max_attachments;if(this._attachmentCount===this.data.attrs.max_attachments)
this.input.set("disabled",true);},getValue:function(){return this._attachments;}},swapLabel:function(container,minAttachments,label,template){this.Y.augment(this,RightNow.RequiredLabel);var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,minAttachments:minAttachments};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},updateMinAttachments:function(evt,constraint){var minAttachments=constraint[0].constraint;if(minAttachments>this.data.attrs.max_attachments||minAttachments===this.data.attrs.min_required_attachments)return;this.toggleErrorIndicator(false);if(this.data.attrs.min_required_attachments>0&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
if(this.data.attrs.label_input){this.swapLabel(this.Y.one(this.baseSelector+'_LabelContainer'),minAttachments,this.data.attrs.label_input,this.getStatic().templates.label);}
this.data.attrs.min_required_attachments=minAttachments;},_onKeyPress:function(event)
{var keyPressed=event.keyCode;if(keyPressed&&(keyPressed!==RightNow.UI.KeyMap.ENTER&&keyPressed!==RightNow.UI.KeyMap.TAB)||(keyPressed===RightNow.UI.KeyMap.ENTER&&this.Y.UA.ie))
{event.halt();}},_onFileAdded:function(e){var value=e.target.get('value');if(this._uploading||value===""||!this._validateFileExtension(value))return;this._sendUploadRequest();},_validateFileExtension:function(fileName){if(!this.data.attrs.valid_file_extensions)return true;this._validExtensions||(this._validExtensions=this.data.attrs.valid_file_extensions.toLowerCase().replace(' ','').split(','));var index=fileName.lastIndexOf('.'),fileExtension=(index!==-1&&index!==(fileName.length-1))?fileName.substring(index+1).toLowerCase():null,extensionIsValid=fileExtension&&this.Y.Array.indexOf(this._validExtensions,fileExtension)>-1;if(extensionIsValid){this.toggleErrorIndicator(false);return true;}
this.toggleErrorIndicator(true);this._displayStatus(RightNow.Text.sprintf(this.data.attrs.label_invalid_extension,'.'+this._validExtensions.join(", .")));return false;},_displayStatus:function(message){this._statusMessage.removeClass("rn_ScreenReaderOnly").set('innerHTML',message);},_sendUploadRequest:function(){this._eo.data.filename=this.input.get('value');var postData={name:this.data.js.id,path:this.data.js.path,ext:this.data.attrs.valid_file_extensions,constraints:this.data.js.constraints};this._localFile=this._getFileFromInput();if(RightNow.Event.fire("evt_fileUploadRequest",this._eo)){this._setLoading(true);this._parentFormElement.set('enctype','multipart/form-data').set('encoding','multipart/form-data');this._errorNotified=false;this._fileUploadReq=RightNow.Ajax.makeRequest("/ci/fattach/upload",postData,{json:true,data:this._eo,scope:this,timeout:(RightNow.Interface.getConfig("CP_FILE_UPLOAD_MAX_TIME")||300)*1000,upload:this._parentFormElement.get('id'),successHandler:this._fileUploadReturn,failureHandler:this._fileUploadFailure});this.input.set("disabled",true);this._parentFormElement.set('enctype',this._origEncType).set('encoding',this._origEncType);}
else{this.resetInput();}},_processServerError:function(response){var attachmentErrorInfo=this.getAttachmentErrorInfo(response);if(attachmentErrorInfo&&attachmentErrorInfo.errorMessage){attachmentErrorInfo.focusElement=this.input;if(!this._errorNotified){RightNow.UI.Dialog.messageDialog(attachmentErrorInfo.errorMessage,attachmentErrorInfo);this._errorNotified=true;}
return true;}
return false;},_processAttachmentThreshold:function(count){if(count>=this.data.attrs.max_attachments){this.input.set("disabled",true);return count>this.data.attrs.max_attachments;}
return false;},_fileUploadReturn:function(response,originalEventObject){var originalFileName=originalEventObject.data.filename;this._setLoading(false);this.resetInput();if(RightNow.Event.fire("evt_fileUploadResponse",response,originalEventObject)){var attachmentInfo=response;if(this._processServerError(attachmentInfo)||this._processAttachmentThreshold(++this._attachmentCount))return;var filename=this._normalizeFilename(attachmentInfo.name,originalFileName);this._attachments.push({userName:filename,localName:attachmentInfo.tmp_name,contentType:attachmentInfo.type||'application/octet-stream'});this.fire('change',this);this._renderNewAttachmentItem(filename,this._attachments.length);}},_getFileFromInput:function(){if(this.data.attrs.display_thumbnail&&window.FileReader){var files=this.Y.Node.getDOMNode(this.input).files,file;if(files&&(file=files[0])&&RightNow.Text.beginsWith(file.type,'image')){return file;}}},_renderNewAttachmentItem:function(filename,count){var attachmentItem=this.Y.Node.create(new EJS({text:this.getStatic().templates.attachmentItem}).render({id:this.baseDomID+'_Item'+count,name:filename,displayThumbnail:!!this._localFile,attrs:this.data.attrs}));if(this._localFile){this._loadThumbnail(this._localFile,new FileReader(),function(img){attachmentItem.one('.rn_Thumbnail').append(img);});}
attachmentItem.one("a.rn_fileRemove").on("click",this.removeClick,this,count-1);if(!this._attachmentList){this._attachmentList=this.Y.Node.create("<ul>");this._attachmentList.setAttribute("role","alert");this._statusMessage.insert(this._attachmentList,"after");}
this._attachmentList.append(attachmentItem);if(this.data.attrs.max_attachments===this._attachmentCount){this._attachmentList.append(new EJS({text:this.getStatic().templates.maxMessage}).render({maxMessage:this.data.attrs.label_max_attachment_limit}));}},_normalizeFilename:function(filename,originalFileName){if(filename.lastIndexOf('*')!==-1){originalFileName=originalFileName.replace(/\\/g,'/');var lastIndex=originalFileName.lastIndexOf('/');if(lastIndex!==-1){originalFileName=originalFileName.substr(lastIndex+1);}
filename=originalFileName;}
filename=filename.replace("&amp;","&");return this._renameDuplicateFilename(filename);},_renameDuplicateFilename:function(filename){var duplicateFilename,renamedFilename=filename,duplicates=0;function filenameIsDuplicate(file){return file.userName===renamedFilename;}
function addCounterToFilename(name,counter){var lastDot=name.lastIndexOf('.');if(lastDot===-1){return name+counter;}
else{return name.substr(0,lastDot)+counter+name.substr(lastDot);}}
do{duplicateFilename=this.Y.Array.find(this._attachments,filenameIsDuplicate);if(duplicateFilename){renamedFilename=addCounterToFilename(filename,++duplicates);}}
while(duplicateFilename);return renamedFilename;},_loadThumbnail:function(file,reader,callback){var maxHeight=this.data.attrs.max_thumbnail_height,width,height;reader.onload=function(){var image=new Image();image.src=reader.result;image.onload=function(){width=image.width;height=image.height;if(width>height&&width>maxHeight){height=Math.round(height*(maxHeight/width));width=maxHeight;}
else if(height>maxHeight){width=Math.round(width*(maxHeight/height));height=maxHeight;}
image.alt=file.name;image.width=width;image.height=height;callback(image);};};reader.readAsDataURL(file);},_fileUploadFailure:function(response){if(this._fileUploadReq===undefined)return;RightNow.Ajax.abortRequest(this._fileUploadReq,null);this._setLoading(false,'');this.resetInput();},getAttachmentErrorInfo:function(attachmentInfo){if(!attachmentInfo)
{return{errorMessage:RightNow.Interface.getMessage("THERE_PROB_REQ_ACTION_COULD_COMPLETED_MSG"),icon:"WARN"};}
else if(attachmentInfo.error===2)
{return{errorMessage:this.data.attrs.label_generic_error,icon:"WARN"};}
else if(attachmentInfo.error===4||attachmentInfo.error===88)
{return{errorMessage:RightNow.Interface.getMessage("FILE_PATH_FOUND_MSG"),icon:"WARN"};}
else if(attachmentInfo.error===10)
{return{errorMessage:RightNow.Interface.getMessage("FILE_ATT_UPLOAD_EMPTY_PLS_ENSURE_MSG")};}
else if(attachmentInfo.error===20)
{return{errorMessage:RightNow.Interface.getMessage("FILE_UPLOAD_ALLOWED_FILE_MSG"),icon:"WARN"};}
else if(attachmentInfo.errorMessage)
{return{errorMessage:attachmentInfo.errorMessage,icon:"WARN"};}
else
{return null;}},resetInput:function(){this.input.set("value","").set("disabled",false);this.recreateInput();},recreateInput:function(){if(this.Y.UA.ie||this.Y.UA.webkit){var inputField=this.input.cloneNode(false);this.input.replace(inputField);this.input=this.Y.one("#"+inputField.get('id'));if(this.Y.UA.ie>8||this.Y.UA.webkit)
this.input.on("change",this._onFileAdded,this);}},removeClick:function(event,index){this._attachments.splice(index,1);event.target.get("parentNode").remove();if(this._statusMessage){this._statusMessage.set("innerHTML",RightNow.Interface.getMessage("FILE_DELETED_LBL")).addClass("rn_ScreenReaderOnly").setAttribute("tabIndex",0);RightNow.UI.updateVirtualBuffer();this._statusMessage.focus();}
this._attachmentCount--;this.input.set("disabled",false);if(this._attachmentCount===this.data.attrs.max_attachments-1)
this._attachmentList.removeChild(this._attachmentList.get("lastChild"));this.fire('change',this);},_onValidateUpdate:function(type,args){this.toggleErrorIndicator(false);var eventObject=this.createEventObject();if(this._uploading||this._attachmentCount<this.data.attrs.min_required_attachments){var message=this._uploading?this.data.attrs.label_still_uploading_error:RightNow.Text.sprintf(this.data.attrs.label_min_required,this.data.attrs.label_input,this.data.attrs.min_required_attachments);this.lastErrorLocation=args[0].data.error_location;this._displayError(message,this.lastErrorLocation);RightNow.Event.fire("evt_formFieldValidateFailure",this._eo);return false;}
if(this._attachmentCount>0){eventObject.data.value=this._attachments;}
RightNow.Event.fire("evt_formFieldValidatePass",eventObject);return eventObject;},toggleErrorIndicator:function(showOrHide){var method=((showOrHide)?"addClass":"removeClass");this.input[method]("rn_ErrorField");this.Y.one(this.baseSelector+"_Label")[method]("rn_ErrorLabel");},_setLoading:function(turnOn,statusMessage){this._uploading=turnOn;this._loading||(this._loading=this.Y.one(this.baseSelector+"_LoadingIcon"));var useMessage=typeof statusMessage==='string';if(turnOn){RightNow.UI.show(this._loading);if(this._statusMessage){this._statusMessage.removeClass("rn_ScreenReaderOnly").setHTML(useMessage?statusMessage:RightNow.Interface.getMessage("UPLOADING_ELLIPSIS_MSG"));this._statusMessage.setAttribute("role","alert");}}
else{RightNow.UI.hide(this._loading);if(this._statusMessage){this._statusMessage.addClass("rn_ScreenReaderOnly").setHTML(useMessage?statusMessage:RightNow.Interface.getMessage("FILE_UPLOAD_COMPLETE_LBL"));if(!useMessage||statusMessage!==''){this._statusMessage.setAttribute("tabIndex",0);RightNow.UI.updateVirtualBuffer();this._statusMessage.focus();this._statusMessage.setAttribute("role","alert");}}}},_displayError:function(errorMessage,errorLocation){var commonErrorDiv=this.Y.one("#"+errorLocation);if(commonErrorDiv){commonErrorDiv.append(new EJS({text:this.getStatic().templates.error}).render({errorLink:(this.data.attrs.label_error.indexOf("%s")>-1)?RightNow.Text.sprintf(this.attrs.label_error,this.data.attrs.label_input):errorMessage,id:this.input.get('id'),fieldName:this._fieldName}));}
this.toggleErrorIndicator(true);}});
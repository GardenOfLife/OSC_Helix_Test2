
RightNow.RequiredLabel=function(){var a=new EJS({text:'<span class="rn_Required" aria-label="<%= requiredLabel %>"><%= requiredMarkLabel %></span>'});EJS.Helpers.prototype.getRequiredLabel=function(b,c){return a.render({requiredLabel:b||RightNow.Interface.getMessage("REQUIRED_LBL"),requiredMarkLabel:c||RightNow.Interface.getMessage("FIELD_REQUIRED_MARK_LBL")})}};
RightNow.Widgets.OpenLogin=RightNow.Widgets.extend({constructor:function(){this._redirectUrl=this.data.attrs.redirect_url;this.Y.Event.attach("click",this._onClick,this.baseSelector+"_ProviderButton",this);this.Y.Event.attach("click",this._onLogin,this.baseSelector+"_LoginButton",this);RightNow.Event.on("evt_requireLogin",this._socialAction,this);RightNow.Event.on("evt_FederatedProviderSelected",function(){this.Y.one(this.baseSelector+"_ActionArea").hide();},this);if(RightNow.Url.getParameter("emailerror")&&this.data.attrs.controller_endpoint.search(/twitter/i)>0){this._displayMessage("email");}
else if(this.data.js&&this.data.js.error){this._displayMessage("error",this.data.js.error);}},_socialAction:function(event,args){var data=(args[0]&&args[0].data)?args[0].data:null;if(data&&data.isSocialAction&&data.urlParamsToAdd){if(this._redirectUrl===''){this._redirectUrl=window.location.pathname;}
for(var param in data.urlParamsToAdd){this._redirectUrl=RightNow.Url.addParameter(this._redirectUrl,param,data.urlParamsToAdd[param]);}}},_onClick:function(event){var actionArea=this.Y.one(this.baseSelector+"_ActionArea");if(this.data.attrs.display_in_dialog){this._dialog=this._dialog||RightNow.UI.Dialog.actionDialog(RightNow.Interface.getMessage("LOGIN_LBL"),actionArea,{buttons:[{text:RightNow.Interface.getMessage("CANCEL_LBL"),handler:function(){this.hide();}}],cssClass:"rn_OpenLogin rn_OpenLoginDialog",navButtons:true,width:'100%'});if(this._dialog.submitEvent){this._dialog.cfg.setProperty("hideaftersubmit",false);this._dialog.submitEvent.subscribe(this._onLogin,null,this);}
this._dialog.show();}
else{RightNow.Event.fire("evt_FederatedProviderSelected",new RightNow.Event.EventObject(this));}
if(this.data.attrs.display_in_dialog){RightNow.UI.show(actionArea);this._selectProvider();}
else{actionArea.setStyle('opacity','0').removeClass("rn_Hidden").show();actionArea.transition({opacity:1,duration:0.1},RightNow.Event.createDelegate(this,this._selectProvider));}},_selectProvider:function(){var loginButton=this.Y.one(this.baseSelector+"_LoginButton");if(!this.data.attrs.openid&&loginButton){this._setAriaSelected(loginButton.set("tabIndex",-1)).focus();}
else if(this.data.attrs.openid&&this.data.attrs.openid_placeholder){this._selectOpenIDProvider();}},_setAriaSelected:function(selectedElement){this._setAriaSelected._items=this._setAriaSelected._items||[];var items=this._setAriaSelected._items,Dom=this.Y.DOM,alreadyInList=false,i,length;for(i=0,length=items.length;i<length;i++){Dom.setAttribute(items[i],'aria-selected','false');if(items[i]===selectedElement.get('id')){alreadyInList=true;}}
if(!alreadyInList){this._setAriaSelected._items.push(selectedElement.get('id'));}
return selectedElement.setAttribute('aria-selected','true');},_displayMessage:function(messageType,errorMessage){if(!this._displayMessage._displayingMessage){this._displayMessage._displayingMessage=true;if(messageType==="email"){this._displayEmailPrompt();}
else if(messageType==="error"){if(RightNow.UI!==undefined&&RightNow.UI.Dialog!==undefined){RightNow.UI.Dialog.messageDialog(errorMessage,{icon:"WARN",title:RightNow.Interface.getMessage("OOPS_LBL"),width:"330px"});}
else{alert(errorMessage);}}}},_displayEmailPrompt:function(){this.Y.augment(this,RightNow.RequiredLabel);var dialog,errorDiv,emailField,Dialog=RightNow.UI.Dialog,inputID=this.baseDomID+"_Email",dialogBody=this.Y.Node.create("<div class='rn_OpenLogin rn_OpenLoginDialog'></div>").set("innerHTML",new EJS({text:this.getStatic().templates.emailPrompt}).render({inputID:inputID,inputLabel:this.data.attrs.label_email_address,promptLabel:this.data.attrs.label_email_prompt})),successHandler=function(serverResponse){if(serverResponse.responseText==="true"){RightNow.Url.navigate(this.data.attrs.redirect_url);}
else{this._submittingEmail=false;dialog.enableButtons();Dialog.messageDialog(RightNow.Interface.getMessage("THERE_PROB_REQ_ACTION_COULD_COMPLETED_MSG"),{icon:"WARN"});}},submitHandler=function(){if(!this._submittingEmail){this._submittingEmail=true;dialog.disableButtons();emailField=emailField||this.Y.one("#"+inputID);if(emailField&&emailField.get("value")){var email=emailField.set("value",this.Y.Lang.trim(emailField.get("value"))).get("value");if(RightNow.Text.isValidEmailAddress(email)){RightNow.UI.hide(errorDiv);RightNow.Ajax.makeRequest(this.data.attrs.provide_email_ajax,{email:email,userData:RightNow.Url.getParameter("emailerror")},{successHandler:successHandler,scope:this});return;}
else if(errorDiv){errorDiv.removeClass("rn_Hidden").one("a").focus();}
else{errorDiv=this.Y.Node.create("<div class='rn_MessageBox rn_ErrorMessage'>"+"<a href='javascript:void(0);' onclick='document.getElementById(\""+inputID+"\").focus();'>"+
RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_IS_INVALID_MSG"),this.data.attrs.label_email_address)+"</a></div>");dialogBody.insert(errorDiv,'before');errorDiv.one("a").focus();}}
dialog.enableButtons();this._submittingEmail=false;}};dialog=Dialog.actionDialog(this.data.attrs.label_email_prompt_title,dialogBody,{buttons:[{text:this.data.attrs.label_email_prompt_submit_button,handler:{fn:submitHandler,scope:this},isDefault:true},{text:this.data.attrs.label_email_prompt_cancel_button,handler:function(){this.hide();}}],width:"330px"});Dialog.addDialogEnterKeyListener(dialog,submitHandler,this);dialog.show();},_selectOpenIDProvider:function(){if(this.data.attrs.openid_placeholder&&this.data.attrs.openid_placeholder.indexOf("[")>-1){var input=this.Y.one(this.baseSelector+"_ProviderUrl"),start,end,selection;if(input){this._setAriaSelected(input);input.focus();start=input.get("value").indexOf("[");end=input.get("value").indexOf("]")+1;if(input.get("value")&&start>-1&&end>start){input=this.Y.Node.getDOMNode(input);if(window.getSelection){selection=window.getSelection();if(selection.rangeCount>0)
selection.removeAllRanges();input.setSelectionRange(start,end);}
else if(document.selection&&document.selection.createRange){selection=input.createTextRange();selection.collapse(true);selection.moveStart("character",start);selection.moveEnd("character",end-start);selection.select();}}}}},_onLogin:function(evt){evt.preventDefault();if(this._cookiesEnabled()){var input=this.Y.one(this.baseSelector+"_ProviderUrl"),inputValue=((input)?input.set("value",this.Y.Lang.trim(input.get("value"))).get("value"):"");this._goToUrl(inputValue);}
else{RightNow.UI.Dialog.messageDialog(RightNow.Interface.getMessage("COOKIES_ENABLED_BROWSER_ORDER_LOG_MSG"),{icon:"WARN"});}},_goToUrl:function(inputValue){var goToUrl=function(url){if(this.Y.UA.ie){var Url=RightNow.Url,referLink=this.Y.Node.getDOMNode(this.Y.Node.create("<a class='rn_Hidden'></a>").set("href",((Url.getSession())?Url.addParameter(url,"session",Url.getSession()):url)));document.body.appendChild(referLink);referLink.click();}
else{RightNow.Url.navigate(url);}},urlToGoTo="";if(this.data.attrs.openid){if(this.data.attrs.preset_openid_url&&inputValue!==""&&inputValue!==this.data.attrs.openid_placeholder&&!RightNow.Text.isValidUrl(inputValue)){urlToGoTo=this.data.attrs.preset_openid_url.replace(/\[username\]/,inputValue);}
else if(!this.data.attrs.preset_openid_url&&inputValue!==this.data.attrs.openid_placeholder&&RightNow.Text.isValidUrl(inputValue)){urlToGoTo=inputValue;}
if(urlToGoTo){urlToGoTo=encodeURIComponent(urlToGoTo)+"/";}
else{return;}}
goToUrl.call(this,this.data.attrs.controller_endpoint+urlToGoTo+encodeURIComponent(this._redirectUrl));},_cookiesEnabled:function(){var noCookie=function(){return document.cookie==="";},setCookie=function(value){return(document.cookie=value);};if(noCookie()){if(setCookie("cp_login_start=1;path=/")&&noCookie()){return false;}
setCookie("");}
return true;}});
RightNow.Widgets.LoginForm=RightNow.Widgets.extend({constructor:function(){this.Y.one(this.baseSelector+"_Submit").on("click",this._onSubmit,this);this._usernameField=this.Y.one(this.baseSelector+"_Username");this._passwordField=this.Y.one(this.baseSelector+"_Password");if(this.data.attrs.initial_focus&&!this.Y.one('.rn_Dialog'))
{if(this._usernameField&&this._usernameField.get("value")==='')
this._usernameField.focus();else if(this._passwordField)
this._passwordField.focus();}
if(RightNow.Widgets.formTokenRegistration)
{RightNow.Widgets.formTokenRegistration(this);}},_getRedirectUrl:function(result){var redirectUrl;if(this.data.js&&this.data.js.redirectOverride)
redirectUrl=RightNow.Url.addParameter(this.data.js.redirectOverride,'session',result.sessionParm.substr(result.sessionParm.lastIndexOf("/")+1));else
redirectUrl=(this.data.attrs.redirect_url||result.url)+((result.addSession)?result.sessionParm:"");redirectUrl+=this.data.attrs.append_to_url;if(result.forceRedirect){redirectUrl=RightNow.Url.addParameter(result.forceRedirect,'redirect',encodeURIComponent(redirectUrl));}
return redirectUrl;},_onLoginResponse:function(response,originalEventObject)
{if(!RightNow.Event.fire("evt_loginFormSubmitResponse",{data:originalEventObject,response:response})){return;}
this._toggleLoading(false);if(response.success)
{this.Y.one(this.baseSelector+"_Content").set("innerHTML",response.message);var redirectUrl=this._getRedirectUrl(response);if(this.Y.UA.ie&&this.Y.UA.ie<9&&RightNow.Text.beginsWith(redirectUrl,'/ci/fattach/get/'))
this.Y.one(this.baseSelector).set('innerHTML',RightNow.Text.sprintf(RightNow.Interface.getMessage("PLS_CLCK_HREF_EQS_PCT_S_THAN_S_MSG"),redirectUrl));else
RightNow.Url.navigate(redirectUrl);}
else
{this._addErrorMessage(response.message,this.baseDomID+'_Username',response.showLink);}},_onSubmit:function(e)
{e.halt();var username=(this._usernameField)?this.Y.Lang.trim(this._usernameField.get("value")):"",errorMessage,eventObject;if(username.indexOf(' ')>-1)
errorMessage=RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_MUST_NOT_CONTAIN_SPACES_MSG"),RightNow.Interface.getMessage("USERNAME_LBL"));else if(username.indexOf('"')>-1)
errorMessage=RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_CONTAIN_DOUBLE_QUOTES_MSG"),RightNow.Interface.getMessage("USERNAME_LBL"));else if(username.indexOf("<")>-1||username.indexOf(">")>-1)
errorMessage=RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_CNT_THAN_MSG"),RightNow.Interface.getMessage("USERNAME_LBL"));if(errorMessage)
{this._addErrorMessage(errorMessage,this.baseDomID+'_Username');return false;}
eventObject=new RightNow.Event.EventObject(this,{data:{login:username,password:((!this.data.attrs.disable_password&&this._passwordField)?this._passwordField.get("value"):""),url:window.location.pathname,w_id:this.data.info.w_id,f_tok:this.data.js.f_tok}});if(RightNow.Event.fire("evt_loginFormSubmitRequest",eventObject)){this._toggleLoading(true);if(RightNow.Event.noSessionCookies()){RightNow.Event.setTestLoginCookie();}
RightNow.Ajax.makeRequest(this.data.attrs.login_ajax,eventObject.data,{successHandler:this._onLoginResponse,scope:this,data:eventObject,json:true});if(this.Y.UA.ie&&window.external&&"AutoCompleteSaveForm"in window.external)
{var form=document.getElementById(this.baseDomID+"_Form");if(form)
window.external.AutoCompleteSaveForm(form);}}},_addErrorMessage:function(message,focusElement,showLink){var error=this.Y.one(this.baseSelector+"_ErrorMessage");if(error)
{error.addClass('rn_MessageBox rn_ErrorMessage');if(showLink===false)
{error.set("innerHTML",message);}
else
{error.set("innerHTML",'<a href="javascript:void(0);" onclick="document.getElementById(\''+focusElement+'\').focus(); return false;">'+message+'</a>');error.one('a').focus();}
error.one("h2")?error.one("h2").setHTML(RightNow.Interface.getMessage("ERRORS_LBL")):error.prepend("<h2>"+RightNow.Interface.getMessage("ERROR_LBL")+"</h2>");error.one("h2").setAttribute('role','alert');}},_toggleLoading:function(turnOn){this._widgetContent||(this._widgetContent=this.Y.one(this.baseSelector+'_Content'));this._widgetContent.all('input')[(turnOn)?'setAttribute':'removeAttribute']('disabled',true);if(!this.Y.UA.ie||this.Y.UA.ie>8){this._widgetContent.transition({opacity:turnOn?0:1,duration:0.4});this.Y.one(this.baseSelector)[(turnOn)?'addClass':'removeClass']('rn_Loading');}}});
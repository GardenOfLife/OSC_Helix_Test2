
RightNow.EventProvider=RightNow.Widgets.extend({constructor:function(){this._events={};this._eventHandlers={};this._eventFilters={}},_addEventHandler:function(a,b){this._eventHandlers[a]=b;return this},_getEventHandlers:function(a){return this._eventHandlers[a]||{}},_addSubscribersFilter:function(a,b,d){if(!b||"function"!==typeof b)throw Error("Subscriber filters must be functions.");this._eventFilters[a]||(this._eventFilters[a]=[]);this._eventFilters[a].push({handler:b,context:d});return this},_getFilteredSubscriberIndices:function(a){var b=this._events[a];a=this._eventFilters[a];var d=[],c;if(a)for(var f=0;f<a.length;f++)c=a[f],c=c.handler.call(c.context,b),this.Y.Array.each(c,function(a){isNaN(a)||d.push(a)},this);return d},fire:function(a,b,d){var c=this._getEventHandlers(a),f=this._getFilteredSubscriberIndices(a),g=this._events[a],e=!0,k=[];c.pre&&(e=c.pre.call(this,b));if(!1!==e){if(g){d="undefined"!==typeof d?[b,d]:[b];for(var e=0,l=g.length,h,m;e<l;e++)-1===this.Y.Array.indexOf(f,e)&&(h=g[e],m=h.handler.call(h.context||window,a,d),h.once&&k.push(e),c.during&&c.during.call(this,m));if(l=k.length)for(e=0;e<l;e++)g.splice(k[e]-e,1)}c.post&&c.post.call(this,b)}return this},on:function(a,b,d,c){this._events[a]=this._events[a]||[];if(b&&"function"===typeof b)return this._events[a].push({handler:b,context:d,once:c}),this;throw Error("Handler specified isn't a callable function");},once:function(a,b,d){return this.on(a,b,d,!0)},detach:function(a,b,d){if(b&&"function"===typeof b){var c;if(c=this._events[a])for(a=c.length-1;0<=a;a--)c[a].handler!==b||d&&d!==c[a].context||c.splice(a,1);return this}throw Error("Handler specified isn't a callable function");}});
(function(){function p(a){var b={},d=new a.HistoryHTML5;d.on("change",function(c){if(c.src===a.HistoryHTML5.SRC_POPSTATE){l=!0;var b=c.changed.state;b?f.RefreshSources(b.newVal):(c.halt(!0),window.history.go(-1));l=!1}});return{enabled:!0,addState:function(a,b,q){d[q?"replace":"add"]({state:b},{url:h.getCurrentPage()+a})},checkCache:function(a){return a in b?b[a]:null},setCache:function(a,d){b[a]=d}}}var k,n,h,f,l=!1;RightNow.ParameterContext={};"pushState"in window.history?YUI().use("history-html5",function(a){k=p(a)}):k={enabled:!1};n=function(){function a(a,b){this.sourceCollection[b.sourceID]={response:a,filters:b.filters,sourceID:b.sourceID};this.completedSearches++;k.setCache(b.sourceID+b.historyKey,this.sourceCollection[b.sourceID]);this.completedSearches===this.sourceCount&&(f.RefreshSources(this.sourceCollection),k.addState(b.historyKey,this.sourceCollection,b.isRestoring),this.completedSearches=0,this.sourceCollection={})}function b(b,c,d){RightNow.Ajax.makeRequest(b,c,{successHandler:a,failureHandler:function(a){var b=RightNow.Interface.getMessage("THERE_PROB_REQ_ACTION_COULD_COMPLETED_MSG");403===a.status&&void 0!==a.responseText&&(b=a.responseText);RightNow.UI.Dialog.messageDialog(b,{icon:"WARN",exitCallback:function(){window.location.reload(!0)}})},json:!0,data:d,timeout:1E4})}function d(a,c,d,g,r){this.sourceCount=g;g=h.getFilterUrl(a);var m=k.checkCache(d+g);if("/"===g)r.fire("response",new RightNow.Event.EventObject(null,{data:{}}));else if(g=RightNow.Url.addParameter(g,"session",RightNow.Url.getSession()),m)this.completedSearches++,this.sourceCollection[m.sourceID]=m,this.completedSearches===this.sourceCount&&(f.RefreshSources(this.sourceCollection),k.addState(g,this.sourceCollection,l),this.completedSearches=0,this.sourceCollection={});else{if(!c.endpoint)throw Error("An endpoint hasn't been specified");b(c.endpoint,e.mix({sourceID:d,filters:RightNow.JSON.stringify(a),limit:c.limit},c.params),{sourceID:d,historyKey:g,filters:a,isRestoring:l})}}function c(a,b){if(!this.refreshInProgress){var c=RightNow.Url.addParameter((b.new_page||h.getCurrentPage())+h.getFilterUrl(a),"session",RightNow.Url.getSession());"_self"===b.target?RightNow.Url.navigate(c,!0):window.open(c,b.target||"_self");this.refreshInProgress=!0}}var e=YUI();this.completedSearches=this.sourceCount=0;this.sourceCollection={};return{go:function(a,b,e,g,f){!k.enabled||b&&(b.new_page||!b.endpoint)?c(a,b):d(a,b,e,g,f)}}}();h={alphanumericSort:function(a,b){return a<b?-1:a>b?1:0},getFilterUrl:function(a){var b=[],d={},c,e;for(c in a)a.hasOwnProperty(c)&&(e=a[c],!e.key||d[e.key]||!e.value&&0!==e.value&&!1!==e.value||(b.push(e.key),d[e.key]=e.value));b.sort(h.alphanumericSort);for(a="";c=b.shift();)a+="/"+c+"/"+encodeURIComponent(d[c]);return a},getFlattenedFilters:function(a){var b={},d,c;for(c in a)a.hasOwnProperty(c)&&"object"===typeof a[c]&&(d=h.getFlattenedFilter(a[c]))&&(b[c]=d);return b},getWidgetData:function(a){var b={};a&&a.data&&(b.w_id=a.w_id,b.rn_contextData=a.data.rn_contextData,b.rn_contextToken=a.data.rn_contextToken,b.rn_timestamp=a.data.rn_timestamp,b.rn_formToken=a.data.rn_formToken);return b},getFlattenedFilter:function(a){if("value"in a&&"type"in a&&"key"in a)return{value:a.value,key:a.key,type:a.type}},getCurrentPage:function(){var a=window.location,b=a.pathname,a=a.origin||a.protocol+"//"+a.host;return"/"===b||"/app"===b||"/app/"===b?a+"/app/"+RightNow.Interface.getConfig("CP_HOME_URL"):b.split("/").slice(0,RightNow.Url.getParameterSegment()-1).join("/")}};f=function(){function a(a){return a?c[a]:c}function b(a){if(!a||!a.length||2>a.length)throw Error("You're doing it wrong");this.sources=a;this.multiple=!0}function d(a){return function(){for(var b=0,c=arguments,g;b<this.sources.length;b++)g=this.sources[b],g[a].apply(g,c);return this}}var c={},e=RightNow.EventProvider.extend({overrides:{constructor:function(a,b,d){this.parent();this.sourceID=b;this.Y=a;this.initialFilters={};this.filters={};this.widgetData={};this.options={};this.cancelSearch=!1;delete this.data;delete this.baseDomID;delete this.baseSelector;this._addEventHandler("collect",{pre:function(){this.filters=this.initialFilters},during:function(a){a&&a instanceof RightNow.Event.EventObject&&((a=h.getFlattenedFilter(a.data))&&a.value?this.filters[a.type]=a:delete this.filters[a.type])}});this._addEventHandler("search",{pre:function(b){if(RightNow.isInstance(b,RightNow.Event.EventObject)){var c=this.options.limit!==b.data.limit?this.options.limit:null;this.options=a.merge(this.options,b.data);c&&(this.options.limit=c)}this.options.params=a.merge(this.options.params,this.widgetData);"page"in this.options&&(this.Y.Object.isEmpty(this.filters)&&(this.filters=this.initialFilters),this.filters.page=this.options.page);this.cancelSearch=!1},during:function(a){!1===a&&(this.cancelSearch=!0)},post:function(){this.cancelSearch?this.fire("searchCancelled",this.filters,this.options):n.go(this.filters,this.options,b,this.options.sourceCount||Object.keys(c).length,this);delete this.options.sourceCount}});this._addEventHandler("initializeFilters",{pre:function(b){if(RightNow.isInstance(b,RightNow.Event.EventObject)&&(RightNow.ParameterContext[this.instanceID]=this.initialFilters=h.getFlattenedFilters(b.data),this.widgetData=h.getWidgetData(b),k.enabled&&(b=Object.keys(c),b[b.length-1]===this.instanceID))){b={};for(var d in RightNow.ParameterContext)b=a.merge(b,RightNow.ParameterContext[d]);var e=h.getFilterUrl(b),f={},e=RightNow.Url.addParameter(e,"session",RightNow.Url.getSession());this.Y.Object.each(c,function(a,b){var c=this.Y.one("#rn_"+a.widgetData.w_id+"_HistoryData"),d=this.Y.one("#rn_"+a.widgetData.w_id+"_Content");c&&d&&(c=JSON.parse(c.getHTML()),c.html=d.getHTML(),c._isParsed=!0,f[b]={response:c,filters:this.initialFilters,sourceID:b},k.setCache(e+b,f[b]))},this);k.addState(e,f,!0)}}});this._addEventHandler("updateHistoryEntry",{pre:function(b){if(k.enabled&&b&&b instanceof RightNow.Event.EventObject){this.options=a.merge(this.options,b.data.data);this.options.params=a.merge(this.options.params,this.widgetData);"page"in this.options&&(this.Y.Object.isEmpty(this.filters)&&(this.filters=this.initialFilters),this.filters.page=this.options.page);for(var c in b.data.update)this.filters[c]=b.data.update[c];b=h.getFilterUrl(this.filters);b=RightNow.Url.addParameter(b,"session",RightNow.Url.getSession());k.addState(b,null,!0)}}});this._addEventHandler("updateFilters");this._addEventHandler("reset");this.on("reset",function(){this.filters=this.initialFilters;this.page=0},this)},setOptions:function(a){a&&this.sourceID in a&&a[this.sourceID]&&(a=a[this.sourceID]);this.options=this.Y.mix(this.options,a,!0);return this}}});b.prototype={on:d("on"),fire:d("fire"),setOptions:d("setOptions")};return{SearchSource:e,MultipleSourcesWrapper:b,RefreshSources:function(b){var c,d;for(d in b)b.hasOwnProperty(d)&&(c=a(d))&&c.fire("response",new RightNow.Event.EventObject(null,{data:b[d].response})).fire("updateFilters",new RightNow.Event.EventObject(null,{data:b[d].filters}))},get:a,getSearchSources:function(a){return a?(a+"").split(","):[]},add:function(a,b){if(a&&RightNow.isInstance(b,e)&&!c[a])return c[a]=b}}}();RightNow.SearchConsumer=RightNow.Widgets.extend({constructor:function(){var a=f.getSearchSources(this.data.attrs.source_id),b=f.get(a[0]);1<a.length&&RightNow.UI.DevelopmentHeader.addJavascriptError("A search consumer cannot have more than one search source");b||(b=new f.SearchSource(this.Y,a[0]),f.add(a[0],b));this.searchSource=function(){return b}}});RightNow.SearchProducer=RightNow.Widgets.extend({constructor:function(){for(var a=f.getSearchSources(this.data.attrs.source_id),b=[],d=0,c;d<a.length;d++)c=c=f.get(a[d]),c||(c=new f.SearchSource(this.Y,a[d]),f.add(a[d],c)),b.push(c);if(!b.length)throw Error("No search sources were given");c=1===b.length?c:new f.MultipleSourcesWrapper(b);this.searchSource=function(){return c}}})})();
RightNow.Widgets.SourceSearchField=RightNow.SearchProducer.extend({overrides:{constructor:function(){this.parent();this.input=this.Y.one(this.baseSelector+'_SearchInput');if(this.data.attrs.initial_focus){this.input.focus();}
this.searchSource().on('collect',this.onCollect,this).on('updateFilters',this.onFilterUpdate,this).on('reset',this.onReset,this);RightNow.Event.subscribe('evt_getSearchField',function(){RightNow.Event.fire("evt_sendSearchField",new RightNow.Event.EventObject(this,{data:this.input}));},this);}},onCollect:function(){var searchTerm="";var keywordEntered=this.Y.Lang.trim(this.input.get('value'));if(this.data.attrs.allow_empty_search&&!keywordEntered){searchTerm="*";}
else if(keywordEntered){searchTerm=keywordEntered;}
this.searchSource().setOptions({page:{key:"page",type:"page",value:1}});return new RightNow.Event.EventObject(this,{data:this.Y.merge(this.data.js.filter,{value:searchTerm})});},onFilterUpdate:function(e,eo){this.Y.Object.some(eo[0].data,function(filter){if(filter.key===this.data.js.filter.key){var filterValue=this.Y.Node.create('<textarea>'+filter.value+'</textarea>').get('innerText');this.input.set('value',(filter.value!=='*')?filterValue:'');return true;}},this);},onReset:function(){this.input.set('value',this.data.js.prefill);}});
RightNow.Widgets.SourceSearchButton=RightNow.SearchProducer.extend({overrides:{constructor:function(){this.parent();this.searchButton=this.Y.one(this.baseSelector+"_SubmitButton");RightNow.Event.subscribe("evt_sendSearchField",function(evt,evtData){this.searchField=evtData[0].data;this.search();},this);if(this.searchButton){this.enableClickListener();this.searchSource().setOptions(this.searchOptions()).setOptions(this.data.js.sources).on('response',this.enableClickListener,this);}}},searchOptions:function(){return this._searchOptions||(this._searchOptions={new_page:this.data.attrs.search_results_url,target:this.data.attrs.target,limit:this.data.attrs.per_page});},search:function(e){if(e)
e.halt();if(!this.searchField){RightNow.Event.fire("evt_getSearchField",new RightNow.Event.EventObject(this));return;}
if(this.searchInProgress)return;this.searchSource().fire('collect');if(this.searchSource().multiple){this.filters=this.searchSource().sources[0].filters;}
else{this.filters=this.searchSource().filters;}
if(this.filters.query&&this.Y.Lang.trim(this.filters.query.value)!==''){if(this.filters.query.key==="kw"&&this.Y.Lang.trim(this.filters.query.value)==="*"){this.filters.direction=this.filters.direction||{};this.filters.direction.value=0;this.filters.sort=this.filters.sort||{};this.filters.sort.value=1;}
this.disableClickListener();this.searchSource().fire('search',new RightNow.Event.EventObject(this,{data:this.searchOptions()}));}
else{RightNow.UI.displayBanner(this.data.attrs.label_enter_search_keyword,{type:'WARNING',focusElement:this.searchField});}},enableClickListener:function(evt){this.searchInProgress=false;this.searchButton.set('disabled',false).on('click',this.search,this);if(evt){this.searchButton.focus();}},disableClickListener:function(){this.searchInProgress=true;this.searchButton.set('disabled',true).detach('click',this.search,this);}});